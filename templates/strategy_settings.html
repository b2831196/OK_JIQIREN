<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½äº¤æ˜“ - ç­–ç•¥è®¾ç½®</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/crypto-theme.css">
    <link rel="stylesheet" href="/static/css/strategy_settings.css">
    
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="u-navbar">
        <div class="u-navbar__content">
            <div class="u-navbar__content__left">
                <i class="fas fa-arrow-left u-icon__icon" onclick="window.history.back()"></i>
            </div>
            <div class="u-navbar__content__title">{{ strategy.name }}</div>
            <div class="u-navbar__content__right"></div>
        </div>
        </div>
        
    <div class="robot-settings">
        <!-- é¡¶éƒ¨èµ„äº§ä¿¡æ¯ -->
        <div class="forms box box-card margin_t2 hover-glow">
            <div class="top-box">
                <div class="top-left">
                    <div class="flex-x">
                        <span class="available-m">å¯ç”¨èµ„äº§</span>
                        <img src="/static/newimg/refresh.png" class="refresh-img" alt="åˆ·æ–°">
                    </div>
                    <span class="now-money">{{ strategy.invested }} USDT</span>
                </div>
                <div class="top-right">
                    <img src="https://newrobot.idyyvv.top/image/20210823/ff380e5a4eac6a36fbf7dde5ed153745.png" class="coin-img" alt="äº¤æ˜“æ‰€">
                    <div class="flex-x">
                        <img src="/static/newimg/change.png" class="change-img" alt="åˆ‡æ¢">
                        <span class="now-money">Binance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¡¨å•å†…å®¹ -->
        <div class="self-forms">
            <!-- å¸ç§é€‰æ‹© -->
            <div class="forms-item f-1 box2 hover-glow" id="crypto-selector">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>å¸ç§é€‰æ‹©</span>
                        <div class="premium-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <img id="selected-crypto-icon" src="https://ai.hkd.red/symbolImage/{{ strategy.trade_pair.split('-')[0] }}.png" style="height: 32px; width: 32px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.08);" alt="å¸ç§å›¾æ ‡">
                                <div id="selected-crypto-name" class="robot-name">{{ strategy.trade_pair.split('-')[0] }}/{{ strategy.trade_pair.split('-')[1] }}</div>
                                <input type="hidden" id="selected-crypto-pair" value="{{ strategy.trade_pair }}">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <span class="margin_r1" style="color: #1a6aff;"></span>
                            <span class="myicon icon-Choose" style="color: #1a6aff;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“å¯¹é€‰æ‹©å¼¹çª— -->
            <div id="crypto-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>é€‰æ‹©äº¤æ˜“å¯¹</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="crypto-search" placeholder="æœç´¢å¸ç§...">
                    </div>
                    <div class="modal-body">
                        <div class="crypto-list">
                            {% for pair in trading_pairs %}
                            <div class="crypto-item" data-original="{{ pair.original }}" data-symbol="{{ pair.symbol }}" data-display="{{ pair.display }}">
                                <img src="{{ pair.icon_url }}" alt="{{ pair.symbol }}" onerror="this.src='/static/images/default-coin.svg'">
                                <span>{{ pair.display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¸ç§é€‰æ‹©ï¼ˆéšè—ï¼‰ -->
            <div class="forms-item f-1 box2" style="display: none;">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>å¸ç§é€‰æ‹©</span>
                    </div>
                    </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <div class="robot-name">å¸ç§</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="flex-x">
                            <span>è¯·é€‰æ‹©å¸ç§</span>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-right" style="font-size: 14px; line-height: 14px; font-weight: normal; top: 1px; color: rgb(200, 200, 200);"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é¢„è®¾ç­–ç•¥ -->
            <div class="flex-y margin_b1">
                <span class="lable-name">é¢„è®¾ç­–ç•¥</span>
                <div class="type-scroll">
                    <div class="scroll-li-types type-actives">
                        <div class="li-type-center flex-x-c">ä¿å®ˆå‹</div>
                    </div>
                    <div class="scroll-li-types premium-strategy">
                        <div class="li-type-center flex-x-c">ç¨³å¥å‹</div>
                </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">æ¿€è¿›å‹</div>
                    </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">è‡ªå®šä¹‰</div>
                </div>
                    </div>
            </div>
            
            <!-- ç­–ç•¥æ–¹å‘ -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>ç­–ç•¥æ–¹å‘</span>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color" style="padding: 0px;">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="type-box flex-x-b box-bg1" style="width: 176px;">
                                <span class="type-li type-active">åšå¤š</span>
                                <span class="type-li">åšç©º</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-right"></div>
                </div>
            </div>
            
    <!-- æ æ†è°ƒæ•´ - å¢å¼ºé«˜äº®ç‰ˆæœ¬ -->
    <div class="forms-item f-1 box2" id="leverage-selector" style="position: relative; z-index: 1;">
        <div class="form-item-label flexs" style="width: auto; position: relative; z-index: 2;">
            <div class="label flexs">
                <span style="font-weight:700;color:#1a6aff;font-size:18px;">æ æ†è°ƒæ•´</span>
                <div class="icon-box">
                    <div class="u-icon u-icon--right">
                        <span class="u-icon__icon uicon-question-circle" style="font-size:20px;line-height:20px;font-weight:bold;color:#1a6aff;"></span>
                    </div>
                </div>
            </div>
            <div class="label-right"></div>
        </div>
        <div class="form-item-input flexs theme-border-color input-border" style="border:3px solid #1a6aff;background:linear-gradient(135deg,#1a6aff,#3f87ff);box-shadow:0 4px 15px rgba(26,106,255,0.3); position: relative; z-index: 1;">
            <div class="flexs f-1" style="background:transparent;border-radius:8px;">
                <div class="input f-1">
                    <div class="uni-input-wrapper">
                        <input disabled="disabled" placeholder="é€‰æ‹©æ æ†å€æ•°" maxlength="140" step="" enterkeyhint="done" autocomplete="off" type="text" class="uni-input-input" id="leverage-input" value="10X" style="font-weight:700;color:white;font-size:18px;text-shadow:0 1px 3px rgba(0,0,0,0.3);">
                                <input type="hidden" id="leverage-value" value="10">
                                <!-- é¢„å…ˆåŠ è½½æ æ†æ•°æ®åˆ°HTML -->
                                <input type="hidden" id="default-leverage-options" value="{{ default_leverages|tojson }}">
                            </div>
                        </div>
                    </div>
            <div class="input-right">
                <div>
                    <div class="u-icon u-icon--right">
                        <span class="u-icon__icon uicon-arrow-down-fill" style="font-size:20px;line-height:20px;font-weight:bold;top:0px;color:#1a6aff;"></span>
                    </div>
                </div>
            </div>
                </div>
                
                <!-- æ æ†é€‰æ‹©ä¸‹æ‹‰é¢æ¿ (æ”¹ä¸ºå†…è”æ˜¾ç¤ºè€Œä¸æ˜¯æ¨¡æ€æ¡†) -->
                <div id="leverage-dropdown" class="leverage-dropdown" style="display: none;">
                    <div class="leverage-dropdown-header">
                        <h3>é€‰æ‹©æ æ†å€æ•°</h3>
                        <span class="close-dropdown">&times;</span>
                    </div>
                    <div class="leverage-dropdown-body">
                        <div class="leverage-list" id="leverage-options-list">
                            <!-- æ æ†é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ æ†é€‰æ‹©å¼¹çª— (ä½œä¸ºå¤‡ç”¨ä¿ç•™ï¼Œä½†ä¸å†ä½¿ç”¨) -->
            <div id="leverage-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>é€‰æ‹©æ æ†å€æ•°</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="leverage-list" id="leverage-modal-options-list">
                            <!-- æ æ†é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é¢„è®¡æŠ•å…¥ -->
            <div class="forms-item f-1 box2" id="margin-input-container">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>é¢„è®¡æŠ•å…¥ï¼ˆä¿è¯é‡‘ï¼‰</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border margin-input">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢" maxlength="140" step="0.01" enterkeyhint="done" autocomplete="off" type="number" class="uni-input-input">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="margin-value-container">
                            <span style="font-weight: 500; color: #1a6aff;">USDT</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç­–ç•¥å‚æ•°è®¾ç½® -->
            <div class="settings-card box hover-glow">
                <div class="settings-title">å‚æ•°è®¾ç½® <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">ä¸“ä¸šç‰ˆ</small></div>
                <div class="settings-row">
                    <div class="setting-label">ç½‘æ ¼æ•°é‡</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.grid_count }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">ä»·æ ¼åŒºé—´</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.price_range }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">é£é™©ç­‰çº§</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.risk_level }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>

                <!-- æ·»åŠ ä»“ä½æ¯”ä¾‹æ§åˆ¶ -->
                <div class="settings-row">
                    <div class="setting-label">ä»“ä½æ¯”ä¾‹æ§åˆ¶</div>
                    <div class="setting-value">
                        <span id="position-value-percent" style="font-weight: 600; color: #1a6aff;">100%</span>
                    </div>
                </div>
                <div class="settings-row position-slider-container">
                    <div class="gress-box">
                        <div class="sunny-sliderBar" style="width: 100%; --sliderBarbgc:#f0f0f0; --primaryColor:#1a6aff;">
                            <div class="sliderBar" style="width: 100%;">
                                <div class="img-box">
                                    <div class="move-img" style="left: 0%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">0</span>
            </div>
                                    <div class="move-img" style="left: 25%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">25</span>
                </div>
                                    <div class="move-img" style="left: 50%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">50</span>
                    </div>
                                    <div class="move-img" style="left: 75%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">75</span>
                        </div>
                                    <div class="move-img" style="left: 100%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">100</span>
                        </div>
                    </div>
                                <div class="gone" style="width: 100%;"></div>
                                <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
                                    <span class="count">100%</span>
                </div>
                            </div>
                        </div>
                        </div>
                    </div>



                <div class="settings-row">
                    <div class="setting-label">ç»­ä¸‹å•</div>
                    <div class="setting-value">
                        <button id="continue-order-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #1a6aff, #3f87ff); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(26, 106, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> ç»­ä¸‹å•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ äº¤æ˜“å¯¹å’Œé‡‘é¢ä¿å­˜åŒºåŸŸ -->
    <div class="settings-card box hover-glow" style="margin-top: 15px;">
        <div class="settings-title">å·²ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢ <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">æ–¹ä¾¿æŸ¥çœ‹å’Œç®¡ç†</small></div>
        
        <!-- éšè—æ–‡æœ¬æ¡†ï¼Œä½†ä¿ç•™ä¾›ä»£ç ä½¿ç”¨ -->
        <textarea id="saved-pairs-amounts" style="display: none;"></textarea>
        
        <!-- æ·»åŠ æç¤ºä¿¡æ¯ -->
        <div style="margin: 5px 0 10px; padding: 8px; background-color: #e6f7ff; border-radius: 4px; border-left: 3px solid #1a6aff; color: #1a6aff;">
            <i class="fas fa-info-circle" style="margin-right: 5px;"></i> 
            <span style="font-size: 14px;">ç‚¹å‡»è®°å½•å¯ä»¥å¿«é€Ÿå¡«å……äº¤æ˜“å¯¹å’Œé‡‘é¢ï¼Œæ–¹ä¾¿å¤ç”¨å¸¸ç”¨é…ç½®</span>
        </div>
        
        <!-- æ·»åŠ å¯äº¤äº’çš„è®°å½•å®¹å™¨ -->
        <div id="saved-pairs-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 10px; padding: 4px;">
            <!-- è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
        </div>
        
        <div class="settings-row" style="display: flex; justify-content: space-between;">
            <button id="save-pair-amount-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #52c41a, #73d13d); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(82, 196, 26, 0.3); transition: all 0.3s ease; flex: 1; margin-right: 10px;">
                <i class="fas fa-save" style="margin-right: 5px;"></i> ä¿å­˜å½“å‰äº¤æ˜“å¯¹å’Œé‡‘é¢
            </button>
            <button id="clear-pairs-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #ff4d4f, #ff7875); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(255, 77, 79, 0.3); transition: all 0.3s ease; flex: 1;">
                <i class="fas fa-trash-alt" style="margin-right: 5px;"></i> æ¸…é™¤æ‰€æœ‰è®°å½•
            </button>
        </div>
    </div>
    
    <!-- æ·»åŠ ç­–ç•¥æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
    <div class="strategy-controls" style="margin-top: 15px; display: flex; flex-direction: row; justify-content: center;">
        <button class="confirm-btn hover-glow" id="toggle-strategy-btn" style="background-color: #52c41a; min-width: 120px;">è¿è¡Œ</button>
    </div>
    <div id="strategy-status" style="margin-top: 10px; text-align: center; font-size: 14px; color: #8c8c8c;"></div>
    
    <!-- æ·»åŠ è‡ªåŠ¨åˆ·æ–°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="auto-refresh-status" style="display: flex; align-items: center; justify-content: center; margin-top: 10px; font-size: 12px; color: #8c8c8c;">
        <div id="refresh-indicator" style="width: 8px; height: 8px; background-color: #52c41a; border-radius: 50%; margin-right: 5px;"></div>
        <span>è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ (10ç§’/æ¬¡)</span>
    </div>
    <div id="last-refresh-time" style="text-align: center; font-size: 12px; color: #8c8c8c; margin-top: 5px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let strategyRunning = false;
        let strategyInterval = null;
        let chichang = false;
        let autoRefreshInterval = null;
        
        // ä»localStorageè·å–ç­–ç•¥è¿è¡ŒçŠ¶æ€
        function getStrategyRunningState() {
            const savedState = localStorage.getItem('strategyRunningState');
            return savedState === 'true';
        }
        
        // ä¿å­˜ç­–ç•¥è¿è¡ŒçŠ¶æ€åˆ°localStorage
        function saveStrategyRunningState(isRunning) {
            localStorage.setItem('strategyRunningState', isRunning.toString());
            console.log(`ç­–ç•¥è¿è¡ŒçŠ¶æ€å·²ä¿å­˜: ${isRunning}`);
        }
        
        // ä¿å­˜äº¤æ˜“å¯¹å’Œé‡‘é¢åˆ°localStorage
        function savePairAndAmount() {
            const tradePair = document.getElementById('selected-crypto-pair').value;
            const tradePairDisplay = document.getElementById('selected-crypto-name').textContent;
            const amountInput = document.querySelector('.uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
            const amount = amountInput.value;
            
            if (!tradePair || !amount || isNaN(amount) || parseFloat(amount) <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                return;
            }
            
            // è·å–å·²ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢
            let savedPairsAmounts = [];
            try {
                const savedData = localStorage.getItem('savedPairsAmounts');
                if (savedData) {
                    savedPairsAmounts = JSON.parse(savedData);
                }
            } catch (e) {
                console.error('è§£æå·²ä¿å­˜çš„äº¤æ˜“å¯¹æ•°æ®å‡ºé”™:', e);
                savedPairsAmounts = [];
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥äº¤æ˜“å¯¹ï¼Œæœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ·»åŠ 
            const existingIndex = savedPairsAmounts.findIndex(item => item.pair === tradePair);
            const timestamp = new Date().toLocaleString();
            
            if (existingIndex >= 0) {
                // æ›´æ–°ç°æœ‰äº¤æ˜“å¯¹çš„é‡‘é¢
                savedPairsAmounts[existingIndex].amount = amount;
                savedPairsAmounts[existingIndex].displayName = tradePairDisplay;
                savedPairsAmounts[existingIndex].timestamp = timestamp;
            } else {
                // æ·»åŠ æ–°äº¤æ˜“å¯¹å’Œé‡‘é¢
                savedPairsAmounts.push({
                    pair: tradePair,
                    displayName: tradePairDisplay,
                    amount: amount,
                    timestamp: timestamp
                });
            }
            
            // ä¿å­˜æ›´æ–°åçš„åˆ—è¡¨
            localStorage.setItem('savedPairsAmounts', JSON.stringify(savedPairsAmounts));
            
            // æ›´æ–°æ˜¾ç¤º
            updateSavedPairsDisplay();
            
            showToast(`å·²ä¿å­˜: ${tradePairDisplay} - ${amount} USDT`);
        }
        
        // æ›´æ–°ä¿å­˜çš„äº¤æ˜“å¯¹æ˜¾ç¤º
        function updateSavedPairsDisplay() {
            const textArea = document.getElementById('saved-pairs-amounts');
            const container = document.getElementById('saved-pairs-container');
            
            try {
                const savedData = localStorage.getItem('savedPairsAmounts');
                if (savedData) {
                    const savedPairsAmounts = JSON.parse(savedData);
                    
                    if (savedPairsAmounts.length > 0) {
                        // æ’åºï¼šæœ€æ–°ä¿å­˜çš„åœ¨æœ€ä¸Šé¢
                        savedPairsAmounts.sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });
                        
                        // ç”Ÿæˆæ–‡æœ¬å†…å®¹
                        let content = '';
                        savedPairsAmounts.forEach((item, index) => {
                            content += `${index + 1}. ${item.displayName} - ${item.amount} USDT (${item.timestamp})\n`;
                        });
                        
                        textArea.value = content;
                        
                        // æ¸…é™¤å®¹å™¨å†…å®¹
                        if (container) {
                            container.innerHTML = '';
                            
                            // åˆ›å»ºå¯ç‚¹å‡»çš„è®°å½•
                            savedPairsAmounts.forEach((item, index) => {
                                const recordDiv = document.createElement('div');
                                recordDiv.className = 'saved-pair-record';
                                recordDiv.style.padding = '8px';
                                recordDiv.style.margin = '5px 0';
                                recordDiv.style.borderRadius = '4px';
                                recordDiv.style.backgroundColor = '#f0f8ff';
                                recordDiv.style.border = '1px solid #e6f7ff';
                                recordDiv.style.cursor = 'pointer';
                                recordDiv.style.transition = 'all 0.3s ease';
                                recordDiv.style.display = 'flex';
                                recordDiv.style.justifyContent = 'space-between';
                                recordDiv.style.alignItems = 'center';
                                
                                // æ‚¬åœæ•ˆæœ
                                recordDiv.addEventListener('mouseover', function() {
                                    this.style.backgroundColor = '#e6f7ff';
                                    this.style.boxShadow = '0 2px 8px rgba(24, 144, 255, 0.15)';
                                });
                                
                                recordDiv.addEventListener('mouseout', function() {
                                    this.style.backgroundColor = '#f0f8ff';
                                    this.style.boxShadow = 'none';
                                });
                                
                                // å·¦ä¾§æ˜¾ç¤ºäº¤æ˜“å¯¹å’Œé‡‘é¢
                                const infoDiv = document.createElement('div');
                                infoDiv.innerHTML = `
                                    <div style="font-weight: 500;">${item.displayName} - ${item.amount} USDT</div>
                                    <div style="font-size: 12px; color: #8c8c8c;">${item.timestamp}</div>
                                `;
                                
                                // å³ä¾§æ˜¾ç¤ºæŒ‰é’®
                                const buttonsDiv = document.createElement('div');
                                buttonsDiv.style.display = 'flex';
                                buttonsDiv.style.gap = '8px';
                                
                                // åº”ç”¨æŒ‰é’®
                                const applyButton = document.createElement('button');
                                applyButton.className = 'confirm-btn hover-glow';
                                applyButton.style.padding = '4px 8px';
                                applyButton.style.backgroundColor = '#1a6aff';
                                applyButton.style.color = 'white';
                                applyButton.style.border = 'none';
                                applyButton.style.borderRadius = '4px';
                                applyButton.style.fontSize = '12px';
                                applyButton.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 4px;"></i>åº”ç”¨';
                                
                                // åˆ é™¤æŒ‰é’®
                                const deleteButton = document.createElement('button');
                                deleteButton.className = 'confirm-btn hover-glow';
                                deleteButton.style.padding = '4px 8px';
                                deleteButton.style.backgroundColor = '#ff4d4f';
                                deleteButton.style.color = 'white';
                                deleteButton.style.border = 'none';
                                deleteButton.style.borderRadius = '4px';
                                deleteButton.style.fontSize = '12px';
                                deleteButton.innerHTML = '<i class="fas fa-trash" style="margin-right: 4px;"></i>åˆ é™¤';
                                
                                // åº”ç”¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                                applyButton.addEventListener('click', function(e) {
                                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                                    applyPairAmount(item.pair, item.displayName, item.amount);
                                });
                                
                                // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                                deleteButton.addEventListener('click', function(e) {
                                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                                    deleteSavedPair(item.pair);
                                });
                                
                                // æ•´ä¸ªè®°å½•çš„ç‚¹å‡»äº‹ä»¶
                                recordDiv.addEventListener('click', function() {
                                    applyPairAmount(item.pair, item.displayName, item.amount);
                                });
                                
                                buttonsDiv.appendChild(applyButton);
                                buttonsDiv.appendChild(deleteButton);
                                
                                recordDiv.appendChild(infoDiv);
                                recordDiv.appendChild(buttonsDiv);
                                
                                container.appendChild(recordDiv);
                            });
                        }
                    } else {
                        textArea.value = 'æš‚æ— ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢';
                        if (container) {
                            container.innerHTML = '<div style="padding: 15px; text-align: center; color: #8c8c8c;">æš‚æ— ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢</div>';
                        }
                    }
                } else {
                    textArea.value = 'æš‚æ— ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢';
                    if (container) {
                        container.innerHTML = '<div style="padding: 15px; text-align: center; color: #8c8c8c;">æš‚æ— ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢</div>';
                    }
                }
            } catch (e) {
                console.error('æ›´æ–°äº¤æ˜“å¯¹æ˜¾ç¤ºå‡ºé”™:', e);
                textArea.value = 'åŠ è½½å·²ä¿å­˜çš„äº¤æ˜“å¯¹å‡ºé”™';
                if (container) {
                    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #ff4d4f;">åŠ è½½å·²ä¿å­˜çš„äº¤æ˜“å¯¹å‡ºé”™</div>';
                }
            }
        }
        
        // åº”ç”¨ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢
        function applyPairAmount(pair, displayName, amount) {
            // è®¾ç½®äº¤æ˜“å¯¹
            document.getElementById('selected-crypto-pair').value = pair;
            document.getElementById('selected-crypto-name').textContent = displayName;
            
            // è®¾ç½®å›¾æ ‡
            const symbol = pair.split('-')[0];
            document.getElementById('selected-crypto-icon').src = `https://ai.hkd.red/symbolImage/${symbol}.png`;
            
            // è®¾ç½®é‡‘é¢
            const amountInput = document.querySelector('.uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
            if (amountInput) {
                amountInput.value = amount;
            }
            
            showToast(`å·²åº”ç”¨: ${displayName} - ${amount} USDT`);
        }
        
        // åˆ é™¤å•ä¸ªä¿å­˜çš„äº¤æ˜“å¯¹
        function deleteSavedPair(pair) {
            try {
                const savedData = localStorage.getItem('savedPairsAmounts');
                if (savedData) {
                    let savedPairsAmounts = JSON.parse(savedData);
                    
                    // æ‰¾åˆ°å¹¶åˆ é™¤ç‰¹å®šäº¤æ˜“å¯¹
                    const index = savedPairsAmounts.findIndex(item => item.pair === pair);
                    if (index >= 0) {
                        const deletedPair = savedPairsAmounts[index];
                        savedPairsAmounts.splice(index, 1);
                        
                        // ä¿å­˜æ›´æ–°åçš„åˆ—è¡¨
                        localStorage.setItem('savedPairsAmounts', JSON.stringify(savedPairsAmounts));
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateSavedPairsDisplay();
                        
                        showToast(`å·²åˆ é™¤: ${deletedPair.displayName}`);
                    }
                }
            } catch (e) {
                console.error('åˆ é™¤äº¤æ˜“å¯¹å‡ºé”™:', e);
                showToast('åˆ é™¤äº¤æ˜“å¯¹å¤±è´¥');
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢
        function clearAllSavedPairs() {
            localStorage.removeItem('savedPairsAmounts');
            document.getElementById('saved-pairs-amounts').value = 'æš‚æ— ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢';
            showToast('å·²æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é¡µé¢
            initSettingsPage();
            
            // ä»localStorageè·å–å·²ä¿å­˜çš„ç­–ç•¥è¿è¡ŒçŠ¶æ€
            strategyRunning = getStrategyRunningState();
            console.log(`é¡µé¢åŠ è½½ï¼Œä»localStorageè¯»å–ç­–ç•¥è¿è¡ŒçŠ¶æ€: ${strategyRunning}`);
            
            // æ·»åŠ é¡µé¢åŠ è½½åŠ¨ç”»
            document.body.classList.add('page-loaded');
            
            // åˆå§‹åŒ–å¸ç§é€‰æ‹©åŠŸèƒ½
            initCryptoSelector();
            
            // åˆ›å»ºä¸€ä¸ªéšè—çš„ä¿å­˜æŒ‰é’®ï¼Œä¿æŒåŠŸèƒ½ä½†ä¸æ˜¾ç¤º
            const hiddenSaveBtn = document.createElement('button');
            hiddenSaveBtn.id = 'save-strategy-btn';
            hiddenSaveBtn.style.display = 'none';
            document.querySelector('.strategy-controls').appendChild(hiddenSaveBtn);
            
            // ä¸ºä¿å­˜æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('save-strategy-btn').addEventListener('click', function() {
                // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ï¼Œä¼ é€’trueè¡¨ç¤ºå…è®¸ä¸‹å•
                saveStrategySettings(true);
            });
            
            // ç«‹å³æ£€æŸ¥æŒä»“çŠ¶æ€ï¼Œä¼˜å…ˆå¤„ç†buy_flag
            checkInitialPositionStatus();
            
            // åˆå§‹åŒ–ç­–ç•¥çŠ¶æ€æŒ‡ç¤ºå™¨çš„åŠ¨ç”»
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes blink {
                    0% { opacity: 0.3; }
                    50% { opacity: 1; }
                    100% { opacity: 0.3; }
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // è·å–åˆ·æ–°æŒ‡ç¤ºç¯å…ƒç´ 
            const refreshIndicator = document.getElementById('refresh-indicator');
            // æ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ - å³ä½¿æ²¡æœ‰ç‚¹å‡»è¿è¡ŒæŒ‰é’®ä¹Ÿä¼šè‡ªåŠ¨åˆ·æ–°
            const autoRefreshInterval = setInterval(function() {
                console.log("è‡ªåŠ¨åˆ·æ–°æ£€æŸ¥æŒä»“çŠ¶æ€...");
                
                // æ¯æ¬¡åˆ·æ–°å‰ï¼Œæ›´æ–°æŒ‡ç¤ºç¯é¢œè‰²ä¸ºé»„è‰²ï¼Œè¡¨ç¤ºæ­£åœ¨åˆ·æ–°
                if (refreshIndicator) {
                    refreshIndicator.style.backgroundColor = '#faad14';
                }
                
                // æ£€æŸ¥çŠ¶æ€ï¼Œä¼ å…¥falseå‚æ•°è¡¨ç¤ºåªæ£€æŸ¥çŠ¶æ€ï¼Œä¸è§¦å‘ä¸‹å•
                checkPositionStatus(false);
                
                // åˆ·æ–°å®Œæˆåï¼Œå»¶è¿Ÿå°†é¢œè‰²æ”¹å›ç»¿è‰²
                setTimeout(function() {
                    if (refreshIndicator) {
                        refreshIndicator.style.backgroundColor = '#52c41a';
                    }
                }, 1000);
            }, 10000); // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
            
            // å°†è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ä¿å­˜åˆ°windowå¯¹è±¡ï¼Œä»¥ä¾¿å¯ä»¥åœ¨éœ€è¦æ—¶åœæ­¢
            window.autoRefreshInterval = autoRefreshInterval;
            
            // å½“é¡µé¢å…³é—­æˆ–åˆ·æ–°æ—¶ï¼Œæ¸…é™¤å®šæ—¶å™¨
            window.addEventListener('beforeunload', function() {
                clearAllIntervals();
                console.log('é¡µé¢å¸è½½ï¼Œå·²æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨');
            });
            
            // åˆå§‹åŒ–ç­–ç•¥åˆ‡æ¢æŒ‰é’®
            document.getElementById('toggle-strategy-btn').addEventListener('click', function() {
                if (strategyRunning) {
                    // å¦‚æœç­–ç•¥æ­£åœ¨è¿è¡Œï¼Œåˆ™åœæ­¢
                    clearAllIntervals(); // ä½¿ç”¨æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨çš„å‡½æ•°
                    strategyRunning = false;
                    
                    // ä¿å­˜åœæ­¢çŠ¶æ€åˆ°localStorage
                    saveStrategyRunningState(false);
                    
                    const statusElement = document.getElementById('strategy-status');
                    statusElement.textContent = 'ç­–ç•¥å·²åœæ­¢';
                    statusElement.style.color = '#8c8c8c';
                    
                    // ç§»é™¤å¾ªç¯çŠ¶æ€æŒ‡ç¤ºå™¨
                    const loopIndicator = document.getElementById('loop-status-indicator');
                    if (loopIndicator) {
                        loopIndicator.remove();
                    }
                    
                    // æ˜¾ç¤ºé€šçŸ¥
                    showToast('ç­–ç•¥å·²ç«‹å³åœæ­¢');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸º"è¿è¡Œ"
                    this.textContent = 'è¿è¡Œ';
                    this.style.backgroundColor = '#52c41a';
                    this.disabled = false;
                    
                    console.log('å·²åœæ­¢æ‰€æœ‰ç­–ç•¥å®šæ—¶å™¨');
                } else {
                    // å¦‚æœç­–ç•¥æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨
                    // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
                    if (strategyInterval) {
                        clearInterval(strategyInterval);
                        strategyInterval = null;
                    }
                    
                    // å°†ç­–ç•¥çŠ¶æ€è®¾ç½®ä¸ºè¿è¡Œä¸­
                    strategyRunning = true;
                    
                    // ä¿å­˜è¿è¡ŒçŠ¶æ€åˆ°localStorage
                    saveStrategyRunningState(true);
                    
                    // æ˜¾ç¤ºæ­£åœ¨è¿è¡ŒçŠ¶æ€
                    const statusElement = document.getElementById('strategy-status');
                    statusElement.textContent = 'ç­–ç•¥æ­£åœ¨è¿è¡Œä¸­...';
                    statusElement.style.color = '#1a6aff';
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸º"åœæ­¢ç­–ç•¥"
                    this.textContent = 'åœæ­¢ç­–ç•¥';
                    this.style.backgroundColor = '#ff4d4f';
                    
                    // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æŒä»“çŠ¶æ€
                    checkPositionStatus(true);
                    
                    // å¯åŠ¨ç­–ç•¥å®šæ—¶å™¨ï¼Œæ¯15ç§’æ£€æŸ¥ä¸€æ¬¡æŒä»“çŠ¶æ€å¹¶è€ƒè™‘ä¸‹å•
                    strategyInterval = setInterval(function() {
                        // ç¡®ä¿ç­–ç•¥ä»åœ¨è¿è¡Œä¸­
                        if (!strategyRunning) {
                            clearInterval(strategyInterval);
                            return;
                        }
                        
                        // ä¼ é€’trueå‚æ•°ï¼Œè¡¨ç¤ºå¯ä»¥è§¦å‘ä¸‹å•æ“ä½œ
                        checkPositionStatus(true);
                        
                        // å¦‚æœæ²¡æœ‰æŒä»“ï¼Œå¯ä»¥å°è¯•ä¸‹å•
                        if (!chichang) {
                            // æ¨¡æ‹Ÿç‚¹å‡»ä¿å­˜æŒ‰é’®ï¼Œè§¦å‘ä¸‹å•é€»è¾‘
                            saveStrategySettings(true);
                        }
                    }, 15000); // 15ç§’æ£€æŸ¥ä¸€æ¬¡
                    
                    // ä¿å­˜å®šæ—¶å™¨å¼•ç”¨åˆ°å…¨å±€å˜é‡
                    window.strategyInterval = strategyInterval;
                }
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€æ˜¾ç¤º
                updateButtonStatus(chichang, strategyRunning);
            });
            
            // ä¸ºç»­ä¸‹å•æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('continue-order-btn').addEventListener('click', function() {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹å•ä¸­...';
                this.disabled = true;
                
                // è°ƒç”¨ä¸‹å•åŠŸèƒ½
                saveStrategySettings(true);
                
                // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 5px;"></i> ç»­ä¸‹å•';
                    this.disabled = false;
                }, 3000);
            });

            // åˆå§‹åŒ–äº¤æ˜“å¯¹å’Œé‡‘é¢ä¿å­˜åŠŸèƒ½
            document.getElementById('save-pair-amount-btn').addEventListener('click', function() {
                savePairAndAmount();
                // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                this.classList.add('btn-clicked');
                setTimeout(() => {
                    this.classList.remove('btn-clicked');
                }, 300);
            });
            
            document.getElementById('clear-pairs-btn').addEventListener('click', function() {
                // ç¡®è®¤æ˜¯å¦æ¸…é™¤
                showConfirmDialog(
                    'ç¡®è®¤æ¸…é™¤',
                    'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„äº¤æ˜“å¯¹å’Œé‡‘é¢è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
                    'ç¡®å®šæ¸…é™¤',
                    'å–æ¶ˆ',
                    function() {
                        clearAllSavedPairs();
                    },
                    function() {
                        // å–æ¶ˆæ“ä½œ
                    }
                );
                
                // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                this.classList.add('btn-clicked');
                setTimeout(() => {
                    this.classList.remove('btn-clicked');
                }, 300);
            });
            
            // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ˜¾ç¤º
            updateSavedPairsDisplay();
        });
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æŒä»“çŠ¶æ€å¹¶æ›´æ–°æŒ‰é’®
        function checkPositionStatusOnLoad() {
            // è·å–å½“å‰URLä¸­çš„ç­–ç•¥IDå’Œäº¤æ˜“å¯¹
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // è·å–äº¤æ˜“å¯¹ï¼ˆæ ¹æ®ç­–ç•¥IDè®¾ç½®ä¸åŒçš„é»˜è®¤äº¤æ˜“å¯¹ï¼‰
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // è·å–é€‰ä¸­çš„äº¤æ˜“æ–¹å‘
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // é»˜è®¤åšå¤š
            
            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                }
            });
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = 'æ­£åœ¨æ£€æŸ¥æŒä»“çŠ¶æ€...';
            
            // å‘åç«¯å‘é€è¯·æ±‚è·å–æŒä»“çŠ¶æ€
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // æ›´æ–°æŒä»“çŠ¶æ€
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // è®°å½•çŠ¶æ€
                    console.log(`[ç­–ç•¥çŠ¶æ€ç»“æœ] å¤šå¤´æŒä»“: ${hasBuyPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}, ç©ºå¤´æŒä»“: ${hasSellPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`);
                    
                    // æ›´æ–°ç­–ç•¥è¿è¡ŒçŠ¶æ€æŒ‡ç¤ºå™¨
                    const statusIndicator = document.getElementById('key-status-indicator');
                            const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // å¦‚æœæœ‰æŒä»“ï¼Œæ›´æ–°ç»­ä¸‹å•æŒ‰é’®æ ·å¼
                    if (chichang) {
                        continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> å·²æŒä»“';
                        continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                        continueOrderBtn.classList.add('position-active');
                        continueOrderBtn.disabled = true;
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•æ­£åœ¨æ‰§è¡Œ
                        if (data.hasOrder) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                            continueOrderBtn.disabled = true;
                        } else {
                            continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> ç»­ä¸‹å•';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                            continueOrderBtn.classList.remove('position-active');
                            continueOrderBtn.disabled = false;
                        }
                    }
                    
                    // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
                    statusIndicator.style.display = 'block';
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œå›¾æ ‡
                    if (chichang) {
                        statusText.innerHTML = `å¤šå¤´æŒä»“: ${hasBuyPosition ? '<span style="color:#52c41a">æ¿€æ´»</span>' : '<span style="color:#bfbfbf">æœªæ¿€æ´»</span>'}, ç©ºå¤´æŒä»“: ${hasSellPosition ? '<span style="color:#52c41a">æ¿€æ´»</span>' : '<span style="color:#bfbfbf">æœªæ¿€æ´»</span>'}`;
                        statusIcon.innerHTML = 'ğŸ”„';
                        statusIcon.style.animation = 'spin 5s linear infinite';
                        statusIndicator.style.backgroundColor = '#e6f7ff';
                        statusIndicator.style.borderColor = '#91d5ff';
                    } else if (data.hasOrder) {
                        statusText.innerHTML = 'æœ‰è®¢å•æ­£åœ¨å¤„ç†ä¸­';
                        statusIcon.innerHTML = 'â³';
                        statusIcon.style.animation = 'blink 1.5s ease infinite';
                        statusIndicator.style.backgroundColor = '#fffbe6';
                        statusIndicator.style.borderColor = '#ffe58f';
                    } else {
                        statusText.innerHTML = 'å½“å‰æ— æŒä»“ï¼Œå¯ä»¥ä¸‹å•';
                        statusIcon.innerHTML = 'âœ…';
                        statusIcon.style.animation = 'none';
                        statusIndicator.style.backgroundColor = '#f6ffed';
                        statusIndicator.style.borderColor = '#b7eb8f';
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateButtonStatus(chichang, strategyRunning);
                    
                    } else {
                    console.error('æ£€æŸ¥æŒä»“çŠ¶æ€å¤±è´¥:', data.message);
                    showToast(`æ£€æŸ¥æŒä»“çŠ¶æ€å¤±è´¥: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å‡ºé”™:', error);
                showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            });
        }
        
        // ä¿å­˜ç­–ç•¥è®¾ç½®å‡½æ•°
        function saveStrategySettings(shouldManuallyOrder = true) {
            // è·å–å½“å‰URLä¸­çš„ç­–ç•¥ID
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // æ£€æŸ¥æ˜¯å¦å…è®¸ä¸‹å• - åªæœ‰å½“shouldManuallyOrderä¸ºtrueæˆ–è€…strategyRunningä¸ºtrueæ—¶æ‰å…è®¸ä¸‹å•
            const shouldProceed = shouldManuallyOrder || strategyRunning;
            
            // å¦‚æœä¸å…è®¸ä¸‹å•ï¼Œåˆ™è®°å½•æ—¥å¿—å¹¶ç›´æ¥è¿”å›
            if (!shouldProceed) {
                console.log("è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€ï¼Œè·³è¿‡ä¸‹å•æ“ä½œ");
                return;
            }
            
            // è·å–ä¿è¯é‡‘è¾“å…¥å€¼
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
            const marginValue = marginInput.value || '0';
            
            // è·å–é€‰ä¸­çš„äº¤æ˜“æ–¹å‘
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // é»˜è®¤åšå¤š

            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                }
            });
            
            // è·å–äº¤æ˜“å¯¹ - ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„äº¤æ˜“å¯¹ï¼Œè€Œä¸æ˜¯é»˜è®¤å€¼
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // åœ¨æŒ‰é’®ä¸Šæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const saveBtn = document.getElementById('save-strategy-btn');
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = 'å¤„ç†ä¸­...';
            saveBtn.disabled = true;
            
            // å‘é€AJAXè¯·æ±‚
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection,
                    leverage: parseInt(document.getElementById('leverage-value').value || '10') // æ·»åŠ æ æ†å€æ•°
                }),
            })
            .then(response => response.json())
            .then(data => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                
                if (data.code === 200) {
                    // æ£€æŸ¥æŒä»“çŠ¶æ€ï¼Œåªæœ‰åœ¨æœ‰è®¢å•ç»“æœä¸”æ²¡æœ‰å·²å­˜åœ¨çš„ç›¸åŒæ–¹å‘çš„æŒä»“æ—¶æ‰æ˜¾ç¤º"å·²ä¸‹å•"
                    if (data.orderResult) {
                        // è·å–å½“å‰äº¤æ˜“æ–¹å‘
                        const dirElements = document.querySelectorAll('.type-box .type-li');
                        let currentDirection = 'buy'; // é»˜è®¤æ–¹å‘
                        dirElements.forEach(function(el) {
                            if (el.classList.contains('type-active')) {
                                currentDirection = el.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                            }
                        });
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸åŒæ–¹å‘çš„æŒä»“
                        const hasSameDirectionPosition = 
                            (currentDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                            (currentDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                        
                        if (hasSameDirectionPosition) {
                            // å·²æœ‰ç›¸åŒæ–¹å‘æŒä»“ï¼Œæ˜¾ç¤ºä¸º"å·²æŒä»“ä¸­"
                            saveBtn.textContent = 'å·²æŒä»“ä¸­';
                            saveBtn.classList.add('position-active');
                        } else {
                            // æ— ç›¸åŒæ–¹å‘æŒä»“ï¼Œæ˜¾ç¤ºä¸º"å·²ä¸‹å•ï¼Œæ‰§è¡Œä¸­"
                            saveBtn.textContent = 'å·²ä¸‹å•ï¼Œæ‰§è¡Œä¸­';
                            saveBtn.classList.add('order-success');
                        }
                        
                        showToast(`ç­–ç•¥ä¿å­˜æˆåŠŸ! åˆçº¦å¼ æ•°: ${data.contractSize}`);
                        showOrderResultModal(data.orderResult, tradePair);
                    } else {
                        // æ²¡æœ‰ä¸‹å•ï¼Œä»…ä¿å­˜è®¾ç½®
                        saveBtn.textContent = 'ä¿å­˜è®¾ç½®';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        showToast('è®¾ç½®å·²æˆåŠŸä¿å­˜');
                    }
                } else if (data.code === 503 || data.code === 504) {
                    // ç½‘ç»œé”™è¯¯å¤„ç†
                    showNetworkErrorModal(data.message);
                } else {
                    // å¤„ç†é”™è¯¯ï¼Œä¿æŒåŸæœ‰æŒ‰é’®æ–‡æœ¬
                    saveBtn.textContent = originalBtnText;
                    saveBtn.classList.remove('order-success');
                    saveBtn.classList.remove('position-active');
                    showNetworkErrorModal(data.message || 'ä¿å­˜ç­–ç•¥å‡ºé”™ï¼Œè¯·ç¨åå†è¯•');
                }
            })
            .catch(error => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.disabled = false;
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                console.error('è¯·æ±‚é”™è¯¯:', error);
                showNetworkErrorModal('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        function initSettingsPage() {
            console.log('ç­–ç•¥è®¾ç½®é¡µé¢åˆå§‹åŒ–');
            
            // è°ƒæ•´é¡µé¢æ ‡é¢˜ç­–ç•¥åç§°æ˜¾ç¤º
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            let strategyName = 'æ™ºèƒ½ç½‘æ ¼ç­–ç•¥'; // é»˜è®¤
            
            // æ ¹æ®IDè®¾ç½®ä¸åŒçš„ç­–ç•¥åç§°
            if (strategyId === '1') {
                strategyName = 'æ™ºèƒ½ç½‘æ ¼ç­–ç•¥';
            } else if (strategyId === '2') {
                strategyName = 'è¶‹åŠ¿è·Ÿè¸ªç­–ç•¥';
            } else if (strategyId === '3') {
                strategyName = 'AIæ™ºèƒ½é¢„æµ‹ç­–ç•¥';
            } else if (strategyId === '4') {
                strategyName = 'è“é¾™ç»¼åˆç­–ç•¥';
            } else if (strategyId === '5') {
                strategyName = 'è“é¾™å‡ºæµ·';
            } else if (strategyId === '6') {
                strategyName = 'ç½‘æ ¼é‡åŒ–';
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const titleElement = document.querySelector('.u-navbar__content__title');
            titleElement.textContent = strategyName;
            
            // æ ‡é¢˜åŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
                document.querySelector('.u-navbar').style.transform = 'translateY(0)';
            }, 100);
            
            // ä¸ºäº¤æ˜“æ–¹å‘é€‰æ‹©å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const directionButtons = document.querySelectorAll('.type-box .type-li');
            directionButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
                    directionButtons.forEach(btn => btn.classList.remove('type-active'));
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
                    this.classList.add('type-active');
                    
                    // æ˜¾ç¤ºåé¦ˆ
                    const direction = this.textContent.trim();
                    showToast(`å·²é€‰æ‹©${direction}æ–¹å‘`);
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    checkPositionStatusOnLoad();
                });
            });
            
            // è®¾ç½®çŠ¶æ€å¼€å…³ç‚¹å‡»äº‹ä»¶ - æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const statusToggle = document.querySelector('.toggle-wrapper');
            if (statusToggle) {
                statusToggle.addEventListener('click', function() {
                    this.classList.toggle('active-lis');
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (this.classList.contains('active-lis')) {
                        indicator.style.transform = 'translateX(28px)';
                        showToast('ç­–ç•¥å·²å¯åŠ¨');
                    } else {
                        indicator.style.transform = 'translateX(0px)';
                        showToast('ç­–ç•¥å·²æš‚åœ');
                    }
                });
            }
            
            // è®¾ç½®é¢„è®¾ç­–ç•¥ç‚¹å‡»äº‹ä»¶
            const strategyTypes = document.querySelectorAll('.scroll-li-types');
            strategyTypes.forEach(type => {
                type.addEventListener('click', function() {
                    // å…ˆç§»é™¤æ‰€æœ‰activeç±»
                    strategyTypes.forEach(t => {
                        t.classList.remove('type-actives');
                        // æ·»åŠ æ·¡å‡ºæ•ˆæœ
                        t.style.opacity = '0.7';
                    });
                    
                    // ç»™å½“å‰ç‚¹å‡»å…ƒç´ æ·»åŠ activeç±»
                    this.classList.add('type-actives');
                    this.style.opacity = '1';
                    
                    // æ˜¾ç¤ºé€‰æ‹©äº†ä»€ä¹ˆç­–ç•¥
                    const strategyType = this.querySelector('.li-type-center').textContent;
                    showToast(`å·²é€‰æ‹©${strategyType}ç­–ç•¥`);
                    
                    // æ¢å¤å…¶ä»–å…ƒç´ çš„é€æ˜åº¦
                    setTimeout(() => {
                        strategyTypes.forEach(t => {
                            t.style.opacity = '1';
                        });
                    }, 300);
                });
            });
            
            // æ·»åŠ åšå¤šåšç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const typeLiButtons = document.querySelectorAll('.type-box .type-li');
            typeLiButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    typeLiButtons.forEach(btn => {
                        btn.classList.remove('type-active');
                    });
                    
                    // ç»™å½“å‰ç‚¹å‡»æŒ‰é’®æ·»åŠ activeç±»
                    this.classList.add('type-active');
                    
                    // æ˜¾ç¤ºæ¶ˆæ¯
                    showToast(`å·²é€‰æ‹©${this.textContent}ç­–ç•¥`);
                });
            });
            
            // æ·»åŠ æ æ†è°ƒæ•´ç‚¹å‡»äº‹ä»¶
            const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="é€‰æ‹©æ æ†å€æ•°"]');
            const leverageContainer = leverageInput.closest('.form-item-input');
            leverageContainer.addEventListener('click', function() {
                // æ¨¡æ‹Ÿæ æ†å€æ•°é€‰æ‹©å¼¹çª—
                const leverageOptions = [1, 2, 3, 5, 10, 20, 50, 100];
                let selectedLeverage = 10; // é»˜è®¤é€‰æ‹©
                
                // åˆ›å»ºæ æ†é€‰æ‹©å¯¹è¯æ¡†
                const createLeverageDialog = () => {
                    // å¦‚æœé¡µé¢ä¸Šå·²æœ‰å¯¹è¯æ¡†ï¼Œå…ˆç§»é™¤
                    const existingDialog = document.querySelector('.leverage-dialog');
                    if (existingDialog) {
                        existingDialog.remove();
                    }
                    
                    // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
                    const dialog = document.createElement('div');
                    dialog.className = 'leverage-dialog';
                    dialog.style.position = 'fixed';
                    dialog.style.top = '50%';
                    dialog.style.left = '50%';
                    dialog.style.transform = 'translate(-50%, -50%)';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '320px';
                    dialog.style.backgroundColor = '#fff';
                    dialog.style.borderRadius = '12px';
                    dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
                    dialog.style.zIndex = '9999';
                    dialog.style.overflow = 'hidden';
                    
                    // åˆ›å»ºå¯¹è¯æ¡†æ ‡é¢˜
                    const dialogTitle = document.createElement('div');
                    dialogTitle.textContent = 'é€‰æ‹©æ æ†å€æ•°';
                    dialogTitle.style.padding = '16px';
                    dialogTitle.style.borderBottom = '1px solid #f0f0f0';
                    dialogTitle.style.fontSize = '16px';
                    dialogTitle.style.fontWeight = '600';
                    dialogTitle.style.textAlign = 'center';
                    dialogTitle.style.color = '#262626';
                    dialog.appendChild(dialogTitle);
                    
                    // åˆ›å»ºé€‰é¡¹å®¹å™¨
                    const optionsContainer = document.createElement('div');
                    optionsContainer.style.padding = '10px 0';
                    optionsContainer.style.maxHeight = '300px';
                    optionsContainer.style.overflowY = 'auto';
                    dialog.appendChild(optionsContainer);
                    
                    // æ·»åŠ æ æ†é€‰é¡¹
                    leverageOptions.forEach(leverage => {
                        const option = document.createElement('div');
                        option.className = 'leverage-option';
                        option.textContent = `${leverage}X`;
                        option.style.padding = '12px 16px';
                        option.style.transition = 'all 0.2s ease';
                        option.style.cursor = 'pointer';
                        option.style.fontSize = '15px';
                        
                        // é«˜äº®å½“å‰é€‰ä¸­çš„é€‰é¡¹
                        if (leverage === selectedLeverage) {
                            option.style.color = '#1a6aff';
                            option.style.fontWeight = '600';
                            option.style.backgroundColor = '#f0f7ff';
                        }
                        
                        option.addEventListener('mouseenter', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = '#f9fafc';
                            }
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = 'transparent';
                            }
                        });
                        
                        option.addEventListener('click', function() {
                            selectedLeverage = leverage;
                            leverageInput.value = `${leverage}X`;
                            
                            // æ›´æ–°é¡µé¢ä¸Šçš„ä¿è¯é‡‘å€¼
                            updateMarginFromLeverage(leverage);
                            
                            dialog.remove();
                            
                            // æ˜¾ç¤ºæ æ†è®¾ç½®æ¶ˆæ¯
                            showToast(`å·²è®¾ç½®æ æ†å€æ•°: ${leverage}X`);
                            
                            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                            leverageContainer.classList.add('row-clicked');
                            setTimeout(() => {
                                leverageContainer.classList.remove('row-clicked');
                            }, 300);
                        });
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // åˆ›å»ºå–æ¶ˆæŒ‰é’®
                    const cancelButton = document.createElement('div');
                    cancelButton.textContent = 'å–æ¶ˆ';
                    cancelButton.style.padding = '14px';
                    cancelButton.style.borderTop = '1px solid #f0f0f0';
                    cancelButton.style.textAlign = 'center';
                    cancelButton.style.color = '#8c8c8c';
                    cancelButton.style.fontSize = '15px';
                    cancelButton.style.cursor = 'pointer';
                    cancelButton.style.transition = 'all 0.2s ease';
                    
                    cancelButton.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f9fafc';
                    });
                    
                    cancelButton.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    cancelButton.addEventListener('click', function() {
                        dialog.remove();
                    });
                    
                    dialog.appendChild(cancelButton);
                    
                    // åˆ›å»ºé®ç½©å±‚
                    const overlay = document.createElement('div');
                    overlay.className = 'leverage-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '9998';
                    
                    overlay.addEventListener('click', function() {
                        dialog.remove();
                        overlay.remove();
                    });
                    
                    // å°†å¯¹è¯æ¡†å’Œé®ç½©æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(overlay);
                    document.body.appendChild(dialog);
                    
                    // æ·»åŠ åŠ¨ç”»
                    dialog.style.opacity = '0';
                    dialog.style.transform = 'translate(-50%, -60%)';
                    dialog.style.transition = 'all 0.3s ease';
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        dialog.style.opacity = '1';
                        dialog.style.transform = 'translate(-50%, -50%)';
                        overlay.style.opacity = '1';
                    }, 10);
                };
                
                // æ˜¾ç¤ºæ æ†é€‰æ‹©å¯¹è¯æ¡†
                createLeverageDialog();
            });
            
            // è®¾ç½®å¸ç§é€‰æ‹©ç‚¹å‡»äº‹ä»¶
            document.querySelector('.robot-info').parentElement.addEventListener('click', function() {
                showToast('å¸ç§é€‰æ‹©åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
            });
            
            // è®¾ç½®è®¾ç½®é¡¹ç‚¹å‡»äº‹ä»¶
            const settingItems = document.querySelectorAll('.setting-value .arrow-right');
            settingItems.forEach(item => {
                item.parentElement.parentElement.addEventListener('click', function() {
                    const settingName = this.querySelector('.setting-label').textContent;
                    showToast(`${settingName}è®¾ç½®é¡µé¢æ­£åœ¨å¼€å‘ä¸­...`);
                    
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                    this.classList.add('row-clicked');
                    setTimeout(() => {
                        this.classList.remove('row-clicked');
                    }, 300);
                });
            });
            
            // è®¾ç½®ä¿å­˜æŒ‰é’®äº‹ä»¶
            const saveButton = document.querySelector('.confirm-btn');
            saveButton.addEventListener('click', function() {
                // æ·»åŠ æŒ‰é’®åŠ¨ç”»
                this.classList.add('btn-clicked');
                
                // è·å–ä¿è¯é‡‘å€¼å’Œäº¤æ˜“å¯¹ä¿¡æ¯
                const marginInput = document.querySelector('.uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
                const marginValue = marginInput.value;
                
                // è·å–URLä¸­çš„ç­–ç•¥ID
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('id') || '1';
                
                // ä»éšè—å­—æ®µè·å–ç”¨æˆ·é€‰æ‹©çš„äº¤æ˜“å¯¹
                const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
                
                // è·å–äº¤æ˜“æ–¹å‘ï¼ˆåšå¤š/åšç©ºï¼‰
                const dirElements = document.querySelectorAll('.type-box .type-li');
                let tradeDirection = 'buy'; // é»˜è®¤åšå¤š
                dirElements.forEach(function(el) {
                    if (el.classList.contains('type-active')) {
                        tradeDirection = el.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                    }
                });
                
                // å‘é€AJAXè¯·æ±‚åˆ°åç«¯
                fetch('/api/strategy/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategyId: strategyId,
                        marginValue: marginValue,
                        tradePair: tradePair,
                        tradeDirection: tradeDirection,
                        leverage: parseInt(document.getElementById('leverage-value').value || '10') // æ·»åŠ æ æ†å€æ•°
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // ä»…ä¿å­˜è®¾ç½®æˆåŠŸçš„é»˜è®¤æ¶ˆæ¯
                        showToast('è®¾ç½®å·²æˆåŠŸä¿å­˜');
                        
                        // æ˜¾ç¤ºåç«¯è¿”å›çš„åˆçº¦å¼ æ•°
                        if (data.contractSize) {
                            showToast(`ç›¸å½“äº ${data.contractSize} å¼ åˆçº¦`);
                        }
                        
                        // æ˜¾ç¤ºè®¢å•ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
                        if (data.orderResult) {
                            // åˆ›å»ºè®¢å•ç»“æœå¼¹çª—
                            showOrderResultModal(data.orderResult, tradePair);
                            
                            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç›¸åŒæ–¹å‘çš„æŒä»“
                            const hasSameDirectionPosition = 
                                (tradeDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                                (tradeDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                            
                            if (hasSameDirectionPosition) {
                                // å·²æœ‰ç›¸åŒæ–¹å‘æŒä»“ï¼Œæ˜¾ç¤ºä¸º"å·²æŒä»“ä¸­"
                                this.textContent = 'å·²æŒä»“ä¸­';
                                this.classList.add('position-active');
                            } else {
                                // æ— ç›¸åŒæ–¹å‘æŒä»“ï¼Œæ˜¾ç¤ºä¸º"å·²ä¸‹å•ï¼Œæ‰§è¡Œä¸­"
                                this.textContent = 'å·²ä¸‹å•ï¼Œæ‰§è¡Œä¸­';
                                this.classList.add('order-success');
                            }
                        } else {
                            // æ— è®¢å•ï¼Œä¿æŒ"ä¿å­˜è®¾ç½®"çŠ¶æ€
                            this.textContent = 'ä¿å­˜è®¾ç½®';
                            this.classList.remove('order-success');
                            this.classList.remove('position-active');
                        }
                    } else if (data.code === 503 || data.code === 504) {
                        // ç½‘ç»œé”™è¯¯å¤„ç†
                        showNetworkErrorModal(data.message);
                    } else {
                        showToast('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                    this.classList.remove('btn-clicked');
                })
                .catch(error => {
                    console.error('Error:', error);
                    // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é—®é¢˜
                    showNetworkErrorModal('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•');
                    this.classList.remove('btn-clicked');
                });
            });
            
            // åˆå§‹åŒ–ä»“ä½æ»‘åŠ¨æ¡
            initPositionSlider();
            
            // åˆå§‹åŒ–ç™¾åˆ†æ¯”æ§åˆ¶æ»‘åŠ¨æ¡
            initPositionPercentSlider();
            
            // æ·»åŠ é¡µé¢å†…å„å…ƒç´ çš„å…¥åœºåŠ¨ç”»
            animateElements();
            
            // æŠ•å…¥é‡‘é¢è·å¾—ç„¦ç‚¹æ—¶æ·»åŠ é«˜äº®æ•ˆæœ
            const marginInput = document.querySelector('.uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
            marginInput.addEventListener('focus', function() {
                // // document.getElementById('margin-input-container').classList.add('margin-highlight'); // å·²ç¦ç”¨åŠ¨ç”» // å·²ç¦ç”¨åŠ¨ç”»
            });
            
            marginInput.addEventListener('blur', function() {
                // // document.getElementById('margin-input-container').classList.remove('margin-highlight'); // å·²ç¦ç”¨åŠ¨ç”» // å·²ç¦ç”¨åŠ¨ç”»
            });
            
            // æ ¹æ®æ æ†å€æ•°æ›´æ–°ä¿è¯é‡‘é‡‘é¢
            function updateMarginFromLeverage(leverage) {
                // è·å–å½“å‰ç™¾åˆ†æ¯”å€¼
                const percentElement = document.getElementById('position-value-percent');
                const percent = parseInt(percentElement.textContent);
                
                // è®¡ç®—ä¿è¯é‡‘é‡‘é¢ï¼ˆç¤ºä¾‹è®¡ç®—å…¬å¼ï¼‰
                const baseAmount = 1000;  // åŸºç¡€é‡‘é¢
                const calculatedMargin = (baseAmount / leverage) * (percent / 100);
                
                // æ›´æ–°ä¿è¯é‡‘è¾“å…¥æ¡†ï¼Œä½¿ç”¨å¹³æ»‘åŠ¨ç”»
                const marginInput = document.querySelector('.uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
                // ä½¿ç”¨toFixedä¿ç•™ä¸¤ä½å°æ•°ï¼Œé¿å…æµ®ç‚¹æ•°é—®é¢˜å¹¶åº”ç”¨å¹³æ»‘è¿‡æ¸¡
                const formattedValue = parseFloat(calculatedMargin.toFixed(2));
                // æ£€æŸ¥å€¼æ˜¯å¦æœ‰æ˜æ˜¾å˜åŒ–
                if (marginInput.value !== formattedValue.toString()) {
                    // å­˜å‚¨ä¸Šä¸€æ¬¡çš„å€¼ï¼Œç”¨äºåŠ¨ç”»åˆ¤æ–­
                    const prevValue = parseFloat(marginInput.value || '0');
                    // å¦‚æœå˜åŒ–å¤§äºä¸€å®šå€¼ï¼Œåº”ç”¨è¿‡æ¸¡åŠ¨ç”»
                    if (Math.abs(prevValue - formattedValue) > 10) {
                        marginInput.classList.add('value-changing');
                        setTimeout(() => {
                            marginInput.classList.remove('value-changing');
                        }, 300);
                    }
                    // è®¾ç½®æ–°å€¼
                    marginInput.value = formattedValue;
                }
                
                // æ˜¾ç¤ºä¿è¯é‡‘æ›´æ–°æç¤º
                showToast(`ä¿è¯é‡‘å·²æ›´æ–°: ${calculatedMargin.toFixed(2)} USDT`);
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showToast(message) {
            // å¦‚æœå·²æœ‰toastï¼Œå…ˆç§»é™¤
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            // åˆ›å»ºæ–°çš„toastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºtoast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // è‡ªåŠ¨éšè—toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // æ˜¾ç¤ºè®¢å•ç»“æœæ¨¡æ€çª—å£
        function showOrderResultModal(orderResult, tradePair) {
            // è°ƒç”¨æ–°çš„ä¾§è¾¹æ˜¾ç¤ºå‡½æ•°ï¼Œä¸å†ä½¿ç”¨å¼¹çª—
            showOrderInfo(orderResult, tradePair);
            
            // åŒæ—¶æ˜¾ç¤ºä¸€ä¸ªå°çš„æˆåŠŸæç¤º
            showToast(`ä¸‹å•æˆåŠŸ: ${tradePair}, ${orderResult.contractSize}å¼ `, 'success');
        }
        
        // æ˜¾ç¤ºç½‘ç»œé”™è¯¯æ¨¡æ€çª—å£
        function showNetworkErrorModal(message) {
            // åˆ›å»ºæ¨¡æ€æ¡†å®¹å™¨
            const modal = document.createElement('div');
            modal.className = 'modal-container error-modal';
            
            // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // æ·»åŠ æ ‡é¢˜
            const titleEl = document.createElement('h3');
            titleEl.textContent = 'ç½‘ç»œè¿æ¥é—®é¢˜';
            titleEl.className = 'modal-title';
            modalContent.appendChild(titleEl);
            
            // æ·»åŠ é”™è¯¯å›¾æ ‡
            const iconEl = document.createElement('div');
            iconEl.className = 'error-icon';
            iconEl.innerHTML = '<svg viewBox="0 0 24 24" width="48" height="48"><path fill="#ff4d4f" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>';
            modalContent.appendChild(iconEl);
            
            // æ·»åŠ é”™è¯¯ä¿¡æ¯
            const msgEl = document.createElement('p');
            msgEl.textContent = message;
            msgEl.className = 'modal-message';
            modalContent.appendChild(msgEl);
            
            // æ·»åŠ ç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.className = 'modal-confirm-btn';
            confirmBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmBtn);
            modal.appendChild(modalContent);
            
            // æ·»åŠ åˆ°bodyå¹¶æ˜¾ç¤º
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // æ·»åŠ å…ƒç´ å…¥åœºåŠ¨ç”»
        function animateElements() {
            const elements = document.querySelectorAll('.box, .box2, .forms-item');
            elements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('element-animated');
                }, 100 * index);
            });
        }
        
        // åˆå§‹åŒ–ç™¾åˆ†æ¯”æ§åˆ¶æ»‘åŠ¨æ¡
        function initPositionPercentSlider() {
            const slider = document.getElementById('position-slider-percent');
            const sliderBar = slider.parentElement;
            const positionValue = document.getElementById('position-value-percent');
            const progressBar = sliderBar.querySelector('.gone');
            
            // è·å–ä¿è¯é‡‘è¾“å…¥æ¡†
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="è¾“å…¥æŠ•å…¥é‡‘é¢"]');
            // è®¾ç½®åˆå§‹ä¿è¯é‡‘å€¼ï¼ˆå‡è®¾æœ‰ä¸€ä¸ªæœ€å¤§å€¼ï¼‰
            const maxMargin = 1000; // å‡è®¾æœ€å¤§ä¿è¯é‡‘ä¸º1000 USDT
            
            // å¹³æ»‘è®¾ç½®åˆå§‹å€¼
            setTimeout(() => {
                const formattedValue = parseFloat(maxMargin.toFixed(2));
                marginInput.value = formattedValue;
            }, 300);
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // å¹³æ»‘æ›´æ–°ä¿è¯é‡‘å€¼å‡½æ•°
            function updateMarginValue(percent, leverage) {
                // è®¡ç®—ä¿è¯é‡‘
                const marginValue = (percent / 100) * (maxMargin / leverage);
                // æ ¼å¼åŒ–å€¼ï¼Œä¿ç•™2ä½å°æ•°
                const formattedValue = parseFloat(marginValue.toFixed(2));
                
                // ç®€åŒ–åçš„é€»è¾‘ï¼Œç›´æ¥è®¾ç½®å€¼ï¼Œæ— åŠ¨ç”»
                if (marginInput.value !== formattedValue.toString()) {
                    marginInput.value = formattedValue;
                }
            }
            
            // æ›´æ–°æ»‘å—ä½ç½®å’Œå€¼
            function updateSlider(clientX) {
                // è®¡ç®—æ»‘å—åœ¨è½¨é“ä¸Šçš„ä½ç½®ç™¾åˆ†æ¯”
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // è®¾ç½®CSSå˜é‡è®°å½•å½“å‰ä½ç½®ï¼Œç”¨äºåŠ¨ç”»
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // æ›´æ–°æ»‘å—ä½ç½®ï¼Œä¿æŒå‚ç›´å±…ä¸­
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = `${percent}%`;
                
                // æ›´æ–°å€¼æ˜¾ç¤º
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // è®¡ç®—å¹¶æ›´æ–°ä¿è¯é‡‘å€¼
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="é€‰æ‹©æ æ†å€æ•°"]');
                let leverage = 10; // é»˜è®¤æ æ†
                if (leverageInput.value) {
                    // è§£ææ æ†å€¼ï¼ˆä¾‹å¦‚ "10X" -> 10ï¼‰
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // ä½¿ç”¨å¹³æ»‘æ›´æ–°å‡½æ•°æ›´æ–°ä¿è¯é‡‘å€¼
                updateMarginValue(percent, leverage);
                
                // æ·»åŠ æ»‘å—åŠ¨ç”»æ•ˆæœ
                const handleSliderAnimation = (percent) => {
                    // ç§»é™¤æ‰€æœ‰é¢œè‰²ç±»
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // æ ¹æ®ç™¾åˆ†æ¯”åº”ç”¨ç›¸åº”çš„é¢œè‰²ç±»
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // æ·»åŠ ç¼©æ”¾åŠ¨ç”»æ•ˆæœ
                    if (isDragging) {
                        // æ‹–åŠ¨æ—¶ä¸æ·»åŠ è„‰å†²åŠ¨ç”»
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // å¼ºåˆ¶é‡ç»˜
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶å¤„ç†
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // è·å–æ»‘åŠ¨æ¡çš„å®½åº¦å’Œä½ç½®
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40; // å‡å»æ»‘å—è‡ªèº«å®½åº¦ï¼Œä½¿æ»‘å—èƒ½å¤Ÿå®Œå…¨ç§»åŠ¨åˆ°è¾¹ç¼˜
                sliderLeft = rect.left + 20; // åŠ ä¸Šæ»‘å—åŠå¾„ï¼Œä½¿ç™¾åˆ†æ¯”è®¡ç®—æ›´å‡†ç¡®
                
                isDragging = true;
                
                // æ·»åŠ æ¿€æ´»æ ·å¼
                slider.classList.add('slider-active');
                document.body.style.cursor = 'grabbing';
                
                // æ›´æ–°åˆå§‹ä½ç½®
                updateSlider(clientX);
                
                // æ·»åŠ ç§»åŠ¨å’Œç»“æŸäº‹ä»¶ç›‘å¬
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // ç§»é™¤æ¿€æ´»æ ·å¼
                slider.classList.remove('slider-active');
                document.body.style.cursor = '';
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
                
                // æ·»åŠ å®ŒæˆåŠ¨ç”»
                slider.classList.add('slider-done');
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                }, 500);
            }
            
            // ä¸ºå›ºå®šç‚¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            sliderBar.querySelectorAll('.move-img').forEach(dot => {
                dot.addEventListener('click', function() {
                    const percent = parseInt(this.style.left);
                    
                    // è·å–æ»‘åŠ¨æ¡çš„å®½åº¦
                    const rect = sliderBar.getBoundingClientRect();
                    sliderWidth = rect.width - 40;
                    sliderLeft = rect.left + 20;
                    
                    const newPosition = (sliderWidth * percent) / 100;
                    
                    // è®¾ç½®CSSå˜é‡è®°å½•å½“å‰ä½ç½®ï¼Œç”¨äºåŠ¨ç”»
                    slider.style.setProperty('--x-pos', `${newPosition}px`);
                    
                    // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                    slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    
                    // æ›´æ–°æ»‘å—ä½ç½®ï¼Œä¿æŒå‚ç›´å±…ä¸­
                    slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                    progressBar.style.width = `${percent}%`;
                    slider.querySelector('.count').textContent = `${percent}%`;
                    positionValue.textContent = `${percent}%`;
                    
                    // è®¡ç®—å¹¶æ›´æ–°ä¿è¯é‡‘å€¼
                    const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="é€‰æ‹©æ æ†å€æ•°"]');
                    let leverage = 10; // é»˜è®¤æ æ†
                    if (leverageInput.value) {
                        // è§£ææ æ†å€¼ï¼ˆä¾‹å¦‚ "10X" -> 10ï¼‰
                        leverage = parseInt(leverageInput.value);
                        if (isNaN(leverage)) leverage = 10;
                    }
                    
                    // ä½¿ç”¨å¹³æ»‘æ›´æ–°å‡½æ•°æ›´æ–°ä¿è¯é‡‘å€¼
                    updateMarginValue(percent, leverage);
                    
                    // æ ¹æ®ç™¾åˆ†æ¯”æ”¹å˜é¢œè‰²
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        progressBar.classList.remove('progress-yellow', 'progress-blue');
                        slider.classList.remove('slider-yellow', 'slider-blue');
                        progressBar.classList.add('progress-red');
                        slider.classList.add('slider-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        progressBar.classList.remove('progress-red', 'progress-blue');
                        slider.classList.remove('slider-red', 'slider-blue');
                        progressBar.classList.add('progress-yellow');
                        slider.classList.add('slider-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        progressBar.classList.remove('progress-red', 'progress-yellow');
                        slider.classList.remove('slider-red', 'slider-yellow');
                        progressBar.classList.add('progress-blue');
                        slider.classList.add('slider-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // æ·»åŠ ç‚¹å‡»é«˜äº®åŠ¨ç”»
                    this.classList.add('dot-active');
                    setTimeout(() => {
                        this.classList.remove('dot-active');
                    }, 500);
                    
                    // æ·»åŠ å®ŒæˆåŠ¨ç”»
                    setTimeout(() => {
                        slider.classList.remove('slider-done');
                        // å¼ºåˆ¶é‡ç»˜
                        void slider.offsetWidth;
                        slider.classList.add('slider-done');
                    }, 300);
                    
                    // ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œä»¥ä¾¿æ‹–åŠ¨æ—¶ä¸å—å½±å“
                    setTimeout(() => {
                        slider.style.transition = '';
                        progressBar.style.transition = '';
                    }, 500);
                });
            });
            
            // ä¸ºæ»‘åŠ¨æ¡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            sliderBar.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ»‘å—æœ¬èº«æˆ–è€…å›ºå®šç‚¹ï¼Œä¸å¤„ç†
                if (e.target === slider || e.target.closest('.move-img')) return;
                
                // è·å–æ»‘åŠ¨æ¡çš„å®½åº¦å’Œä½ç½®
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40;
                sliderLeft = rect.left + 20;
                
                const clickX = e.clientX - sliderLeft + 20; // è°ƒæ•´ç‚¹å‡»ä½ç½®
                const percent = Math.round((clickX / sliderWidth) * 100);
                const adjustedPercent = Math.max(0, Math.min(percent, 100)); // ç¡®ä¿ç™¾åˆ†æ¯”åœ¨0-100ä¹‹é—´
                
                // è®¾ç½®CSSå˜é‡è®°å½•å½“å‰ä½ç½®ï¼Œç”¨äºåŠ¨ç”»
                const newPosition = (sliderWidth * adjustedPercent) / 100;
                slider.style.setProperty('--x-pos', `${newPosition}px`);
                
                // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                // æ›´æ–°æ»‘å—ä½ç½®ï¼Œä¿æŒå‚ç›´å±…ä¸­
                slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                progressBar.style.width = `${adjustedPercent}%`;
                slider.querySelector('.count').textContent = `${adjustedPercent}%`;
                positionValue.textContent = `${adjustedPercent}%`;
                
                // è®¡ç®—å¹¶æ›´æ–°ä¿è¯é‡‘å€¼
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="é€‰æ‹©æ æ†å€æ•°"]');
                let leverage = 10; // é»˜è®¤æ æ†
                if (leverageInput.value) {
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // ä½¿ç”¨å¹³æ»‘æ›´æ–°å‡½æ•°æ›´æ–°ä¿è¯é‡‘å€¼
                updateMarginValue(adjustedPercent, leverage);
                
                // æ ¹æ®ç™¾åˆ†æ¯”æ”¹å˜é¢œè‰²
                if (adjustedPercent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (adjustedPercent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
                
                // æ·»åŠ å®ŒæˆåŠ¨ç”»
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                    // å¼ºåˆ¶é‡ç»˜
                    void slider.offsetWidth;
                    slider.classList.add('slider-done');
                }, 300);
                
                // ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œä»¥ä¾¿æ‹–åŠ¨æ—¶ä¸å—å½±å“
                setTimeout(() => {
                    slider.style.transition = '';
                    progressBar.style.transition = '';
                }, 500);
            });
            
            // æ·»åŠ æ‹–åŠ¨äº‹ä»¶ç›‘å¬
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
            
            // åˆå§‹åŒ–æ—¶è®¾ç½®æ»‘å—çš„é¢œè‰²
            setTimeout(() => {
                // è·å–åˆå§‹ç™¾åˆ†æ¯”
                const percent = parseInt(positionValue.textContent);
                
                if (percent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (percent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
            }, 500);
        }
        
        // åˆå§‹åŒ–ä»“ä½æ»‘åŠ¨æ¡
        function initPositionSlider() {
            const slider = document.getElementById('position-slider');
            if (!slider) return; // é˜²æ­¢é”™è¯¯
            
            const progressBar = document.getElementById('progress-bar');
            const positionValue = document.getElementById('position-value');
            const sliderBar = document.querySelector('.sliderBar');
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // æ›´æ–°æ»‘å—ä½ç½®å’Œå€¼
            function updateSlider(clientX) {
                // è®¡ç®—æ»‘å—åœ¨è½¨é“ä¸Šçš„ä½ç½®ç™¾åˆ†æ¯”
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // è®¾ç½®CSSå˜é‡è®°å½•å½“å‰ä½ç½®ï¼Œç”¨äºåŠ¨ç”»
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // æ›´æ–°æ»‘å—ä½ç½®ï¼Œä¿æŒå‚ç›´å±…ä¸­
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = `${percent}%`;
                
                // æ›´æ–°å€¼æ˜¾ç¤º
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // è®¡ç®—å¹¶æ›´æ–°ä¿è¯é‡‘å€¼
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="é€‰æ‹©æ æ†å€æ•°"]');
                let leverage = 10; // é»˜è®¤æ æ†
                if (leverageInput.value) {
                    // è§£ææ æ†å€¼ï¼ˆä¾‹å¦‚ "10X" -> 10ï¼‰
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // è®¡ç®—ä¿è¯é‡‘
                const marginValue = (percent / 100) * (maxMargin / leverage);
                marginInput.value = marginValue.toFixed(2);
                
                // æ·»åŠ æ»‘å—åŠ¨ç”»æ•ˆæœ
                const handleSliderAnimation = (percent) => {
                    // ç§»é™¤æ‰€æœ‰é¢œè‰²ç±»
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // æ ¹æ®ç™¾åˆ†æ¯”åº”ç”¨ç›¸åº”çš„é¢œè‰²ç±»
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // æ·»åŠ ç¼©æ”¾åŠ¨ç”»æ•ˆæœ
                    if (isDragging) {
                        // æ‹–åŠ¨æ—¶ä¸æ·»åŠ è„‰å†²åŠ¨ç”»
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // å¼ºåˆ¶é‡ç»˜
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶å¤„ç†
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // è·å–æ»‘åŠ¨æ¡çš„å®½åº¦å’Œä½ç½®
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width;
                sliderLeft = rect.left;
                
                isDragging = true;
                
                // æ›´æ–°åˆå§‹ä½ç½®
                updateSlider(clientX);
                
                // æ·»åŠ ç§»åŠ¨å’Œç»“æŸäº‹ä»¶ç›‘å¬
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            }
            
            // ä¸ºå›ºå®šç‚¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const dotElements = document.querySelectorAll('.move-img');
            if (dotElements.length > 0) {
                dotElements.forEach(dot => {
                    dot.addEventListener('click', function() {
                        if (this.style.left) {
                            const percent = parseInt(this.style.left);
                            slider.style.left = `${percent}%`;
                            
                            if (progressBar) {
                                progressBar.style.width = `${percent}%`;
                            }
                            
                            const countElement = slider.querySelector('.count');
                            if (countElement) {
                                countElement.textContent = `${percent}%`;
                            }
                            
                            if (positionValue) {
                                positionValue.textContent = `${percent}%`;
                            }
                        }
                    });
                });
            }
            
            // ä¸ºæ»‘åŠ¨æ¡æ·»åŠ ç‚¹å‡»äº‹ä»¶
            sliderBar.addEventListener('click', function(e) {
                if (e.target === slider) return;
                
                const rect = sliderBar.getBoundingClientRect();
                const sliderWidth = rect.width;
                const clickX = e.clientX - rect.left;
                const percent = Math.round((clickX / sliderWidth) * 100);
                
                slider.style.left = `${percent}%`;
                
                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
                
                const countElement = slider.querySelector('.count');
                if (countElement) {
                    countElement.textContent = `${percent}%`;
                }
                
                if (positionValue) {
                    positionValue.textContent = `${percent}%`;
                }
            });
            
            // æ·»åŠ æ‹–åŠ¨äº‹ä»¶ç›‘å¬
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
        }

        // æ£€æŸ¥æŒä»“çŠ¶æ€å‡½æ•°
        function checkPositionStatus(allowTrade = false) {
            // è·å–å½“å‰é€‰æ‹©çš„äº¤æ˜“å¯¹å’Œäº¤æ˜“æ–¹å‘
            let tradePair = 'BTC-USDT'; // é»˜è®¤å€¼
            
            // ä¼˜å…ˆä½¿ç”¨selected-crypto-pair
            const selectedCryptoPair = document.getElementById('selected-crypto-pair');
            if (selectedCryptoPair && selectedCryptoPair.value) {
                tradePair = selectedCryptoPair.value;
            }
            // å¦‚æœselected-crypto-pairä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨trade-pair-select
            else {
                const tradePairSelect = document.getElementById('trade-pair-select');
                if (tradePairSelect && tradePairSelect.value) {
                    tradePair = tradePairSelect.value;
                }
            }
            
            console.log(`æ£€æŸ¥æŒä»“çŠ¶æ€ä½¿ç”¨çš„äº¤æ˜“å¯¹: ${tradePair}`);
            
            // è·å–äº¤æ˜“æ–¹å‘
            let tradeDirection = 'buy'; // é»˜è®¤åšå¤š
            const dirInput = document.querySelector('input[name="trade_direction"]:checked');
            if (dirInput) {
                tradeDirection = dirInput.value;
            } else {
                // å°è¯•ä½¿ç”¨ç±»å‹é€‰æ‹©å™¨
                const activeTypeEl = document.querySelector('.type-box .type-li.type-active');
                if (activeTypeEl) {
                    tradeDirection = activeTypeEl.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                }
            }
            
            // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
            const lastRefreshTime = document.getElementById('last-refresh-time');
            if (lastRefreshTime) {
                lastRefreshTime.textContent = `æœ€ååˆ·æ–°: ${new Date().toLocaleTimeString()}`;
            }
            
            // æ›´æ–°ç»­ä¸‹å•æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            const continueOrderBtn = document.getElementById('continue-order-btn');
            
            // å‘é€è¯·æ±‚æ£€æŸ¥æŒä»“çŠ¶æ€
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // æ›´æ–°æŒä»“çŠ¶æ€
                    const hasBuyPosition = data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // è®°å½•çŠ¶æ€
                    console.log(`[ç­–ç•¥çŠ¶æ€ç»“æœ] å¤šå¤´æŒä»“: ${hasBuyPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}, ç©ºå¤´æŒä»“: ${hasSellPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`);
                    
                    // æ›´æ–°ç­–ç•¥è¿è¡ŒçŠ¶æ€æŒ‡ç¤ºå™¨
                    const statusIndicator = document.getElementById('key-status-indicator');
                            const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // å¦‚æœæœ‰æŒä»“ï¼Œæ›´æ–°ç»­ä¸‹å•æŒ‰é’®æ ·å¼
                    if (chichang) {
                        continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> å·²æŒä»“';
                        continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                        continueOrderBtn.classList.add('position-active');
                        continueOrderBtn.disabled = true;
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•æ­£åœ¨æ‰§è¡Œ
                        if (data.hasOrder) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                            continueOrderBtn.disabled = true;
                        } else {
                            continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> ç»­ä¸‹å•';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                            continueOrderBtn.classList.remove('position-active');
                            continueOrderBtn.disabled = false;
                        }
                    }
                    
                    // æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨
                    statusIndicator.style.display = 'block';
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œå›¾æ ‡
                    if (chichang) {
                        statusText.innerHTML = `å¤šå¤´æŒä»“: ${hasBuyPosition ? '<span style="color:#52c41a">æ¿€æ´»</span>' : '<span style="color:#bfbfbf">æœªæ¿€æ´»</span>'}, ç©ºå¤´æŒä»“: ${hasSellPosition ? '<span style="color:#52c41a">æ¿€æ´»</span>' : '<span style="color:#bfbfbf">æœªæ¿€æ´»</span>'}`;
                        statusIcon.innerHTML = 'ğŸ”„';
                        statusIcon.style.animation = 'spin 5s linear infinite';
                        statusIndicator.style.backgroundColor = '#e6f7ff';
                        statusIndicator.style.borderColor = '#91d5ff';
                    } else if (data.hasOrder) {
                        statusText.innerHTML = 'æœ‰è®¢å•æ­£åœ¨å¤„ç†ä¸­';
                        statusIcon.innerHTML = 'â³';
                        statusIcon.style.animation = 'blink 1.5s ease infinite';
                        statusIndicator.style.backgroundColor = '#fffbe6';
                        statusIndicator.style.borderColor = '#ffe58f';
                    } else {
                        statusText.innerHTML = 'å½“å‰æ— æŒä»“ï¼Œå¯ä»¥ä¸‹å•';
                        statusIcon.innerHTML = 'âœ…';
                        statusIcon.style.animation = 'none';
                        statusIndicator.style.backgroundColor = '#f6ffed';
                        statusIndicator.style.borderColor = '#b7eb8f';
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateButtonStatus(chichang, strategyRunning);
                    
                    } else {
                    console.error('æ£€æŸ¥æŒä»“çŠ¶æ€å¤±è´¥:', data.message);
                    showToast(`æ£€æŸ¥æŒä»“çŠ¶æ€å¤±è´¥: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å‡ºé”™:', error);
                showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            });
        }

        // ä¿å­˜æŒä»“æ•°æ®åˆ°localStorage
        function storePositionData(positionInfo, tradePair) {
            // è·å–ä¹‹å‰ä¿å­˜çš„æ‰€æœ‰æŒä»“ä¿¡æ¯
            let allPositions = [];
            try {
                const positionsStr = localStorage.getItem('okxPositions');
                if (positionsStr) {
                    allPositions = JSON.parse(positionsStr);
                }
            } catch (e) {
                console.error('è§£ælocalStorageæ•°æ®å‡ºé”™:', e);
                allPositions = [];
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ­¤äº¤æ˜“å¯¹çš„ä¿¡æ¯ï¼Œæœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ·»åŠ 
            const existingIndex = allPositions.findIndex(p => p.tradePair === tradePair);
            const hasPosition = positionInfo.hasBuyPosition || positionInfo.hasSellPosition;
            
            if (existingIndex >= 0) {
                if (hasPosition) {
                    // æ›´æ–°ç°æœ‰æŒä»“
                    allPositions[existingIndex] = positionInfo;
                } else {
                    // å¦‚æœä¸å†æœ‰æŒä»“ï¼Œç§»é™¤æ­¤äº¤æ˜“å¯¹
                    allPositions.splice(existingIndex, 1);
                }
            } else if (hasPosition) {
                // æ·»åŠ æ–°æŒä»“
                allPositions.push(positionInfo);
            }
            
            // ä¿å­˜æ›´æ–°åçš„æŒä»“åˆ—è¡¨
            localStorage.setItem('okxPositions', JSON.stringify(allPositions));
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°
            window.dispatchEvent(new CustomEvent('okxPositionsChanged', {
                detail: { positions: allPositions }
            }));
            
            // æ›´æ–°æŒä»“æ•°é‡
            updatePositionCount(allPositions.length);
            
            // å¼ºåˆ¶åˆ·æ–°localStorageäº‹ä»¶ï¼Œç¡®ä¿å…¶ä»–æ ‡ç­¾é¡µèƒ½æ•è·åˆ°å˜åŒ–
            localStorage.setItem('okxPositionCount', allPositions.length.toString());
            localStorage.setItem('okxPositionsUpdateTime', new Date().getTime().toString());
            
            return allPositions;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStatus(hasPosition, isRunning) {
            const toggleBtn = document.getElementById('toggle-strategy-btn');
            
            if (isRunning) {
                // å¦‚æœç­–ç•¥æ­£åœ¨è¿è¡Œä¸­
                toggleBtn.textContent = 'åœæ­¢ç­–ç•¥';
                toggleBtn.style.backgroundColor = '#ff4d4f';
            } else {
                // å¦‚æœç­–ç•¥å·²åœæ­¢
                toggleBtn.textContent = 'è¿è¡Œ';
                toggleBtn.style.backgroundColor = '#52c41a';
            }
        }

        // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
        function clearAllIntervals() {
            if (strategyInterval) {
                clearInterval(strategyInterval);
                strategyInterval = null;
            }
            
            if (window.strategyInterval) {
                clearInterval(window.strategyInterval);
                window.strategyInterval = null;
            }
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            if (window.autoRefreshInterval) {
                clearInterval(window.autoRefreshInterval);
                window.autoRefreshInterval = null;
            }
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm, onCancel) {
            // åˆ›å»ºå¯¹è¯æ¡†å®¹å™¨
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.width = '100%';
            dialogOverlay.style.height = '100%';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            dialogOverlay.style.zIndex = '9999';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            // åˆ›å»ºå¯¹è¯æ¡†å†…å®¹
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.width = '300px';
            dialog.style.maxWidth = '90%';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // æ·»åŠ æ ‡é¢˜
            const titleElement = document.createElement('div');
            titleElement.textContent = title;
            titleElement.style.padding = '16px';
            titleElement.style.borderBottom = '1px solid #f0f0f0';
            titleElement.style.fontWeight = 'bold';
            dialog.appendChild(titleElement);
            
            // æ·»åŠ æ¶ˆæ¯
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.padding = '16px';
            messageElement.style.color = '#595959';
            dialog.appendChild(messageElement);
            
            // æ·»åŠ æŒ‰é’®å®¹å™¨
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.borderTop = '1px solid #f0f0f0';
            
            // ç¡®è®¤æŒ‰é’®
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.flex = '1';
            confirmButton.style.padding = '12px';
            confirmButton.style.border = 'none';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.color = 'white';
            confirmButton.style.borderRadius = '0 0 0 8px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onConfirm) onConfirm();
            });
            
            // å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '12px';
            cancelButton.style.border = 'none';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#595959';
            cancelButton.style.borderRadius = '0 0 8px 0';
            cancelButton.style.cursor = 'pointer';
            cancelButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onCancel) onCancel();
            });
            
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            dialog.appendChild(buttonsContainer);
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
        }

        // æ›´æ–°å¯¼èˆªæ ä¸­çš„æŒä»“æ•°é‡æ˜¾ç¤º
        function updatePositionCount(count) {
            // å°è¯•æ‰¾åˆ°å½“å‰é¡µé¢ä¸­çš„æŒä»“æ•°é‡æ˜¾ç¤ºå…ƒç´ 
            const positionCountElem = document.querySelector('.flex-x.nav-li.active-nav-li.nav-li-p span:nth-child(2)');
            if (positionCountElem) {
                positionCountElem.textContent = `(${count})`;
            }
            
            // å°è¯•å‘é€æ¶ˆæ¯åˆ°spoté¡µé¢ï¼ˆå¦‚æœæœ‰ï¼‰
            try {
                // å°†æŒä»“ä¿¡æ¯å¹¿æ’­åˆ°å…¶ä»–é¡µé¢
                localStorage.setItem('okxPositionCount', count.toString());
                
                // æ´¾å‘è‡ªå®šä¹‰äº‹ä»¶
                window.dispatchEvent(new CustomEvent('okxPositionUpdated', {
                    detail: { count: count }
                }));
            } catch (e) {
                console.error('æ›´æ–°æŒä»“æ•°é‡å‡ºé”™:', e);
            }
            
            // åˆ›å»ºæŒä»“ä¿¡æ¯å±•ç¤ºåŒºï¼ˆå¦‚æœå°šæœªåˆ›å»ºï¼‰
            if (!document.getElementById('position-details-container')) {
                // åœ¨çŠ¶æ€æ˜¾ç¤ºä¸‹æ–¹æ·»åŠ æŒä»“è¯¦æƒ…åŒºåŸŸ
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = 'position-details-container';
                    detailsContainer.style.marginTop = '15px';
                    detailsContainer.style.padding = '15px';
                    detailsContainer.style.backgroundColor = '#f8f9fa';
                    detailsContainer.style.borderRadius = '8px';
                    detailsContainer.style.display = count > 0 ? 'block' : 'none';
                    statusElement.parentNode.insertBefore(detailsContainer, statusElement.nextSibling);
                }
            }
        }

        // æ˜¾ç¤ºæŒä»“è¯¦æƒ…
        function showPositionDetails(positionStatus, tradePair) {
            const container = document.getElementById('position-details-container');
            if (!container) return;
            
            container.style.display = 'block';
            container.innerHTML = `<h5 style="font-size: 16px; margin-bottom: 10px;">æŒä»“è¯¦æƒ…</h5>`;
            
            // æ˜¾ç¤ºå¤šå¤´æŒä»“ä¿¡æ¯
            if (positionStatus.buy_flag) {
                const buyInfo = document.createElement('div');
                buyInfo.classList.add('position-item');
                buyInfo.style.marginBottom = '10px';
                buyInfo.style.padding = '10px';
                buyInfo.style.backgroundColor = '#e6f7ff';
                buyInfo.style.borderRadius = '4px';
                buyInfo.style.borderLeft = '3px solid #1890ff';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz) {
                    availPos = positionStatus.p_Pos_sz;
                }
                
                if (positionStatus.p_cw_avgPx) {
                    avgPrice = positionStatus.p_cw_avgPx;
                }
                
                buyInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} å¤šå¤´</span>
                        <span style="color: #52c41a;">${availPos} å¼ </span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>å¼€ä»“å‡ä»·</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(buyInfo);
            }
            
            // æ˜¾ç¤ºç©ºå¤´æŒä»“ä¿¡æ¯
            if (positionStatus.sell_flag) {
                const sellInfo = document.createElement('div');
                sellInfo.classList.add('position-item');
                sellInfo.style.marginBottom = '10px';
                sellInfo.style.padding = '10px';
                sellInfo.style.backgroundColor = '#fff2e8';
                sellInfo.style.borderRadius = '4px';
                sellInfo.style.borderLeft = '3px solid #fa541c';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz_s) {
                    availPos = positionStatus.p_Pos_sz_s;
                }
                
                if (positionStatus.p_cw_avgPx_s) {
                    avgPrice = positionStatus.p_cw_avgPx_s;
                }
                
                sellInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} ç©ºå¤´</span>
                        <span style="color: #ff4d4f;">${availPos} å¼ </span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>å¼€ä»“å‡ä»·</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(sellInfo);
            }
        }

        // æ¸…é™¤æŒä»“è¯¦æƒ…æ˜¾ç¤º
        function clearPositionDetails() {
            const container = document.getElementById('position-details-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ä¼˜å…ˆæ£€æŸ¥buy_flagçŠ¶æ€å¹¶æ¿€æ´»æŒ‰é’®
        function checkInitialPositionStatus() {
            // è·å–å½“å‰URLä¸­çš„ç­–ç•¥IDå’Œäº¤æ˜“å¯¹
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // è·å–äº¤æ˜“å¯¹ï¼ˆæ ¹æ®ç­–ç•¥IDè®¾ç½®ä¸åŒçš„é»˜è®¤äº¤æ˜“å¯¹ï¼‰
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = 'æ­£åœ¨æ£€æŸ¥æŒä»“çŠ¶æ€...';
            
            // å‘åç«¯å‘é€è¯·æ±‚è·å–æŒä»“çŠ¶æ€
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: 'buy'  // æ— è®ºå½“å‰é€‰æ‹©ä»€ä¹ˆæ–¹å‘ï¼Œä¼˜å…ˆæ£€æŸ¥buy_flag
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // ç›´æ¥æ£€æŸ¥buy_flag
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // è·å–UIå…ƒç´ 
                    const toggleBtn = document.getElementById('toggle-strategy-btn');
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // æ›´æ–°åç«¯æ£€æŸ¥ç»“æœåˆ°æ§åˆ¶å° - è¿™æ˜¯æ§åˆ¶zhibiao.pyå¾ªç¯çš„å…³é”®çŠ¶æ€
                    console.log(`[ç­–ç•¥çŠ¶æ€ç»“æœ] å¤šå¤´æŒä»“: ${hasBuyPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}, ç©ºå¤´æŒä»“: ${hasSellPosition ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}`);
                    
                    // è·å–ä¹‹å‰ä¿å­˜çš„ç­–ç•¥è¿è¡ŒçŠ¶æ€
                    const savedStrategyRunning = getStrategyRunningState();
                    strategyRunning = savedStrategyRunning;
                    
                    // å¦‚æœä¿å­˜çš„çŠ¶æ€æ˜¯å·²åœæ­¢ï¼Œåˆ™æ— è®ºæŒä»“çŠ¶æ€å¦‚ä½•ï¼Œéƒ½æ˜¾ç¤ºè¿è¡ŒæŒ‰é’®
                    if (!savedStrategyRunning) {
                        // æ˜¾ç¤ºè¿è¡ŒæŒ‰é’®
                        toggleBtn.textContent = 'è¿è¡Œ';
                        toggleBtn.style.backgroundColor = '#52c41a';
                        statusElement.textContent = 'ç­–ç•¥å·²åœæ­¢ï¼Œç‚¹å‡»"è¿è¡Œ"å¯åŠ¨ç­–ç•¥';
                        statusElement.style.color = '#8c8c8c';
                        return;
                    }
                    
                    // ä»¥ä¸‹ä»…åœ¨ç­–ç•¥æ˜¯è¿è¡ŒçŠ¶æ€æ—¶æ‰§è¡Œ
                    
                    // å…³é”®çŠ¶æ€ï¼šå¤šå¤´æ¿€æ´»è€Œç©ºå¤´æœªæ¿€æ´» - è¿™æ˜¯æœ€é‡è¦çš„çŠ¶æ€ï¼Œç”¨æ¥æ§åˆ¶zhibiao.pyå¾ªç¯
                    if (hasBuyPosition && !hasSellPosition) {
                        console.log('ğŸ”„ å…³é”®å¾ªç¯çŠ¶æ€: å¤šå¤´æŒä»“æ¿€æ´»ä¸”ç©ºå¤´æœªæ¿€æ´»ï¼Œzhibiao.pyä¸»å¾ªç¯è¿è¡Œä¸­');
                        
                        // æ›´æ–°å…¨å±€æŒä»“çŠ¶æ€
                        chichang = true;
                        
                        // æ¿€æ´»è¿è¡ŒæŒ‰é’® - æ¸…æ™°æ˜¾ç¤ºå¾ªç¯è¿è¡ŒçŠ¶æ€
                        toggleBtn.textContent = 'åœæ­¢ç­–ç•¥';
                        toggleBtn.style.backgroundColor = '#ff4d4f';
                        
                        // æ¿€æ´»ä¿å­˜æŒ‰é’®
                        saveBtn.textContent = 'å¤šå¤´æŒä»“ä¸­';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // æ›´æ–°çŠ¶æ€æç¤º
                        statusElement.textContent = 'ğŸ”„ å¤šå¤´æŒä»“æ¿€æ´»ï¼Œzhibiao.pyä¸»å¾ªç¯è¿è¡Œä¸­';
                        statusElement.style.color = '#1a6aff'; // è“è‰²è­¦å‘Š
                        
                        // è‡ªåŠ¨å¼€å§‹ç­–ç•¥è¿è¡ŒçŠ¶æ€
                        strategyRunning = true;
                        saveStrategyRunningState(true);
                        
                        // åˆ›å»ºæŒä»“çŠ¶æ€æŒ‡ç¤ºæ ‡ç­¾
                        const statusIndicator = document.createElement('div');
                        statusIndicator.style.backgroundColor = '#e6f7ff';
                        statusIndicator.style.border = '1px solid #91d5ff';
                        statusIndicator.style.borderRadius = '4px';
                        statusIndicator.style.padding = '8px 12px';
                        statusIndicator.style.marginTop = '10px';
                        statusIndicator.style.fontWeight = 'bold';
                        statusIndicator.style.color = '#1a6aff';
                        statusIndicator.style.display = 'flex';
                        statusIndicator.style.alignItems = 'center';
                        statusIndicator.style.justifyContent = 'center';
                        statusIndicator.style.gap = '8px';
                        
                        // æ·»åŠ å¾ªç¯å›¾æ ‡å’Œæ–‡æœ¬
                        statusIndicator.innerHTML = `
                            <div style="animation: spin 2s linear infinite;">ğŸ”„</div>
                            <div>å¤šå¤´æŒä»“æ¿€æ´» - zhibiao.pyä¸»å¾ªç¯è¿è¡Œä¸­</div>
                        `;
                        
                        // å¦‚æœå·²æœ‰çŠ¶æ€æŒ‡ç¤ºï¼Œå…ˆç§»é™¤
                        const existingIndicator = document.querySelector('#loop-status-indicator');
                        if (existingIndicator) {
                            existingIndicator.remove();
                        }
                        
                        statusIndicator.id = 'loop-status-indicator';
                        statusElement.parentNode.insertBefore(statusIndicator, statusElement.nextSibling);
                        
                        // æ·»åŠ CSSåŠ¨ç”»
                        const style = document.createElement('style');
                        style.innerHTML = `
                            @keyframes spin {
                                from { transform: rotate(0deg); }
                                to { transform: rotate(360deg); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // è®¾ç½®è‡ªåŠ¨ç›‘æ§ - æ›´é¢‘ç¹æ£€æŸ¥çŠ¶æ€
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 10000); // 10ç§’æ£€æŸ¥ä¸€æ¬¡
                    } else if (hasBuyPosition && hasSellPosition) {
                        // å¤šå¤´å’Œç©ºå¤´éƒ½æ¿€æ´»
                        console.log('æ£€æµ‹åˆ°buy_flag=Trueå’Œsell_flag=Trueï¼Œè®¾ç½®ä¸ºåŒå‘æŒä»“çŠ¶æ€');
                        
                        // æ›´æ–°å…¨å±€æŒä»“çŠ¶æ€
                        chichang = true;
                        
                        // æ¿€æ´»è¿è¡ŒæŒ‰é’®
                        toggleBtn.textContent = 'åœæ­¢ç­–ç•¥';
                        toggleBtn.style.backgroundColor = '#ff4d4f';
                        
                        // æ¿€æ´»ä¿å­˜æŒ‰é’®
                        saveBtn.textContent = 'åŒå‘æŒä»“ä¸­';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // æ›´æ–°çŠ¶æ€æç¤º
                        statusElement.textContent = 'æ£€æµ‹åˆ°å¤šå¤´å’Œç©ºå¤´æŒä»“ï¼Œç­–ç•¥å·²æ¿€æ´»';
                        statusElement.style.color = '#faad14'; // é»„è‰²è­¦å‘Š
                        
                        // è‡ªåŠ¨å¼€å§‹ç­–ç•¥è¿è¡ŒçŠ¶æ€
                        strategyRunning = true;
                        saveStrategyRunningState(true);
                        
                        // è®¾ç½®è‡ªåŠ¨ç›‘æ§
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15ç§’æ£€æŸ¥ä¸€æ¬¡
                    } else if (!hasBuyPosition && hasSellPosition) {
                        // åªæœ‰ç©ºå¤´æŒä»“
                        console.log('æ£€æµ‹åˆ°buy_flag=Falseä½†sell_flag=Trueï¼Œè®¾ç½®ä¸ºç©ºå¤´æŒä»“çŠ¶æ€');
                        
                        // æ›´æ–°å…¨å±€æŒä»“çŠ¶æ€
                        chichang = true;
                        
                        // æ¿€æ´»è¿è¡ŒæŒ‰é’®
                        toggleBtn.textContent = 'åœæ­¢ç­–ç•¥';
                        toggleBtn.style.backgroundColor = '#ff4d4f';
                        
                        // æ¿€æ´»ä¿å­˜æŒ‰é’®
                        saveBtn.textContent = 'ç©ºå¤´æŒä»“ä¸­';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // æ›´æ–°çŠ¶æ€æç¤º
                        statusElement.textContent = 'æ£€æµ‹åˆ°ç©ºå¤´æŒä»“ï¼Œå¤šå¤´æœªæ¿€æ´»';
                        statusElement.style.color = '#ff4d4f'; // çº¢è‰²è­¦å‘Š
                        
                        // è‡ªåŠ¨å¼€å§‹ç­–ç•¥è¿è¡ŒçŠ¶æ€
                        strategyRunning = true;
                        saveStrategyRunningState(true);
                        
                        // è®¾ç½®è‡ªåŠ¨ç›‘æ§
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15ç§’æ£€æŸ¥ä¸€æ¬¡
                    } else {
                        // æ— ä»»ä½•æŒä»“ï¼Œä½†æ£€æŸ¥ä¿å­˜çš„ç­–ç•¥çŠ¶æ€
                        console.log('æ£€æµ‹åˆ°æ— æŒä»“ï¼Œå‚è€ƒä¿å­˜çš„ç­–ç•¥çŠ¶æ€');
                        
                        // æœªæ£€æµ‹åˆ°æŒä»“ï¼Œè®¾ç½®å…¨å±€å˜é‡
                        chichang = false;
                        
                        // æ ¹æ®ä¿å­˜çš„ç­–ç•¥è¿è¡ŒçŠ¶æ€è®¾ç½®UI
                        if (savedStrategyRunning) {
                            // å¦‚æœä¹‹å‰æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œåˆ™ç»§ç»­æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                            toggleBtn.textContent = 'åœæ­¢ç­–ç•¥';
                            toggleBtn.style.backgroundColor = '#ff4d4f';
                            
                            statusElement.textContent = 'ç­–ç•¥æ­£åœ¨è¿è¡Œä¸­...';
                            statusElement.style.color = '#1a6aff';
                            
                            // å¯åŠ¨å®šæ—¶å™¨
                            strategyInterval = setInterval(function() {
                                checkPositionStatus(true);
                            }, 15000);
                        } else {
                            // ä¿æŒæ­£å¸¸çŠ¶æ€
                            toggleBtn.textContent = 'è¿è¡Œ';
                            toggleBtn.style.backgroundColor = '#52c41a'; // ç»¿è‰²
                            
                            saveBtn.textContent = 'ä¿å­˜è®¾ç½®';
                            statusElement.textContent = 'æ— æŒä»“ï¼Œç³»ç»Ÿå‡†å¤‡å°±ç»ª';
                            statusElement.style.color = '#52c41a'; // ç»¿è‰²æ­£å¸¸
                            strategyRunning = false;
                        }
                        
                        // ç¡®ä¿ç§»é™¤ä»»ä½•æ¿€æ´»çŠ¶æ€çš„ç±»
                        saveBtn.classList.remove('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // å¦‚æœæ²¡æœ‰buy_flagï¼Œåˆ™æ­£å¸¸æ£€æŸ¥æŒä»“çŠ¶æ€
                        checkPositionStatusOnLoad();
                    }
                    
                    // æ·»åŠ çŠ¶æ€æ‘˜è¦æ˜¾ç¤º - å¦‚æœåç«¯æä¾›äº†çŠ¶æ€æ‘˜è¦
                    if (data.statusSummary) {
                        // åœ¨çŠ¶æ€å…ƒç´ çš„ä¸‹æ–¹æ·»åŠ åç«¯çŠ¶æ€æ‘˜è¦
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `åç«¯çŠ¶æ€: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // å¦‚æœå·²æœ‰ä¹‹å‰çš„çŠ¶æ€æ‘˜è¦ï¼Œå…ˆç§»é™¤
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                    
                    // å…³é”®çŠ¶æ€æ˜¾ç¤º
                    if (hasBuyPosition && !hasSellPosition) {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'block';
                        }
                    } else {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'none';
                        }
                    }
                } else {
                    // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå›é€€åˆ°æ­£å¸¸æ£€æŸ¥
                    checkPositionStatusOnLoad();
                }
            })
            .catch(error => {
                console.error('ä¼˜å…ˆæ£€æŸ¥buy_flagå¤±è´¥:', error);
                // å‡ºé”™æ—¶å›é€€åˆ°æ­£å¸¸æ£€æŸ¥
                checkPositionStatusOnLoad();
            });
        }

        // åˆå§‹åŒ–å¸ç§é€‰æ‹©å™¨åŠŸèƒ½
        function initCryptoSelector() {
            // å¸ç§é€‰æ‹©æ¨¡æ€æ¡†
            const modal = document.getElementById('crypto-selection-modal');
            const cryptoSelector = document.getElementById('crypto-selector');
            const closeBtn = document.querySelector('.close');
            const searchInput = document.getElementById('crypto-search');
            const cryptoItems = document.querySelectorAll('.crypto-item');
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            if (cryptoSelector) {
                cryptoSelector.addEventListener('click', function() {
                    modal.style.display = 'block';
                });
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
            
            // æœç´¢åŠŸèƒ½
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    cryptoItems.forEach(item => {
                        const symbol = item.getAttribute('data-symbol').toLowerCase();
                        const display = item.getAttribute('data-display').toLowerCase();
                        if (symbol.includes(searchTerm) || display.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // é€‰æ‹©äº¤æ˜“å¯¹
            cryptoItems.forEach(item => {
                item.addEventListener('click', function() {
                    const symbol = this.getAttribute('data-symbol');
                    const display = this.getAttribute('data-display');
                    const originalPair = this.getAttribute('data-original');
                    
                    // æ›´æ–°æ˜¾ç¤º
                    document.getElementById('selected-crypto-name').textContent = display;
                    document.getElementById('selected-crypto-icon').src = `https://ai.hkd.red/symbolImage/${symbol}.png`;
                    document.getElementById('selected-crypto-pair').value = originalPair;
                    
                    // é«˜äº®é€‰ä¸­é¡¹
                    cryptoItems.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    modal.style.display = 'none';
                    
                    // æ›´æ–°ç­–ç•¥é…ç½®ä¸­çš„äº¤æ˜“å¯¹
                    if (window.strategyConfig) {
                        window.strategyConfig.tradePair = originalPair;
                    }
                    
                    // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰æ‹©äº¤æ˜“å¯¹åçš„å…¶ä»–é€»è¾‘ï¼Œå¦‚æ›´æ–°æ æ†é€‰é¡¹ç­‰
                    showToast(`å·²é€‰æ‹© ${display} äº¤æ˜“å¯¹`);
                    
                    // é€‰æ‹©æ–°çš„äº¤æ˜“å¯¹åï¼Œé‡æ–°æ£€æŸ¥æŒä»“çŠ¶æ€
                    checkPositionStatus(false);
                });
            });
        }

        // ç­–ç•¥æ–¹å‘é€‰æ‹©äº‹ä»¶
        const typeElements = document.querySelectorAll('.type-box .type-li');
        typeElements.forEach(function(el) {
            el.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰çš„æ¿€æ´»çŠ¶æ€
                typeElements.forEach(item => {
                    item.classList.remove('type-active');
                });
                
                // ä¸ºå½“å‰ç‚¹å‡»å…ƒç´ æ·»åŠ æ¿€æ´»çŠ¶æ€
                this.classList.add('type-active');
                
                // æ›´æ–°æ–¹å‘ï¼Œå¦‚æœæ˜¯ä¿å­˜æŒ‰é’®å†æ¬¡æäº¤ï¼Œéœ€è¦è·å–æœ€æ–°çš„æ–¹å‘
                const tradeDirection = this.textContent.trim() === 'åšå¤š' ? 'buy' : 'sell';
                
                // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                this.parentElement.classList.add('row-clicked');
                setTimeout(() => {
                    this.parentElement.classList.remove('row-clicked');
                }, 300);
                
                // æ˜¾ç¤ºé€‰æ‹©çš„æ–¹å‘
                showToast(`å·²é€‰æ‹©${this.textContent.trim()}æ–¹å‘`);
                
                // é‡ç½®ä¿å­˜æŒ‰é’®çŠ¶æ€ - ç”¨æˆ·åˆ‡æ¢æ–¹å‘ååº”è¯¥é‡æ–°æäº¤è®¢å•
                const saveButton = document.querySelector('.confirm-btn');
                saveButton.textContent = 'ä¿å­˜è®¾ç½®';
                saveButton.classList.remove('order-success');
                saveButton.classList.remove('position-active');
                
                // æ£€æŸ¥å½“å‰æ–¹å‘æ˜¯å¦å·²æœ‰æŒä»“ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°æŒ‰é’®çŠ¶æ€
                checkPositionStatus(tradeDirection);
            });
        });
        
        // æ£€æŸ¥æŒä»“çŠ¶æ€
        function checkPositionStatus(direction) {
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // å‘é€AJAXè¯·æ±‚åˆ°åç«¯æ£€æŸ¥æŒä»“çŠ¶æ€
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: direction
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveButton = document.querySelector('.confirm-btn');
                    const hasSameDirectionPosition = 
                        (direction === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                        (direction === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                    
                    if (hasSameDirectionPosition) {
                        // å·²æœ‰ç›¸åŒæ–¹å‘æŒä»“ï¼Œæ˜¾ç¤ºä¸º"å·²æŒä»“ä¸­"
                        saveButton.textContent = 'å·²æŒä»“ä¸­';
                        saveButton.classList.add('position-active');
                        saveButton.classList.remove('order-success');
                    } else if (data.hasOrder) {
                        // æœ‰è®¢å•æ‰§è¡Œä¸­
                        saveButton.textContent = 'å·²ä¸‹å•ï¼Œæ‰§è¡Œä¸­';
                        saveButton.classList.add('order-success');
                        saveButton.classList.remove('position-active');
                    } else {
                        // æ— æŒä»“æˆ–è®¢å•
                        saveButton.textContent = 'ä¿å­˜è®¾ç½®';
                        saveButton.classList.remove('order-success');
                        saveButton.classList.remove('position-active');
                    }
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    updateStatusIndicator(data.positionStatus, data.statusSummary);
                }
            })
            .catch(error => {
                console.error('Error checking position:', error);
            });
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatusIndicator(positionStatus, statusSummary) {
            const statusIndicator = document.getElementById('key-status-indicator');
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');
            
            if (statusIndicator && statusText) {
                statusIndicator.style.display = 'block';
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                if (statusSummary) {
                    statusText.textContent = statusSummary;
                } else {
                    const buyStatus = positionStatus && positionStatus.buy_flag ? 'æ¿€æ´»' : 'æœªæ¿€æ´»';
                    const sellStatus = positionStatus && positionStatus.sell_flag ? 'æ¿€æ´»' : 'æœªæ¿€æ´»';
                    statusText.textContent = `å¤šå¤´æŒä»“: ${buyStatus}, ç©ºå¤´æŒä»“: ${sellStatus}`;
                }
                
                // æ›´æ–°å›¾æ ‡
                if (positionStatus && (positionStatus.buy_flag || positionStatus.sell_flag)) {
                    statusIcon.textContent = 'âœ…';
                } else {
                    statusIcon.textContent = 'âš™ï¸';
                }
            }
        }
    </script>

    <script>
        // ç¡®ä¿ä¿è¯é‡‘è¾“å…¥æ¡†ç¨³å®šï¼Œç¦ç”¨æ‰€æœ‰åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            const marginContainer = document.getElementById('margin-input-container');
            if (marginContainer) {
                // ç§»é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´åŠ¨ç”»çš„ç±»
                marginContainer.classList.remove('hover-glow', 'element-animated', 'margin-highlight');
                
                // è®¾ç½®å†…è”æ ·å¼ä»¥è¦†ç›–ä»»ä½•åŠ¨ç”»
                marginContainer.style.transition = 'none';
                marginContainer.style.animation = 'none';
                marginContainer.style.transform = 'none';
                
                // è·å–è¾“å…¥æ¡†
                const input = marginContainer.querySelector('.uni-input-input');
                if (input) {
                    input.style.transition = 'none';
                    input.style.animation = 'none';
                }
            }
        });
    </script>
    
    <!-- æ·»åŠ è®¢å•ä¿¡æ¯ä¾§è¾¹æ˜¾ç¤ºåŒºåŸŸçš„HTMLç»“æ„ - åœ¨bodyæœ«å°¾æ·»åŠ  -->
    <div id="order-info-sidebar" class="order-info-sidebar" style="display: none; position: fixed; right: 20px; top: 20px; width: 30%; max-width: 350px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 9998; padding: 15px; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(100%); opacity: 0;">
        <div class="order-info-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
            <div style="display: flex; align-items: center;">
                <div style="margin-right: 10px;">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>
                </div>
                <h3 style="margin: 0; font-size: 16px;">è®¢å•ä¿¡æ¯</h3>
            </div>
            <button class="close-order-info" style="background: none; border: none; cursor: pointer; font-size: 16px; color: #999;">Ã—</button>
        </div>
        <div id="order-info-content"></div>
    </div>

    <script>
        // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
            const closeBtn = document.querySelector('.close-order-info');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    hideOrderInfo();
                });
            }
        });

        // æ˜¾ç¤ºè®¢å•ä¿¡æ¯å°çª—å£
        function showOrderInfo(orderResult, tradePair) {
            const orderInfoSidebar = document.getElementById('order-info-sidebar');
            const orderInfoContent = document.getElementById('order-info-content');
            
            if (!orderInfoSidebar || !orderInfoContent) return;
            
            // æ·»åŠ äº¤æ˜“å¯¹ä¿¡æ¯
            let htmlContent = `
                <div style="background: linear-gradient(135deg, #f0f7ff, #e6f7ff); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="color: #333; font-weight: 500;">äº¤æ˜“å¯¹:</span>
                    <span style="color: #1a6aff; font-weight: 600; font-size: 16px;">${tradePair}</span>
                </div>
                <div class="order-details" style="background: #f9fafc; border: 1px solid #f0f0f0; border-radius: 8px; padding: 15px;">
            `;
            
            // å®šä¹‰è¦æ˜¾ç¤ºçš„å­—æ®µå’Œå¯¹åº”çš„ä¸­æ–‡åç§°
            const fieldLabels = {
                'orderId': 'è®¢å•ID',
                'status': 'çŠ¶æ€',
                'exchangeId': 'äº¤æ˜“æ‰€',
                'direction': 'æ–¹å‘',
                'contractSize': 'åˆçº¦æ•°é‡',
                'margin': 'ä¿è¯é‡‘',
                'time': 'æ—¶é—´'
            };
            
            // æŒ‰é¡ºåºæ˜¾ç¤ºå­—æ®µ
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'time'];
            
            // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºè®¢å•ç»“æœæ•°æ®
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                    htmlContent += `
                        <div class="detail-row">
                            <span class="detail-label">${fieldLabels[key] || key}:</span>
                            <span class="detail-value" ${key === 'direction' ? 
                                `style="color: ${orderResult[key] === 'åšå¤š' ? '#52c41a' : '#ff4d4f'}; font-weight: 600;"` :
                                key === 'status' ? `style="color: #52c41a; font-weight: 600;"` : ''
                            }>${orderResult[key]}</span>
                        </div>
                    `;
                }
            });
            
            htmlContent += `
                </div>
                <p style="color: #8c8c8c; font-size: 14px; text-align: center; margin: 15px 0;">æ‚¨çš„è®¢å•å·²æˆåŠŸæäº¤ï¼Œå¯åœ¨äº¤æ˜“æ‰€æŸ¥çœ‹è®¢å•è¯¦æƒ…ã€‚</p>
            `;
            
            // æ›´æ–°å†…å®¹
            orderInfoContent.innerHTML = htmlContent;
            
            // æ˜¾ç¤ºä¾§è¾¹æ 
            orderInfoSidebar.style.display = 'block';
            
            // ä½¿ç”¨CSSåŠ¨ç”»ç±»æ§åˆ¶æ˜¾ç¤º
            orderInfoSidebar.classList.remove('order-info-slide-out');
            orderInfoSidebar.classList.add('order-info-slide-in');
            orderInfoSidebar.classList.add('show');
            
            // æ·»åŠ è‡ªåŠ¨å…³é—­
            setTimeout(() => {
                hideOrderInfo();
            }, 60000); // 60ç§’åè‡ªåŠ¨éšè—
        }

        // éšè—è®¢å•ä¿¡æ¯å°çª—å£
        function hideOrderInfo() {
            const orderInfoSidebar = document.getElementById('order-info-sidebar');
            if (!orderInfoSidebar) return;
            
            // ä½¿ç”¨CSSåŠ¨ç”»ç±»æ§åˆ¶éšè—
            orderInfoSidebar.classList.remove('order-info-slide-in');
            orderInfoSidebar.classList.remove('show');
            orderInfoSidebar.classList.add('order-info-slide-out');
            
            setTimeout(() => {
                orderInfoSidebar.style.display = 'none';
            }, 300);
        }
    </script>

    <!-- æ æ†å€æ•°ç›¸å…³åŠŸèƒ½ -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // è·å–æ æ†é€‰æ‹©å™¨å…ƒç´ 
        const leverageSelector = document.getElementById('leverage-selector');
        const leverageInput = document.getElementById('leverage-input');
        const leverageValue = document.getElementById('leverage-value');
        const leverageDropdown = document.getElementById('leverage-dropdown');
        const leverageOptionsList = document.getElementById('leverage-options-list');
        
        // æ æ†å€æ•°åˆ—è¡¨ - ä»HTMLé¢„åŠ è½½çš„æ•°æ®è·å–
        let leverageOptions = [1, 2, 3, 5, 10, 20, 50, 100]; // é»˜è®¤å€¼
        const defaultLeverageOptionsElem = document.getElementById('default-leverage-options');
        if (defaultLeverageOptionsElem && defaultLeverageOptionsElem.value) {
            try {
                const parsedOptions = JSON.parse(defaultLeverageOptionsElem.value);
                if (Array.isArray(parsedOptions) && parsedOptions.length > 0) {
                    leverageOptions = parsedOptions;
                }
            } catch (e) {
                console.error('è§£æé»˜è®¤æ æ†é€‰é¡¹å¤±è´¥', e);
            }
        }
        
        let selectedLeverage = 10; // é»˜è®¤é€‰æ‹©
        
        // å½“å‰é€‰ä¸­çš„äº¤æ˜“å¯¹
        let currentTradePair = '';
        const selectedCryptoPair = document.getElementById('selected-crypto-pair');
        if (selectedCryptoPair) {
            currentTradePair = selectedCryptoPair.value;
        }
        
        // åˆå§‹åŒ–æ—¶åŠ è½½å½“å‰äº¤æ˜“å¯¹çš„æ æ†å€æ•°
        if (currentTradePair) {
            loadLeverageOptions(currentTradePair);
        }
        
        // ç›‘å¬å¸ç§é€‰æ‹©å˜åŒ–
        document.querySelectorAll('.crypto-item').forEach(item => {
            item.addEventListener('click', function() {
                const tradePair = this.getAttribute('data-original');
                if (tradePair) {
                    currentTradePair = tradePair;
                    loadLeverageOptions(tradePair);
                }
            });
        });
        
        // ç‚¹å‡»æ æ†é€‰æ‹©å™¨æ˜¾ç¤ºä¸‹æ‹‰é¢æ¿
        leverageSelector.addEventListener('click', function(e) {
            // å¦‚æœä¸‹æ‹‰é¢æ¿å·²æ˜¾ç¤ºï¼Œåˆ™éšè—
            if (leverageDropdown.style.display === 'block') {
                // æ·»åŠ å¹³æ»‘å…³é—­æ•ˆæœ
                leverageDropdown.style.animation = 'fadeOut 0.2s ease forwards';
                
                setTimeout(() => {
                    leverageDropdown.style.display = 'none';
                    leverageSelector.classList.remove('dropdown-active');
                    leverageDropdown.style.animation = '';
                }, 200);
                return;
            }
            
            // ç»™é€‰æ‹©å™¨æ·»åŠ æ´»åŠ¨çŠ¶æ€æ ·å¼
            leverageSelector.classList.add('dropdown-active');
            
            // æ˜¾ç¤ºä¸‹æ‹‰é¢æ¿
            showLeverageDropdown();
        });
        
        // å…³é—­ä¸‹æ‹‰é¢æ¿çš„æŒ‰é’®
        const closeDropdownBtn = document.querySelector('.close-dropdown');
        if (closeDropdownBtn) {
            closeDropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                leverageDropdown.style.display = 'none';
                leverageSelector.classList.remove('dropdown-active');
            });
        }
        
        // ä¿®æ”¹ç‚¹å‡»å¤–éƒ¨å…³é—­é€»è¾‘ï¼Œæ·»åŠ å»¶è¿Ÿå’Œæ ‡ç­¾å¯è§æ€§ä¿æŠ¤
        let closeTimeout;
        document.addEventListener('click', function(e) {
            // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸‹æ‹‰é¢æ¿å†…æˆ–é€‰æ‹©å™¨å†…
            const isClickInside = leverageDropdown.contains(e.target) || leverageSelector.contains(e.target);
            
            // åªæœ‰å½“ç‚¹å‡»å¤–éƒ¨æ—¶æ‰å…³é—­ä¸‹æ‹‰é¢æ¿
            if (leverageDropdown.style.display === 'block' && !isClickInside) {
                // ç›´æ¥å…³é—­ä¸‹æ‹‰é¢æ¿ï¼Œæ— åŠ¨ç”»
                leverageDropdown.style.display = 'none';
                leverageSelector.classList.remove('dropdown-active');
                
                // ç¡®ä¿æ ‡ç­¾å§‹ç»ˆå¯è§
                const labelElement = document.querySelector('#leverage-selector .form-item-label');
                if (labelElement) {
                    labelElement.style.zIndex = '3';
                }
            }
        });

        // é˜»æ­¢ä¸‹æ‹‰é¢æ¿å†…çš„ç‚¹å‡»äº‹ä»¶è§¦å‘å…³é—­
        leverageDropdown.addEventListener('mousedown', function(e) {
            e.stopPropagation();
        });

        // é˜»æ­¢ä¸‹æ‹‰é¢æ¿å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        leverageDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // ä»APIåŠ è½½æ æ†å€æ•°é€‰é¡¹
        function loadLeverageOptions(tradePair) {
            // æ˜¾ç¤ºåŠ è½½ä¸­
            leverageInput.value = 'åŠ è½½ä¸­...';
            
            // è°ƒç”¨APIè·å–æ æ†å€æ•°
            fetch(`/api/trading/leverage?trade_pair=${tradePair}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // æ›´æ–°æ æ†é€‰é¡¹
                        leverageOptions = data.data.leverage_options;
                        // æ›´æ–°å½“å‰æ æ†
                        selectedLeverage = data.data.current_leverage;
                        leverageInput.value = `${selectedLeverage}X`;
                        leverageValue.value = selectedLeverage;
                        
                        // æ›´æ–°ä¿è¯é‡‘å€¼
                        if (typeof updateMarginFromLeverage === 'function') {
                            updateMarginFromLeverage(selectedLeverage);
                        }
                        
                        console.log(`å·²åŠ è½½äº¤æ˜“å¯¹ ${tradePair} çš„æ æ†å€æ•°:`, leverageOptions);
                    } else {
                        console.warn('è·å–æ æ†å€æ•°å¤±è´¥:', data.message);
                        // è®¾ç½®é»˜è®¤æ æ†
                        leverageInput.value = '10X';
                        leverageValue.value = 10;
                    }
                })
                .catch(error => {
                    console.error('è·å–æ æ†å€æ•°å‡ºé”™:', error);
                    // è®¾ç½®é»˜è®¤æ æ†
                    leverageInput.value = '10X';
                    leverageValue.value = 10;
                });
        }
        
        // æ˜¾ç¤ºæ æ†é€‰æ‹©ä¸‹æ‹‰é¢æ¿
        function showLeverageDropdown() {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            leverageOptionsList.innerHTML = '';
            
            // ç¡®ä¿æ ‡ç­¾å§‹ç»ˆå¯è§
            const labelElement = document.querySelector('#leverage-selector .form-item-label');
            if (labelElement) {
                labelElement.style.zIndex = '3';
            }
            
            // æ·»åŠ æ æ†é€‰é¡¹
            leverageOptions.forEach(function(leverage) {
                const option = document.createElement('div');
                option.className = 'leverage-option';
                if (leverage === selectedLeverage) {
                    option.classList.add('selected');
                }
                option.textContent = `${leverage}`;
                option.setAttribute('data-value', leverage);
                
                // æ·»åŠ ä¸€ä¸ªæ ‡è®°ç”¨äºæ ·å¼åŒ–
                const badge = document.createElement('span');
                badge.className = 'leverage-badge';
                badge.textContent = 'X';
                badge.style.marginLeft = '3px';
                badge.style.fontSize = '14px';
                badge.style.opacity = '0.7';
                option.appendChild(badge);
                
                // ç‚¹å‡»é€‰é¡¹äº‹ä»¶
                option.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    const leverageVal = parseInt(this.getAttribute('data-value'));
                    selectedLeverage = leverageVal;
                    leverageInput.value = `${leverageVal}X`;
                    document.getElementById('leverage-value').value = leverageVal;
                    
                    // ä¸ºæ‰€æœ‰é€‰é¡¹ç§»é™¤é€‰ä¸­æ ·å¼
                    document.querySelectorAll('.leverage-option').forEach(function(opt) {
                        opt.classList.remove('selected');
                    });
                    
                    // ä¸ºå½“å‰é€‰é¡¹æ·»åŠ é€‰ä¸­æ ·å¼
                    this.classList.add('selected');
                    
                    // æ›´æ–°ä¿è¯é‡‘å€¼
                    if (typeof updateMarginFromLeverage === 'function') {
                        updateMarginFromLeverage(leverageVal);
                    }
                    
                    // ç®€å•éšè—ä¸‹æ‹‰é¢æ¿ï¼Œæ— åŠ¨ç”»
                    leverageDropdown.style.display = 'none';
                    leverageSelector.classList.remove('dropdown-active');
                    
                    // æ˜¾ç¤ºæç¤º
                    if (typeof showToast === 'function') {
                        showToast(`å·²è®¾ç½®æ æ†å€æ•°: ${leverageVal}X`);
                    }
                });
                
                leverageOptionsList.appendChild(option);
            });
            
            // æ˜¾ç¤ºä¸‹æ‹‰é¢æ¿ï¼Œæ— åŠ¨ç”»
            leverageDropdown.style.display = 'block';
            
            // ç¡®ä¿é€‰ä¸­çš„é€‰é¡¹åœ¨è§†å›¾ä¸­å¯è§
            setTimeout(function() {
                const selectedOption = leverageOptionsList.querySelector('.selected');
                if (selectedOption) {
                    selectedOption.scrollIntoView({ block: 'nearest' });
                }
            }, 100);
        }

        // ä¿®æ”¹ç‚¹å‡»å¤–éƒ¨å…³é—­é€»è¾‘ï¼Œç§»é™¤åŠ¨ç”»æ•ˆæœ
        document.addEventListener('click', function(e) {
            // æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æ˜¯å¦åœ¨ä¸‹æ‹‰é¢æ¿å†…æˆ–é€‰æ‹©å™¨å†…
            const isClickInside = leverageDropdown.contains(e.target) || leverageSelector.contains(e.target);
            
            // åªæœ‰å½“ç‚¹å‡»å¤–éƒ¨æ—¶æ‰å…³é—­ä¸‹æ‹‰é¢æ¿
            if (leverageDropdown.style.display === 'block' && !isClickInside) {
                // ç›´æ¥å…³é—­ä¸‹æ‹‰é¢æ¿ï¼Œæ— åŠ¨ç”»
                leverageDropdown.style.display = 'none';
                leverageSelector.classList.remove('dropdown-active');
                
                // ç¡®ä¿æ ‡ç­¾å§‹ç»ˆå¯è§
                const labelElement = document.querySelector('#leverage-selector .form-item-label');
                if (labelElement) {
                    labelElement.style.zIndex = '3';
                }
            }
        });

        // ç‚¹å‡»æ æ†é€‰æ‹©å™¨æ˜¾ç¤ºä¸‹æ‹‰é¢æ¿
        leverageSelector.addEventListener('click', function(e) {
            // å¦‚æœä¸‹æ‹‰é¢æ¿å·²æ˜¾ç¤ºï¼Œåˆ™éšè—
            if (leverageDropdown.style.display === 'block') {
                // ç›´æ¥éšè—ï¼Œæ— åŠ¨ç”»
                leverageDropdown.style.display = 'none';
                leverageSelector.classList.remove('dropdown-active');
                return;
            }
            
            // ç»™é€‰æ‹©å™¨æ·»åŠ æ´»åŠ¨çŠ¶æ€æ ·å¼
            leverageSelector.classList.add('dropdown-active');
            
            // æ˜¾ç¤ºä¸‹æ‹‰é¢æ¿
            showLeverageDropdown();
        });
    });
    </script>

    <!-- æ·»åŠ æ ·å¼ -->
    <style>
    /* æ æ†é€‰æ‹©ä¸‹æ‹‰é¢æ¿æ ·å¼ - å¢å¼ºç‰ˆ */
    .leverage-dropdown {
        position: absolute;
        z-index: 99; /* é™ä½z-indexï¼Œç¡®ä¿ä¸ä¼šè¦†ç›–æ ‡ç­¾ */
        top: calc(100% + 10px); /* å¢åŠ ä¸ä¸Šæ–¹å…ƒç´ çš„é—´è· */
        left: 0;
        right: 0;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 
                    0 5px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e6f7ff;
        overflow: hidden;
        animation: fadeInDown 0.3s ease;
        min-width: 240px;
        transform-origin: top center;
    }
    
    /* ä¿®å¤ä¸‹æ‹‰æ¡†å’Œæ ‡ç­¾çš„å±‚çº§é—®é¢˜ */
    #leverage-selector {
        position: relative;
        z-index: 1;
    }
    
    #leverage-selector .form-item-label {
        position: relative;
        z-index: 3 !important; /* ç¡®ä¿æ ‡ç­¾å§‹ç»ˆåœ¨æœ€é¡¶å±‚ */
    }
    
    #leverage-selector.dropdown-active .form-item-input {
        z-index: 2;
    }
    
    /* ç¡®ä¿ä¸‹æ‹‰æ¡†å…³é—­åä¸å½±å“å¸ƒå±€ */
    #leverage-dropdown[style*="display: none"] {
        visibility: hidden;
        pointer-events: none;
        opacity: 0;
        transform: translateY(-5px);
    }
    
    /* å¢å¼ºå…³é—­åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-5px);
        }
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .leverage-dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        background: linear-gradient(135deg, #f8faff, #edf3ff);
    }

    .leverage-dropdown-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1a6aff;
    }

    .close-dropdown {
        color: #8c8c8c;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .close-dropdown:hover {
        color: #555;
        background-color: rgba(0, 0, 0, 0.05);
    }

    .leverage-dropdown-body {
        max-height: 320px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 8px 0;
    }

    .leverage-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* æ æ†é€‰é¡¹æ ·å¼ - å¯¹é½ä¼˜åŒ–ç‰ˆ */
    .leverage-option {
        padding: 14px 24px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        transition: all 0.2s ease;
        height: 54px;
        color: #333;
        font-weight: 500;
        margin: 0 8px;
        border-radius: 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .leverage-option:hover {
        background-color: #f0f7ff !important;
        transform: translateX(0);
        border-left: 4px solid #1a6aff;
        margin-left: 4px;
    }

    .leverage-option:last-child {
        border-bottom: none;
    }

    /* å•é€‰æ¡†æ ·å¼ */
    .leverage-option:before {
        content: "";
        display: inline-block;
        width: 22px;
        height: 22px;
        border: 2px solid #e0e0e0;
        border-radius: 50%;
        margin-right: 14px;
        transition: all 0.2s ease;
        flex-shrink: 0;
        box-sizing: border-box;
    }

    /* æ æ†å¾½ç« æ ·å¼ */
    .leverage-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #777;
        margin-left: 4px;
    }

    /* æ æ†å€æ•°æ˜¾ç¤º */
    .leverage-option .leverage-value {
        font-weight: 600;
        color: #666;
        padding-right: 10px;
    }
    
    .leverage-option .leverage-badge {
        color: #999;
        font-size: 14px;
        margin-left: 4px;
        flex-shrink: 0;
        width: 20px;
        text-align: center;
    }

    /* æ‚¬åœæ•ˆæœ */
    .leverage-option:hover {
        background-color: #f7faff;
    }

    .leverage-option:hover:after {
        background-color: #e7f0ff;
        color: #1a6aff;
        transform: translateY(-50%);
    }

    .leverage-option:active {
        background-color: #edf3ff;
    }

    /* é€‰ä¸­çŠ¶æ€æ ·å¼ - å¢å¼ºç‰ˆ */
    .leverage-option.selected {
        color: #1a6aff;
        font-weight: 700;
        background-color: #e6f7ff;
        box-shadow: 0 0 0 2px rgba(26, 106, 255, 0.2);
        border-left: 4px solid #1a6aff;
    }

    .leverage-option.selected:hover {
        background-color: #e6f7ff !important;
    }

    .leverage-option.selected:after {
        background-color: #1a6aff;
        color: white;
        box-shadow: 0 2px 8px rgba(26, 106, 255, 0.3);
    }

    .leverage-option.selected:before {
        border-color: #1a6aff;
        background-color: #1a6aff;
        box-shadow: inset 0 0 0 4px #fff;
    }

    /* è¾“å…¥æ¡†æ ·å¼ä¼˜åŒ– - æ›´é†’ç›®ç‰ˆæœ¬ */
    #leverage-selector {
        position: relative;
        cursor: pointer;
        padding: 12px 0;
        margin: 15px 0;
    }

    #leverage-selector .form-item-input {
        background: linear-gradient(135deg, #1a6aff, #3f87ff);
        border: 3px solid #0c449d;
        border-radius: 12px;
        transition: all 0.3s ease;
        height: 60px;
        box-shadow: 0 6px 20px rgba(26, 106, 255, 0.4);
    }

    #leverage-selector .form-item-input:hover {
        box-shadow: 0 8px 25px rgba(26, 106, 255, 0.6);
    }

    #leverage-selector .uni-input-input {
        font-weight: 900;
        color: white !important;
        font-size: 22px;
        background-color: transparent;
        height: 54px;
        line-height: 54px;
        cursor: pointer;
        padding-left: 25px;
        letter-spacing: 1.5px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    #leverage-selector:hover .form-item-input {
        transform: translateY(0);
        box-shadow: 0 6px 20px rgba(26, 106, 255, 0.5);
        border-color: #1a6aff;
        animation: none;
    }

    #leverage-selector:active .form-item-input {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(26, 106, 255, 0.3);
    }

    /* ä¸‹æ‹‰ç®­å¤´åŠ¨ç”» */
    #leverage-selector .input-right .u-icon__icon {
        color: #1a6aff;
        font-size: 18px !important;
        animation: none;
    }

    #leverage-selector.dropdown-active .input-right .u-icon__icon {
        transform: rotate(180deg);
        color: white !important;
        font-size: 24px !important;
    }

    /* æ‚¬åœæ•ˆæœå¢å¼º */
    #leverage-selector:hover .form-item-input {
        transform: translateY(0);
        box-shadow: 0 6px 20px rgba(26, 106, 255, 0.5);
        border-color: #1a6aff;
        animation: none;
    }

    #leverage-selector:active .form-item-input {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(26, 106, 255, 0.3);
    }

    /* æç¤ºæ–‡æœ¬ */
    #leverage-selector:after {
        content: "ç‚¹å‡»é€‰æ‹©æ æ†å€æ•°";
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 100;
        white-space: nowrap;
    }

    #leverage-selector:hover:after {
        opacity: 1;
    }

    /* æ æ†é€‰æ‹©å™¨é«˜äº®åŠ¨ç”» */
    @keyframes highlightPulse {
        0% { box-shadow: 0 0 0 0 rgba(26, 106, 255, 0.2); }
        70% { box-shadow: 0 0 0 0 rgba(26, 106, 255, 0.1); }
        100% { box-shadow: 0 0 0 0 rgba(26, 106, 255, 0.0); }
    }

    /* æ æ†é€‰æ‹©å™¨æ·»åŠ æç¤ºå’Œé«˜äº®æ•ˆæœ */
    #leverage-selector {
        position: relative;
    }
    
    /* åˆæ¬¡åŠ è½½æ—¶æ·»åŠ ä¸€ä¸ªåŠ¨ç”»ï¼Œå¸å¼•ç”¨æˆ·æ³¨æ„ */
    #leverage-selector:after {
        content: "å¯ç‚¹å‡»é€‰æ‹©æ æ†å€æ•°";
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 100;
        white-space: nowrap;
    }
    
    #leverage-selector:hover:after {
        opacity: 1;
    }
    
    /* è®©è¾“å…¥æ¡†çœ‹èµ·æ¥æ›´åƒæŒ‰é’® */
    #leverage-selector .form-item-input {
        background-color: #f8f9fa;
        border: 1px solid #e8e8e8;
        transition: all 0.3s ease;
    }
    
    #leverage-selector:hover .form-item-input {
        background-color: #f0f7ff;
        border-color: #1a6aff;
        animation: highlightPulse 2s infinite;
    }
    
    /* æ›´æ˜æ˜¾çš„ä¸‹æ‹‰æŒ‡ç¤ºå™¨ */
    #leverage-selector .input-right .u-icon__icon {
        color: #1a6aff;
        font-size: 18px !important;
        animation: bounce 1.5s ease infinite;
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(0); }
    }

    /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„ç‰¹æ®Šå¤„ç† */
    @media (max-width: 767px) {
        .leverage-dropdown {
            position: fixed;
            top: auto;
            bottom: 0;
            left: 0;
            right: 0;
            margin-top: 0;
            border-radius: 16px 16px 0 0;
            max-height: 80vh;
            animation: slideUp 0.3s ease;
            z-index: 10000; /* ç¡®ä¿åœ¨é¡¶å±‚ */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .leverage-dropdown-body {
            max-height: 60vh;
            padding-bottom: env(safe-area-inset-bottom, 20px); /* é€‚é…iOSåº•éƒ¨å®‰å…¨åŒºåŸŸ */
        }
        
        /* ç§»åŠ¨è®¾å¤‡ä¸Šé€‰é¡¹æ›´å¤§ï¼Œä¾¿äºè§¦æ‘¸ */
        .leverage-option {
            padding: 18px 20px; /* ç§»åŠ¨ç«¯æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
            font-size: 16px;
            min-height: 60px; /* ç§»åŠ¨ç«¯æ›´é«˜çš„æœ€å°é«˜åº¦ */
        }
        
        .leverage-option:before {
            width: 24px; /* ç§»åŠ¨ç«¯æ›´å¤§çš„é€‰æ‹©æ¡† */
            height: 24px;
            margin-right: 16px;
        }
        
        /* æ·»åŠ èƒŒæ™¯é®ç½© */
        .leverage-dropdown:before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        
        /* ç§»åŠ¨ç«¯é¡¶éƒ¨æ‹–åŠ¨æ¡ */
        .leverage-dropdown-header:before {
            content: "";
            display: block;
            width: 40px;
            height: 5px;
            background-color: #ddd;
            border-radius: 3px;
            margin: 0 auto 12px;
        }
        
        .leverage-dropdown-header {
            flex-direction: column;
            padding-top: 12px;
            background: #fff;
        }
        
        .leverage-dropdown-header h3 {
            font-size: 17px;
            margin-bottom: 5px;
        }
        
        /* å…³é—­æŒ‰é’®ä½ç½®è°ƒæ•´ */
        .close-dropdown {
            position: absolute;
            top: 12px;
            right: 15px;
            font-size: 24px;
            background-color: rgba(0, 0, 0, 0.05);
            width: 32px;
            height: 32px;
        }
        
        /* ç§»åŠ¨ç«¯é€‰é¡¹çš„å¾½ç« æ ·å¼ */
        .leverage-option:after {
            font-size: 15px;
            padding: 5px 14px;
            background-color: #f0f7ff;
        }
    }

    /* æ›´æ–°dropdown-activeç±»ä¸­çš„ç®­å¤´å˜æ¢ï¼Œç§»é™¤æ”¾å¤§æ•ˆæœ */
    #leverage-selector.dropdown-active .input-right .u-icon__icon {
        transform: rotate(180deg);
        color: white !important;
        font-size: 18px !important;
    }
    
    /* ä¿®æ”¹æ æ†é€‰æ‹©å™¨çš„åŠ¨ç”» */
    #leverage-selector:hover .form-item-input {
        animation: none !important;
    }
    
    /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šç§»é™¤æ»‘åŠ¨æ•ˆæœ */
    @media (max-width: 767px) {
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
    }
    </style>
</body>
</html>
