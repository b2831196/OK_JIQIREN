<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能交易 - 策略设置</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/crypto-theme.css">
    <style>
        /* 页面基础样式 */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        /* 已下单状态按钮样式 */
        .confirm-btn.order-success {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }
        
        .confirm-btn.order-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
            background: linear-gradient(135deg, #46b314, #66c832);
        }
        
        /* 已持仓状态按钮样式 */
        .confirm-btn.position-active {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }
        
        .confirm-btn.position-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
            background: linear-gradient(135deg, #096dd9, #1f9fff);
        }
        
        /* 导航栏样式 */
        .u-navbar {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }
        
        .u-navbar__content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            padding: 0 15px;
        }
        
        .u-navbar__content__left {
            position: absolute;
            left: 15px;
            display: flex;
            align-items: center;
        }
        
        .u-navbar__content__title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .u-icon__icon {
            font-size: 20px;
            color: #ffffff;
            transition: transform 0.2s ease;
        }
        
        .u-icon__icon:hover {
            transform: scale(1.1);
        }
        
        /* 主要内容区域 */
        .robot-settings {
            margin-top: 70px;
            padding: 15px;
        }
        
        /* 卡片式容器 */
        .box {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .box:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.11);
            transform: translateY(-2px);
        }
        
        .box-card {
            padding: 22px;
        }
        
        /* 顶部资产信息 */
        .top-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .top-left {
            display: flex;
            flex-direction: column;
        }
        
        .available-m {
            font-size: 14px;
            color: #8c8c8c;
            margin-right: 8px;
        }
        
        .refresh-img {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .refresh-img:hover {
            transform: rotate(90deg);
        }
        
        .now-money {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
            margin-top: 5px;
            letter-spacing: 0.5px;
        }
        
        .top-right {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .coin-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 2px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .change-img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .change-img:hover {
            opacity: 1;
        }
        
        /* 表单项样式 */
        .self-forms {
            margin-top: 15px;
        }
        
        .forms-item {
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .forms-item:hover {
            transform: translateY(-2px);
        }
        
        .form-item-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-size: 15px;
            color: #262626;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .form-item-input {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .form-item-input:focus-within {
            box-shadow: 0 0 0 2px rgba(51, 102, 255, 0.2);
        }
        
        .input-border {
            border: 1px solid #e8e8e8;
        }
        
        .robot-info {
            display: flex;
            align-items: center;
        }
        
        .robot-name {
            margin-left: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #262626;
        }
        
        .input-right {
            margin-left: auto;
            color: #3366FF;
        }
        
        /* 策略类型选择 */
        .type-scroll {
            display: flex;
            overflow-x: auto;
            margin: 10px 0;
            padding: 8px 0;
            scrollbar-width: none; /* Firefox */
        }
        
        .type-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .scroll-li-types {
            min-width: 100px;
            height: 44px;
            border-radius: 22px;
            background-color: #f9fafc;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #5c5c5c;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .scroll-li-types:hover {
            background-color: #edf2ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(51, 102, 255, 0.15);
        }
        
        .type-actives {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.3);
            border: none;
        }
        
        /* 滑块样式 */
        .gress-box {
            margin: 15px 0;
            padding: 5px 0;
            width: 100%;
        }
        
        .sunny-sliderBar {
            width: 100%;
        }
        
        /* 进度条样式优化，修复背景出界问题 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            max-width: 100% !important;
            overflow: hidden;
        }
        
        /* 滑动条容器增强 */
        .sliderBar {
            cursor: pointer;
            background: linear-gradient(to bottom, #f0f0f0, #f9fafc);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
            border-radius: 22px;
            position: relative;
            border: 1px solid rgba(220, 220, 220, 0.9);
            height: 44px;
            overflow: hidden;
        }
        
        .img-box {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .move-img {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .move-img:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .dot-indicator {
            width: 14px;
            height: 14px;
            background-color: #fff;
            border: 2px solid var(--primaryColor, #1a6aff);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(26, 106, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .move-img:hover .dot-indicator {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.3);
        }
        
        .bili-text {
            position: absolute;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .move-img:hover .bili-text {
            color: #1a6aff;
            font-weight: 600;
        }
        
        .gone {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            z-index: 1;
            transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .slider {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(51, 102, 255, 0.4);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) inset;
        }
        
        .slider::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        .slider:hover {
            box-shadow: 0 5px 18px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .slider:active {
            box-shadow: 0 2px 8px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(0.98);
        }
        
        .count {
            color: rgba(255, 255, 255, 0);
            font-size: 13px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a6aff;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .slider:hover .count {
            color: rgba(255, 255, 255, 1);
            opacity: 1;
            bottom: -30px;
        }
        
        .position-slider-container {
            padding: 15px 0;
        }
        
        /* 底部按钮 */
        .confirm-bot-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background-color: white;
            z-index: 90;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.08);
        }
        
        .confirm-btn {
            width: 100%;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            font-size: 16px;
            font-weight: 500;
            border: none;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
            letter-spacing: 1px;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 102, 255, 0.35);
            background: linear-gradient(135deg, #0a5aea, #2d78ff);
        }
        
        .confirm-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(51, 102, 255, 0.3);
        }
        
        /* 开关样式 */
        .toggle-wrapper {
            width: 60px;
            height: 32px;
            position: relative;
            background-color: #e8e8e8;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-background {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: block;
            transition: all 0.3s ease;
        }
        
        .toggle-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        .active-lis .toggle-background {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
        }
        
        .active-lis .toggle-indicator {
            transform: translateX(28px);
        }
        
        /* 单选框样式 */
        .radio-box {
            display: flex;
            flex-wrap: wrap;
            margin: 5px 0;
        }
        
        .u-radio {
            margin-right: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        
        .u-radio:hover {
            color: #3366FF;
        }
        
        .u-radio__icon-wrap {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c8c9cc;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .u-radio__icon-wrap--circle {
            background-color: #fff;
        }
        
        /* 修改原有样式 */
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .settings-row:hover {
            background-color: #f9fafc;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 15px;
            color: #454545;
            font-weight: 500;
        }
        
        .setting-value {
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .arrow-right {
            margin-left: 10px;
            color: #c0c4cc;
            transition: transform 0.2s ease;
        }
        
        .settings-row:hover .arrow-right {
            transform: translateX(3px);
            color: #3366FF;
        }
        
        /* 添加uni-app风格组件样式 */
        .f-1 {
            flex: 1;
        }
        
        .box2 {
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .box2:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.09);
        }
        
        .flexs {
            display: flex;
            align-items: center;
        }
        
        .flex-x {
            display: flex;
            align-items: center;
        }
        
        .flex-y {
            display: flex;
            flex-direction: column;
        }
        
        .flex-x-b {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .flex-x-c {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flex-y-c {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .f-s {
            display: flex;
            align-items: center;
        }
        
        .theme-border-color {
            border-color: #e8e8e8;
        }
        
        .theme-border-color2 {
            border-color: #f5f7fa;
        }
        
        .box-bg1 {
            background-color: #f5f7fa;
        }
        
        .margin_r1 {
            margin-right: 10px;
        }
        
        .margin_b1 {
            margin-bottom: 18px;
        }
        
        .lable-name {
            font-size: 15px;
            color: #262626;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .type-box {
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .type-li {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .type-active {
            background: linear-gradient(135deg, #3366FF, #5C91EF);
            color: white;
        }
        
        .icon-box {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        
        .uni-input-input {
            height: 36px;
            width: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 15px;
            color: #262626;
            font-weight: 500;
        }
        
        .uni-input-wrapper {
            width: 100%;
            position: relative;
        }
        
        .myicon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        
        .icon-Choose:before {
            content: "\f0c9";
        }
        
        /* 滑块相关样式补充 */
        .gress-box {
            margin: 10px 0;
            padding: 10px 5px;
            width: 100%;
        }
        
        .uni-input-placeholder {
            color: #999;
            font-size: 14px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
        }
        
        .uicon-question-circle:before {
            content: "\f059";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-right:before {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-down-fill:before {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
        }
        
        /* 修改滑块组件样式 */
        .position-slider-container {
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* 添加动画和过渡效果 */
        .element-animated {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .title-animated {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .row-clicked {
            background-color: #f0f7ff !important;
        }
        
        .btn-clicked {
            transform: scale(0.95) !important;
        }
        
        .slider-active {
            box-shadow: 0 5px 15px rgba(51, 102, 255, 0.5) !important;
        }
        
        .page-loaded .u-navbar {
            transform: translateY(0);
        }
        
        /* Toast消息提示 */
        .toast-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background-color: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 9999;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 80%;
            font-weight: 500;
        }
        
        .toast-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 新增高级样式 */
        .premium-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #ffb700, #ffd869);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 2px 6px rgba(255, 183, 0, 0.3);
        }
        
        .premium-icon i {
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .premium-strategy {
            position: relative;
        }
        
        .premium-strategy::after {
            content: "推荐";
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
        }
        
        /* 新增按钮悬停效果 */
        .hover-glow {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(26, 106, 255, 0.4);
        }
        
        /* 动画关键帧增强 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 新增投入金额高亮效果 - 已修改为无动画 */
        .margin-highlight {
            box-shadow: 0 0 0 2px rgba(26, 106, 255, 0.3);
        }
        
        /* 杠杆选择框样式优化 */
        .leverage-dialog {
            animation: fadeInUp 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .leverage-option {
            position: relative;
            overflow: hidden;
        }
        
        .leverage-option::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 106, 255, 0.05);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: -1;
        }
        
        .leverage-option:hover::before {
            transform: scaleX(1);
        }
        
        /* 页面初始化状态 */
        .u-navbar {
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        
        /* 滑块颜色样式 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }
        
        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }
        
        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }

        /* 滑块动画效果 */
        .slider-active {
            transform: scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }

        .slider-pulse {
            animation: pulse 0.3s ease-out;
        }

        .slider-done {
            animation: done 0.5s ease-out;
        }

        .dot-active {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(26, 106, 255, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 3;
        }

        @keyframes pulse {
            0% { transform: scale(1) translateX(var(--x-position, 0)); }
            50% { transform: scale(1.2) translateX(var(--x-position, 0)); }
            100% { transform: scale(1) translateX(var(--x-position, 0)); }
        }

        @keyframes done {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }

        /* 滑动条容器增强样式 */
        .sliderBar {
            cursor: pointer;
            background-color: #f5f7fa;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 进度条样式增强 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 4px;
        }

        /* 滑块增强样式 */
        .slider {
            cursor: grab;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
            z-index: 4;
        }
        
        .slider:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(26, 106, 255, 0.6);
        }
        
        .slider:active {
            cursor: grabbing;
        }

        /* 百分比显示样式增强 */
        .slider .count {
            background-color: #1a6aff;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider:hover .count {
            transform: translateY(-5px) scale(1.1);
        }

        /* 固定点样式增强 */
        .move-img {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border: 1px solid #e4e7ed;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 3;
        }
        
        .move-img:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.4);
        }
        
        /* 滑块点指示器 */
        .dot-indicator {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dot-indicator::after {
            content: "";
            width: 6px;
            height: 6px;
            background-color: #1a6aff;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .move-img:hover .dot-indicator::after {
            transform: scale(1.5);
        }
        
        /* 滑块优化 */
        #position-slider-percent {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
        }
        
        #position-slider-percent:active {
            cursor: grabbing;
            transform: scale(1.1) translateX(var(--x-pos, 0px));
        }
        
        #position-slider-percent .count {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 50px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            background-color: #1a6aff;
            color: white;
            border-radius: 13px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.3s;
        }
        
        /* 修复动画效果 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out;
        }
        
        .slider-done {
            animation: sliderDone 0.5s ease-out;
        }
        
        @keyframes sliderPulse {
            0% { transform: scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: scale(1.2) translateX(var(--x-pos, 0px)); }
            100% { transform: scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        /* 保证金输入框更强优化 - 彻底消除跳动 */
        .form-item-input.margin-input {
            height: 56px; /* 固定高度 */
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.9);
            background: linear-gradient(to bottom, #f9fafc, #fff);
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 保证输入框内部元素不引起跳动 */
        .form-item-input.margin-input .uni-input-wrapper {
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .form-item-input.margin-input .uni-input-input {
            font-family: 'Roboto Mono', monospace, 'Segoe UI', 'PingFang SC';
            font-size: 16px;
            letter-spacing: 0.5px;
            height: 100%;
            line-height: 56px; /* 与容器高度相同 */
            transition: all 0.2s ease;
        }
        
        /* 右侧单位固定位置和尺寸 */
        .margin-value-container {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px; /* 固定宽度 */
            font-size: 16px;
        }
        
        /* 滑块球体居中 */
        #position-slider-percent {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
            backdrop-filter: blur(4px);
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%) translateX(0); /* 垂直居中并保留水平移动能力 */
        }
        
        /* 更新滑块球体在激活和交互状态的变形样式 */
        #position-slider-percent:active {
            cursor: grabbing;
            transform: translateY(-50%) scale(1.05) translateX(var(--x-pos, 0px));
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }
        
        .slider-active {
            transform: translateY(-50%) scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }
        
        /* 修复动画关键帧，保持垂直居中 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        /* 百分比值显示 */
        #position-value-percent {
            transition: color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            min-width: 50px;
            text-align: right;
        }
        
        #position-value-percent:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: right;
            opacity: 0.7;
        }
        
        #position-value-percent:hover:after {
            transform: scaleX(1);
        }
        
        /* 动画关键帧增强 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 25px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 15px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 8px rgba(26, 106, 255, 0.3); }
        }
        
        .dot-active {
            animation: dotPulse 0.5s ease-out;
        }

        /* 数值变化动画 */
        .value-changing {
            animation: value-pulse 0.3s ease;
        }

        @keyframes value-pulse {
            0% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 添加滑块滑动时的样式，确保其垂直居中 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out !important;
        }

        /* 更新HTML中的滑块初始样式 */
        <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
            <span class="count">100%</span>
        </div>

        /* 为数字输入添加额外的反跳动防护 */
        .uni-input-input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield;
            margin: 0;
            padding: 0 15px; /* 统一内边距，防止跳动 */
            width: 100%;
        }

        /* 消除数字输入框的上下箭头，避免高度变化 */
        .uni-input-input[type="number"]::-webkit-inner-spin-button,
        .uni-input-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 添加数值平滑过渡效果 */
        .form-item-input.margin-input .uni-input-input {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 输入值变化时的动画优化 */
        .value-changing {
            animation: value-pulse 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes value-pulse {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 确保USDT单位有固定尺寸 */
        .margin-value-container span {
            min-width: 45px;
            text-align: center;
            display: block;
            font-size: 15px;
            font-weight: 600;
        }

        /* 不同颜色进度条的样式 */
        .progress-red {
            background: linear-gradient(135deg, rgba(255, 77, 79, 0.25), rgba(255, 120, 117, 0.25)) !important;
        }

        .progress-yellow {
            background: linear-gradient(135deg, rgba(250, 173, 20, 0.25), rgba(255, 197, 61, 0.25)) !important;
        }

        .progress-blue {
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25)) !important;
        }

        /* 滑块的颜色样式增强 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }

        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }

        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }
        
        /* 模态窗口样式 */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-container.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .order-details {
            width: 100%;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        
        .detail-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            max-width: 60%;
            word-break: break-all;
            text-align: right;
        }
        
        .modal-confirm-btn {
            background-color: #1a6aff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .modal-confirm-btn:hover {
            background-color: #0052d9;
        }
        
        .error-modal .modal-content {
            border-top: 4px solid #ff4d4f;
        }
        
        .error-icon {
            margin: 10px 0 20px;
            color: #ff4d4f;
        }
        
        .modal-message {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-modal .modal-confirm-btn {
            background-color: #ff4d4f;
        }
        
        .error-modal .modal-confirm-btn:hover {
            background-color: #ff1f1f;
        }

        /* 币种选择弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-search {
            margin-bottom: 15px;
        }
        
        .modal-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-body {
            overflow-y: auto;
            flex: 1;
        }
        
        .crypto-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .crypto-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .crypto-item:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .crypto-item.selected {
            background-color: #e6f0ff;
            border: 1px solid #1a6aff;
        }
        
        .crypto-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .crypto-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* 续下单按钮动画效果 */
        #continue-order-btn {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #continue-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
            z-index: -1;
        }
        
        #continue-order-btn:hover::before {
            left: 100%;
        }
    
        /* 禁用保证金输入框的所有动画和过渡 */
        #margin-input-container,
        #margin-input-container *,
        .margin-input,
        .uni-input-input {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }
        
        /* 禁用值变化动画 */
        .value-changing {
            animation: none !important;
            transition: none !important;
        }
        
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="u-navbar">
        <div class="u-navbar__content">
            <div class="u-navbar__content__left">
                <i class="fas fa-arrow-left u-icon__icon" onclick="goBackToContract()"></i>
            </div>
            <div class="u-navbar__content__title">{{ strategy.name }}</div>
            <div class="u-navbar__content__right"></div>
        </div>
        </div>
        
    <div class="robot-settings">
        <!-- 顶部资产信息 -->
        <div class="forms box box-card margin_t2 hover-glow">
            <div class="top-box">
                <div class="top-left">
                    <div class="flex-x">
                        <span class="available-m">可用资产</span>
                        <img src="/static/newimg/refresh.png" class="refresh-img" alt="刷新">
                    </div>
                    <span class="now-money">{{ strategy.invested }} USDT</span>
                </div>
                <div class="top-right">
                    <img src="https://newrobot.idyyvv.top/image/20210823/ff380e5a4eac6a36fbf7dde5ed153745.png" class="coin-img" alt="交易所">
                    <div class="flex-x">
                        <img src="/static/newimg/change.png" class="change-img" alt="切换">
                        <span class="now-money">Binance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表单内容 -->
        <div class="self-forms">
            <!-- 币种选择 -->
            <div class="forms-item f-1 box2 hover-glow" id="crypto-selector">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                        <div class="premium-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <img id="selected-crypto-icon" src="https://ai.hkd.red/symbolImage/{{ strategy.trade_pair.split('-')[0] }}.png" style="height: 32px; width: 32px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.08);" alt="币种图标">
                                <div id="selected-crypto-name" class="robot-name">{{ strategy.trade_pair.split('-')[0] }}/{{ strategy.trade_pair.split('-')[1] }}</div>
                                <input type="hidden" id="selected-crypto-pair" value="{{ strategy.trade_pair }}">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <span class="margin_r1" style="color: #1a6aff;"></span>
                            <span class="myicon icon-Choose" style="color: #1a6aff;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易对选择弹窗 -->
            <div id="crypto-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>选择交易对</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="crypto-search" placeholder="搜索币种...">
                    </div>
                    <div class="modal-body">
                        <div class="crypto-list">
                            {% for pair in trading_pairs %}
                            <div class="crypto-item" data-original="{{ pair.original }}" data-symbol="{{ pair.symbol }}" data-display="{{ pair.display }}">
                                <img src="{{ pair.icon_url }}" alt="{{ pair.symbol }}" onerror="this.src='/static/images/default-coin.svg'">
                                <span>{{ pair.display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 币种选择（隐藏） -->
            <div class="forms-item f-1 box2" style="display: none;">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                    </div>
                    </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <div class="robot-name">币种</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="flex-x">
                            <span>请选择币种</span>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-right" style="font-size: 14px; line-height: 14px; font-weight: normal; top: 1px; color: rgb(200, 200, 200);"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预设策略 -->
            <div class="flex-y margin_b1">
                <span class="lable-name">预设策略</span>
                <div class="type-scroll">
                    <div class="scroll-li-types type-actives">
                        <div class="li-type-center flex-x-c">保守型</div>
                    </div>
                    <div class="scroll-li-types premium-strategy">
                        <div class="li-type-center flex-x-c">稳健型</div>
                </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">激进型</div>
                    </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">自定义</div>
                </div>
                    </div>
            </div>
            
            <!-- 策略方向 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>策略方向</span>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color" style="padding: 0px;">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="type-box flex-x-b box-bg1" style="width: 176px;">
                                <span class="type-li type-active">做多</span>
                                <span class="type-li">做空</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-right"></div>
                </div>
            </div>
            
            <!-- 杠杆调整 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>杠杆调整</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input disabled="disabled" placeholder="选择杠杆倍数" maxlength="140" step="" enterkeyhint="done" autocomplete="off" type="text" class="uni-input-input">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-down-fill" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: #1a6aff;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预计投入 -->
            <div class="forms-item f-1 box2" id="margin-input-container">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>预计投入（保证金）</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border margin-input">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input placeholder="输入投入金额" maxlength="140" step="0.01" min="0.01" enterkeyhint="done" autocomplete="off" type="number" class="uni-input-input" id="margin-input" onchange="formatMarginValue(this)">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="margin-value-container">
                            <span style="font-weight: 500; color: #1a6aff;">USDT</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 策略参数设置 -->
            <div class="settings-card box hover-glow">
                <div class="settings-title">参数设置 <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">专业版</small></div>
                <div class="settings-row">
                    <div class="setting-label">网格数量</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.grid_count }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">价格区间</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.price_range }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">风险等级</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.risk_level }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>

                <!-- 添加仓位比例控制 -->
                <div class="settings-row">
                    <div class="setting-label">仓位比例控制</div>
                    <div class="setting-value">
                        <span id="position-value-percent" style="font-weight: 600; color: #1a6aff;">100%</span>
                    </div>
                </div>
                <div class="settings-row position-slider-container">
                    <div class="gress-box">
                        <div class="sunny-sliderBar" style="width: 100%; --sliderBarbgc:#f0f0f0; --primaryColor:#1a6aff;">
                            <div class="sliderBar" style="width: 100%;">
                                <div class="img-box">
                                    <div class="move-img" style="left: 0%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">0</span>
            </div>
                                    <div class="move-img" style="left: 25%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">25</span>
                </div>
                                    <div class="move-img" style="left: 50%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">50</span>
                    </div>
                                    <div class="move-img" style="left: 75%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">75</span>
                        </div>
                                    <div class="move-img" style="left: 100%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">100</span>
                        </div>
                    </div>
                                <div class="gone" style="width: 100%;"></div>
                                <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
                                    <span class="count">100%</span>
                </div>
                            </div>
                        </div>
                        </div>
                    </div>



                <div class="settings-row">
                    <div class="setting-label">续下单</div>
                    <div class="setting-value">
                        <button id="continue-order-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #1a6aff, #3f87ff); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(26, 106, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试用)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加策略控制按钮区域 -->
    <div class="strategy-controls" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;">
        <button class="confirm-btn hover-glow" id="run-strategy-btn" style="background-color: #52c41a; flex: 2;">运行</button>
        <button class="confirm-btn hover-glow" id="stop-strategy-btn" style="background-color: #ff4d4f; display: none; flex: 1;">强制停止</button>
    </div>
    <div id="strategy-status" style="margin-top: 10px; text-align: center; font-size: 14px; color: #8c8c8c;"></div>
    
    <!-- 添加自动刷新状态显示区域 -->
    <div id="auto-refresh-status" style="display: flex; align-items: center; justify-content: center; margin-top: 10px; font-size: 12px; color: #8c8c8c;">
        <div id="refresh-indicator" style="width: 8px; height: 8px; background-color: #52c41a; border-radius: 50%; margin-right: 5px;"></div>
        <span>自动刷新已开启 (10秒/次)</span>
    </div>
    <div id="last-refresh-time" style="text-align: center; font-size: 12px; color: #8c8c8c; margin-top: 5px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面
            initSettingsPage();
            
            // 添加页面加载动画
            document.body.classList.add('page-loaded');
            
            // 初始化币种选择功能
            initCryptoSelector();
            
            // 创建一个隐藏的保存按钮，保持功能但不显示
            const hiddenSaveBtn = document.createElement('button');
            hiddenSaveBtn.id = 'save-strategy-btn';
            hiddenSaveBtn.style.display = 'none';
            document.querySelector('.strategy-controls').appendChild(hiddenSaveBtn);
            
            // 为保存按钮添加点击事件
            document.getElementById('save-strategy-btn').addEventListener('click', function() {
                // 仅保存策略，不运行
                saveStrategy(false);
            });
            
            // 初始化策略状态指示器的动画
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes blink {
                    0% { opacity: 0.3; }
                    50% { opacity: 1; }
                    100% { opacity: 0.3; }
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // 检查是否有保存的运行状态
            const isSystemRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            console.log(`页面加载时检查到系统运行状态: ${isSystemRunning ? '运行中' : '已停止'}`);
            
            // 如果系统之前是运行状态，自动启动交易系统循环
            if (isSystemRunning) {
                const runBtn = document.getElementById('run-strategy-btn');
                if (runBtn) {
                    runBtn.setAttribute('data-running', 'true');
                    runBtn.textContent = '停止';
                    runBtn.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    console.log('恢复之前的交易系统运行状态');
                }
            }
            
            // 立即检查持仓状态，优先处理buy_flag
            checkInitialPositionStatus();
            
            // 检查交易对JSON文件状态
            checkTradingPairsStatus();
            
            // 获取刷新指示灯元素
            const refreshIndicator = document.getElementById('refresh-indicator');
            // 添加自动刷新定时器 - 即使没有点击运行按钮也会自动刷新
            const autoRefreshInterval = setInterval(function() {
                console.log("自动刷新检查持仓状态...");
                
                // 每次刷新前，更新指示灯颜色为黄色，表示正在刷新
                if (refreshIndicator) {
                    refreshIndicator.style.backgroundColor = '#faad14';
                }
                
                // 检查状态，传入false参数表示只检查状态，不触发下单
                // 这里调用时，确保checkPositionStatus不会因为网络或其他原因意外重置系统状态
                const currentIsRunning = localStorage.getItem('tradingSystemRunning');
                checkPositionStatus(false);  // 只检查状态，不触发下单
                
                // 确保刷新后系统状态一致
                setTimeout(function() {
                    // 确保状态没有被意外改变
                    if (localStorage.getItem('tradingSystemRunning') !== currentIsRunning && currentIsRunning !== null) {
                        console.log('检测到系统状态被意外更改，正在恢复...');
                        localStorage.setItem('tradingSystemRunning', currentIsRunning);
                        // 强制更新UI
                        updateButtonStatus(chichang, currentIsRunning === 'true');
                    }
                    
                    // 刷新完成后，延迟将颜色改回绿色
                    if (refreshIndicator) {
                        refreshIndicator.style.backgroundColor = '#52c41a';
                    }
                }, 1000);
            }, 10000); // 每10秒自动刷新一次
            
            // 将自动刷新定时器保存到window对象，以便可以在需要时停止
            window.autoRefreshInterval = autoRefreshInterval;
            
            // 当页面关闭或刷新时，清除定时器
            window.addEventListener('beforeunload', function() {
                clearInterval(window.autoRefreshInterval);
            });
            
            // 初始化运行策略按钮
            document.getElementById('run-strategy-btn').addEventListener('click', function() {
                // 判断当前状态
                const isRunning = this.getAttribute('data-running') === 'true';
                
                if (isRunning) {
                    // 如果已经在运行，则停止循环
                    clearInterval(window.tradingSystemInterval);
                    this.setAttribute('data-running', 'false');
                    this.textContent = '运行';
                    this.style.backgroundColor = '#52c41a';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统已停止';
                        statusElement.style.color = '#8c8c8c';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    // 隐藏强制停止按钮
                    const stopBtn = document.getElementById('stop-strategy-btn');
                    if (stopBtn) {
                        stopBtn.style.display = 'none';
                    }
                    
                    showToast('交易系统循环已停止', 'info');
                } else {
                    // 如果未运行，启动循环
                    this.setAttribute('data-running', 'true');
                    this.textContent = '停止';
                    this.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'true');
                    
                    // 如果有持仓，显示强制停止按钮
                    if (chichang) {
                        const stopBtn = document.getElementById('stop-strategy-btn');
                        if (stopBtn) {
                            stopBtn.style.display = 'inline-block';
                        }
                    }
                    
                    showToast('交易系统循环已启动', 'success');
                }
            });
            
            // 初始化停止策略按钮（强制停止）
            document.getElementById('stop-strategy-btn').addEventListener('click', function() {
                if (chichang) {
                    // 如果有持仓，提示用户需要平仓
                    showConfirmDialog(
                        '强制停止警告', 
                        '当前有持仓，强制停止可能导致持仓无法自动平仓。是否继续运行直到平仓完成？',
                        '继续运行',
                        '强制停止',
                        function() {
                            // 用户选择继续运行，不做任何操作
                            showToast('策略将继续运行直到平仓完成');
                        },
                        function() {
                            // 用户选择强制停止
                            clearInterval(strategyInterval);
                            strategyRunning = false;
                            
                            // 强制修改运行状态按钮
                            const runBtn = document.getElementById('run-strategy-btn');
                            if (runBtn) {
                                runBtn.setAttribute('data-running', 'false');
                                runBtn.textContent = '运行';
                                runBtn.style.backgroundColor = '#52c41a';
                            }
                            
                            // 保存运行状态到localStorage
                            localStorage.setItem('tradingSystemRunning', 'false');
                            
                            updateButtonStatus(chichang, false);
                            
                            const statusElement = document.getElementById('strategy-status');
                            statusElement.textContent = '策略已强制停止，但仍有未平仓的持仓';
                            statusElement.style.color = '#ff4d4f';
                            
                            // 隐藏强制停止按钮
                            this.style.display = 'none';
                            
                            showToast('策略已强制停止，请注意未平仓的持仓状态', 'warning');
                        }
                    );
                } else {
                    // 没有持仓，直接停止
                    clearInterval(strategyInterval);
                    strategyRunning = false;
                    
                    // 强制修改运行状态按钮
                    const runBtn = document.getElementById('run-strategy-btn');
                    if (runBtn) {
                        runBtn.setAttribute('data-running', 'false');
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    updateButtonStatus(chichang, false);
                    
                    const statusElement = document.getElementById('strategy-status');
                    statusElement.textContent = '策略已强制停止';
                    statusElement.style.color = '#8c8c8c';
                    
                    // 隐藏强制停止按钮
                    this.style.display = 'none';
                    
                    showToast('策略已强制停止');
                }
            });
            
            // 为续下单按钮添加点击事件
            document.getElementById('continue-order-btn').addEventListener('click', function() {
                // 显示加载动画
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                this.disabled = true;
                
                // 显示测试提示
                showToast('这是测试功能，仅用于验证系统连接', 'info');
                
                // 调用测试功能而不是实际下单
                testOrderSystem();
                
                // 3秒后恢复按钮状态
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试)';
                    this.disabled = false;
                }, 3000);
            });


        });
        
        // 页面加载时检查持仓状态并更新按钮
        function checkPositionStatusOnLoad() {
            // 获取当前URL中的策略ID和交易对
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 获取交易对（根据策略ID设置不同的默认交易对）
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多
            
            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 显示加载状态
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = '正在检查持仓状态...';
            
            // 向后端发送请求获取持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // 检查当前方向是否有持仓
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // 初始化全局变量chichang（根据持仓状态）
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 初始化运行按钮状态
                    updateButtonStatus(chichang, strategyRunning);
                    
                    // 根据当前交易方向和持仓状态更新按钮
                    if ((tradeDirection === 'buy' && hasBuyPosition) || 
                        (tradeDirection === 'sell' && hasSellPosition)) {
                        // 已有相同方向持仓
                        saveBtn.textContent = '已持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = `当前有${hasBuyPosition ? '多头' : ''}${hasSellPosition ? '空头' : ''}持仓`;
                        statusElement.style.color = '#faad14'; // 黄色警告
                    } else if ((!hasBuyPosition && !hasSellPosition) && data.hasOrder) {
                        // 没有持仓但有订单，显示为"已下单"
                        saveBtn.textContent = '已下单，执行中';
                        saveBtn.classList.add('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '订单正在处理中，请稍候...';
                        statusElement.style.color = '#1a6aff'; // 蓝色信息
                    } else {
                        // 无持仓无订单
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '系统准备就绪，点击"运行"开始策略';
                        statusElement.style.color = '#52c41a'; // 绿色正常
                    }
                    
                    // 添加状态摘要显示 - 如果后端提供了状态摘要
                    if (data.statusSummary) {
                        // 在状态元素的下方添加后端状态摘要
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `后端状态: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // 如果已有之前的状态摘要，先移除
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                }
            })
            .catch(error => {
                console.error('获取持仓状态失败:', error);
                statusElement.textContent = '网络错误，无法检查持仓状态';
                statusElement.style.color = '#ff4d4f'; // 红色错误
            });
        }
        
        // 保存策略设置函数
        function saveStrategy(shouldManuallyOrder = true) {
            // 获取当前URL中的策略ID
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 检查是否允许下单 - 只有当shouldManuallyOrder为true或者strategyRunning为true时才允许下单
            const shouldProceed = shouldManuallyOrder || strategyRunning;
            
            // 如果不允许下单，则记录日志并直接返回
            if (!shouldProceed) {
                console.log("自动检查状态，跳过下单操作");
                return;
            }
            
            // 获取保证金输入值并格式化
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 先格式化输入框的值
            formatMarginValue(marginInput);
            // 再获取格式化后的值
            const marginValue = marginInput.value || '0';
            
            // 检查保证金是否为有效值
            if (parseFloat(marginValue) <= 0) {
                showToast('请输入有效的保证金金额');
                return;
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多

            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 获取交易对
            const tradePair = '{{ strategy.trade_pair|default("BTC-USDT") }}';
            
            // 在按钮上显示加载状态
            const saveBtn = document.getElementById('save-strategy-btn');
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = '处理中...';
            saveBtn.disabled = true;
            
            // 发送AJAX请求
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                if (data.code === 200) {
                    // 检查持仓状态，只有在有订单结果且没有已存在的相同方向的持仓时才显示"已下单"
                    if (data.orderResult) {
                        // 获取当前交易方向
                        const dirElements = document.querySelectorAll('.type-box .type-li');
                        let currentDirection = 'buy'; // 默认方向
                        dirElements.forEach(function(el) {
                            if (el.classList.contains('type-active')) {
                                currentDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                            }
                        });
                        
                        // 检查是否已经有相同方向的持仓
                        const hasSameDirectionPosition = 
                            (currentDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                            (currentDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                        
                        if (hasSameDirectionPosition) {
                            // 已有相同方向持仓，显示为"已持仓中"
                            saveBtn.textContent = '已持仓中';
                            saveBtn.classList.add('position-active');
                        } else {
                            // 无相同方向持仓，显示为"已下单，执行中"
                            saveBtn.textContent = '已下单，执行中';
                            saveBtn.classList.add('order-success');
                        }
                        
                        showToast(`策略保存成功! 合约张数: ${data.contractSize}`);
                        showOrderResultModal(data.orderResult, tradePair);
                    } else {
                        // 没有下单，仅保存设置
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        showToast('设置已成功保存');
                    }
                } else if (data.code === 503 || data.code === 504) {
                    // 网络错误处理
                    showNetworkErrorModal(data.message);
                } else {
                    // 处理错误，保持原有按钮文本
                    saveBtn.textContent = originalBtnText;
                    saveBtn.classList.remove('order-success');
                    saveBtn.classList.remove('position-active');
                    showNetworkErrorModal(data.message || '保存策略出错，请稍后再试');
                }
            })
            .catch(error => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                // 显示错误提示
                console.error('请求错误:', error);
                showNetworkErrorModal('网络请求失败，请检查网络连接');
            });
        }
        
        function initSettingsPage() {
            console.log('策略设置页面初始化');
            
            // 调整页面标题策略名称显示
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            let strategyName = '智能网格策略'; // 默认
            
            // 根据ID设置不同的策略名称
            if (strategyId === '1') {
                strategyName = '智能网格策略';
            } else if (strategyId === '2') {
                strategyName = '趋势跟踪策略';
            } else if (strategyId === '3') {
                strategyName = 'AI智能预测策略';
            } else if (strategyId === '4') {
                strategyName = '蓝龙综合策略';
            } else if (strategyId === '5') {
                strategyName = '蓝龙出海';
            } else if (strategyId === '6') {
                strategyName = '网格量化';
            }
            
            // 更新页面标题
            const titleElement = document.querySelector('.u-navbar__content__title');
            titleElement.textContent = strategyName;
            
            // 标题动画效果
            setTimeout(() => {
                document.querySelector('.u-navbar').style.transform = 'translateY(0)';
            }, 100);
            
            // 为交易方向选择器添加点击事件
            const directionButtons = document.querySelectorAll('.type-box .type-li');
            directionButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    // 移除所有按钮的活动状态
                    directionButtons.forEach(btn => btn.classList.remove('type-active'));
                    // 添加当前按钮的活动状态
                    this.classList.add('type-active');
                    
                    // 显示反馈
                    const direction = this.textContent.trim();
                    showToast(`已选择${direction}方向`);
                    
                    // 更新按钮状态
                    checkPositionStatusOnLoad();
                });
            });
            
            // 设置状态开关点击事件 - 检查元素是否存在
            const statusToggle = document.querySelector('.toggle-wrapper');
            if (statusToggle) {
                statusToggle.addEventListener('click', function() {
                    this.classList.toggle('active-lis');
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (this.classList.contains('active-lis')) {
                        indicator.style.transform = 'translateX(28px)';
                        showToast('策略已启动');
                    } else {
                        indicator.style.transform = 'translateX(0px)';
                        showToast('策略已暂停');
                    }
                });
            }
            
            // 设置预设策略点击事件
            const strategyTypes = document.querySelectorAll('.scroll-li-types');
            strategyTypes.forEach(type => {
                type.addEventListener('click', function() {
                    // 先移除所有active类
                    strategyTypes.forEach(t => {
                        t.classList.remove('type-actives');
                        // 添加淡出效果
                        t.style.opacity = '0.7';
                    });
                    
                    // 给当前点击元素添加active类
                    this.classList.add('type-actives');
                    this.style.opacity = '1';
                    
                    // 显示选择了什么策略
                    const strategyType = this.querySelector('.li-type-center').textContent;
                    showToast(`已选择${strategyType}策略`);
                    
                    // 恢复其他元素的透明度
                    setTimeout(() => {
                        strategyTypes.forEach(t => {
                            t.style.opacity = '1';
                        });
                    }, 300);
                });
            });
            
            // 添加做多做空按钮点击事件
            const typeLiButtons = document.querySelectorAll('.type-box .type-li');
            typeLiButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    typeLiButtons.forEach(btn => {
                        btn.classList.remove('type-active');
                    });
                    
                    // 给当前点击按钮添加active类
                    this.classList.add('type-active');
                    
                    // 显示消息
                    showToast(`已选择${this.textContent}策略`);
                });
            });
            
            // 添加杠杆调整点击事件
            const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
            const leverageContainer = leverageInput.closest('.form-item-input');
            leverageContainer.addEventListener('click', function() {
                // 模拟杠杆倍数选择弹窗
                const leverageOptions = [1, 2, 3, 5, 10, 20, 50, 100];
                let selectedLeverage = 10; // 默认选择
                
                // 创建杠杆选择对话框
                const createLeverageDialog = () => {
                    // 如果页面上已有对话框，先移除
                    const existingDialog = document.querySelector('.leverage-dialog');
                    if (existingDialog) {
                        existingDialog.remove();
                    }
                    
                    // 创建对话框容器
                    const dialog = document.createElement('div');
                    dialog.className = 'leverage-dialog';
                    dialog.style.position = 'fixed';
                    dialog.style.top = '50%';
                    dialog.style.left = '50%';
                    dialog.style.transform = 'translate(-50%, -50%)';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '320px';
                    dialog.style.backgroundColor = '#fff';
                    dialog.style.borderRadius = '12px';
                    dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
                    dialog.style.zIndex = '9999';
                    dialog.style.overflow = 'hidden';
                    
                    // 创建对话框标题
                    const dialogTitle = document.createElement('div');
                    dialogTitle.textContent = '选择杠杆倍数';
                    dialogTitle.style.padding = '16px';
                    dialogTitle.style.borderBottom = '1px solid #f0f0f0';
                    dialogTitle.style.fontSize = '16px';
                    dialogTitle.style.fontWeight = '600';
                    dialogTitle.style.textAlign = 'center';
                    dialogTitle.style.color = '#262626';
                    dialog.appendChild(dialogTitle);
                    
                    // 创建选项容器
                    const optionsContainer = document.createElement('div');
                    optionsContainer.style.padding = '10px 0';
                    optionsContainer.style.maxHeight = '300px';
                    optionsContainer.style.overflowY = 'auto';
                    dialog.appendChild(optionsContainer);
                    
                    // 添加杠杆选项
                    leverageOptions.forEach(leverage => {
                        const option = document.createElement('div');
                        option.className = 'leverage-option';
                        option.textContent = `${leverage}X`;
                        option.style.padding = '12px 16px';
                        option.style.transition = 'all 0.2s ease';
                        option.style.cursor = 'pointer';
                        option.style.fontSize = '15px';
                        
                        // 高亮当前选中的选项
                        if (leverage === selectedLeverage) {
                            option.style.color = '#1a6aff';
                            option.style.fontWeight = '600';
                            option.style.backgroundColor = '#f0f7ff';
                        }
                        
                        option.addEventListener('mouseenter', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = '#f9fafc';
                            }
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = 'transparent';
                            }
                        });
                        
                        option.addEventListener('click', function() {
                            selectedLeverage = leverage;
                            leverageInput.value = `${leverage}X`;
                            
                            // 更新页面上的保证金值
                            updateMarginFromLeverage(leverage);
                            
                            dialog.remove();
                            
                            // 显示杠杆设置消息
                            showToast(`已设置杠杆倍数: ${leverage}X`);
                            
                            // 添加点击动画效果
                            leverageContainer.classList.add('row-clicked');
                            setTimeout(() => {
                                leverageContainer.classList.remove('row-clicked');
                            }, 300);
                        });
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // 创建取消按钮
                    const cancelButton = document.createElement('div');
                    cancelButton.textContent = '取消';
                    cancelButton.style.padding = '14px';
                    cancelButton.style.borderTop = '1px solid #f0f0f0';
                    cancelButton.style.textAlign = 'center';
                    cancelButton.style.color = '#8c8c8c';
                    cancelButton.style.fontSize = '15px';
                    cancelButton.style.cursor = 'pointer';
                    cancelButton.style.transition = 'all 0.2s ease';
                    
                    cancelButton.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f9fafc';
                    });
                    
                    cancelButton.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    cancelButton.addEventListener('click', function() {
                        dialog.remove();
                    });
                    
                    dialog.appendChild(cancelButton);
                    
                    // 创建遮罩层
                    const overlay = document.createElement('div');
                    overlay.className = 'leverage-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '9998';
                    
                    overlay.addEventListener('click', function() {
                        dialog.remove();
                        overlay.remove();
                    });
                    
                    // 将对话框和遮罩添加到页面
                    document.body.appendChild(overlay);
                    document.body.appendChild(dialog);
                    
                    // 添加动画
                    dialog.style.opacity = '0';
                    dialog.style.transform = 'translate(-50%, -60%)';
                    dialog.style.transition = 'all 0.3s ease';
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        dialog.style.opacity = '1';
                        dialog.style.transform = 'translate(-50%, -50%)';
                        overlay.style.opacity = '1';
                    }, 10);
                };
                
                // 显示杠杆选择对话框
                createLeverageDialog();
            });
            
            // 设置币种选择点击事件
            document.querySelector('.robot-info').parentElement.addEventListener('click', function() {
                showToast('币种选择功能正在开发中...');
            });
            
            // 设置设置项点击事件
            const settingItems = document.querySelectorAll('.setting-value .arrow-right');
            settingItems.forEach(item => {
                item.parentElement.parentElement.addEventListener('click', function() {
                    const settingName = this.querySelector('.setting-label').textContent;
                    showToast(`${settingName}设置页面正在开发中...`);
                    
                    // 添加点击动画效果
                    this.classList.add('row-clicked');
                    setTimeout(() => {
                        this.classList.remove('row-clicked');
                    }, 300);
                });
            });
            
            // 设置保存按钮事件
            const saveButton = document.querySelector('.confirm-btn');
            saveButton.addEventListener('click', function() {
                // 添加按钮动画
                this.classList.add('btn-clicked');
                
                // 获取保证金值和交易对信息
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                const marginValue = marginInput.value;
                
                // 获取URL中的策略ID
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('id') || '1';
                
                // 从隐藏字段获取用户选择的交易对
                const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
                
                // 获取交易方向（做多/做空）
                const dirElements = document.querySelectorAll('.type-box .type-li');
                let tradeDirection = 'buy'; // 默认做多
                dirElements.forEach(function(el) {
                    if (el.classList.contains('type-active')) {
                        tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                    }
                });
                
                // 发送AJAX请求到后端
                fetch('/api/strategy/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategyId: strategyId,
                        marginValue: marginValue,
                        tradePair: tradePair,
                        tradeDirection: tradeDirection
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 仅保存设置成功的默认消息
                        showToast('设置已成功保存');
                        
                        // 显示后端返回的合约张数
                        if (data.contractSize) {
                            showToast(`相当于 ${data.contractSize} 张合约`);
                        }
                        
                        // 显示订单结果（如果有）
                        if (data.orderResult) {
                            // 创建订单结果弹窗
                            showOrderResultModal(data.orderResult, tradePair);
                            
                            // 检查是否已经有相同方向的持仓
                            const hasSameDirectionPosition = 
                                (tradeDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                                (tradeDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                            
                            if (hasSameDirectionPosition) {
                                // 已有相同方向持仓，显示为"已持仓中"
                                this.textContent = '已持仓中';
                                this.classList.add('position-active');
                            } else {
                                // 无相同方向持仓，显示为"已下单，执行中"
                                this.textContent = '已下单，执行中';
                                this.classList.add('order-success');
                            }
                        } else {
                            // 无订单，保持"保存设置"状态
                            this.textContent = '保存设置';
                            this.classList.remove('order-success');
                            this.classList.remove('position-active');
                        }
                    } else if (data.code === 503 || data.code === 504) {
                        // 网络错误处理
                        showNetworkErrorModal(data.message);
                    } else {
                        showToast('保存失败: ' + data.message);
                    }
                    this.classList.remove('btn-clicked');
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 网络错误或服务器问题
                    showNetworkErrorModal('无法连接到服务器，请检查您的网络连接后重试');
                    this.classList.remove('btn-clicked');
                });
            });
            
            // 初始化仓位滑动条
            initPositionSlider();
            
            // 初始化百分比控制滑动条
            initPositionPercentSlider();
            
            // 添加页面内各元素的入场动画
            animateElements();
            
            // 投入金额获得焦点时添加高亮效果
            const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
            marginInput.addEventListener('focus', function() {
                // // document.getElementById('margin-input-container').classList.add('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            marginInput.addEventListener('blur', function() {
                // // document.getElementById('margin-input-container').classList.remove('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            // 根据杠杆倍数更新保证金金额
            function updateMarginFromLeverage(leverage) {
                // 获取当前百分比值
                const percentElement = document.getElementById('position-value-percent');
                const percent = parseInt(percentElement.textContent);
                
                // 计算保证金金额（示例计算公式）
                const baseAmount = 1000;  // 基础金额
                const calculatedMargin = (baseAmount / leverage) * (percent / 100);
                
                // 更新保证金输入框，使用平滑动画
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                // 使用toFixed保留两位小数，避免浮点数问题并应用平滑过渡
                const formattedValue = parseFloat(calculatedMargin.toFixed(2));
                // 检查值是否有明显变化
                if (marginInput.value !== formattedValue.toString()) {
                    // 存储上一次的值，用于动画判断
                    const prevValue = parseFloat(marginInput.value || '0');
                    // 如果变化大于一定值，应用过渡动画
                    if (Math.abs(prevValue - formattedValue) > 10) {
                        marginInput.classList.add('value-changing');
                        setTimeout(() => {
                            marginInput.classList.remove('value-changing');
                        }, 300);
                    }
                    // 设置新值
                    marginInput.value = formattedValue;
                }
                
                // 显示保证金更新提示
                showToast(`保证金已更新: ${calculatedMargin.toFixed(2)} USDT`);
            }
        }
        
        // 显示消息提示
        function showToast(message) {
            // 如果已有toast，先移除
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 创建新的toast元素
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 自动隐藏toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // 格式化保证金值，确保正确的数值格式
        function formatMarginValue(input) {
            // 获取输入值并解析为数值
            let value = parseFloat(input.value);
            
            // 检查是否为有效数字
            if (isNaN(value)) {
                input.value = '0.01';
                showToast('无效的金额，已设为最小值');
                return;
            }
            
            // 确保最小值为0.01
            if (value < 0.01) {
                value = 0.01;
                showToast('金额不能小于0.01 USDT');
            }
            
            // 将值格式化为最多两位小数
            const formattedValue = parseFloat(value.toFixed(2));
            
            // 如果格式化前后的值不同，更新输入框值
            if (parseFloat(input.value) !== formattedValue) {
                input.value = formattedValue;
                console.log(`保证金值已格式化: ${formattedValue} USDT`);
            }
            
            return formattedValue;
        }
        
        // 显示订单结果模态窗口
        function showOrderResultModal(orderResult, tradePair) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '450px';
            
            // 添加标题和成功图标
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.justifyContent = 'center';
            titleContainer.style.marginBottom = '15px';
            
            const successIcon = document.createElement('div');
            successIcon.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32"><path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.177-7.86l-2.765-2.767L7 12.431l3.119 3.121a1 1 0 001.414 0l5.952-5.95-1.062-1.062-5.6 5.6z"/></svg>';
            successIcon.style.marginRight = '10px';
            
            const title = document.createElement('h3');
            title.textContent = '下单成功';
            title.className = 'modal-title';
            title.style.margin = '0';
            
            titleContainer.appendChild(successIcon);
            titleContainer.appendChild(title);
            modalContent.appendChild(titleContainer);
            
            // 添加交易对信息
            const pairInfo = document.createElement('div');
            pairInfo.style.background = 'linear-gradient(135deg, #f0f7ff, #e6f7ff)';
            pairInfo.style.padding = '12px 15px';
            pairInfo.style.borderRadius = '8px';
            pairInfo.style.marginBottom = '15px';
            pairInfo.style.display = 'flex';
            pairInfo.style.alignItems = 'center';
            pairInfo.style.justifyContent = 'space-between';
            
            const pairLabel = document.createElement('span');
            pairLabel.textContent = '交易对:';
            pairLabel.style.color = '#333';
            pairLabel.style.fontWeight = '500';
            
            const pairValue = document.createElement('span');
            pairValue.textContent = tradePair;
            pairValue.style.color = '#1a6aff';
            pairValue.style.fontWeight = '600';
            pairValue.style.fontSize = '16px';
            
            pairInfo.appendChild(pairLabel);
            pairInfo.appendChild(pairValue);
            modalContent.appendChild(pairInfo);
            
            // 添加订单详情
            const orderDetails = document.createElement('div');
            orderDetails.className = 'order-details';
            orderDetails.style.background = '#f9fafc';
            orderDetails.style.border = '1px solid #f0f0f0';
            orderDetails.style.borderRadius = '8px';
            orderDetails.style.padding = '15px';
            
            // 定义要显示的字段和对应的中文名称
            const fieldLabels = {
                'orderId': '订单ID',
                'status': '状态',
                'exchangeId': '交易所',
                'direction': '方向',
                'contractSize': '合约数量',
                'margin': '保证金',
                'tradePair': '交易对',
                'price': '价格',
                'time': '时间'
            };
            
            // 按顺序显示字段
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'price', 'time'];
            
            // 格式化并显示订单结果数据
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                    const detailRow = document.createElement('div');
                    detailRow.className = 'detail-row';
                    
                    const detailLabel = document.createElement('span');
                    detailLabel.textContent = fieldLabels[key] || key;
                    detailLabel.className = 'detail-label';
                    
                    const detailValue = document.createElement('span');
                    detailValue.textContent = orderResult[key];
                    detailValue.className = 'detail-value';
                    
                    // 为特定字段添加样式
                    if (key === 'direction') {
                        detailValue.style.color = orderResult[key] === '做多' ? '#52c41a' : '#ff4d4f';
                        detailValue.style.fontWeight = '600';
                    } else if (key === 'status') {
                        detailValue.style.color = '#52c41a';
                        detailValue.style.fontWeight = '600';
                    }
                    
                    detailRow.appendChild(detailLabel);
                    detailRow.appendChild(detailValue);
                    orderDetails.appendChild(detailRow);
                }
            });
            
            modalContent.appendChild(orderDetails);
            
            // 检查是否为特殊币种（如ARB）并添加特殊提示
            if (isSpecialCoin(tradePair)) {
                const specialNoteContainer = document.createElement('div');
                specialNoteContainer.style.backgroundColor = '#fffbe6';
                specialNoteContainer.style.border = '1px solid #ffe58f';
                specialNoteContainer.style.borderRadius = '4px';
                specialNoteContainer.style.padding = '10px 12px';
                specialNoteContainer.style.marginTop = '10px';
                specialNoteContainer.style.marginBottom = '10px';
                
                const noteTitle = document.createElement('div');
                noteTitle.textContent = '特殊币种提示';
                noteTitle.style.fontWeight = '600';
                noteTitle.style.color = '#fa8c16';
                noteTitle.style.marginBottom = '5px';
                
                const noteContent = document.createElement('div');
                noteContent.style.fontSize = '13px';
                noteContent.style.color = '#666';
                noteContent.style.lineHeight = '1.5';
                noteContent.innerHTML = `对于 ${tradePair.split('-')[0]} 等特殊币种，显示的合约数量可能与实际持有的代币数量不同。<br/>请注意，系统中显示的持仓数量可能是实际代币数量，而非合约数量。`;
                
                specialNoteContainer.appendChild(noteTitle);
                specialNoteContainer.appendChild(noteContent);
                modalContent.appendChild(specialNoteContainer);
            }
            
            // 添加操作说明
            const infoText = document.createElement('p');
            infoText.textContent = '您的订单已成功提交，可在交易所查看订单详情。';
            infoText.style.color = '#8c8c8c';
            infoText.style.fontSize = '14px';
            infoText.style.textAlign = 'center';
            infoText.style.margin = '15px 0';
            modalContent.appendChild(infoText);
            
            // 添加确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = '确定';
            confirmButton.className = 'modal-confirm-btn';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.width = '100%';
            confirmButton.style.height = '40px';
            confirmButton.style.borderRadius = '20px';
            confirmButton.style.marginTop = '10px';
            
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmButton);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 显示网络错误模态窗口
        function showNetworkErrorModal(message) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container error-modal';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 添加标题
            const titleEl = document.createElement('h3');
            titleEl.textContent = '网络连接问题';
            titleEl.className = 'modal-title';
            modalContent.appendChild(titleEl);
            
            // 添加错误图标
            const iconEl = document.createElement('div');
            iconEl.className = 'error-icon';
            iconEl.innerHTML = '<svg viewBox="0 0 24 24" width="48" height="48"><path fill="#ff4d4f" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>';
            modalContent.appendChild(iconEl);
            
            // 添加错误信息
            const msgEl = document.createElement('p');
            msgEl.textContent = message;
            msgEl.className = 'modal-message';
            modalContent.appendChild(msgEl);
            
            // 添加确认按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '确定';
            confirmBtn.className = 'modal-confirm-btn';
            confirmBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmBtn);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 添加元素入场动画
        function animateElements() {
            const elements = document.querySelectorAll('.box, .box2, .forms-item');
            elements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('element-animated');
                }, 100 * index);
            });
        }
        
        // 初始化百分比控制滑动条
        function initPositionPercentSlider() {
            const slider = document.getElementById('position-slider-percent');
            const sliderBar = slider.parentElement;
            const positionValue = document.getElementById('position-value-percent');
            const progressBar = sliderBar.querySelector('.gone');
            
            // 获取保证金输入框
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 设置初始保证金值（假设有一个最大值）
            const maxMargin = 1000; // 假设最大保证金为1000 USDT
            
            // 平滑设置初始值
            setTimeout(() => {
                const formattedValue = parseFloat(maxMargin.toFixed(2));
                marginInput.value = formattedValue;
            }, 300);
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 平滑更新保证金值函数
            function updateMarginValue(percent, leverage) {
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                // 格式化值，保留2位小数
                const formattedValue = parseFloat(marginValue.toFixed(2));
                
                // 简化后的逻辑，直接设置值，无动画
                if (marginInput.value !== formattedValue.toString()) {
                    marginInput.value = formattedValue;
                }
            }
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(percent, leverage);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40; // 减去滑块自身宽度，使滑块能够完全移动到边缘
                sliderLeft = rect.left + 20; // 加上滑块半径，使百分比计算更准确
                
                isDragging = true;
                
                // 添加激活样式
                slider.classList.add('slider-active');
                document.body.style.cursor = 'grabbing';
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除激活样式
                slider.classList.remove('slider-active');
                document.body.style.cursor = '';
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
                
                // 添加完成动画
                slider.classList.add('slider-done');
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                }, 500);
            }
            
            // 为固定点添加点击事件
            sliderBar.querySelectorAll('.move-img').forEach(dot => {
                dot.addEventListener('click', function() {
                    const percent = parseInt(this.style.left);
                    
                    // 获取滑动条的宽度
                    const rect = sliderBar.getBoundingClientRect();
                    sliderWidth = rect.width - 40;
                    sliderLeft = rect.left + 20;
                    
                    const newPosition = (sliderWidth * percent) / 100;
                    
                    // 设置CSS变量记录当前位置，用于动画
                    slider.style.setProperty('--x-pos', `${newPosition}px`);
                    
                    // 添加过渡动画
                    slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    
                    // 更新滑块位置，保持垂直居中
                    slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                    progressBar.style.width = `${percent}%`;
                    slider.querySelector('.count').textContent = `${percent}%`;
                    positionValue.textContent = `${percent}%`;
                    
                    // 计算并更新保证金值
                    const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                    let leverage = 10; // 默认杠杆
                    if (leverageInput.value) {
                        // 解析杠杆值（例如 "10X" -> 10）
                        leverage = parseInt(leverageInput.value);
                        if (isNaN(leverage)) leverage = 10;
                    }
                    
                    // 使用平滑更新函数更新保证金值
                    updateMarginValue(percent, leverage);
                    
                    // 根据百分比改变颜色
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        progressBar.classList.remove('progress-yellow', 'progress-blue');
                        slider.classList.remove('slider-yellow', 'slider-blue');
                        progressBar.classList.add('progress-red');
                        slider.classList.add('slider-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        progressBar.classList.remove('progress-red', 'progress-blue');
                        slider.classList.remove('slider-red', 'slider-blue');
                        progressBar.classList.add('progress-yellow');
                        slider.classList.add('slider-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        progressBar.classList.remove('progress-red', 'progress-yellow');
                        slider.classList.remove('slider-red', 'slider-yellow');
                        progressBar.classList.add('progress-blue');
                        slider.classList.add('slider-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加点击高亮动画
                    this.classList.add('dot-active');
                    setTimeout(() => {
                        this.classList.remove('dot-active');
                    }, 500);
                    
                    // 添加完成动画
                    setTimeout(() => {
                        slider.classList.remove('slider-done');
                        // 强制重绘
                        void slider.offsetWidth;
                        slider.classList.add('slider-done');
                    }, 300);
                    
                    // 移除过渡动画，以便拖动时不受影响
                    setTimeout(() => {
                        slider.style.transition = '';
                        progressBar.style.transition = '';
                    }, 500);
                });
            });
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                // 如果点击的是滑块本身或者固定点，不处理
                if (e.target === slider || e.target.closest('.move-img')) return;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40;
                sliderLeft = rect.left + 20;
                
                const clickX = e.clientX - sliderLeft + 20; // 调整点击位置
                const percent = Math.round((clickX / sliderWidth) * 100);
                const adjustedPercent = Math.max(0, Math.min(percent, 100)); // 确保百分比在0-100之间
                
                // 设置CSS变量记录当前位置，用于动画
                const newPosition = (sliderWidth * adjustedPercent) / 100;
                slider.style.setProperty('--x-pos', `${newPosition}px`);
                
                // 添加过渡动画
                slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                progressBar.style.width = `${adjustedPercent}%`;
                slider.querySelector('.count').textContent = `${adjustedPercent}%`;
                positionValue.textContent = `${adjustedPercent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(adjustedPercent, leverage);
                
                // 根据百分比改变颜色
                if (adjustedPercent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (adjustedPercent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
                
                // 添加完成动画
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-done');
                }, 300);
                
                // 移除过渡动画，以便拖动时不受影响
                setTimeout(() => {
                    slider.style.transition = '';
                    progressBar.style.transition = '';
                }, 500);
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
            
            // 初始化时设置滑块的颜色
            setTimeout(() => {
                // 获取初始百分比
                const percent = parseInt(positionValue.textContent);
                
                if (percent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (percent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
            }, 500);
        }
        
        // 初始化仓位滑动条
        function initPositionSlider() {
            const slider = document.getElementById('position-slider');
            if (!slider) return; // 防止错误
            
            const progressBar = document.getElementById('progress-bar');
            const positionValue = document.getElementById('position-value');
            const sliderBar = document.querySelector('.sliderBar');
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                marginInput.value = marginValue.toFixed(2);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width;
                sliderLeft = rect.left;
                
                isDragging = true;
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            }
            
            // 为固定点添加点击事件
            const dotElements = document.querySelectorAll('.move-img');
            if (dotElements.length > 0) {
                dotElements.forEach(dot => {
                    dot.addEventListener('click', function() {
                        if (this.style.left) {
                            const percent = parseInt(this.style.left);
                            slider.style.left = `${percent}%`;
                            
                            if (progressBar) {
                                progressBar.style.width = `${percent}%`;
                            }
                            
                            const countElement = slider.querySelector('.count');
                            if (countElement) {
                                countElement.textContent = `${percent}%`;
                            }
                            
                            if (positionValue) {
                                positionValue.textContent = `${percent}%`;
                            }
                        }
                    });
                });
            }
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                if (e.target === slider) return;
                
                const rect = sliderBar.getBoundingClientRect();
                const sliderWidth = rect.width;
                const clickX = e.clientX - rect.left;
                const percent = Math.round((clickX / sliderWidth) * 100);
                
                slider.style.left = `${percent}%`;
                
                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
                
                const countElement = slider.querySelector('.count');
                if (countElement) {
                    countElement.textContent = `${percent}%`;
                }
                
                if (positionValue) {
                    positionValue.textContent = `${percent}%`;
                }
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
        }

        // 全局变量
        let strategyRunning = false;
        let strategyInterval = null;
        let chichang = false;

        // 检查持仓状态函数
        function checkPositionStatus(allowTrade = false) {
            console.log(`检查持仓状态 (允许交易: ${allowTrade})`);
            
            // 获取当前选择的交易对和交易方向
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 更新最后刷新时间
            const lastRefreshElement = document.getElementById('last-refresh-time');
            if (lastRefreshElement) {
                lastRefreshElement.textContent = `最后刷新: ${new Date().toLocaleTimeString()}`;
            }
            
            // 确保从localStorage中获取正确的运行状态，确保与按钮状态同步
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 如果localStorage中有运行状态，同步按钮状态
            const runBtn = document.getElementById('run-strategy-btn');
            if (runBtn) {
                const currentBtnState = runBtn.getAttribute('data-running') === 'true';
                // 如果按钮状态与保存的状态不一致，则同步
                if (currentBtnState !== savedIsRunning) {
                    console.log(`按钮状态(${currentBtnState})与localStorage中的运行状态(${savedIsRunning})不一致，正在同步...`);
                    runBtn.setAttribute('data-running', savedIsRunning.toString());
                    
                    // 更新按钮外观
                    if (savedIsRunning) {
                        runBtn.textContent = '停止';
                        runBtn.style.backgroundColor = '#ff4d4f';
                    } else {
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                }
            }
            
            // 更新续下单按钮显示状态
            const continueOrderBtn = document.getElementById('continue-order-btn');
            
            // 发送请求检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 更新持仓状态
                    const hasBuyPosition = data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 记录状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 更新策略运行状态指示器
                    const statusIndicator = document.getElementById('key-status-indicator');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // 如果有持仓，更新续下单按钮样式
                    if (continueOrderBtn) {
                        if (chichang) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> 已持仓(测试用)';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                            continueOrderBtn.classList.add('position-active');
                            continueOrderBtn.disabled = false; // 保持可点击，因为它是测试按钮
                        } else {
                            // 检查是否有订单正在执行
                            if (data.hasOrder) {
                                continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                                continueOrderBtn.disabled = false; // 保持可点击
                            } else {
                                continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 续下单(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                                continueOrderBtn.classList.remove('position-active');
                                continueOrderBtn.disabled = false;
                            }
                        }
                    }
                    
                    // 显示状态指示器
                    if (statusIndicator) {
                        statusIndicator.style.display = 'block';
                        
                        // 更新状态文本和图标
                        if (chichang) {
                            statusText.innerHTML = `多头持仓: ${hasBuyPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}, 空头持仓: ${hasSellPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}`;
                            statusIcon.innerHTML = '🔄';
                            statusIcon.style.animation = 'spin 5s linear infinite';
                            statusIndicator.style.backgroundColor = '#e6f7ff';
                            statusIndicator.style.borderColor = '#91d5ff';
                        } else if (data.hasOrder) {
                            statusText.innerHTML = '有订单正在处理中';
                            statusIcon.innerHTML = '⏳';
                            statusIcon.style.animation = 'blink 1.5s ease infinite';
                            statusIndicator.style.backgroundColor = '#fffbe6';
                            statusIndicator.style.borderColor = '#ffe58f';
                        } else {
                            statusText.innerHTML = '当前无持仓，可以下单';
                            statusIcon.innerHTML = '✅';
                            statusIcon.style.animation = 'none';
                            statusIndicator.style.backgroundColor = '#f6ffed';
                            statusIndicator.style.borderColor = '#b7eb8f';
                        }
                    }
                    
                    // 始终使用localStorage中的运行状态，而不是从按钮状态获取
                    const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                    
                    // 如果允许交易且系统正在运行，且没有持仓，则进行自动下单
                    if (allowTrade && isRunning && !chichang) {
                        console.log('交易系统循环触发自动下单...');
                        
                        // 获取保证金值
                        const marginInput = document.getElementById('margin-input') || 
                                            document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                        const marginValue = marginInput ? marginInput.value : '0';
                        
                        // 如果保证金值有效，执行下单
                        if (parseFloat(marginValue) > 0) {
                            console.log(`执行自动下单: 交易对=${tradePair}, 金额=${marginValue}, 方向=${tradeDirection}`);
                            saveStrategy(false); // 执行下单但不启动策略循环
                        } else {
                            console.log('保证金金额无效，跳过自动下单');
                        }
                    }
                    
                    // 更新按钮状态 - 始终使用localStorage中的状态
                    updateButtonStatus(chichang, isRunning);
                    
                } else {
                    console.error('检查持仓状态失败:', data.message);
                    showToast(`检查持仓状态失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('请求出错:', error);
                showToast('网络请求失败，请检查网络连接', 'error');
                
                // 即使网络请求失败，也要确保按钮状态与localStorage一致
                const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                updateButtonStatus(chichang, isRunning);
            });
        }

        // 更新按钮状态
        function updateButtonStatus(hasPosition, isRunning) {
            const runBtn = document.getElementById('run-strategy-btn');
            const stopBtn = document.getElementById('stop-strategy-btn');
            
            // 再次从localStorage获取以确保一致性
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 使用savedIsRunning而不是传入的isRunning，确保与localStorage一致
            if (!runBtn) return;
            
            if (savedIsRunning) {
                // 交易系统正在运行
                runBtn.textContent = '停止';
                runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示可以停止
                runBtn.setAttribute('data-running', 'true');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                    statusElement.style.color = '#52c41a';
                }
                
                // 仅当有持仓时显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = hasPosition ? 'inline-block' : 'none';
                    // 强制停止按钮的样式保持红色
                    stopBtn.style.backgroundColor = '#ff4d4f';
                }
                
                // 确保交易系统循环是启动的
                if (!window.tradingSystemInterval) {
                    console.log('检测到系统应该运行但循环未启动，重新启动交易系统循环...');
                    startTradingSystemLoop();
                }
            } else {
                // 交易系统未运行
                runBtn.textContent = '运行';
                runBtn.style.backgroundColor = '#52c41a'; // 绿色表示可以运行
                runBtn.setAttribute('data-running', 'false');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统已停止，但仍有持仓' : '交易系统已停止';
                    statusElement.style.color = '#8c8c8c';
                }
                
                // 系统未运行时，不显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = 'none';
                }
                
                // 确保循环已停止
                if (window.tradingSystemInterval) {
                    console.log('检测到系统应该停止但循环仍在运行，停止交易系统循环...');
                    clearInterval(window.tradingSystemInterval);
                    window.tradingSystemInterval = null;
                }
            }
        }

        // 自定义确认对话框函数
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm, onCancel) {
            // 创建对话框容器
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.width = '100%';
            dialogOverlay.style.height = '100%';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            dialogOverlay.style.zIndex = '9999';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            // 创建对话框内容
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.width = '300px';
            dialog.style.maxWidth = '90%';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // 添加标题
            const titleElement = document.createElement('div');
            titleElement.textContent = title;
            titleElement.style.padding = '16px';
            titleElement.style.borderBottom = '1px solid #f0f0f0';
            titleElement.style.fontWeight = 'bold';
            dialog.appendChild(titleElement);
            
            // 添加消息
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.padding = '16px';
            messageElement.style.color = '#595959';
            dialog.appendChild(messageElement);
            
            // 添加按钮容器
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.borderTop = '1px solid #f0f0f0';
            
            // 确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.flex = '1';
            confirmButton.style.padding = '12px';
            confirmButton.style.border = 'none';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.color = 'white';
            confirmButton.style.borderRadius = '0 0 0 8px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onConfirm) onConfirm();
            });
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '12px';
            cancelButton.style.border = 'none';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#595959';
            cancelButton.style.borderRadius = '0 0 8px 0';
            cancelButton.style.cursor = 'pointer';
            cancelButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onCancel) onCancel();
            });
            
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            dialog.appendChild(buttonsContainer);
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
        }

        // 更新导航栏中的持仓数量显示
        function updatePositionCount(count) {
            // 尝试找到当前页面中的持仓数量显示元素
            const positionCountElem = document.querySelector('.flex-x.nav-li.active-nav-li.nav-li-p span:nth-child(2)');
            if (positionCountElem) {
                positionCountElem.textContent = `(${count})`;
            }
            
            // 尝试发送消息到spot页面（如果有）
            try {
                // 将持仓信息广播到其他页面
                localStorage.setItem('okxPositionCount', count.toString());
                
                // 派发自定义事件
                window.dispatchEvent(new CustomEvent('okxPositionUpdated', {
                    detail: { count: count }
                }));
            } catch (e) {
                console.error('更新持仓数量出错:', e);
            }
            
            // 创建持仓信息展示区（如果尚未创建）
            if (!document.getElementById('position-details-container')) {
                // 在状态显示下方添加持仓详情区域
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = 'position-details-container';
                    detailsContainer.style.marginTop = '15px';
                    detailsContainer.style.padding = '15px';
                    detailsContainer.style.backgroundColor = '#f8f9fa';
                    detailsContainer.style.borderRadius = '8px';
                    detailsContainer.style.display = count > 0 ? 'block' : 'none';
                    statusElement.parentNode.insertBefore(detailsContainer, statusElement.nextSibling);
                }
            }
        }

        // 显示持仓详情
        function showPositionDetails(positionStatus, tradePair) {
            const container = document.getElementById('position-details-container');
            if (!container) return;
            
            container.style.display = 'block';
            container.innerHTML = `<h5 style="font-size: 16px; margin-bottom: 10px;">持仓详情</h5>`;
            
            // 显示多头持仓信息
            if (positionStatus.buy_flag) {
                const buyInfo = document.createElement('div');
                buyInfo.classList.add('position-item');
                buyInfo.style.marginBottom = '10px';
                buyInfo.style.padding = '10px';
                buyInfo.style.backgroundColor = '#e6f7ff';
                buyInfo.style.borderRadius = '4px';
                buyInfo.style.borderLeft = '3px solid #1890ff';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz) {
                    availPos = positionStatus.p_Pos_sz;
                }
                
                if (positionStatus.p_cw_avgPx) {
                    avgPrice = positionStatus.p_cw_avgPx;
                }
                
                buyInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 多头</span>
                        <span style="color: #52c41a;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(buyInfo);
            }
            
            // 显示空头持仓信息
            if (positionStatus.sell_flag) {
                const sellInfo = document.createElement('div');
                sellInfo.classList.add('position-item');
                sellInfo.style.marginBottom = '10px';
                sellInfo.style.padding = '10px';
                sellInfo.style.backgroundColor = '#fff2e8';
                sellInfo.style.borderRadius = '4px';
                sellInfo.style.borderLeft = '3px solid #fa541c';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz_s) {
                    availPos = positionStatus.p_Pos_sz_s;
                }
                
                if (positionStatus.p_cw_avgPx_s) {
                    avgPrice = positionStatus.p_cw_avgPx_s;
                }
                
                sellInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 空头</span>
                        <span style="color: #ff4d4f;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(sellInfo);
            }
        }

        // 清除持仓详情显示
        function clearPositionDetails() {
            const container = document.getElementById('position-details-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
        
        // 检查是否为特殊币种（如ARB等低价值代币）
        function isSpecialCoin(tradePair) {
            if (!tradePair) return false;
            
            // 提取交易对中的币种名称
            let coinName = tradePair.split('-')[0];
            if (!coinName) return false;
            
            // 特殊币种列表（需要特殊处理的币种）
            const specialCoins = ['ARB', 'DOGE', 'SHIB', 'XRP'];
            
            // 检查是否为特殊币种
            return specialCoins.includes(coinName);
        }
        
        // 显示订单结果模态窗口
        function showOrderResultModal(orderResult, tradePair) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '450px';
            
            // 添加标题和成功图标
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.justifyContent = 'center';
            titleContainer.style.marginBottom = '15px';
            
            const successIcon = document.createElement('div');
            successIcon.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32"><path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.177-7.86l-2.765-2.767L7 12.431l3.119 3.121a1 1 0 001.414 0l5.952-5.95-1.062-1.062-5.6 5.6z"/></svg>';
            successIcon.style.marginRight = '10px';
            
            const title = document.createElement('h3');
            title.textContent = '下单成功';
            title.className = 'modal-title';
            title.style.margin = '0';
            
            titleContainer.appendChild(successIcon);
            titleContainer.appendChild(title);
            modalContent.appendChild(titleContainer);
            
            // 添加交易对信息
            const pairInfo = document.createElement('div');
            pairInfo.style.background = 'linear-gradient(135deg, #f0f7ff, #e6f7ff)';
            pairInfo.style.padding = '12px 15px';
            pairInfo.style.borderRadius = '8px';
            pairInfo.style.marginBottom = '15px';
            pairInfo.style.display = 'flex';
            pairInfo.style.alignItems = 'center';
            pairInfo.style.justifyContent = 'space-between';
            
            const pairLabel = document.createElement('span');
            pairLabel.textContent = '交易对:';
            pairLabel.style.color = '#333';
            pairLabel.style.fontWeight = '500';
            
            const pairValue = document.createElement('span');
            pairValue.textContent = tradePair;
            pairValue.style.color = '#1a6aff';
            pairValue.style.fontWeight = '600';
            pairValue.style.fontSize = '16px';
            
            pairInfo.appendChild(pairLabel);
            pairInfo.appendChild(pairValue);
            modalContent.appendChild(pairInfo);
            
            // 添加订单详情
            const orderDetails = document.createElement('div');
            orderDetails.className = 'order-details';
            orderDetails.style.background = '#f9fafc';
            orderDetails.style.border = '1px solid #f0f0f0';
            orderDetails.style.borderRadius = '8px';
            orderDetails.style.padding = '15px';
            
            // 定义要显示的字段和对应的中文名称
            const fieldLabels = {
                'orderId': '订单ID',
                'status': '状态',
                'exchangeId': '交易所',
                'direction': '方向',
                'contractSize': '合约数量',
                'margin': '保证金',
                'tradePair': '交易对',
                'price': '价格',
                'time': '时间'
            };
            
            // 按顺序显示字段
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'price', 'time'];
            
            // 格式化并显示订单结果数据
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                    const detailRow = document.createElement('div');
                    detailRow.className = 'detail-row';
                    
                    const detailLabel = document.createElement('span');
                    detailLabel.textContent = fieldLabels[key] || key;
                    detailLabel.className = 'detail-label';
                    
                    const detailValue = document.createElement('span');
                    detailValue.textContent = orderResult[key];
                    detailValue.className = 'detail-value';
                    
                    // 为特定字段添加样式
                    if (key === 'direction') {
                        detailValue.style.color = orderResult[key] === '做多' ? '#52c41a' : '#ff4d4f';
                        detailValue.style.fontWeight = '600';
                    } else if (key === 'status') {
                        detailValue.style.color = '#52c41a';
                        detailValue.style.fontWeight = '600';
                    }
                    
                    detailRow.appendChild(detailLabel);
                    detailRow.appendChild(detailValue);
                    orderDetails.appendChild(detailRow);
                }
            });
            
            modalContent.appendChild(orderDetails);
            
            // 检查是否为特殊币种（如ARB）并添加特殊提示
            if (isSpecialCoin(tradePair)) {
                const specialNoteContainer = document.createElement('div');
                specialNoteContainer.style.backgroundColor = '#fffbe6';
                specialNoteContainer.style.border = '1px solid #ffe58f';
                specialNoteContainer.style.borderRadius = '4px';
                specialNoteContainer.style.padding = '10px 12px';
                specialNoteContainer.style.marginTop = '10px';
                specialNoteContainer.style.marginBottom = '10px';
                
                const noteTitle = document.createElement('div');
                noteTitle.textContent = '特殊币种提示';
                noteTitle.style.fontWeight = '600';
                noteTitle.style.color = '#fa8c16';
                noteTitle.style.marginBottom = '5px';
                
                const noteContent = document.createElement('div');
                noteContent.style.fontSize = '13px';
                noteContent.style.color = '#666';
                noteContent.style.lineHeight = '1.5';
                noteContent.innerHTML = `对于 ${tradePair.split('-')[0]} 等特殊币种，显示的合约数量可能与实际持有的代币数量不同。<br/>请注意，系统中显示的持仓数量可能是实际代币数量，而非合约数量。`;
                
                specialNoteContainer.appendChild(noteTitle);
                specialNoteContainer.appendChild(noteContent);
                modalContent.appendChild(specialNoteContainer);
            }
            
            // 添加操作说明
            const infoText = document.createElement('p');
            infoText.textContent = '您的订单已成功提交，可在交易所查看订单详情。';
            infoText.style.color = '#8c8c8c';
            infoText.style.fontSize = '14px';
            infoText.style.textAlign = 'center';
            infoText.style.margin = '15px 0';
            modalContent.appendChild(infoText);
            
            // 添加确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = '确定';
            confirmButton.className = 'modal-confirm-btn';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.width = '100%';
            confirmButton.style.height = '40px';
            confirmButton.style.borderRadius = '20px';
            confirmButton.style.marginTop = '10px';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmButton);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 显示持仓状态函数
        function displayPositionStatus(statusData) {
            // 清除当前显示的状态
            const statusContainer = document.getElementById('position-status-container');
            if (!statusContainer) {
                console.log('未找到状态容器元素');
                return;
            }
            
            // 清空容器内容
            statusContainer.innerHTML = '';
            
            // 检查是否有持仓数据
            if (!statusData || (!statusData.buy_flag && !statusData.sell_flag)) {
                // 无持仓时显示提示
                statusContainer.innerHTML = `
                    <div class="no-position-message" style="text-align: center; padding: 20px; color: #8c8c8c;">
        // 检查持仓状态函数
        function checkPositionStatus(allowTrade = false) {
            console.log(`检查持仓状态 (允许交易: ${allowTrade})`);
            
            // 获取当前选择的交易对和交易方向
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 更新最后刷新时间
            const lastRefreshElement = document.getElementById('last-refresh-time');
            if (lastRefreshElement) {
                lastRefreshElement.textContent = `最后刷新: ${new Date().toLocaleTimeString()}`;
            }
            
            // 确保从localStorage中获取正确的运行状态，确保与按钮状态同步
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 如果localStorage中有运行状态，同步按钮状态
            const runBtn = document.getElementById('run-strategy-btn');
            if (runBtn) {
                const currentBtnState = runBtn.getAttribute('data-running') === 'true';
                // 如果按钮状态与保存的状态不一致，则同步
                if (currentBtnState !== savedIsRunning) {
                    console.log(`按钮状态(${currentBtnState})与localStorage中的运行状态(${savedIsRunning})不一致，正在同步...`);
                    runBtn.setAttribute('data-running', savedIsRunning.toString());
                    
                    // 更新按钮外观
                    if (savedIsRunning) {
                        runBtn.textContent = '停止';
                        runBtn.style.backgroundColor = '#ff4d4f';
                    } else {
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                }
            }
            
            // 更新续下单按钮显示状态
            const continueOrderBtn = document.getElementById('continue-order-btn');
            
            // 发送请求检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 更新持仓状态
                    const hasBuyPosition = data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 记录状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 更新策略运行状态指示器
                    const statusIndicator = document.getElementById('key-status-indicator');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // 如果有持仓，更新续下单按钮样式
                    if (continueOrderBtn) {
                        if (chichang) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> 已持仓(测试用)';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                            continueOrderBtn.classList.add('position-active');
                            continueOrderBtn.disabled = false; // 保持可点击，因为它是测试按钮
                        } else {
                            // 检查是否有订单正在执行
                            if (data.hasOrder) {
                                continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                                continueOrderBtn.disabled = false; // 保持可点击
                            } else {
                                continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 续下单(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                                continueOrderBtn.classList.remove('position-active');
                                continueOrderBtn.disabled = false;
                            }
                        }
                    }
                    
                    // 显示状态指示器
                    if (statusIndicator) {
                        statusIndicator.style.display = 'block';
                        
                        // 更新状态文本和图标
                        if (chichang) {
                            statusText.innerHTML = `多头持仓: ${hasBuyPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}, 空头持仓: ${hasSellPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}`;
                            statusIcon.innerHTML = '🔄';
                            statusIcon.style.animation = 'spin 5s linear infinite';
                            statusIndicator.style.backgroundColor = '#e6f7ff';
                            statusIndicator.style.borderColor = '#91d5ff';
                        } else if (data.hasOrder) {
                            statusText.innerHTML = '有订单正在处理中';
                            statusIcon.innerHTML = '⏳';
                            statusIcon.style.animation = 'blink 1.5s ease infinite';
                            statusIndicator.style.backgroundColor = '#fffbe6';
                            statusIndicator.style.borderColor = '#ffe58f';
                        } else {
                            statusText.innerHTML = '当前无持仓，可以下单';
                            statusIcon.innerHTML = '✅';
                            statusIcon.style.animation = 'none';
                            statusIndicator.style.backgroundColor = '#f6ffed';
                            statusIndicator.style.borderColor = '#b7eb8f';
                        }
                    }
                    
                    // 始终使用localStorage中的运行状态，而不是从按钮状态获取
                    const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                    
                    // 如果允许交易且系统正在运行，且没有持仓，则进行自动下单
                    if (allowTrade && isRunning && !chichang) {
                        console.log('交易系统循环触发自动下单...');
                        
                        // 获取保证金值
                        const marginInput = document.getElementById('margin-input') || 
                                            document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                        const marginValue = marginInput ? marginInput.value : '0';
                        
                        // 如果保证金值有效，执行下单
                        if (parseFloat(marginValue) > 0) {
                            console.log(`执行自动下单: 交易对=${tradePair}, 金额=${marginValue}, 方向=${tradeDirection}`);
                            saveStrategy(false); // 执行下单但不启动策略循环
                        } else {
                            console.log('保证金金额无效，跳过自动下单');
                        }
                    }
                    
                    // 更新按钮状态 - 始终使用localStorage中的状态
                    updateButtonStatus(chichang, isRunning);
                    
                } else {
                    console.error('检查持仓状态失败:', data.message);
                    showToast(`检查持仓状态失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('请求出错:', error);
                showToast('网络请求失败，请检查网络连接', 'error');
                
                // 即使网络请求失败，也要确保按钮状态与localStorage一致
                const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                updateButtonStatus(chichang, isRunning);
            });
        }

        // 更新按钮状态
        function updateButtonStatus(hasPosition, isRunning) {
            const runBtn = document.getElementById('run-strategy-btn');
            const stopBtn = document.getElementById('stop-strategy-btn');
            
            // 再次从localStorage获取以确保一致性
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 使用savedIsRunning而不是传入的isRunning，确保与localStorage一致
            if (!runBtn) return;
            
            if (savedIsRunning) {
                // 交易系统正在运行
                runBtn.textContent = '停止';
                runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示可以停止
                runBtn.setAttribute('data-running', 'true');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                    statusElement.style.color = '#52c41a';
                }
                
                // 仅当有持仓时显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = hasPosition ? 'inline-block' : 'none';
                    // 强制停止按钮的样式保持红色
                    stopBtn.style.backgroundColor = '#ff4d4f';
                }
                
                // 确保交易系统循环是启动的
                if (!window.tradingSystemInterval) {
                    console.log('检测到系统应该运行但循环未启动，重新启动交易系统循环...');
                    startTradingSystemLoop();
                }
            } else {
                // 交易系统未运行
                runBtn.textContent = '运行';
                runBtn.style.backgroundColor = '#52c41a'; // 绿色表示可以运行
                runBtn.setAttribute('data-running', 'false');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统已停止，但仍有持仓' : '交易系统已停止';
                    statusElement.style.color = '#8c8c8c';
                }
                
                // 系统未运行时，不显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = 'none';
                }
                
                // 确保循环已停止
                if (window.tradingSystemInterval) {
                    console.log('检测到系统应该停止但循环仍在运行，停止交易系统循环...');
                    clearInterval(window.tradingSystemInterval);
                    window.tradingSystemInterval = null;
                }
            }
        }

        // 自定义确认对话框函数
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm, onCancel) {
            // 创建对话框容器
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.width = '100%';
            dialogOverlay.style.height = '100%';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            dialogOverlay.style.zIndex = '9999';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            // 创建对话框内容
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.width = '300px';
            dialog.style.maxWidth = '90%';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // 添加标题
            const titleElement = document.createElement('div');
            titleElement.textContent = title;
            titleElement.style.padding = '16px';
            titleElement.style.borderBottom = '1px solid #f0f0f0';
            titleElement.style.fontWeight = 'bold';
            dialog.appendChild(titleElement);
            
            // 添加消息
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.padding = '16px';
            messageElement.style.color = '#595959';
            dialog.appendChild(messageElement);
            
            // 添加按钮容器
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.borderTop = '1px solid #f0f0f0';
            
            // 确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.flex = '1';
            confirmButton.style.padding = '12px';
            confirmButton.style.border = 'none';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.color = 'white';
            confirmButton.style.borderRadius = '0 0 0 8px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onConfirm) onConfirm();
            });
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '12px';
            cancelButton.style.border = 'none';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#595959';
            cancelButton.style.borderRadius = '0 0 8px 0';
            cancelButton.style.cursor = 'pointer';
            cancelButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onCancel) onCancel();
            });
            
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            dialog.appendChild(buttonsContainer);
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
        }

        // 更新导航栏中的持仓数量显示
        function updatePositionCount(count) {
            // 尝试找到当前页面中的持仓数量显示元素
            const positionCountElem = document.querySelector('.flex-x.nav-li.active-nav-li.nav-li-p span:nth-child(2)');
            if (positionCountElem) {
                positionCountElem.textContent = `(${count})`;
            }
            
            // 尝试发送消息到spot页面（如果有）
            try {
                // 将持仓信息广播到其他页面
                localStorage.setItem('okxPositionCount', count.toString());
                
                // 派发自定义事件
                window.dispatchEvent(new CustomEvent('okxPositionUpdated', {
                    detail: { count: count }
                }));
            } catch (e) {
                console.error('更新持仓数量出错:', e);
            }
            
            // 创建持仓信息展示区（如果尚未创建）
            if (!document.getElementById('position-details-container')) {
                // 在状态显示下方添加持仓详情区域
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = 'position-details-container';
                    detailsContainer.style.marginTop = '15px';
                    detailsContainer.style.padding = '15px';
                    detailsContainer.style.backgroundColor = '#f8f9fa';
                    detailsContainer.style.borderRadius = '8px';
                    detailsContainer.style.display = count > 0 ? 'block' : 'none';
                    statusElement.parentNode.insertBefore(detailsContainer, statusElement.nextSibling);
                }
            }
        }

        // 显示持仓详情
        function showPositionDetails(positionStatus, tradePair) {
            const container = document.getElementById('position-details-container');
            if (!container) return;
            
            container.style.display = 'block';
            container.innerHTML = `<h5 style="font-size: 16px; margin-bottom: 10px;">持仓详情</h5>`;
            
            // 显示多头持仓信息
            if (positionStatus.buy_flag) {
                const buyInfo = document.createElement('div');
                buyInfo.classList.add('position-item');
                buyInfo.style.marginBottom = '10px';
                buyInfo.style.padding = '10px';
                buyInfo.style.backgroundColor = '#e6f7ff';
                buyInfo.style.borderRadius = '4px';
                buyInfo.style.borderLeft = '3px solid #1890ff';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz) {
                    availPos = positionStatus.p_Pos_sz;
                }
                
                if (positionStatus.p_cw_avgPx) {
                    avgPrice = positionStatus.p_cw_avgPx;
                }
                
                buyInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 多头</span>
                        <span style="color: #52c41a;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(buyInfo);
            }
            
            // 显示空头持仓信息
            if (positionStatus.sell_flag) {
                const sellInfo = document.createElement('div');
                sellInfo.classList.add('position-item');
                sellInfo.style.marginBottom = '10px';
                sellInfo.style.padding = '10px';
                sellInfo.style.backgroundColor = '#fff2e8';
                sellInfo.style.borderRadius = '4px';
                sellInfo.style.borderLeft = '3px solid #fa541c';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz_s) {
                    availPos = positionStatus.p_Pos_sz_s;
                }
                
                if (positionStatus.p_cw_avgPx_s) {
                    avgPrice = positionStatus.p_cw_avgPx_s;
                }
                
                sellInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 空头</span>
                        <span style="color: #ff4d4f;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(sellInfo);
            }
        }

        // 清除持仓详情显示
        function clearPositionDetails() {
            const container = document.getElementById('position-details-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
        
        // 检查是否为特殊币种（如ARB等低价值代币）
        function isSpecialCoin(tradePair) {
            if (!tradePair) return false;
            
            // 提取交易对中的币种名称
            let coinName = tradePair.split('-')[0];
            if (!coinName) return false;
            
            // 特殊币种列表（需要特殊处理的币种）
            const specialCoins = ['ARB', 'DOGE', 'SHIB', 'XRP'];
            
            // 检查是否为特殊币种
            return specialCoins.includes(coinName);
        }
        
        // 显示订单结果模态窗口
        function showOrderResultModal(orderResult, tradePair) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '450px';
            
            // 添加标题和成功图标
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.justifyContent = 'center';
            titleContainer.style.marginBottom = '15px';
            
            const successIcon = document.createElement('div');
            successIcon.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32"><path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.177-7.86l-2.765-2.767L7 12.431l3.119 3.121a1 1 0 001.414 0l5.952-5.95-1.062-1.062-5.6 5.6z"/></svg>';
            successIcon.style.marginRight = '10px';
            
            const title = document.createElement('h3');
            title.textContent = '下单成功';
            title.className = 'modal-title';
            title.style.margin = '0';
            
            titleContainer.appendChild(successIcon);
            titleContainer.appendChild(title);
            modalContent.appendChild(titleContainer);
            
            // 添加交易对信息
            const pairInfo = document.createElement('div');
            pairInfo.style.background = 'linear-gradient(135deg, #f0f7ff, #e6f7ff)';
            pairInfo.style.padding = '12px 15px';
            pairInfo.style.borderRadius = '8px';
            pairInfo.style.marginBottom = '15px';
            pairInfo.style.display = 'flex';
            pairInfo.style.alignItems = 'center';
            pairInfo.style.justifyContent = 'space-between';
            
            const pairLabel = document.createElement('span');
            pairLabel.textContent = '交易对:';
            pairLabel.style.color = '#333';
            pairLabel.style.fontWeight = '500';
            
            const pairValue = document.createElement('span');
            pairValue.textContent = tradePair;
            pairValue.style.color = '#1a6aff';
            pairValue.style.fontWeight = '600';
            pairValue.style.fontSize = '16px';
            
            pairInfo.appendChild(pairLabel);
            pairInfo.appendChild(pairValue);
            modalContent.appendChild(pairInfo);
            
            // 添加订单详情
            const orderDetails = document.createElement('div');
            orderDetails.className = 'order-details';
            orderDetails.style.background = '#f9fafc';
            orderDetails.style.border = '1px solid #f0f0f0';
            orderDetails.style.borderRadius = '8px';
            orderDetails.style.padding = '15px';
            
            // 定义要显示的字段和对应的中文名称
            const fieldLabels = {
                'orderId': '订单ID',
                'status': '状态',
                'exchangeId': '交易所',
                'direction': '方向',
                'contractSize': '合约数量',
                'margin': '保证金',
                'tradePair': '交易对',
                'price': '价格',
                'time': '时间'
            };
            
            // 按顺序显示字段
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'price', 'time'];
            
            // 格式化并显示订单结果数据
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                    const detailRow = document.createElement('div');
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能交易 - 策略设置</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/crypto-theme.css">
    <style>
        /* 页面基础样式 */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        /* 已下单状态按钮样式 */
        .confirm-btn.order-success {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }
        
        .confirm-btn.order-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
            background: linear-gradient(135deg, #46b314, #66c832);
        }
        
        /* 已持仓状态按钮样式 */
        .confirm-btn.position-active {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }
        
        .confirm-btn.position-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
            background: linear-gradient(135deg, #096dd9, #1f9fff);
        }
        
        /* 导航栏样式 */
        .u-navbar {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }
        
        .u-navbar__content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            padding: 0 15px;
        }
        
        .u-navbar__content__left {
            position: absolute;
            left: 15px;
            display: flex;
            align-items: center;
        }
        
        .u-navbar__content__title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .u-icon__icon {
            font-size: 20px;
            color: #ffffff;
            transition: transform 0.2s ease;
        }
        
        .u-icon__icon:hover {
            transform: scale(1.1);
        }
        
        /* 主要内容区域 */
        .robot-settings {
            margin-top: 70px;
            padding: 15px;
        }
        
        /* 卡片式容器 */
        .box {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .box:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.11);
            transform: translateY(-2px);
        }
        
        .box-card {
            padding: 22px;
        }
        
        /* 顶部资产信息 */
        .top-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .top-left {
            display: flex;
            flex-direction: column;
        }
        
        .available-m {
            font-size: 14px;
            color: #8c8c8c;
            margin-right: 8px;
        }
        
        .refresh-img {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .refresh-img:hover {
            transform: rotate(90deg);
        }
        
        .now-money {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
            margin-top: 5px;
            letter-spacing: 0.5px;
        }
        
        .top-right {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .coin-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 2px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .change-img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .change-img:hover {
            opacity: 1;
        }
        
        /* 表单项样式 */
        .self-forms {
            margin-top: 15px;
        }
        
        .forms-item {
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .forms-item:hover {
            transform: translateY(-2px);
        }
        
        .form-item-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-size: 15px;
            color: #262626;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .form-item-input {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .form-item-input:focus-within {
            box-shadow: 0 0 0 2px rgba(51, 102, 255, 0.2);
        }
        
        .input-border {
            border: 1px solid #e8e8e8;
        }
        
        .robot-info {
            display: flex;
            align-items: center;
        }
        
        .robot-name {
            margin-left: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #262626;
        }
        
        .input-right {
            margin-left: auto;
            color: #3366FF;
        }
        
        /* 策略类型选择 */
        .type-scroll {
            display: flex;
            overflow-x: auto;
            margin: 10px 0;
            padding: 8px 0;
            scrollbar-width: none; /* Firefox */
        }
        
        .type-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .scroll-li-types {
            min-width: 100px;
            height: 44px;
            border-radius: 22px;
            background-color: #f9fafc;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #5c5c5c;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .scroll-li-types:hover {
            background-color: #edf2ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(51, 102, 255, 0.15);
        }
        
        .type-actives {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.3);
            border: none;
        }
        
        /* 滑块样式 */
        .gress-box {
            margin: 15px 0;
            padding: 5px 0;
            width: 100%;
        }
        
        .sunny-sliderBar {
            width: 100%;
        }
        
        /* 进度条样式优化，修复背景出界问题 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            max-width: 100% !important;
            overflow: hidden;
        }
        
        /* 滑动条容器增强 */
        .sliderBar {
            cursor: pointer;
            background: linear-gradient(to bottom, #f0f0f0, #f9fafc);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
            border-radius: 22px;
            position: relative;
            border: 1px solid rgba(220, 220, 220, 0.9);
            height: 44px;
            overflow: hidden;
        }
        
        .img-box {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .move-img {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .move-img:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .dot-indicator {
            width: 14px;
            height: 14px;
            background-color: #fff;
            border: 2px solid var(--primaryColor, #1a6aff);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(26, 106, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .move-img:hover .dot-indicator {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.3);
        }
        
        .bili-text {
            position: absolute;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .move-img:hover .bili-text {
            color: #1a6aff;
            font-weight: 600;
        }
        
        .gone {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            z-index: 1;
            transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .slider {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(51, 102, 255, 0.4);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) inset;
        }
        
        .slider::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        .slider:hover {
            box-shadow: 0 5px 18px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .slider:active {
            box-shadow: 0 2px 8px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(0.98);
        }
        
        .count {
            color: rgba(255, 255, 255, 0);
            font-size: 13px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a6aff;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .slider:hover .count {
            color: rgba(255, 255, 255, 1);
            opacity: 1;
            bottom: -30px;
        }
        
        .position-slider-container {
            padding: 15px 0;
        }
        
        /* 底部按钮 */
        .confirm-bot-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background-color: white;
            z-index: 90;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.08);
        }
        
        .confirm-btn {
            width: 100%;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            font-size: 16px;
            font-weight: 500;
            border: none;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
            letter-spacing: 1px;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 102, 255, 0.35);
            background: linear-gradient(135deg, #0a5aea, #2d78ff);
        }
        
        .confirm-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(51, 102, 255, 0.3);
        }
        
        /* 开关样式 */
        .toggle-wrapper {
            width: 60px;
            height: 32px;
            position: relative;
            background-color: #e8e8e8;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-background {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: block;
            transition: all 0.3s ease;
        }
        
        .toggle-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        .active-lis .toggle-background {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
        }
        
        .active-lis .toggle-indicator {
            transform: translateX(28px);
        }
        
        /* 单选框样式 */
        .radio-box {
            display: flex;
            flex-wrap: wrap;
            margin: 5px 0;
        }
        
        .u-radio {
            margin-right: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        
        .u-radio:hover {
            color: #3366FF;
        }
        
        .u-radio__icon-wrap {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c8c9cc;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .u-radio__icon-wrap--circle {
            background-color: #fff;
        }
        
        /* 修改原有样式 */
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .settings-row:hover {
            background-color: #f9fafc;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 15px;
            color: #454545;
            font-weight: 500;
        }
        
        .setting-value {
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .arrow-right {
            margin-left: 10px;
            color: #c0c4cc;
            transition: transform 0.2s ease;
        }
        
        .settings-row:hover .arrow-right {
            transform: translateX(3px);
            color: #3366FF;
        }
        
        /* 添加uni-app风格组件样式 */
        .f-1 {
            flex: 1;
        }
        
        .box2 {
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .box2:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.09);
        }
        
        .flexs {
            display: flex;
            align-items: center;
        }
        
        .flex-x {
            display: flex;
            align-items: center;
        }
        
        .flex-y {
            display: flex;
            flex-direction: column;
        }
        
        .flex-x-b {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .flex-x-c {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flex-y-c {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .f-s {
            display: flex;
            align-items: center;
        }
        
        .theme-border-color {
            border-color: #e8e8e8;
        }
        
        .theme-border-color2 {
            border-color: #f5f7fa;
        }
        
        .box-bg1 {
            background-color: #f5f7fa;
        }
        
        .margin_r1 {
            margin-right: 10px;
        }
        
        .margin_b1 {
            margin-bottom: 18px;
        }
        
        .lable-name {
            font-size: 15px;
            color: #262626;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .type-box {
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .type-li {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .type-active {
            background: linear-gradient(135deg, #3366FF, #5C91EF);
            color: white;
        }
        
        .icon-box {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        
        .uni-input-input {
            height: 36px;
            width: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 15px;
            color: #262626;
            font-weight: 500;
        }
        
        .uni-input-wrapper {
            width: 100%;
            position: relative;
        }
        
        .myicon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        
        .icon-Choose:before {
            content: "\f0c9";
        }
        
        /* 滑块相关样式补充 */
        .gress-box {
            margin: 10px 0;
            padding: 10px 5px;
            width: 100%;
        }
        
        .uni-input-placeholder {
            color: #999;
            font-size: 14px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
        }
        
        .uicon-question-circle:before {
            content: "\f059";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-right:before {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-down-fill:before {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
        }
        
        /* 修改滑块组件样式 */
        .position-slider-container {
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* 添加动画和过渡效果 */
        .element-animated {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .title-animated {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .row-clicked {
            background-color: #f0f7ff !important;
        }
        
        .btn-clicked {
            transform: scale(0.95) !important;
        }
        
        .slider-active {
            box-shadow: 0 5px 15px rgba(51, 102, 255, 0.5) !important;
        }
        
        .page-loaded .u-navbar {
            transform: translateY(0);
        }
        
        /* Toast消息提示 */
        .toast-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background-color: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 9999;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 80%;
            font-weight: 500;
        }
        
        .toast-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 新增高级样式 */
        .premium-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #ffb700, #ffd869);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 2px 6px rgba(255, 183, 0, 0.3);
        }
        
        .premium-icon i {
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .premium-strategy {
            position: relative;
        }
        
        .premium-strategy::after {
            content: "推荐";
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
        }
        
        /* 新增按钮悬停效果 */
        .hover-glow {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(26, 106, 255, 0.4);
        }
        
        /* 动画关键帧增强 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 新增投入金额高亮效果 - 已修改为无动画 */
        .margin-highlight {
            box-shadow: 0 0 0 2px rgba(26, 106, 255, 0.3);
        }
        
        /* 杠杆选择框样式优化 */
        .leverage-dialog {
            animation: fadeInUp 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .leverage-option {
            position: relative;
            overflow: hidden;
        }
        
        .leverage-option::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 106, 255, 0.05);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: -1;
        }
        
        .leverage-option:hover::before {
            transform: scaleX(1);
        }
        
        /* 页面初始化状态 */
        .u-navbar {
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        
        /* 滑块颜色样式 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }
        
        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }
        
        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }

        /* 滑块动画效果 */
        .slider-active {
            transform: scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }

        .slider-pulse {
            animation: pulse 0.3s ease-out;
        }

        .slider-done {
            animation: done 0.5s ease-out;
        }

        .dot-active {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(26, 106, 255, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 3;
        }

        @keyframes pulse {
            0% { transform: scale(1) translateX(var(--x-position, 0)); }
            50% { transform: scale(1.2) translateX(var(--x-position, 0)); }
            100% { transform: scale(1) translateX(var(--x-position, 0)); }
        }

        @keyframes done {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }

        /* 滑动条容器增强样式 */
        .sliderBar {
            cursor: pointer;
            background-color: #f5f7fa;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 进度条样式增强 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 4px;
        }

        /* 滑块增强样式 */
        .slider {
            cursor: grab;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
            z-index: 4;
        }
        
        .slider:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(26, 106, 255, 0.6);
        }
        
        .slider:active {
            cursor: grabbing;
        }

        /* 百分比显示样式增强 */
        .slider .count {
            background-color: #1a6aff;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider:hover .count {
            transform: translateY(-5px) scale(1.1);
        }

        /* 固定点样式增强 */
        .move-img {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border: 1px solid #e4e7ed;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 3;
        }
        
        .move-img:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.4);
        }
        
        /* 滑块点指示器 */
        .dot-indicator {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dot-indicator::after {
            content: "";
            width: 6px;
            height: 6px;
            background-color: #1a6aff;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .move-img:hover .dot-indicator::after {
            transform: scale(1.5);
        }
        
        /* 滑块优化 */
        #position-slider-percent {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
        }
        
        #position-slider-percent:active {
            cursor: grabbing;
            transform: scale(1.1) translateX(var(--x-pos, 0px));
        }
        
        #position-slider-percent .count {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 50px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            background-color: #1a6aff;
            color: white;
            border-radius: 13px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.3s;
        }
        
        /* 修复动画效果 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out;
        }
        
        .slider-done {
            animation: sliderDone 0.5s ease-out;
        }
        
        @keyframes sliderPulse {
            0% { transform: scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: scale(1.2) translateX(var(--x-pos, 0px)); }
            100% { transform: scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        /* 保证金输入框更强优化 - 彻底消除跳动 */
        .form-item-input.margin-input {
            height: 56px; /* 固定高度 */
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.9);
            background: linear-gradient(to bottom, #f9fafc, #fff);
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 保证输入框内部元素不引起跳动 */
        .form-item-input.margin-input .uni-input-wrapper {
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .form-item-input.margin-input .uni-input-input {
            font-family: 'Roboto Mono', monospace, 'Segoe UI', 'PingFang SC';
            font-size: 16px;
            letter-spacing: 0.5px;
            height: 100%;
            line-height: 56px; /* 与容器高度相同 */
            transition: all 0.2s ease;
        }
        
        /* 右侧单位固定位置和尺寸 */
        .margin-value-container {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px; /* 固定宽度 */
            font-size: 16px;
        }
        
        /* 滑块球体居中 */
        #position-slider-percent {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
            backdrop-filter: blur(4px);
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%) translateX(0); /* 垂直居中并保留水平移动能力 */
        }
        
        /* 更新滑块球体在激活和交互状态的变形样式 */
        #position-slider-percent:active {
            cursor: grabbing;
            transform: translateY(-50%) scale(1.05) translateX(var(--x-pos, 0px));
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }
        
        .slider-active {
            transform: translateY(-50%) scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }
        
        /* 修复动画关键帧，保持垂直居中 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        /* 百分比值显示 */
        #position-value-percent {
            transition: color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            min-width: 50px;
            text-align: right;
        }
        
        #position-value-percent:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: right;
            opacity: 0.7;
        }
        
        #position-value-percent:hover:after {
            transform: scaleX(1);
        }
        
        /* 动画关键帧增强 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 25px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 15px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 8px rgba(26, 106, 255, 0.3); }
        }
        
        .dot-active {
            animation: dotPulse 0.5s ease-out;
        }

        /* 数值变化动画 */
        .value-changing {
            animation: value-pulse 0.3s ease;
        }

        @keyframes value-pulse {
            0% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 添加滑块滑动时的样式，确保其垂直居中 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out !important;
        }

        /* 更新HTML中的滑块初始样式 */
        <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
            <span class="count">100%</span>
        </div>

        /* 为数字输入添加额外的反跳动防护 */
        .uni-input-input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield;
            margin: 0;
            padding: 0 15px; /* 统一内边距，防止跳动 */
            width: 100%;
        }

        /* 消除数字输入框的上下箭头，避免高度变化 */
        .uni-input-input[type="number"]::-webkit-inner-spin-button,
        .uni-input-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 添加数值平滑过渡效果 */
        .form-item-input.margin-input .uni-input-input {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 输入值变化时的动画优化 */
        .value-changing {
            animation: value-pulse 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes value-pulse {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 确保USDT单位有固定尺寸 */
        .margin-value-container span {
            min-width: 45px;
            text-align: center;
            display: block;
            font-size: 15px;
            font-weight: 600;
        }

        /* 不同颜色进度条的样式 */
        .progress-red {
            background: linear-gradient(135deg, rgba(255, 77, 79, 0.25), rgba(255, 120, 117, 0.25)) !important;
        }

        .progress-yellow {
            background: linear-gradient(135deg, rgba(250, 173, 20, 0.25), rgba(255, 197, 61, 0.25)) !important;
        }

        .progress-blue {
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25)) !important;
        }

        /* 滑块的颜色样式增强 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }

        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }

        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }
        
        /* 模态窗口样式 */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-container.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .order-details {
            width: 100%;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        
        .detail-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            max-width: 60%;
            word-break: break-all;
            text-align: right;
        }
        
        .modal-confirm-btn {
            background-color: #1a6aff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .modal-confirm-btn:hover {
            background-color: #0052d9;
        }
        
        .error-modal .modal-content {
            border-top: 4px solid #ff4d4f;
        }
        
        .error-icon {
            margin: 10px 0 20px;
            color: #ff4d4f;
        }
        
        .modal-message {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-modal .modal-confirm-btn {
            background-color: #ff4d4f;
        }
        
        .error-modal .modal-confirm-btn:hover {
            background-color: #ff1f1f;
        }

        /* 币种选择弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-search {
            margin-bottom: 15px;
        }
        
        .modal-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-body {
            overflow-y: auto;
            flex: 1;
        }
        
        .crypto-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .crypto-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .crypto-item:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .crypto-item.selected {
            background-color: #e6f0ff;
            border: 1px solid #1a6aff;
        }
        
        .crypto-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .crypto-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* 续下单按钮动画效果 */
        #continue-order-btn {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #continue-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
            z-index: -1;
        }
        
        #continue-order-btn:hover::before {
            left: 100%;
        }
    
        /* 禁用保证金输入框的所有动画和过渡 */
        #margin-input-container,
        #margin-input-container *,
        .margin-input,
        .uni-input-input {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }
        
        /* 禁用值变化动画 */
        .value-changing {
            animation: none !important;
            transition: none !important;
        }
        
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="u-navbar">
        <div class="u-navbar__content">
            <div class="u-navbar__content__left">
                <i class="fas fa-arrow-left u-icon__icon" onclick="goBackToContract()"></i>
            </div>
            <div class="u-navbar__content__title">{{ strategy.name }}</div>
            <div class="u-navbar__content__right"></div>
        </div>
        </div>
        
    <div class="robot-settings">
        <!-- 顶部资产信息 -->
        <div class="forms box box-card margin_t2 hover-glow">
            <div class="top-box">
                <div class="top-left">
                    <div class="flex-x">
                        <span class="available-m">可用资产</span>
                        <img src="/static/newimg/refresh.png" class="refresh-img" alt="刷新">
                    </div>
                    <span class="now-money">{{ strategy.invested }} USDT</span>
                </div>
                <div class="top-right">
                    <img src="https://newrobot.idyyvv.top/image/20210823/ff380e5a4eac6a36fbf7dde5ed153745.png" class="coin-img" alt="交易所">
                    <div class="flex-x">
                        <img src="/static/newimg/change.png" class="change-img" alt="切换">
                        <span class="now-money">Binance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表单内容 -->
        <div class="self-forms">
            <!-- 币种选择 -->
            <div class="forms-item f-1 box2 hover-glow" id="crypto-selector">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                        <div class="premium-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <img id="selected-crypto-icon" src="https://ai.hkd.red/symbolImage/{{ strategy.trade_pair.split('-')[0] }}.png" style="height: 32px; width: 32px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.08);" alt="币种图标">
                                <div id="selected-crypto-name" class="robot-name">{{ strategy.trade_pair.split('-')[0] }}/{{ strategy.trade_pair.split('-')[1] }}</div>
                                <input type="hidden" id="selected-crypto-pair" value="{{ strategy.trade_pair }}">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <span class="margin_r1" style="color: #1a6aff;"></span>
                            <span class="myicon icon-Choose" style="color: #1a6aff;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易对选择弹窗 -->
            <div id="crypto-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>选择交易对</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="crypto-search" placeholder="搜索币种...">
                    </div>
                    <div class="modal-body">
                        <div class="crypto-list">
                            {% for pair in trading_pairs %}
                            <div class="crypto-item" data-original="{{ pair.original }}" data-symbol="{{ pair.symbol }}" data-display="{{ pair.display }}">
                                <img src="{{ pair.icon_url }}" alt="{{ pair.symbol }}" onerror="this.src='/static/images/default-coin.svg'">
                                <span>{{ pair.display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 币种选择（隐藏） -->
            <div class="forms-item f-1 box2" style="display: none;">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                    </div>
                    </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <div class="robot-name">币种</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="flex-x">
                            <span>请选择币种</span>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-right" style="font-size: 14px; line-height: 14px; font-weight: normal; top: 1px; color: rgb(200, 200, 200);"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预设策略 -->
            <div class="flex-y margin_b1">
                <span class="lable-name">预设策略</span>
                <div class="type-scroll">
                    <div class="scroll-li-types type-actives">
                        <div class="li-type-center flex-x-c">保守型</div>
                    </div>
                    <div class="scroll-li-types premium-strategy">
                        <div class="li-type-center flex-x-c">稳健型</div>
                </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">激进型</div>
                    </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">自定义</div>
                </div>
                    </div>
            </div>
            
            <!-- 策略方向 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>策略方向</span>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color" style="padding: 0px;">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="type-box flex-x-b box-bg1" style="width: 176px;">
                                <span class="type-li type-active">做多</span>
                                <span class="type-li">做空</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-right"></div>
                </div>
            </div>
            
            <!-- 杠杆调整 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>杠杆调整</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input disabled="disabled" placeholder="选择杠杆倍数" maxlength="140" step="" enterkeyhint="done" autocomplete="off" type="text" class="uni-input-input">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-down-fill" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: #1a6aff;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预计投入 -->
            <div class="forms-item f-1 box2" id="margin-input-container">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>预计投入（保证金）</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border margin-input">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input placeholder="输入投入金额" maxlength="140" step="0.01" min="0.01" enterkeyhint="done" autocomplete="off" type="number" class="uni-input-input" id="margin-input" onchange="formatMarginValue(this)">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="margin-value-container">
                            <span style="font-weight: 500; color: #1a6aff;">USDT</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 策略参数设置 -->
            <div class="settings-card box hover-glow">
                <div class="settings-title">参数设置 <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">专业版</small></div>
                <div class="settings-row">
                    <div class="setting-label">网格数量</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.grid_count }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">价格区间</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.price_range }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">风险等级</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.risk_level }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>

                <!-- 添加仓位比例控制 -->
                <div class="settings-row">
                    <div class="setting-label">仓位比例控制</div>
                    <div class="setting-value">
                        <span id="position-value-percent" style="font-weight: 600; color: #1a6aff;">100%</span>
                    </div>
                </div>
                <div class="settings-row position-slider-container">
                    <div class="gress-box">
                        <div class="sunny-sliderBar" style="width: 100%; --sliderBarbgc:#f0f0f0; --primaryColor:#1a6aff;">
                            <div class="sliderBar" style="width: 100%;">
                                <div class="img-box">
                                    <div class="move-img" style="left: 0%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">0</span>
            </div>
                                    <div class="move-img" style="left: 25%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">25</span>
                </div>
                                    <div class="move-img" style="left: 50%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">50</span>
                    </div>
                                    <div class="move-img" style="left: 75%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">75</span>
                        </div>
                                    <div class="move-img" style="left: 100%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">100</span>
                        </div>
                    </div>
                                <div class="gone" style="width: 100%;"></div>
                                <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
                                    <span class="count">100%</span>
                </div>
                            </div>
                        </div>
                        </div>
                    </div>



                <div class="settings-row">
                    <div class="setting-label">续下单</div>
                    <div class="setting-value">
                        <button id="continue-order-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #1a6aff, #3f87ff); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(26, 106, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试用)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加策略控制按钮区域 -->
    <div class="strategy-controls" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;">
        <button class="confirm-btn hover-glow" id="run-strategy-btn" style="background-color: #52c41a; flex: 2;">运行</button>
        <button class="confirm-btn hover-glow" id="stop-strategy-btn" style="background-color: #ff4d4f; display: none; flex: 1;">强制停止</button>
    </div>
    <div id="strategy-status" style="margin-top: 10px; text-align: center; font-size: 14px; color: #8c8c8c;"></div>
    
    <!-- 添加自动刷新状态显示区域 -->
    <div id="auto-refresh-status" style="display: flex; align-items: center; justify-content: center; margin-top: 10px; font-size: 12px; color: #8c8c8c;">
        <div id="refresh-indicator" style="width: 8px; height: 8px; background-color: #52c41a; border-radius: 50%; margin-right: 5px;"></div>
        <span>自动刷新已开启 (10秒/次)</span>
    </div>
    <div id="last-refresh-time" style="text-align: center; font-size: 12px; color: #8c8c8c; margin-top: 5px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面
            initSettingsPage();
            
            // 添加页面加载动画
            document.body.classList.add('page-loaded');
            
            // 初始化币种选择功能
            initCryptoSelector();
            
            // 创建一个隐藏的保存按钮，保持功能但不显示
            const hiddenSaveBtn = document.createElement('button');
            hiddenSaveBtn.id = 'save-strategy-btn';
            hiddenSaveBtn.style.display = 'none';
            document.querySelector('.strategy-controls').appendChild(hiddenSaveBtn);
            
            // 为保存按钮添加点击事件
            document.getElementById('save-strategy-btn').addEventListener('click', function() {
                // 仅保存策略，不运行
                saveStrategy(false);
            });
            
            // 初始化策略状态指示器的动画
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes blink {
                    0% { opacity: 0.3; }
                    50% { opacity: 1; }
                    100% { opacity: 0.3; }
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // 检查是否有保存的运行状态
            const isSystemRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            console.log(`页面加载时检查到系统运行状态: ${isSystemRunning ? '运行中' : '已停止'}`);
            
            // 如果系统之前是运行状态，自动启动交易系统循环
            if (isSystemRunning) {
                const runBtn = document.getElementById('run-strategy-btn');
                if (runBtn) {
                    runBtn.setAttribute('data-running', 'true');
                    runBtn.textContent = '停止';
                    runBtn.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    console.log('恢复之前的交易系统运行状态');
                }
            }
            
            // 立即检查持仓状态，优先处理buy_flag
            checkInitialPositionStatus();
            
            // 检查交易对JSON文件状态
            checkTradingPairsStatus();
            
            // 获取刷新指示灯元素
            const refreshIndicator = document.getElementById('refresh-indicator');
            // 添加自动刷新定时器 - 即使没有点击运行按钮也会自动刷新
            const autoRefreshInterval = setInterval(function() {
                console.log("自动刷新检查持仓状态...");
                
                // 每次刷新前，更新指示灯颜色为黄色，表示正在刷新
                if (refreshIndicator) {
                    refreshIndicator.style.backgroundColor = '#faad14';
                }
                
                // 检查状态，传入false参数表示只检查状态，不触发下单
                // 这里调用时，确保checkPositionStatus不会因为网络或其他原因意外重置系统状态
                const currentIsRunning = localStorage.getItem('tradingSystemRunning');
                checkPositionStatus(false);  // 只检查状态，不触发下单
                
                // 确保刷新后系统状态一致
                setTimeout(function() {
                    // 确保状态没有被意外改变
                    if (localStorage.getItem('tradingSystemRunning') !== currentIsRunning && currentIsRunning !== null) {
                        console.log('检测到系统状态被意外更改，正在恢复...');
                        localStorage.setItem('tradingSystemRunning', currentIsRunning);
                        // 强制更新UI
                        updateButtonStatus(chichang, currentIsRunning === 'true');
                    }
                    
                    // 刷新完成后，延迟将颜色改回绿色
                    if (refreshIndicator) {
                        refreshIndicator.style.backgroundColor = '#52c41a';
                    }
                }, 1000);
            }, 10000); // 每10秒自动刷新一次
            
            // 将自动刷新定时器保存到window对象，以便可以在需要时停止
            window.autoRefreshInterval = autoRefreshInterval;
            
            // 当页面关闭或刷新时，清除定时器
            window.addEventListener('beforeunload', function() {
                clearInterval(window.autoRefreshInterval);
            });
            
            // 初始化运行策略按钮
            document.getElementById('run-strategy-btn').addEventListener('click', function() {
                // 判断当前状态
                const isRunning = this.getAttribute('data-running') === 'true';
                
                if (isRunning) {
                    // 如果已经在运行，则停止循环
                    clearInterval(window.tradingSystemInterval);
                    this.setAttribute('data-running', 'false');
                    this.textContent = '运行';
                    this.style.backgroundColor = '#52c41a';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统已停止';
                        statusElement.style.color = '#8c8c8c';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    // 隐藏强制停止按钮
                    const stopBtn = document.getElementById('stop-strategy-btn');
                    if (stopBtn) {
                        stopBtn.style.display = 'none';
                    }
                    
                    showToast('交易系统循环已停止', 'info');
                } else {
                    // 如果未运行，启动循环
                    this.setAttribute('data-running', 'true');
                    this.textContent = '停止';
                    this.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'true');
                    
                    // 如果有持仓，显示强制停止按钮
                    if (chichang) {
                        const stopBtn = document.getElementById('stop-strategy-btn');
                        if (stopBtn) {
                            stopBtn.style.display = 'inline-block';
                        }
                    }
                    
                    showToast('交易系统循环已启动', 'success');
                }
            });
            
            // 初始化停止策略按钮（强制停止）
            document.getElementById('stop-strategy-btn').addEventListener('click', function() {
                if (chichang) {
                    // 如果有持仓，提示用户需要平仓
                    showConfirmDialog(
                        '强制停止警告', 
                        '当前有持仓，强制停止可能导致持仓无法自动平仓。是否继续运行直到平仓完成？',
                        '继续运行',
                        '强制停止',
                        function() {
                            // 用户选择继续运行，不做任何操作
                            showToast('策略将继续运行直到平仓完成');
                        },
                        function() {
                            // 用户选择强制停止
                            clearInterval(strategyInterval);
                            strategyRunning = false;
                            
                            // 强制修改运行状态按钮
                            const runBtn = document.getElementById('run-strategy-btn');
                            if (runBtn) {
                                runBtn.setAttribute('data-running', 'false');
                                runBtn.textContent = '运行';
                                runBtn.style.backgroundColor = '#52c41a';
                            }
                            
                            // 保存运行状态到localStorage
                            localStorage.setItem('tradingSystemRunning', 'false');
                            
                            updateButtonStatus(chichang, false);
                            
                            const statusElement = document.getElementById('strategy-status');
                            statusElement.textContent = '策略已强制停止，但仍有未平仓的持仓';
                            statusElement.style.color = '#ff4d4f';
                            
                            // 隐藏强制停止按钮
                            this.style.display = 'none';
                            
                            showToast('策略已强制停止，请注意未平仓的持仓状态', 'warning');
                        }
                    );
                } else {
                    // 没有持仓，直接停止
                    clearInterval(strategyInterval);
                    strategyRunning = false;
                    
                    // 强制修改运行状态按钮
                    const runBtn = document.getElementById('run-strategy-btn');
                    if (runBtn) {
                        runBtn.setAttribute('data-running', 'false');
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    updateButtonStatus(chichang, false);
                    
                    const statusElement = document.getElementById('strategy-status');
                    statusElement.textContent = '策略已强制停止';
                    statusElement.style.color = '#8c8c8c';
                    
                    // 隐藏强制停止按钮
                    this.style.display = 'none';
                    
                    showToast('策略已强制停止');
                }
            });
            
            // 为续下单按钮添加点击事件
            document.getElementById('continue-order-btn').addEventListener('click', function() {
                // 显示加载动画
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                this.disabled = true;
                
                // 显示测试提示
                showToast('这是测试功能，仅用于验证系统连接', 'info');
                
                // 调用测试功能而不是实际下单
                testOrderSystem();
                
                // 3秒后恢复按钮状态
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试)';
                    this.disabled = false;
                }, 3000);
            });


        });
        
        // 页面加载时检查持仓状态并更新按钮
        function checkPositionStatusOnLoad() {
            // 获取当前URL中的策略ID和交易对
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 获取交易对（根据策略ID设置不同的默认交易对）
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多
            
            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 显示加载状态
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = '正在检查持仓状态...';
            
            // 向后端发送请求获取持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // 检查当前方向是否有持仓
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // 初始化全局变量chichang（根据持仓状态）
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 初始化运行按钮状态
                    updateButtonStatus(chichang, strategyRunning);
                    
                    // 根据当前交易方向和持仓状态更新按钮
                    if ((tradeDirection === 'buy' && hasBuyPosition) || 
                        (tradeDirection === 'sell' && hasSellPosition)) {
                        // 已有相同方向持仓
                        saveBtn.textContent = '已持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = `当前有${hasBuyPosition ? '多头' : ''}${hasSellPosition ? '空头' : ''}持仓`;
                        statusElement.style.color = '#faad14'; // 黄色警告
                    } else if ((!hasBuyPosition && !hasSellPosition) && data.hasOrder) {
                        // 没有持仓但有订单，显示为"已下单"
                        saveBtn.textContent = '已下单，执行中';
                        saveBtn.classList.add('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '订单正在处理中，请稍候...';
                        statusElement.style.color = '#1a6aff'; // 蓝色信息
                    } else {
                        // 无持仓无订单
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '系统准备就绪，点击"运行"开始策略';
                        statusElement.style.color = '#52c41a'; // 绿色正常
                    }
                    
                    // 添加状态摘要显示 - 如果后端提供了状态摘要
                    if (data.statusSummary) {
                        // 在状态元素的下方添加后端状态摘要
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `后端状态: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // 如果已有之前的状态摘要，先移除
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                }
            })
            .catch(error => {
                console.error('获取持仓状态失败:', error);
                statusElement.textContent = '网络错误，无法检查持仓状态';
                statusElement.style.color = '#ff4d4f'; // 红色错误
            });
        }
        
        // 保存策略设置函数
        function saveStrategy(shouldManuallyOrder = true) {
            // 获取当前URL中的策略ID
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 检查是否允许下单 - 只有当shouldManuallyOrder为true或者strategyRunning为true时才允许下单
            const shouldProceed = shouldManuallyOrder || strategyRunning;
            
            // 如果不允许下单，则记录日志并直接返回
            if (!shouldProceed) {
                console.log("自动检查状态，跳过下单操作");
                return;
            }
            
            // 获取保证金输入值并格式化
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 先格式化输入框的值
            formatMarginValue(marginInput);
            // 再获取格式化后的值
            const marginValue = marginInput.value || '0';
            
            // 检查保证金是否为有效值
            if (parseFloat(marginValue) <= 0) {
                showToast('请输入有效的保证金金额');
                return;
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多

            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 获取交易对
            const tradePair = '{{ strategy.trade_pair|default("BTC-USDT") }}';
            
            // 在按钮上显示加载状态
            const saveBtn = document.getElementById('save-strategy-btn');
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = '处理中...';
            saveBtn.disabled = true;
            
            // 发送AJAX请求
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                if (data.code === 200) {
                    // 检查持仓状态，只有在有订单结果且没有已存在的相同方向的持仓时才显示"已下单"
                    if (data.orderResult) {
                        // 获取当前交易方向
                        const dirElements = document.querySelectorAll('.type-box .type-li');
                        let currentDirection = 'buy'; // 默认方向
                        dirElements.forEach(function(el) {
                            if (el.classList.contains('type-active')) {
                                currentDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                            }
                        });
                        
                        // 检查是否已经有相同方向的持仓
                        const hasSameDirectionPosition = 
                            (currentDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                            (currentDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                        
                        if (hasSameDirectionPosition) {
                            // 已有相同方向持仓，显示为"已持仓中"
                            saveBtn.textContent = '已持仓中';
                            saveBtn.classList.add('position-active');
                        } else {
                            // 无相同方向持仓，显示为"已下单，执行中"
                            saveBtn.textContent = '已下单，执行中';
                            saveBtn.classList.add('order-success');
                        }
                        
                        showToast(`策略保存成功! 合约张数: ${data.contractSize}`);
                        showOrderResultModal(data.orderResult, tradePair);
                    } else {
                        // 没有下单，仅保存设置
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        showToast('设置已成功保存');
                    }
                } else if (data.code === 503 || data.code === 504) {
                    // 网络错误处理
                    showNetworkErrorModal(data.message);
                } else {
                    // 处理错误，保持原有按钮文本
                    saveBtn.textContent = originalBtnText;
                    saveBtn.classList.remove('order-success');
                    saveBtn.classList.remove('position-active');
                    showNetworkErrorModal(data.message || '保存策略出错，请稍后再试');
                }
            })
            .catch(error => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                // 显示错误提示
                console.error('请求错误:', error);
                showNetworkErrorModal('网络请求失败，请检查网络连接');
            });
        }
        
        function initSettingsPage() {
            console.log('策略设置页面初始化');
            
            // 调整页面标题策略名称显示
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            let strategyName = '智能网格策略'; // 默认
            
            // 根据ID设置不同的策略名称
            if (strategyId === '1') {
                strategyName = '智能网格策略';
            } else if (strategyId === '2') {
                strategyName = '趋势跟踪策略';
            } else if (strategyId === '3') {
                strategyName = 'AI智能预测策略';
            } else if (strategyId === '4') {
                strategyName = '蓝龙综合策略';
            } else if (strategyId === '5') {
                strategyName = '蓝龙出海';
            } else if (strategyId === '6') {
                strategyName = '网格量化';
            }
            
            // 更新页面标题
            const titleElement = document.querySelector('.u-navbar__content__title');
            titleElement.textContent = strategyName;
            
            // 标题动画效果
            setTimeout(() => {
                document.querySelector('.u-navbar').style.transform = 'translateY(0)';
            }, 100);
            
            // 为交易方向选择器添加点击事件
            const directionButtons = document.querySelectorAll('.type-box .type-li');
            directionButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    // 移除所有按钮的活动状态
                    directionButtons.forEach(btn => btn.classList.remove('type-active'));
                    // 添加当前按钮的活动状态
                    this.classList.add('type-active');
                    
                    // 显示反馈
                    const direction = this.textContent.trim();
                    showToast(`已选择${direction}方向`);
                    
                    // 更新按钮状态
                    checkPositionStatusOnLoad();
                });
            });
            
            // 设置状态开关点击事件 - 检查元素是否存在
            const statusToggle = document.querySelector('.toggle-wrapper');
            if (statusToggle) {
                statusToggle.addEventListener('click', function() {
                    this.classList.toggle('active-lis');
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (this.classList.contains('active-lis')) {
                        indicator.style.transform = 'translateX(28px)';
                        showToast('策略已启动');
                    } else {
                        indicator.style.transform = 'translateX(0px)';
                        showToast('策略已暂停');
                    }
                });
            }
            
            // 设置预设策略点击事件
            const strategyTypes = document.querySelectorAll('.scroll-li-types');
            strategyTypes.forEach(type => {
                type.addEventListener('click', function() {
                    // 先移除所有active类
                    strategyTypes.forEach(t => {
                        t.classList.remove('type-actives');
                        // 添加淡出效果
                        t.style.opacity = '0.7';
                    });
                    
                    // 给当前点击元素添加active类
                    this.classList.add('type-actives');
                    this.style.opacity = '1';
                    
                    // 显示选择了什么策略
                    const strategyType = this.querySelector('.li-type-center').textContent;
                    showToast(`已选择${strategyType}策略`);
                    
                    // 恢复其他元素的透明度
                    setTimeout(() => {
                        strategyTypes.forEach(t => {
                            t.style.opacity = '1';
                        });
                    }, 300);
                });
            });
            
            // 添加做多做空按钮点击事件
            const typeLiButtons = document.querySelectorAll('.type-box .type-li');
            typeLiButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    typeLiButtons.forEach(btn => {
                        btn.classList.remove('type-active');
                    });
                    
                    // 给当前点击按钮添加active类
                    this.classList.add('type-active');
                    
                    // 显示消息
                    showToast(`已选择${this.textContent}策略`);
                });
            });
            
            // 添加杠杆调整点击事件
            const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
            const leverageContainer = leverageInput.closest('.form-item-input');
            leverageContainer.addEventListener('click', function() {
                // 模拟杠杆倍数选择弹窗
                const leverageOptions = [1, 2, 3, 5, 10, 20, 50, 100];
                let selectedLeverage = 10; // 默认选择
                
                // 创建杠杆选择对话框
                const createLeverageDialog = () => {
                    // 如果页面上已有对话框，先移除
                    const existingDialog = document.querySelector('.leverage-dialog');
                    if (existingDialog) {
                        existingDialog.remove();
                    }
                    
                    // 创建对话框容器
                    const dialog = document.createElement('div');
                    dialog.className = 'leverage-dialog';
                    dialog.style.position = 'fixed';
                    dialog.style.top = '50%';
                    dialog.style.left = '50%';
                    dialog.style.transform = 'translate(-50%, -50%)';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '320px';
                    dialog.style.backgroundColor = '#fff';
                    dialog.style.borderRadius = '12px';
                    dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
                    dialog.style.zIndex = '9999';
                    dialog.style.overflow = 'hidden';
                    
                    // 创建对话框标题
                    const dialogTitle = document.createElement('div');
                    dialogTitle.textContent = '选择杠杆倍数';
                    dialogTitle.style.padding = '16px';
                    dialogTitle.style.borderBottom = '1px solid #f0f0f0';
                    dialogTitle.style.fontSize = '16px';
                    dialogTitle.style.fontWeight = '600';
                    dialogTitle.style.textAlign = 'center';
                    dialogTitle.style.color = '#262626';
                    dialog.appendChild(dialogTitle);
                    
                    // 创建选项容器
                    const optionsContainer = document.createElement('div');
                    optionsContainer.style.padding = '10px 0';
                    optionsContainer.style.maxHeight = '300px';
                    optionsContainer.style.overflowY = 'auto';
                    dialog.appendChild(optionsContainer);
                    
                    // 添加杠杆选项
                    leverageOptions.forEach(leverage => {
                        const option = document.createElement('div');
                        option.className = 'leverage-option';
                        option.textContent = `${leverage}X`;
                        option.style.padding = '12px 16px';
                        option.style.transition = 'all 0.2s ease';
                        option.style.cursor = 'pointer';
                        option.style.fontSize = '15px';
                        
                        // 高亮当前选中的选项
                        if (leverage === selectedLeverage) {
                            option.style.color = '#1a6aff';
                            option.style.fontWeight = '600';
                            option.style.backgroundColor = '#f0f7ff';
                        }
                        
                        option.addEventListener('mouseenter', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = '#f9fafc';
                            }
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = 'transparent';
                            }
                        });
                        
                        option.addEventListener('click', function() {
                            selectedLeverage = leverage;
                            leverageInput.value = `${leverage}X`;
                            
                            // 更新页面上的保证金值
                            updateMarginFromLeverage(leverage);
                            
                            dialog.remove();
                            
                            // 显示杠杆设置消息
                            showToast(`已设置杠杆倍数: ${leverage}X`);
                            
                            // 添加点击动画效果
                            leverageContainer.classList.add('row-clicked');
                            setTimeout(() => {
                                leverageContainer.classList.remove('row-clicked');
                            }, 300);
                        });
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // 创建取消按钮
                    const cancelButton = document.createElement('div');
                    cancelButton.textContent = '取消';
                    cancelButton.style.padding = '14px';
                    cancelButton.style.borderTop = '1px solid #f0f0f0';
                    cancelButton.style.textAlign = 'center';
                    cancelButton.style.color = '#8c8c8c';
                    cancelButton.style.fontSize = '15px';
                    cancelButton.style.cursor = 'pointer';
                    cancelButton.style.transition = 'all 0.2s ease';
                    
                    cancelButton.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f9fafc';
                    });
                    
                    cancelButton.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    cancelButton.addEventListener('click', function() {
                        dialog.remove();
                    });
                    
                    dialog.appendChild(cancelButton);
                    
                    // 创建遮罩层
                    const overlay = document.createElement('div');
                    overlay.className = 'leverage-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '9998';
                    
                    overlay.addEventListener('click', function() {
                        dialog.remove();
                        overlay.remove();
                    });
                    
                    // 将对话框和遮罩添加到页面
                    document.body.appendChild(overlay);
                    document.body.appendChild(dialog);
                    
                    // 添加动画
                    dialog.style.opacity = '0';
                    dialog.style.transform = 'translate(-50%, -60%)';
                    dialog.style.transition = 'all 0.3s ease';
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        dialog.style.opacity = '1';
                        dialog.style.transform = 'translate(-50%, -50%)';
                        overlay.style.opacity = '1';
                    }, 10);
                };
                
                // 显示杠杆选择对话框
                createLeverageDialog();
            });
            
            // 设置币种选择点击事件
            document.querySelector('.robot-info').parentElement.addEventListener('click', function() {
                showToast('币种选择功能正在开发中...');
            });
            
            // 设置设置项点击事件
            const settingItems = document.querySelectorAll('.setting-value .arrow-right');
            settingItems.forEach(item => {
                item.parentElement.parentElement.addEventListener('click', function() {
                    const settingName = this.querySelector('.setting-label').textContent;
                    showToast(`${settingName}设置页面正在开发中...`);
                    
                    // 添加点击动画效果
                    this.classList.add('row-clicked');
                    setTimeout(() => {
                        this.classList.remove('row-clicked');
                    }, 300);
                });
            });
            
            // 设置保存按钮事件
            const saveButton = document.querySelector('.confirm-btn');
            saveButton.addEventListener('click', function() {
                // 添加按钮动画
                this.classList.add('btn-clicked');
                
                // 获取保证金值和交易对信息
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                const marginValue = marginInput.value;
                
                // 获取URL中的策略ID
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('id') || '1';
                
                // 从隐藏字段获取用户选择的交易对
                const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
                
                // 获取交易方向（做多/做空）
                const dirElements = document.querySelectorAll('.type-box .type-li');
                let tradeDirection = 'buy'; // 默认做多
                dirElements.forEach(function(el) {
                    if (el.classList.contains('type-active')) {
                        tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                    }
                });
                
                // 发送AJAX请求到后端
                fetch('/api/strategy/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategyId: strategyId,
                        marginValue: marginValue,
                        tradePair: tradePair,
                        tradeDirection: tradeDirection
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 仅保存设置成功的默认消息
                        showToast('设置已成功保存');
                        
                        // 显示后端返回的合约张数
                        if (data.contractSize) {
                            showToast(`相当于 ${data.contractSize} 张合约`);
                        }
                        
                        // 显示订单结果（如果有）
                        if (data.orderResult) {
                            // 创建订单结果弹窗
                            showOrderResultModal(data.orderResult, tradePair);
                            
                            // 检查是否已经有相同方向的持仓
                            const hasSameDirectionPosition = 
                                (tradeDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                                (tradeDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                            
                            if (hasSameDirectionPosition) {
                                // 已有相同方向持仓，显示为"已持仓中"
                                this.textContent = '已持仓中';
                                this.classList.add('position-active');
                            } else {
                                // 无相同方向持仓，显示为"已下单，执行中"
                                this.textContent = '已下单，执行中';
                                this.classList.add('order-success');
                            }
                        } else {
                            // 无订单，保持"保存设置"状态
                            this.textContent = '保存设置';
                            this.classList.remove('order-success');
                            this.classList.remove('position-active');
                        }
                    } else if (data.code === 503 || data.code === 504) {
                        // 网络错误处理
                        showNetworkErrorModal(data.message);
                    } else {
                        showToast('保存失败: ' + data.message);
                    }
                    this.classList.remove('btn-clicked');
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 网络错误或服务器问题
                    showNetworkErrorModal('无法连接到服务器，请检查您的网络连接后重试');
                    this.classList.remove('btn-clicked');
                });
            });
            
            // 初始化仓位滑动条
            initPositionSlider();
            
            // 初始化百分比控制滑动条
            initPositionPercentSlider();
            
            // 添加页面内各元素的入场动画
            animateElements();
            
            // 投入金额获得焦点时添加高亮效果
            const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
            marginInput.addEventListener('focus', function() {
                // // document.getElementById('margin-input-container').classList.add('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            marginInput.addEventListener('blur', function() {
                // // document.getElementById('margin-input-container').classList.remove('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            // 根据杠杆倍数更新保证金金额
            function updateMarginFromLeverage(leverage) {
                // 获取当前百分比值
                const percentElement = document.getElementById('position-value-percent');
                const percent = parseInt(percentElement.textContent);
                
                // 计算保证金金额（示例计算公式）
                const baseAmount = 1000;  // 基础金额
                const calculatedMargin = (baseAmount / leverage) * (percent / 100);
                
                // 更新保证金输入框，使用平滑动画
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                // 使用toFixed保留两位小数，避免浮点数问题并应用平滑过渡
                const formattedValue = parseFloat(calculatedMargin.toFixed(2));
                // 检查值是否有明显变化
                if (marginInput.value !== formattedValue.toString()) {
                    // 存储上一次的值，用于动画判断
                    const prevValue = parseFloat(marginInput.value || '0');
                    // 如果变化大于一定值，应用过渡动画
                    if (Math.abs(prevValue - formattedValue) > 10) {
                        marginInput.classList.add('value-changing');
                        setTimeout(() => {
                            marginInput.classList.remove('value-changing');
                        }, 300);
                    }
                    // 设置新值
                    marginInput.value = formattedValue;
                }
                
                // 显示保证金更新提示
                showToast(`保证金已更新: ${calculatedMargin.toFixed(2)} USDT`);
            }
        }
        
        // 显示消息提示
        function showToast(message) {
            // 如果已有toast，先移除
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 创建新的toast元素
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 自动隐藏toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // 格式化保证金值，确保正确的数值格式
        function formatMarginValue(input) {
            // 获取输入值并解析为数值
            let value = parseFloat(input.value);
            
            // 检查是否为有效数字
            if (isNaN(value)) {
                input.value = '0.01';
                showToast('无效的金额，已设为最小值');
                return;
            }
            
            // 确保最小值为0.01
            if (value < 0.01) {
                value = 0.01;
                showToast('金额不能小于0.01 USDT');
            }
            
            // 将值格式化为最多两位小数
            const formattedValue = parseFloat(value.toFixed(2));
            
            // 如果格式化前后的值不同，更新输入框值
            if (parseFloat(input.value) !== formattedValue) {
                input.value = formattedValue;
                console.log(`保证金值已格式化: ${formattedValue} USDT`);
            }
            
            return formattedValue;
        }
        
        // 显示订单结果模态窗口
        function showOrderResultModal(orderResult, tradePair) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '450px';
            
            // 添加标题和成功图标
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.justifyContent = 'center';
            titleContainer.style.marginBottom = '15px';
            
            const successIcon = document.createElement('div');
            successIcon.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32"><path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.177-7.86l-2.765-2.767L7 12.431l3.119 3.121a1 1 0 001.414 0l5.952-5.95-1.062-1.062-5.6 5.6z"/></svg>';
            successIcon.style.marginRight = '10px';
            
            const title = document.createElement('h3');
            title.textContent = '下单成功';
            title.className = 'modal-title';
            title.style.margin = '0';
            
            titleContainer.appendChild(successIcon);
            titleContainer.appendChild(title);
            modalContent.appendChild(titleContainer);
            
            // 添加交易对信息
            const pairInfo = document.createElement('div');
            pairInfo.style.background = 'linear-gradient(135deg, #f0f7ff, #e6f7ff)';
            pairInfo.style.padding = '12px 15px';
            pairInfo.style.borderRadius = '8px';
            pairInfo.style.marginBottom = '15px';
            pairInfo.style.display = 'flex';
            pairInfo.style.alignItems = 'center';
            pairInfo.style.justifyContent = 'space-between';
            
            const pairLabel = document.createElement('span');
            pairLabel.textContent = '交易对:';
            pairLabel.style.color = '#333';
            pairLabel.style.fontWeight = '500';
            
            const pairValue = document.createElement('span');
            pairValue.textContent = tradePair;
            pairValue.style.color = '#1a6aff';
            pairValue.style.fontWeight = '600';
            pairValue.style.fontSize = '16px';
            
            pairInfo.appendChild(pairLabel);
            pairInfo.appendChild(pairValue);
            modalContent.appendChild(pairInfo);
            
            // 添加订单详情
            const orderDetails = document.createElement('div');
            orderDetails.className = 'order-details';
            orderDetails.style.background = '#f9fafc';
            orderDetails.style.border = '1px solid #f0f0f0';
            orderDetails.style.borderRadius = '8px';
            orderDetails.style.padding = '15px';
            
            // 定义要显示的字段和对应的中文名称
            const fieldLabels = {
                'orderId': '订单ID',
                'status': '状态',
                'exchangeId': '交易所',
                'direction': '方向',
                'contractSize': '合约数量',
                'margin': '保证金',
                'tradePair': '交易对',
                'price': '价格',
                'time': '时间'
            };
            
            // 按顺序显示字段
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'price', 'time'];
            
            // 格式化并显示订单结果数据
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                const detailRow = document.createElement('div');
                detailRow.className = 'detail-row';
                
                const detailLabel = document.createElement('span');
                    detailLabel.textContent = fieldLabels[key] || key;
                detailLabel.className = 'detail-label';
                
                const detailValue = document.createElement('span');
                    detailValue.textContent = orderResult[key];
                detailValue.className = 'detail-value';
                    
                    // 为特定字段添加样式
                    if (key === 'direction') {
                        detailValue.style.color = orderResult[key] === '做多' ? '#52c41a' : '#ff4d4f';
                        detailValue.style.fontWeight = '600';
                    } else if (key === 'status') {
                        detailValue.style.color = '#52c41a';
                        detailValue.style.fontWeight = '600';
                    }
                
                detailRow.appendChild(detailLabel);
                detailRow.appendChild(detailValue);
                orderDetails.appendChild(detailRow);
            }
            });
            
            modalContent.appendChild(orderDetails);
            
            // 添加操作说明
            const infoText = document.createElement('p');
            infoText.textContent = '您的订单已成功提交，可在交易所查看订单详情。';
            infoText.style.color = '#8c8c8c';
            infoText.style.fontSize = '14px';
            infoText.style.textAlign = 'center';
            infoText.style.margin = '15px 0';
            modalContent.appendChild(infoText);
            
            // 添加确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = '确定';
            confirmButton.className = 'modal-confirm-btn';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.width = '100%';
            confirmButton.style.height = '40px';
            confirmButton.style.borderRadius = '20px';
            confirmButton.style.marginTop = '10px';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmButton);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 显示网络错误模态窗口
        function showNetworkErrorModal(message) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container error-modal';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 添加标题
            const titleEl = document.createElement('h3');
            titleEl.textContent = '网络连接问题';
            titleEl.className = 'modal-title';
            modalContent.appendChild(titleEl);
            
            // 添加错误图标
            const iconEl = document.createElement('div');
            iconEl.className = 'error-icon';
            iconEl.innerHTML = '<svg viewBox="0 0 24 24" width="48" height="48"><path fill="#ff4d4f" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>';
            modalContent.appendChild(iconEl);
            
            // 添加错误信息
            const msgEl = document.createElement('p');
            msgEl.textContent = message;
            msgEl.className = 'modal-message';
            modalContent.appendChild(msgEl);
            
            // 添加确认按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '确定';
            confirmBtn.className = 'modal-confirm-btn';
            confirmBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmBtn);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 添加元素入场动画
        function animateElements() {
            const elements = document.querySelectorAll('.box, .box2, .forms-item');
            elements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('element-animated');
                }, 100 * index);
            });
        }
        
        // 初始化百分比控制滑动条
        function initPositionPercentSlider() {
            const slider = document.getElementById('position-slider-percent');
            const sliderBar = slider.parentElement;
            const positionValue = document.getElementById('position-value-percent');
            const progressBar = sliderBar.querySelector('.gone');
            
            // 获取保证金输入框
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 设置初始保证金值（假设有一个最大值）
            const maxMargin = 1000; // 假设最大保证金为1000 USDT
            
            // 平滑设置初始值
            setTimeout(() => {
                const formattedValue = parseFloat(maxMargin.toFixed(2));
                marginInput.value = formattedValue;
            }, 300);
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 平滑更新保证金值函数
            function updateMarginValue(percent, leverage) {
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                // 格式化值，保留2位小数
                const formattedValue = parseFloat(marginValue.toFixed(2));
                
                // 简化后的逻辑，直接设置值，无动画
                if (marginInput.value !== formattedValue.toString()) {
                    marginInput.value = formattedValue;
                }
            }
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(percent, leverage);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40; // 减去滑块自身宽度，使滑块能够完全移动到边缘
                sliderLeft = rect.left + 20; // 加上滑块半径，使百分比计算更准确
                
                isDragging = true;
                
                // 添加激活样式
                slider.classList.add('slider-active');
                document.body.style.cursor = 'grabbing';
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除激活样式
                slider.classList.remove('slider-active');
                document.body.style.cursor = '';
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
                
                // 添加完成动画
                slider.classList.add('slider-done');
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                }, 500);
            }
            
            // 为固定点添加点击事件
            sliderBar.querySelectorAll('.move-img').forEach(dot => {
                dot.addEventListener('click', function() {
                    const percent = parseInt(this.style.left);
                    
                    // 获取滑动条的宽度
                    const rect = sliderBar.getBoundingClientRect();
                    sliderWidth = rect.width - 40;
                    sliderLeft = rect.left + 20;
                    
                    const newPosition = (sliderWidth * percent) / 100;
                    
                    // 设置CSS变量记录当前位置，用于动画
                    slider.style.setProperty('--x-pos', `${newPosition}px`);
                    
                    // 添加过渡动画
                    slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    
                    // 更新滑块位置，保持垂直居中
                    slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                    progressBar.style.width = `${percent}%`;
                    slider.querySelector('.count').textContent = `${percent}%`;
                    positionValue.textContent = `${percent}%`;
                    
                    // 计算并更新保证金值
                    const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                    let leverage = 10; // 默认杠杆
                    if (leverageInput.value) {
                        // 解析杠杆值（例如 "10X" -> 10）
                        leverage = parseInt(leverageInput.value);
                        if (isNaN(leverage)) leverage = 10;
                    }
                    
                    // 使用平滑更新函数更新保证金值
                    updateMarginValue(percent, leverage);
                    
                    // 根据百分比改变颜色
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        progressBar.classList.remove('progress-yellow', 'progress-blue');
                        slider.classList.remove('slider-yellow', 'slider-blue');
                        progressBar.classList.add('progress-red');
                        slider.classList.add('slider-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        progressBar.classList.remove('progress-red', 'progress-blue');
                        slider.classList.remove('slider-red', 'slider-blue');
                        progressBar.classList.add('progress-yellow');
                        slider.classList.add('slider-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        progressBar.classList.remove('progress-red', 'progress-yellow');
                        slider.classList.remove('slider-red', 'slider-yellow');
                        progressBar.classList.add('progress-blue');
                        slider.classList.add('slider-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加点击高亮动画
                    this.classList.add('dot-active');
                    setTimeout(() => {
                        this.classList.remove('dot-active');
                    }, 500);
                    
                    // 添加完成动画
                    setTimeout(() => {
                        slider.classList.remove('slider-done');
                        // 强制重绘
                        void slider.offsetWidth;
                        slider.classList.add('slider-done');
                    }, 300);
                    
                    // 移除过渡动画，以便拖动时不受影响
                    setTimeout(() => {
                        slider.style.transition = '';
                        progressBar.style.transition = '';
                    }, 500);
                });
            });
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                // 如果点击的是滑块本身或者固定点，不处理
                if (e.target === slider || e.target.closest('.move-img')) return;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40;
                sliderLeft = rect.left + 20;
                
                const clickX = e.clientX - sliderLeft + 20; // 调整点击位置
                const percent = Math.round((clickX / sliderWidth) * 100);
                const adjustedPercent = Math.max(0, Math.min(percent, 100)); // 确保百分比在0-100之间
                
                // 设置CSS变量记录当前位置，用于动画
                const newPosition = (sliderWidth * adjustedPercent) / 100;
                slider.style.setProperty('--x-pos', `${newPosition}px`);
                
                // 添加过渡动画
                slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                progressBar.style.width = `${adjustedPercent}%`;
                slider.querySelector('.count').textContent = `${adjustedPercent}%`;
                positionValue.textContent = `${adjustedPercent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(adjustedPercent, leverage);
                
                // 根据百分比改变颜色
                if (adjustedPercent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (adjustedPercent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
                
                // 添加完成动画
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-done');
                }, 300);
                
                // 移除过渡动画，以便拖动时不受影响
                setTimeout(() => {
                    slider.style.transition = '';
                    progressBar.style.transition = '';
                }, 500);
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
            
            // 初始化时设置滑块的颜色
            setTimeout(() => {
                // 获取初始百分比
                const percent = parseInt(positionValue.textContent);
                
                if (percent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (percent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
            }, 500);
        }
        
        // 初始化仓位滑动条
        function initPositionSlider() {
            const slider = document.getElementById('position-slider');
            if (!slider) return; // 防止错误
            
            const progressBar = document.getElementById('progress-bar');
            const positionValue = document.getElementById('position-value');
            const sliderBar = document.querySelector('.sliderBar');
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                marginInput.value = marginValue.toFixed(2);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width;
                sliderLeft = rect.left;
                
                isDragging = true;
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            }
            
            // 为固定点添加点击事件
            const dotElements = document.querySelectorAll('.move-img');
            if (dotElements.length > 0) {
                dotElements.forEach(dot => {
                    dot.addEventListener('click', function() {
                        if (this.style.left) {
                            const percent = parseInt(this.style.left);
                            slider.style.left = `${percent}%`;
                            
                            if (progressBar) {
                                progressBar.style.width = `${percent}%`;
                            }
                            
                            const countElement = slider.querySelector('.count');
                            if (countElement) {
                                countElement.textContent = `${percent}%`;
                            }
                            
                            if (positionValue) {
                                positionValue.textContent = `${percent}%`;
                            }
                        }
                    });
                });
            }
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                if (e.target === slider) return;
                
                const rect = sliderBar.getBoundingClientRect();
                const sliderWidth = rect.width;
                const clickX = e.clientX - rect.left;
                const percent = Math.round((clickX / sliderWidth) * 100);
                
                slider.style.left = `${percent}%`;
                
                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
                
                const countElement = slider.querySelector('.count');
                if (countElement) {
                    countElement.textContent = `${percent}%`;
                }
                
                if (positionValue) {
                    positionValue.textContent = `${percent}%`;
                }
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
        }

        // 全局变量
        let strategyRunning = false;
        let strategyInterval = null;
        let chichang = false;

        // 检查持仓状态函数
        function checkPositionStatus(allowTrade = false) {
            console.log(`检查持仓状态 (允许交易: ${allowTrade})`);
            
            // 获取当前选择的交易对和交易方向
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 更新最后刷新时间
            const lastRefreshElement = document.getElementById('last-refresh-time');
            if (lastRefreshElement) {
                lastRefreshElement.textContent = `最后刷新: ${new Date().toLocaleTimeString()}`;
            }
            
            // 确保从localStorage中获取正确的运行状态，确保与按钮状态同步
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 如果localStorage中有运行状态，同步按钮状态
            const runBtn = document.getElementById('run-strategy-btn');
            if (runBtn) {
                const currentBtnState = runBtn.getAttribute('data-running') === 'true';
                // 如果按钮状态与保存的状态不一致，则同步
                if (currentBtnState !== savedIsRunning) {
                    console.log(`按钮状态(${currentBtnState})与localStorage中的运行状态(${savedIsRunning})不一致，正在同步...`);
                    runBtn.setAttribute('data-running', savedIsRunning.toString());
                    
                    // 更新按钮外观
                    if (savedIsRunning) {
                        runBtn.textContent = '停止';
                        runBtn.style.backgroundColor = '#ff4d4f';
                    } else {
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                }
            }
            
            // 更新续下单按钮显示状态
            const continueOrderBtn = document.getElementById('continue-order-btn');
            
            // 发送请求检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 更新持仓状态
                    const hasBuyPosition = data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 记录状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 更新策略运行状态指示器
                    const statusIndicator = document.getElementById('key-status-indicator');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // 如果有持仓，更新续下单按钮样式
                    if (continueOrderBtn) {
                        if (chichang) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> 已持仓(测试用)';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                            continueOrderBtn.classList.add('position-active');
                            continueOrderBtn.disabled = false; // 保持可点击，因为它是测试按钮
                        } else {
                            // 检查是否有订单正在执行
                            if (data.hasOrder) {
                                continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                                continueOrderBtn.disabled = false; // 保持可点击
                            } else {
                                continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 续下单(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                                continueOrderBtn.classList.remove('position-active');
                                continueOrderBtn.disabled = false;
                            }
                        }
                    }
                    
                    // 显示状态指示器
                    if (statusIndicator) {
                        statusIndicator.style.display = 'block';
                        
                        // 更新状态文本和图标
                        if (chichang) {
                            statusText.innerHTML = `多头持仓: ${hasBuyPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}, 空头持仓: ${hasSellPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}`;
                            statusIcon.innerHTML = '🔄';
                            statusIcon.style.animation = 'spin 5s linear infinite';
                            statusIndicator.style.backgroundColor = '#e6f7ff';
                            statusIndicator.style.borderColor = '#91d5ff';
                        } else if (data.hasOrder) {
                            statusText.innerHTML = '有订单正在处理中';
                            statusIcon.innerHTML = '⏳';
                            statusIcon.style.animation = 'blink 1.5s ease infinite';
                            statusIndicator.style.backgroundColor = '#fffbe6';
                            statusIndicator.style.borderColor = '#ffe58f';
                        } else {
                            statusText.innerHTML = '当前无持仓，可以下单';
                            statusIcon.innerHTML = '✅';
                            statusIcon.style.animation = 'none';
                            statusIndicator.style.backgroundColor = '#f6ffed';
                            statusIndicator.style.borderColor = '#b7eb8f';
                        }
                    }
                    
                    // 始终使用localStorage中的运行状态，而不是从按钮状态获取
                    const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                    
                    // 如果允许交易且系统正在运行，且没有持仓，则进行自动下单
                    if (allowTrade && isRunning && !chichang) {
                        console.log('交易系统循环触发自动下单...');
                        
                        // 获取保证金值
                        const marginInput = document.getElementById('margin-input') || 
                                            document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                        const marginValue = marginInput ? marginInput.value : '0';
                        
                        // 如果保证金值有效，执行下单
                        if (parseFloat(marginValue) > 0) {
                            console.log(`执行自动下单: 交易对=${tradePair}, 金额=${marginValue}, 方向=${tradeDirection}`);
                            saveStrategy(false); // 执行下单但不启动策略循环
                        } else {
                            console.log('保证金金额无效，跳过自动下单');
                        }
                    }
                    
                    // 更新按钮状态 - 始终使用localStorage中的状态
                    updateButtonStatus(chichang, isRunning);
                    
                } else {
                    console.error('检查持仓状态失败:', data.message);
                    showToast(`检查持仓状态失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('请求出错:', error);
                showToast('网络请求失败，请检查网络连接', 'error');
                
                // 即使网络请求失败，也要确保按钮状态与localStorage一致
                const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                updateButtonStatus(chichang, isRunning);
            });
        }

        // 更新按钮状态
        function updateButtonStatus(hasPosition, isRunning) {
            const runBtn = document.getElementById('run-strategy-btn');
            const stopBtn = document.getElementById('stop-strategy-btn');
            
            // 再次从localStorage获取以确保一致性
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 使用savedIsRunning而不是传入的isRunning，确保与localStorage一致
            if (!runBtn) return;
            
            if (savedIsRunning) {
                // 交易系统正在运行
                runBtn.textContent = '停止';
                runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示可以停止
                runBtn.setAttribute('data-running', 'true');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                    statusElement.style.color = '#52c41a';
                }
                
                // 仅当有持仓时显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = hasPosition ? 'inline-block' : 'none';
                    // 强制停止按钮的样式保持红色
                    stopBtn.style.backgroundColor = '#ff4d4f';
                }
                
                // 确保交易系统循环是启动的
                if (!window.tradingSystemInterval) {
                    console.log('检测到系统应该运行但循环未启动，重新启动交易系统循环...');
                    startTradingSystemLoop();
                }
            } else {
                // 交易系统未运行
                runBtn.textContent = '运行';
                runBtn.style.backgroundColor = '#52c41a'; // 绿色表示可以运行
                runBtn.setAttribute('data-running', 'false');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统已停止，但仍有持仓' : '交易系统已停止';
                    statusElement.style.color = '#8c8c8c';
                }
                
                // 系统未运行时，不显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = 'none';
                }
                
                // 确保循环已停止
                if (window.tradingSystemInterval) {
                    console.log('检测到系统应该停止但循环仍在运行，停止交易系统循环...');
                    clearInterval(window.tradingSystemInterval);
                    window.tradingSystemInterval = null;
                }
            }
        }

        // 自定义确认对话框函数
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm, onCancel) {
            // 创建对话框容器
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.width = '100%';
            dialogOverlay.style.height = '100%';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            dialogOverlay.style.zIndex = '9999';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            // 创建对话框内容
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.width = '300px';
            dialog.style.maxWidth = '90%';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // 添加标题
            const titleElement = document.createElement('div');
            titleElement.textContent = title;
            titleElement.style.padding = '16px';
            titleElement.style.borderBottom = '1px solid #f0f0f0';
            titleElement.style.fontWeight = 'bold';
            dialog.appendChild(titleElement);
            
            // 添加消息
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.padding = '16px';
            messageElement.style.color = '#595959';
            dialog.appendChild(messageElement);
            
            // 添加按钮容器
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.borderTop = '1px solid #f0f0f0';
            
            // 确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.flex = '1';
            confirmButton.style.padding = '12px';
            confirmButton.style.border = 'none';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.color = 'white';
            confirmButton.style.borderRadius = '0 0 0 8px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onConfirm) onConfirm();
            });
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '12px';
            cancelButton.style.border = 'none';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#595959';
            cancelButton.style.borderRadius = '0 0 8px 0';
            cancelButton.style.cursor = 'pointer';
            cancelButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onCancel) onCancel();
            });
            
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            dialog.appendChild(buttonsContainer);
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
        }

        // 更新导航栏中的持仓数量显示
        function updatePositionCount(count) {
            // 尝试找到当前页面中的持仓数量显示元素
            const positionCountElem = document.querySelector('.flex-x.nav-li.active-nav-li.nav-li-p span:nth-child(2)');
            if (positionCountElem) {
                positionCountElem.textContent = `(${count})`;
            }
            
            // 尝试发送消息到spot页面（如果有）
            try {
                // 将持仓信息广播到其他页面
                localStorage.setItem('okxPositionCount', count.toString());
                
                // 派发自定义事件
                window.dispatchEvent(new CustomEvent('okxPositionUpdated', {
                    detail: { count: count }
                }));
            } catch (e) {
                console.error('更新持仓数量出错:', e);
            }
            
            // 创建持仓信息展示区（如果尚未创建）
            if (!document.getElementById('position-details-container')) {
                // 在状态显示下方添加持仓详情区域
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = 'position-details-container';
                    detailsContainer.style.marginTop = '15px';
                    detailsContainer.style.padding = '15px';
                    detailsContainer.style.backgroundColor = '#f8f9fa';
                    detailsContainer.style.borderRadius = '8px';
                    detailsContainer.style.display = count > 0 ? 'block' : 'none';
                    statusElement.parentNode.insertBefore(detailsContainer, statusElement.nextSibling);
                }
            }
        }

        // 显示持仓详情
        function showPositionDetails(positionStatus, tradePair) {
            const container = document.getElementById('position-details-container');
            if (!container) return;
            
            container.style.display = 'block';
            container.innerHTML = `<h5 style="font-size: 16px; margin-bottom: 10px;">持仓详情</h5>`;
            
            // 显示多头持仓信息
            if (positionStatus.buy_flag) {
                const buyInfo = document.createElement('div');
                buyInfo.classList.add('position-item');
                buyInfo.style.marginBottom = '10px';
                buyInfo.style.padding = '10px';
                buyInfo.style.backgroundColor = '#e6f7ff';
                buyInfo.style.borderRadius = '4px';
                buyInfo.style.borderLeft = '3px solid #1890ff';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz) {
                    availPos = positionStatus.p_Pos_sz;
                }
                
                if (positionStatus.p_cw_avgPx) {
                    avgPrice = positionStatus.p_cw_avgPx;
                }
                
                buyInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 多头</span>
                        <span style="color: #52c41a;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(buyInfo);
            }
            
            // 显示空头持仓信息
            if (positionStatus.sell_flag) {
                const sellInfo = document.createElement('div');
                sellInfo.classList.add('position-item');
                sellInfo.style.marginBottom = '10px';
                sellInfo.style.padding = '10px';
                sellInfo.style.backgroundColor = '#fff2e8';
                sellInfo.style.borderRadius = '4px';
                sellInfo.style.borderLeft = '3px solid #fa541c';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz_s) {
                    availPos = positionStatus.p_Pos_sz_s;
                }
                
                if (positionStatus.p_cw_avgPx_s) {
                    avgPrice = positionStatus.p_cw_avgPx_s;
                }
                
                sellInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 空头</span>
                        <span style="color: #ff4d4f;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(sellInfo);
            }
        }

        // 清除持仓详情显示
        function clearPositionDetails() {
            const container = document.getElementById('position-details-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
        
        // 页面加载时优先检查buy_flag状态并激活按钮
        function checkInitialPositionStatus() {
            // 获取当前URL中的策略ID和交易对
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 获取交易对（根据策略ID设置不同的默认交易对）
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // 显示加载状态
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = '正在检查持仓状态...';
            
            // 向后端发送请求获取持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: 'buy'  // 无论当前选择什么方向，优先检查buy_flag
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 直接检查buy_flag
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // 获取UI元素
                    const runBtn = document.getElementById('run-strategy-btn');
                    const stopBtn = document.getElementById('stop-strategy-btn');
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // 更新后端检查结果到控制台 - 这是控制zhibiao.py循环的关键状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 关键状态：多头激活而空头未激活 - 这是最重要的状态，用来控制zhibiao.py循环
                    if (hasBuyPosition && !hasSellPosition) {
                        console.log('🔄 关键循环状态: 多头持仓激活且空头未激活，zhibiao.py主循环运行中');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮 - 清晰显示循环运行状态
                        runBtn.textContent = '循环运行中';
                        runBtn.style.backgroundColor = '#1a6aff'; // 蓝色表示正在循环
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '多头持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '🔄 多头持仓激活，zhibiao.py主循环运行中';
                        statusElement.style.color = '#1a6aff'; // 蓝色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 创建持仓状态指示标签
                        const statusIndicator = document.createElement('div');
                        statusIndicator.style.backgroundColor = '#e6f7ff';
                        statusIndicator.style.border = '1px solid #91d5ff';
                        statusIndicator.style.borderRadius = '4px';
                        statusIndicator.style.padding = '8px 12px';
                        statusIndicator.style.marginTop = '10px';
                        statusIndicator.style.fontWeight = 'bold';
                        statusIndicator.style.color = '#1a6aff';
                        statusIndicator.style.display = 'flex';
                        statusIndicator.style.alignItems = 'center';
                        statusIndicator.style.justifyContent = 'center';
                        statusIndicator.style.gap = '8px';
                        
                        // 添加循环图标和文本
                        statusIndicator.innerHTML = `
                            <div style="animation: spin 2s linear infinite;">🔄</div>
                            <div>多头持仓激活 - zhibiao.py主循环运行中</div>
                        `;
                        
                        // 如果已有状态指示，先移除
                        const existingIndicator = document.querySelector('#loop-status-indicator');
                        if (existingIndicator) {
                            existingIndicator.remove();
                        }
                        
                        statusIndicator.id = 'loop-status-indicator';
                        statusElement.parentNode.insertBefore(statusIndicator, statusElement.nextSibling);
                        
                        // 添加CSS动画
                        const style = document.createElement('style');
                        style.innerHTML = `
                            @keyframes spin {
                                from { transform: rotate(0deg); }
                                to { transform: rotate(360deg); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // 设置自动监控 - 更频繁检查状态
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 10000); // 10秒检查一次
                    } else if (hasBuyPosition && hasSellPosition) {
                        // 多头和空头都激活
                        console.log('检测到buy_flag=True和sell_flag=True，设置为双向持仓状态');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮
                        runBtn.textContent = '运行中';
                        runBtn.style.backgroundColor = '#faad14'; // 黄色表示运行中
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '双向持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '检测到多头和空头持仓，策略已激活';
                        statusElement.style.color = '#faad14'; // 黄色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 设置自动监控
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15秒检查一次
                    } else if (!hasBuyPosition && hasSellPosition) {
                        // 只有空头持仓
                        console.log('检测到buy_flag=False但sell_flag=True，设置为空头持仓状态');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮
                        runBtn.textContent = '运行中';
                        runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示空头运行中
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '空头持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '检测到空头持仓，多头未激活';
                        statusElement.style.color = '#ff4d4f'; // 红色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 设置自动监控
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15秒检查一次
                    } else {
                        // 无任何持仓
                        console.log('检测到buy_flag=False，无任何持仓，设置为未激活状态');
                        
                        // 未检测到多头持仓，设置为非激活状态
                        chichang = false;
                        
                        // 保持正常状态
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a'; // 绿色
                        runBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        saveBtn.textContent = '保存设置';
                        statusElement.textContent = '无持仓，系统准备就绪';
                        statusElement.style.color = '#52c41a'; // 绿色正常
                        strategyRunning = false;
                        
                        // 确保移除任何激活状态的类
                        saveBtn.classList.remove('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 如果没有buy_flag，则正常检查持仓状态
                        checkPositionStatusOnLoad();
                    }
                    
                    // 添加状态摘要显示 - 如果后端提供了状态摘要
                    if (data.statusSummary) {
                        // 在状态元素的下方添加后端状态摘要
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `后端状态: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // 如果已有之前的状态摘要，先移除
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                    
                    // 关键状态显示
                    if (hasBuyPosition && !hasSellPosition) {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'block';
                        }
                    } else {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'none';
                        }
                    }
                } else {
                    // 如果检查失败，回退到正常检查
                    checkPositionStatusOnLoad();
                }
            })
            .catch(error => {
                console.error('优先检查buy_flag失败:', error);
                // 出错时回退到正常检查
                checkPositionStatusOnLoad();
            });
        }

        // 初始化币种选择器功能
        function initCryptoSelector() {
            // 币种选择模态框
            const modal = document.getElementById('crypto-selection-modal');
            const cryptoSelector = document.getElementById('crypto-selector');
            const closeBtn = document.querySelector('.close');
            const searchInput = document.getElementById('crypto-search');
            const cryptoItems = document.querySelectorAll('.crypto-item');
            
            // 打开模态框
            if (cryptoSelector) {
                cryptoSelector.addEventListener('click', function() {
                    modal.style.display = 'block';
                });
            }
            
            // 关闭模态框
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 搜索功能
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    cryptoItems.forEach(item => {
                        const symbol = item.getAttribute('data-symbol').toLowerCase();
                        const display = item.getAttribute('data-display').toLowerCase();
                        if (symbol.includes(searchTerm) || display.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // 选择交易对
            cryptoItems.forEach(item => {
                item.addEventListener('click', function() {
                    const symbol = this.getAttribute('data-symbol');
                    const display = this.getAttribute('data-display');
                    const originalPair = this.getAttribute('data-original');
                    
                    // 更新显示
                    document.getElementById('selected-crypto-name').textContent = display;
                    document.getElementById('selected-crypto-icon').src = `https://ai.hkd.red/symbolImage/${symbol}.png`;
                    document.getElementById('selected-crypto-pair').value = originalPair;
                    
                    // 高亮选中项
                    cryptoItems.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // 关闭模态框
                    modal.style.display = 'none';
                    
                    // 更新策略配置中的交易对
                    if (window.strategyConfig) {
                        window.strategyConfig.tradePair = originalPair;
                    }
                    
                    // 这里可以添加选择交易对后的其他逻辑，如更新杠杆选项等
                    showToast(`已选择 ${display} 交易对`);
                    
                    // 选择新的交易对后，重新检查持仓状态
                    checkPositionStatus(false);
                });
            });
        }

        // 策略方向选择事件
        const typeElements = document.querySelectorAll('.type-box .type-li');
        typeElements.forEach(function(el) {
            el.addEventListener('click', function() {
                // 移除所有的激活状态
                typeElements.forEach(item => {
                    item.classList.remove('type-active');
                });
                
                // 为当前点击元素添加激活状态
                this.classList.add('type-active');
                
                // 更新方向，如果是保存按钮再次提交，需要获取最新的方向
                const tradeDirection = this.textContent.trim() === '做多' ? 'buy' : 'sell';
                
                // 添加点击动画效果
                this.parentElement.classList.add('row-clicked');
                setTimeout(() => {
                    this.parentElement.classList.remove('row-clicked');
                }, 300);
                
                // 显示选择的方向
                showToast(`已选择${this.textContent.trim()}方向`);
                
                // 重置保存按钮状态 - 用户切换方向后应该重新提交订单
                const saveButton = document.querySelector('.confirm-btn');
                saveButton.textContent = '保存设置';
                saveButton.classList.remove('order-success');
                saveButton.classList.remove('position-active');
                
                // 检查当前方向是否已有持仓，如果有则更新按钮状态
                checkPositionStatus(tradeDirection);
            });
        });
        
        // 检查持仓状态
        function checkPositionStatus(direction) {
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 发送AJAX请求到后端检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: direction
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveButton = document.querySelector('.confirm-btn');
                    const hasSameDirectionPosition = 
                        (direction === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                        (direction === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                    
                    if (hasSameDirectionPosition) {
                        // 已有相同方向持仓，显示为"已持仓中"
                        saveButton.textContent = '已持仓中';
                        saveButton.classList.add('position-active');
                        saveButton.classList.remove('order-success');
                    } else if (data.hasOrder) {
                        // 有订单执行中
                        saveButton.textContent = '已下单，执行中';
                        saveButton.classList.add('order-success');
                        saveButton.classList.remove('position-active');
                    } else {
                        // 无持仓或订单
                        saveButton.textContent = '保存设置';
                        saveButton.classList.remove('order-success');
                        saveButton.classList.remove('position-active');
                    }
                    
                    // 更新状态指示器
                    updateStatusIndicator(data.positionStatus, data.statusSummary);
                }
            })
            .catch(error => {
                console.error('Error checking position:', error);
            });
        }
        
        // 更新状态指示器
        function updateStatusIndicator(positionStatus, statusSummary) {
            const statusIndicator = document.getElementById('key-status-indicator');
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');
            
            if (statusIndicator && statusText) {
                statusIndicator.style.display = 'block';
                
                // 更新状态文本
                if (statusSummary) {
                    statusText.textContent = statusSummary;
                } else {
                    const buyStatus = positionStatus && positionStatus.buy_flag ? '激活' : '未激活';
                    const sellStatus = positionStatus && positionStatus.sell_flag ? '激活' : '未激活';
                    statusText.textContent = `多头持仓: ${buyStatus}, 空头持仓: ${sellStatus}`;
                }
                
                // 更新图标
                if (positionStatus && (positionStatus.buy_flag || positionStatus.sell_flag)) {
                    statusIcon.textContent = '✅';
                } else {
                    statusIcon.textContent = '⚙️';
                }
            }
        }

        // 运行策略按钮点击事件
        document.getElementById('run-strategy-btn').addEventListener('click', function() {
            // 获取表单数据
            saveStrategy(true);  // 传入true表示运行策略
        });

        // 修改saveStrategy函数，添加运行成功后的处理逻辑
        function saveStrategy(shouldRunStrategy = false) {
            // 获取策略ID
            const strategyId = getStrategyId();
            // 获取保证金值
            const marginInput = document.getElementById('margin-input');
            const marginValue = marginInput ? marginInput.value : '0';
            // 获取交易对
            const tradePairInput = document.getElementById('selected-crypto-pair');
            const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 显示加载指示器
            showLoading();
            
            // 发送请求保存策略
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                // 隐藏加载指示器
                hideLoading();
                
                // 显示合约张数
                if (data.code === 200) {
                    // 是否已经持有头寸
                    const hasPosition = data.positionStatus && 
                                       (data.positionStatus.buy_flag || data.positionStatus.sell_flag);
                    
                    // 更新运行状态
                    const runBtn = document.getElementById('run-strategy-btn');
                    const isRunning = runBtn ? runBtn.getAttribute('data-running') === 'true' : false;
                    
                    // 如果有订单结果或持仓，自动设置系统为运行状态
                    if (data.orderResult || hasPosition) {
                        console.log('下单成功或检测到持仓，自动启动交易系统');
                        
                        // 设置按钮状态
                        if (runBtn && !isRunning) {
                            runBtn.setAttribute('data-running', 'true');
                            runBtn.textContent = '停止';
                            runBtn.style.backgroundColor = '#ff4d4f';
                            
                            // 如果不是正在运行，启动循环
                            startTradingSystemLoop();
                        }
                        
                        // 保存运行状态到localStorage
                        localStorage.setItem('tradingSystemRunning', 'true');
                        
                        // 更新状态提示
                        const statusElement = document.getElementById('strategy-status');
                        if (statusElement) {
                            statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                            statusElement.style.color = '#52c41a';
                        }
                    }
                    
                    // 如果有订单结果，则显示订单结果
                    if (data.orderResult) {
                        console.log('下单成功，订单信息:', data.orderResult);
                        
                        // 显示订单成功对话框
                        showOrderSuccessDialog(data.orderResult);
                        
                        // 延迟检查交易对JSON状态
                        setTimeout(() => {
                            checkTradingPairsStatus();
                        }, 2000);
                        
                        // 如果是"运行策略"操作，则在对话框中添加"返回合约页面"按钮
                        if (shouldRunStrategy) {
                            // 延迟3秒后，清除localStorage中的持仓数据，并返回合约页面
                            setTimeout(() => {
                                // 清除localStorage数据，确保返回页面时能够重新获取最新数据
                                localStorage.removeItem('okxPositions');
                                localStorage.removeItem('okxPositionCount');
                                localStorage.removeItem('okxPositionsUpdateTime');
                                
                                // 返回合约页面，添加时间戳避免缓存问题
                                if (confirm('策略已成功运行，是否返回合约页面查看持仓状态？')) {
                                    goBackToContract();
                                }
                            }, 3000);
                        }
                    } else {
                        // 仅保存策略设置
                        showToast('策略保存成功!', 'success');
                    }
                } else {
                    // 处理错误情况
                    console.error('保存策略失败:', data.message);
                    showToast(`操作失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('保存策略时出错:', error);
                showToast('保存策略时出错，请稍后再试', 'error');
            });
        }

        // 获取策略ID
        function getStrategyId() {
            // 从URL中获取策略ID
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || '1';
        }

        // 显示加载指示器
        function showLoading() {
            // 检查是否存在加载指示器，没有则创建
            let loadingOverlay = document.getElementById('loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.position = 'fixed';
                loadingOverlay.style.top = '0';
                loadingOverlay.style.left = '0';
                loadingOverlay.style.width = '100%';
                loadingOverlay.style.height = '100%';
                loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.justifyContent = 'center';
                loadingOverlay.style.alignItems = 'center';
                loadingOverlay.style.zIndex = '9999';
                
                const spinner = document.createElement('div');
                spinner.style.width = '50px';
                spinner.style.height = '50px';
                spinner.style.border = '5px solid #f3f3f3';
                spinner.style.borderTop = '5px solid #3498db';
                spinner.style.borderRadius = '50%';
                spinner.style.animation = 'spin 1s linear infinite';
                
                // 添加旋转动画
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                loadingOverlay.appendChild(spinner);
                document.body.appendChild(loadingOverlay);
            } else {
                loadingOverlay.style.display = 'flex';
            }
        }

        // 隐藏加载指示器
        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // 显示订单成功对话框
        function showOrderSuccessDialog(orderResult) {
            // 创建对话框元素
            const dialog = document.createElement('div');
            dialog.className = 'order-success-dialog';
            dialog.style.position = 'fixed';
            dialog.style.top = '50%';
            dialog.style.left = '50%';
            dialog.style.transform = 'translate(-50%, -50%)';
            dialog.style.width = '80%';
            dialog.style.maxWidth = '350px';
            dialog.style.backgroundColor = '#fff';
            dialog.style.borderRadius = '8px';
            dialog.style.padding = '20px';
            dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
            dialog.style.zIndex = '10000';
            
            // 设置对话框内容
            dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <i class="fas fa-check-circle" style="font-size: 50px; color: #52c41a;"></i>
                    <h3 style="margin-top: 10px; font-size: 18px;">下单成功</h3>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">交易对:</span>
                        <span>${orderResult.tradePair}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">方向:</span>
                        <span>${orderResult.direction}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">合约张数:</span>
                        <span>${orderResult.contractSize}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">保证金:</span>
                        <span>${orderResult.margin}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">订单ID:</span>
                        <span>${orderResult.orderId}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">时间:</span>
                        <span>${orderResult.time}</span>
                    </div>
                </div>
                <button id="close-dialog-btn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #1a6aff, #3f87ff); color: white; border: none; border-radius: 4px; font-weight: 500;">知道了</button>
            `;
            
            // 添加对话框到页面
            document.body.appendChild(dialog);
            
            // 创建背景遮罩
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
            document.body.appendChild(overlay);

            // 添加关闭按钮事件
            document.getElementById('close-dialog-btn').addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
            });

            // 点击背景遮罩也可以关闭
            overlay.addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
            });
        }

        // 添加新的交易系统循环函数
        function startTradingSystemLoop() {
            // 先清除可能存在的旧定时器
            if (window.tradingSystemInterval) {
                clearInterval(window.tradingSystemInterval);
            }
            
            // 创建新的定时器，每30秒执行一次交易检查
            window.tradingSystemInterval = setInterval(function() {
                // 获取当前时间并格式化
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                // 更新最后检查时间
                const lastCheckElement = document.getElementById('last-refresh-time');
                if (lastCheckElement) {
                    lastCheckElement.textContent = `上次检查时间: ${timeString}`;
                }
                
                console.log(`[${timeString}] 执行交易系统检查...`);
                
                // 获取交易对和金额信息
                const tradePairInput = document.getElementById('selected-crypto-pair');
                const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
                
                // 获取保证金值
                const marginInput = document.getElementById('margin-input') || 
                                    document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                const marginValue = marginInput ? marginInput.value : '0';
                
                // 检查交易对状态
                checkPositionStatus(true);
                
                // 记录日志
                console.log(`检查交易对: ${tradePair}, 金额: ${marginValue} USDT`);
            }, 30000); // 每30秒执行一次
            
            // 立即执行一次
            console.log('启动交易系统循环，立即执行第一次检查...');
            checkPositionStatus(true);
        }

        // 添加测试订单系统功能
        function testOrderSystem() {
            // 获取当前表单数据
            const tradePairInput = document.getElementById('selected-crypto-pair');
            const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
            
            const marginInput = document.getElementById('margin-input') || 
                                document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
            const marginValue = marginInput ? marginInput.value : '0';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 记录测试信息
            console.log('测试交易系统连接...');
            console.log(`交易对: ${tradePair}, 金额: ${marginValue} USDT, 方向: ${tradeDirection}`);
            
            // 检查持仓状态但不实际下单
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 显示成功测试结果
                    showToast(`测试成功! 持仓状态: ${JSON.stringify(data.positionStatus)}`, 'success');
                } else {
                    // 显示测试失败
                    showToast(`测试失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('测试订单系统出错:', error);
                showToast('测试过程中发生错误，请检查网络连接', 'error');
            });
        }

        // 检查交易对JSON文件状态
        function checkTradingPairsStatus() {
            console.log('检查交易对JSON文件状态...');
            
            // 请求获取所有交易对数据
            fetch('/api/trading_pairs/list')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && Array.isArray(data.data)) {
                        const tradingPairs = data.data;
                        
                        console.log(`获取到${tradingPairs.length}个交易对`);
                        
                        // 如果有交易对数据，说明系统可能在使用中
                        if (tradingPairs.length > 0) {
                            // 检查localStorage中的运行状态
                            const isSystemRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                            
                            // 如果没有明确的运行状态记录，或状态为false，但有交易对，则假设系统应该是运行中的
                            if (localStorage.getItem('tradingSystemRunning') === null || !isSystemRunning) {
                                console.log('检测到交易对数据但系统未运行，自动设置为运行中');
                                
                                // 设置运行状态为true
                                localStorage.setItem('tradingSystemRunning', 'true');
                                
                                // 更新UI
                                const runBtn = document.getElementById('run-strategy-btn');
                                if (runBtn && runBtn.getAttribute('data-running') !== 'true') {
                                    runBtn.setAttribute('data-running', 'true');
                                    runBtn.textContent = '停止';
                                    runBtn.style.backgroundColor = '#ff4d4f';
                                    
                                    // 更新状态提示
                                    const statusElement = document.getElementById('strategy-status');
                                    if (statusElement) {
                                        statusElement.textContent = '交易系统正在运行中...';
                                        statusElement.style.color = '#52c41a';
                                    }
                                    
                                    // 启动交易系统循环
                                    startTradingSystemLoop();
                                    
                                    // 显示通知
                                    showToast('检测到交易对数据，自动启动交易系统', 'info');
                                }
                            }
                            
                            // 获取当前选择的交易对
                            const currentTradePair = document.getElementById('selected-crypto-pair').value;
                            
                            // 尝试找到匹配当前交易对的数据
                            const matchedPair = tradingPairs.find(p => p.tradePair === currentTradePair);
                            
                            // 如果找到匹配的交易对，填充金额信息
                            if (matchedPair) {
                                console.log(`找到匹配的交易对: ${matchedPair.tradePair}, 金额: ${matchedPair.amount}`);
                                
                                // 更新金额输入框
                                const marginInput = document.getElementById('margin-input') || 
                                                  document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                                if (marginInput && !marginInput.value) {
                                    marginInput.value = matchedPair.amount;
                                    console.log(`已自动填充金额: ${matchedPair.amount}`);
                                }
                            }
                        } else {
                            // 没有交易对数据，可以考虑设置运行状态为false
                            // 但这里我们不自动更改，因为用户可能想保持系统运行状态
                            console.log('没有检测到交易对数据，保持当前系统状态');
                        }
                    } else {
                        console.log('没有获取到交易对数据或请求失败');
                    }
                })
                .catch(error => {
                    console.error('获取交易对数据出错:', error);
                });
        }

        // 显示持仓状态信息
        function displayPositionStatus(statusData) {
            // 清空现有的状态显示
            const statusContainer = document.getElementById('position-status-container');
            if (!statusContainer) return;
            
            statusContainer.innerHTML = '';
            
            if (!statusData || !statusData.positions || statusData.positions.length === 0) {
                const noPositionMsg = document.createElement('div');
                noPositionMsg.className = 'no-position-message';
                noPositionMsg.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #8c8c8c;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; color: #d9d9d9;"></i>
                        <p>暂无持仓信息</p>
                    </div>
                `;
                statusContainer.appendChild(noPositionMsg);
                return;
            }
            
            // 创建表格显示持仓信息
            const table = document.createElement('table');
            table.className = 'position-table';
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '10px';
            
            // 添加表头
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid #f0f0f0; color: #8c8c8c; font-weight: 500;">交易对</th>
                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid #f0f0f0; color: #8c8c8c; font-weight: 500;">方向</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 1px solid #f0f0f0; color: #8c8c8c; font-weight: 500;">持仓量</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 1px solid #f0f0f0; color: #8c8c8c; font-weight: 500;">开仓均价</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 1px solid #f0f0f0; color: #8c8c8c; font-weight: 500;">未实现盈亏</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // 添加表格内容
            const tbody = document.createElement('tbody');
            statusData.positions.forEach(position => {
                const tr = document.createElement('tr');
                
                // 判断是否为特殊币种
                const isSpecial = isSpecialCoin(position.tradePair || position.instId);
                
                // 交易对列
                const tdPair = document.createElement('td');
                tdPair.style.padding = '12px 10px';
                tdPair.style.borderBottom = '1px solid #f0f0f0';
                tdPair.textContent = position.tradePair || position.instId;
                
                // 方向列
                const tdDirection = document.createElement('td');
                tdDirection.style.padding = '12px 10px';
                tdDirection.style.borderBottom = '1px solid #f0f0f0';
                tdDirection.style.textAlign = 'center';
                tdDirection.style.fontWeight = '600';
                tdDirection.textContent = position.posSide === 'long' ? '做多' : '做空';
                tdDirection.style.color = position.posSide === 'long' ? '#52c41a' : '#ff4d4f';
                
                // 持仓量列
                const tdPosition = document.createElement('td');
                tdPosition.style.padding = '12px 10px';
                tdPosition.style.borderBottom = '1px solid #f0f0f0';
                tdPosition.style.textAlign = 'right';
                tdPosition.style.fontWeight = '500';
                tdPosition.textContent = position.pos + (position.instId ? '' : ' 张');
                
                // 开仓均价列
                const tdAvgPrice = document.createElement('td');
                tdAvgPrice.style.padding = '12px 10px';
                tdAvgPrice.style.borderBottom = '1px solid #f0f0f0';
                tdAvgPrice.style.textAlign = 'right';
                tdAvgPrice.textContent = position.avgPx || '--';
                
                // 未实现盈亏列
                const tdUnpl = document.createElement('td');
                tdUnpl.style.padding = '12px 10px';
                tdUnpl.style.borderBottom = '1px solid #f0f0f0';
                tdUnpl.style.textAlign = 'right';
                tdUnpl.style.fontWeight = '600';
                
                // 如果有未实现盈亏数据，则计算并显示颜色
                if (position.upl) {
                    const upl = parseFloat(position.upl);
                    tdUnpl.textContent = upl.toFixed(4);
                    tdUnpl.style.color = upl >= 0 ? '#52c41a' : '#ff4d4f';
                } else {
                    tdUnpl.textContent = '--';
                    tdUnpl.style.color = '#8c8c8c';
                }
                
                // 将所有列添加到行中
                tr.appendChild(tdPair);
                tr.appendChild(tdDirection);
                tr.appendChild(tdPosition);
                tr.appendChild(tdAvgPrice);
                tr.appendChild(tdUnpl);
                
                // 为特殊币种添加说明行
                if (isSpecial) {
                    const specialRow = document.createElement('tr');
                    const specialCell = document.createElement('td');
                    specialCell.colSpan = 5;
                    specialCell.style.padding = '8px 10px';
                    specialCell.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                    specialCell.style.borderBottom = '1px solid #f0f0f0';
                    specialCell.style.fontSize = '12px';
                    specialCell.style.color = '#d46b08';
                    
                    // 获取币种名称
                    let coinName = '';
                    if (position.tradePair) {
                        coinName = position.tradePair.split('-')[0];
                    } else if (position.instId) {
                        coinName = position.instId.split('-')[0];
                    }
                    
                    specialCell.innerHTML = `
                        <i class="fas fa-exclamation-circle" style="margin-right: 5px;"></i>
                        <b>${coinName || 'ARB'}</b>合约特别说明: 显示的持仓量是<b>币的数量</b>，而非合约张数。
                    `;
                    
                    specialRow.appendChild(specialCell);
                    tbody.appendChild(tr);
                    tbody.appendChild(specialRow);
                } else {
                    tbody.appendChild(tr);
                }
            });
            
            table.appendChild(tbody);
            statusContainer.appendChild(table);
            
            // 添加特别说明信息
            const hasSpecialCoins = statusData.positions.some(position => 
                isSpecialCoin(position.tradePair || position.instId)
            );
            
            if (hasSpecialCoins) {
                const infoBox = document.createElement('div');
                infoBox.className = 'special-coin-info';
                infoBox.style.marginTop = '15px';
                infoBox.style.padding = '10px 15px';
                infoBox.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                infoBox.style.borderRadius = '8px';
                infoBox.style.fontSize = '13px';
                infoBox.style.color = '#d46b08';
                
                infoBox.innerHTML = `
                    <p style="margin: 0 0 5px 0; font-weight: 600;"><i class="fas fa-info-circle" style="margin-right: 5px;"></i> 特殊币种持仓说明</p>
                    <p style="margin: 0; line-height: 1.5;">对于ARB等部分小额币种，交易所API返回的持仓量是<b>币的数量</b>而非合约张数。实际下单张数可能少于显示的持仓量。</p>
                `;
                
                statusContainer.appendChild(infoBox);
            }
        }
    </script>

    <script>
        // 确保保证金输入框稳定，禁用所有动画
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能交易 - 策略设置</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/crypto-theme.css">
    <style>
        /* 页面基础样式 */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        /* 已下单状态按钮样式 */
        .confirm-btn.order-success {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }
        
        .confirm-btn.order-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
            background: linear-gradient(135deg, #46b314, #66c832);
        }
        
        /* 已持仓状态按钮样式 */
        .confirm-btn.position-active {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }
        
        .confirm-btn.position-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
            background: linear-gradient(135deg, #096dd9, #1f9fff);
        }
        
        /* 导航栏样式 */
        .u-navbar {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }
        
        .u-navbar__content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            padding: 0 15px;
        }
        
        .u-navbar__content__left {
            position: absolute;
            left: 15px;
            display: flex;
            align-items: center;
        }
        
        .u-navbar__content__title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .u-icon__icon {
            font-size: 20px;
            color: #ffffff;
            transition: transform 0.2s ease;
        }
        
        .u-icon__icon:hover {
            transform: scale(1.1);
        }
        
        /* 主要内容区域 */
        .robot-settings {
            margin-top: 70px;
            padding: 15px;
        }
        
        /* 卡片式容器 */
        .box {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .box:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.11);
            transform: translateY(-2px);
        }
        
        .box-card {
            padding: 22px;
        }
        
        /* 顶部资产信息 */
        .top-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .top-left {
            display: flex;
            flex-direction: column;
        }
        
        .available-m {
            font-size: 14px;
            color: #8c8c8c;
            margin-right: 8px;
        }
        
        .refresh-img {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .refresh-img:hover {
            transform: rotate(90deg);
        }
        
        .now-money {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
            margin-top: 5px;
            letter-spacing: 0.5px;
        }
        
        .top-right {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .coin-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 2px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .change-img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .change-img:hover {
            opacity: 1;
        }
        
        /* 表单项样式 */
        .self-forms {
            margin-top: 15px;
        }
        
        .forms-item {
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .forms-item:hover {
            transform: translateY(-2px);
        }
        
        .form-item-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-size: 15px;
            color: #262626;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .form-item-input {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .form-item-input:focus-within {
            box-shadow: 0 0 0 2px rgba(51, 102, 255, 0.2);
        }
        
        .input-border {
            border: 1px solid #e8e8e8;
        }
        
        .robot-info {
            display: flex;
            align-items: center;
        }
        
        .robot-name {
            margin-left: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #262626;
        }
        
        .input-right {
            margin-left: auto;
            color: #3366FF;
        }
        
        /* 策略类型选择 */
        .type-scroll {
            display: flex;
            overflow-x: auto;
            margin: 10px 0;
            padding: 8px 0;
            scrollbar-width: none; /* Firefox */
        }
        
        .type-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .scroll-li-types {
            min-width: 100px;
            height: 44px;
            border-radius: 22px;
            background-color: #f9fafc;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #5c5c5c;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .scroll-li-types:hover {
            background-color: #edf2ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(51, 102, 255, 0.15);
        }
        
        .type-actives {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.3);
            border: none;
        }
        
        /* 滑块样式 */
        .gress-box {
            margin: 15px 0;
            padding: 5px 0;
            width: 100%;
        }
        
        .sunny-sliderBar {
            width: 100%;
        }
        
        /* 进度条样式优化，修复背景出界问题 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            max-width: 100% !important;
            overflow: hidden;
        }
        
        /* 滑动条容器增强 */
        .sliderBar {
            cursor: pointer;
            background: linear-gradient(to bottom, #f0f0f0, #f9fafc);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
            border-radius: 22px;
            position: relative;
            border: 1px solid rgba(220, 220, 220, 0.9);
            height: 44px;
            overflow: hidden;
        }
        
        .img-box {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .move-img {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .move-img:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .dot-indicator {
            width: 14px;
            height: 14px;
            background-color: #fff;
            border: 2px solid var(--primaryColor, #1a6aff);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(26, 106, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .move-img:hover .dot-indicator {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.3);
        }
        
        .bili-text {
            position: absolute;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .move-img:hover .bili-text {
            color: #1a6aff;
            font-weight: 600;
        }
        
        .gone {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            z-index: 1;
            transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .slider {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(51, 102, 255, 0.4);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) inset;
        }
        
        .slider::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        .slider:hover {
            box-shadow: 0 5px 18px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .slider:active {
            box-shadow: 0 2px 8px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(0.98);
        }
        
        .count {
            color: rgba(255, 255, 255, 0);
            font-size: 13px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a6aff;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .slider:hover .count {
            color: rgba(255, 255, 255, 1);
            opacity: 1;
            bottom: -30px;
        }
        
        .position-slider-container {
            padding: 15px 0;
        }
        
        /* 底部按钮 */
        .confirm-bot-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background-color: white;
            z-index: 90;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.08);
        }
        
        .confirm-btn {
            width: 100%;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            font-size: 16px;
            font-weight: 500;
            border: none;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
            letter-spacing: 1px;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 102, 255, 0.35);
            background: linear-gradient(135deg, #0a5aea, #2d78ff);
        }
        
        .confirm-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(51, 102, 255, 0.3);
        }
        
        /* 开关样式 */
        .toggle-wrapper {
            width: 60px;
            height: 32px;
            position: relative;
            background-color: #e8e8e8;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-background {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: block;
            transition: all 0.3s ease;
        }
        
        .toggle-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        .active-lis .toggle-background {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
        }
        
        .active-lis .toggle-indicator {
            transform: translateX(28px);
        }
        
        /* 单选框样式 */
        .radio-box {
            display: flex;
            flex-wrap: wrap;
            margin: 5px 0;
        }
        
        .u-radio {
            margin-right: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        
        .u-radio:hover {
            color: #3366FF;
        }
        
        .u-radio__icon-wrap {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c8c9cc;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .u-radio__icon-wrap--circle {
            background-color: #fff;
        }
        
        /* 修改原有样式 */
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .settings-row:hover {
            background-color: #f9fafc;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 15px;
            color: #454545;
            font-weight: 500;
        }
        
        .setting-value {
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .arrow-right {
            margin-left: 10px;
            color: #c0c4cc;
            transition: transform 0.2s ease;
        }
        
        .settings-row:hover .arrow-right {
            transform: translateX(3px);
            color: #3366FF;
        }
        
        /* 添加uni-app风格组件样式 */
        .f-1 {
            flex: 1;
        }
        
        .box2 {
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .box2:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.09);
        }
        
        .flexs {
            display: flex;
            align-items: center;
        }
        
        .flex-x {
            display: flex;
            align-items: center;
        }
        
        .flex-y {
            display: flex;
            flex-direction: column;
        }
        
        .flex-x-b {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .flex-x-c {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flex-y-c {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .f-s {
            display: flex;
            align-items: center;
        }
        
        .theme-border-color {
            border-color: #e8e8e8;
        }
        
        .theme-border-color2 {
            border-color: #f5f7fa;
        }
        
        .box-bg1 {
            background-color: #f5f7fa;
        }
        
        .margin_r1 {
            margin-right: 10px;
        }
        
        .margin_b1 {
            margin-bottom: 18px;
        }
        
        .lable-name {
            font-size: 15px;
            color: #262626;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .type-box {
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .type-li {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .type-active {
            background: linear-gradient(135deg, #3366FF, #5C91EF);
            color: white;
        }
        
        .icon-box {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        
        .uni-input-input {
            height: 36px;
            width: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 15px;
            color: #262626;
            font-weight: 500;
        }
        
        .uni-input-wrapper {
            width: 100%;
            position: relative;
        }
        
        .myicon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        
        .icon-Choose:before {
            content: "\f0c9";
        }
        
        /* 滑块相关样式补充 */
        .gress-box {
            margin: 10px 0;
            padding: 10px 5px;
            width: 100%;
        }
        
        .uni-input-placeholder {
            color: #999;
            font-size: 14px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
        }
        
        .uicon-question-circle:before {
            content: "\f059";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-right:before {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-down-fill:before {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
        }
        
        /* 修改滑块组件样式 */
        .position-slider-container {
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* 添加动画和过渡效果 */
        .element-animated {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .title-animated {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .row-clicked {
            background-color: #f0f7ff !important;
        }
        
        .btn-clicked {
            transform: scale(0.95) !important;
        }
        
        .slider-active {
            box-shadow: 0 5px 15px rgba(51, 102, 255, 0.5) !important;
        }
        
        .page-loaded .u-navbar {
            transform: translateY(0);
        }
        
        /* Toast消息提示 */
        .toast-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background-color: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 9999;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 80%;
            font-weight: 500;
        }
        
        .toast-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 新增高级样式 */
        .premium-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #ffb700, #ffd869);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 2px 6px rgba(255, 183, 0, 0.3);
        }
        
        .premium-icon i {
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .premium-strategy {
            position: relative;
        }
        
        .premium-strategy::after {
            content: "推荐";
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
        }
        
        /* 新增按钮悬停效果 */
        .hover-glow {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(26, 106, 255, 0.4);
        }
        
        /* 动画关键帧增强 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 新增投入金额高亮效果 - 已修改为无动画 */
        .margin-highlight {
            box-shadow: 0 0 0 2px rgba(26, 106, 255, 0.3);
        }
        
        /* 杠杆选择框样式优化 */
        .leverage-dialog {
            animation: fadeInUp 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .leverage-option {
            position: relative;
            overflow: hidden;
        }
        
        .leverage-option::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 106, 255, 0.05);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: -1;
        }
        
        .leverage-option:hover::before {
            transform: scaleX(1);
        }
        
        /* 页面初始化状态 */
        .u-navbar {
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        
        /* 滑块颜色样式 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }
        
        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }
        
        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }

        /* 滑块动画效果 */
        .slider-active {
            transform: scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }

        .slider-pulse {
            animation: pulse 0.3s ease-out;
        }

        .slider-done {
            animation: done 0.5s ease-out;
        }

        .dot-active {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(26, 106, 255, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 3;
        }

        @keyframes pulse {
            0% { transform: scale(1) translateX(var(--x-position, 0)); }
            50% { transform: scale(1.2) translateX(var(--x-position, 0)); }
            100% { transform: scale(1) translateX(var(--x-position, 0)); }
        }

        @keyframes done {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }

        /* 滑动条容器增强样式 */
        .sliderBar {
            cursor: pointer;
            background-color: #f5f7fa;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 进度条样式增强 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 4px;
        }

        /* 滑块增强样式 */
        .slider {
            cursor: grab;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
            z-index: 4;
        }
        
        .slider:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(26, 106, 255, 0.6);
        }
        
        .slider:active {
            cursor: grabbing;
        }

        /* 百分比显示样式增强 */
        .slider .count {
            background-color: #1a6aff;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider:hover .count {
            transform: translateY(-5px) scale(1.1);
        }

        /* 固定点样式增强 */
        .move-img {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border: 1px solid #e4e7ed;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 3;
        }
        
        .move-img:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.4);
        }
        
        /* 滑块点指示器 */
        .dot-indicator {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dot-indicator::after {
            content: "";
            width: 6px;
            height: 6px;
            background-color: #1a6aff;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .move-img:hover .dot-indicator::after {
            transform: scale(1.5);
        }
        
        /* 滑块优化 */
        #position-slider-percent {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
        }
        
        #position-slider-percent:active {
            cursor: grabbing;
            transform: scale(1.1) translateX(var(--x-pos, 0px));
        }
        
        #position-slider-percent .count {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 50px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            background-color: #1a6aff;
            color: white;
            border-radius: 13px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.3s;
        }
        
        /* 修复动画效果 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out;
        }
        
        .slider-done {
            animation: sliderDone 0.5s ease-out;
        }
        
        @keyframes sliderPulse {
            0% { transform: scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: scale(1.2) translateX(var(--x-pos, 0px)); }
            100% { transform: scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        /* 保证金输入框更强优化 - 彻底消除跳动 */
        .form-item-input.margin-input {
            height: 56px; /* 固定高度 */
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.9);
            background: linear-gradient(to bottom, #f9fafc, #fff);
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 保证输入框内部元素不引起跳动 */
        .form-item-input.margin-input .uni-input-wrapper {
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .form-item-input.margin-input .uni-input-input {
            font-family: 'Roboto Mono', monospace, 'Segoe UI', 'PingFang SC';
            font-size: 16px;
            letter-spacing: 0.5px;
            height: 100%;
            line-height: 56px; /* 与容器高度相同 */
            transition: all 0.2s ease;
        }
        
        /* 右侧单位固定位置和尺寸 */
        .margin-value-container {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px; /* 固定宽度 */
            font-size: 16px;
        }
        
        /* 滑块球体居中 */
        #position-slider-percent {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
            backdrop-filter: blur(4px);
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%) translateX(0); /* 垂直居中并保留水平移动能力 */
        }
        
        /* 更新滑块球体在激活和交互状态的变形样式 */
        #position-slider-percent:active {
            cursor: grabbing;
            transform: translateY(-50%) scale(1.05) translateX(var(--x-pos, 0px));
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }
        
        .slider-active {
            transform: translateY(-50%) scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }
        
        /* 修复动画关键帧，保持垂直居中 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        /* 百分比值显示 */
        #position-value-percent {
            transition: color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            min-width: 50px;
            text-align: right;
        }
        
        #position-value-percent:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: right;
            opacity: 0.7;
        }
        
        #position-value-percent:hover:after {
            transform: scaleX(1);
        }
        
        /* 动画关键帧增强 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 25px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 15px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 8px rgba(26, 106, 255, 0.3); }
        }
        
        .dot-active {
            animation: dotPulse 0.5s ease-out;
        }

        /* 数值变化动画 */
        .value-changing {
            animation: value-pulse 0.3s ease;
        }

        @keyframes value-pulse {
            0% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 添加滑块滑动时的样式，确保其垂直居中 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out !important;
        }

        /* 更新HTML中的滑块初始样式 */
        <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
            <span class="count">100%</span>
        </div>

        /* 为数字输入添加额外的反跳动防护 */
        .uni-input-input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield;
            margin: 0;
            padding: 0 15px; /* 统一内边距，防止跳动 */
            width: 100%;
        }

        /* 消除数字输入框的上下箭头，避免高度变化 */
        .uni-input-input[type="number"]::-webkit-inner-spin-button,
        .uni-input-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 添加数值平滑过渡效果 */
        .form-item-input.margin-input .uni-input-input {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 输入值变化时的动画优化 */
        .value-changing {
            animation: value-pulse 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes value-pulse {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 确保USDT单位有固定尺寸 */
        .margin-value-container span {
            min-width: 45px;
            text-align: center;
            display: block;
            font-size: 15px;
            font-weight: 600;
        }

        /* 不同颜色进度条的样式 */
        .progress-red {
            background: linear-gradient(135deg, rgba(255, 77, 79, 0.25), rgba(255, 120, 117, 0.25)) !important;
        }

        .progress-yellow {
            background: linear-gradient(135deg, rgba(250, 173, 20, 0.25), rgba(255, 197, 61, 0.25)) !important;
        }

        .progress-blue {
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25)) !important;
        }

        /* 滑块的颜色样式增强 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }

        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }

        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }
        
        /* 模态窗口样式 */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-container.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .order-details {
            width: 100%;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        
        .detail-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            max-width: 60%;
            word-break: break-all;
            text-align: right;
        }
        
        .modal-confirm-btn {
            background-color: #1a6aff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .modal-confirm-btn:hover {
            background-color: #0052d9;
        }
        
        .error-modal .modal-content {
            border-top: 4px solid #ff4d4f;
        }
        
        .error-icon {
            margin: 10px 0 20px;
            color: #ff4d4f;
        }
        
        .modal-message {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-modal .modal-confirm-btn {
            background-color: #ff4d4f;
        }
        
        .error-modal .modal-confirm-btn:hover {
            background-color: #ff1f1f;
        }

        /* 币种选择弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-search {
            margin-bottom: 15px;
        }
        
        .modal-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-body {
            overflow-y: auto;
            flex: 1;
        }
        
        .crypto-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .crypto-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .crypto-item:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .crypto-item.selected {
            background-color: #e6f0ff;
            border: 1px solid #1a6aff;
        }
        
        .crypto-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .crypto-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* 续下单按钮动画效果 */
        #continue-order-btn {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #continue-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
            z-index: -1;
        }
        
        #continue-order-btn:hover::before {
            left: 100%;
        }
    
        /* 禁用保证金输入框的所有动画和过渡 */
        #margin-input-container,
        #margin-input-container *,
        .margin-input,
        .uni-input-input {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }
        
        /* 禁用值变化动画 */
        .value-changing {
            animation: none !important;
            transition: none !important;
        }
        
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="u-navbar">
        <div class="u-navbar__content">
            <div class="u-navbar__content__left">
                <i class="fas fa-arrow-left u-icon__icon" onclick="goBackToContract()"></i>
            </div>
            <div class="u-navbar__content__title">{{ strategy.name }}</div>
            <div class="u-navbar__content__right"></div>
        </div>
        </div>
        
    <div class="robot-settings">
        <!-- 顶部资产信息 -->
        <div class="forms box box-card margin_t2 hover-glow">
            <div class="top-box">
                <div class="top-left">
                    <div class="flex-x">
                        <span class="available-m">可用资产</span>
                        <img src="/static/newimg/refresh.png" class="refresh-img" alt="刷新">
                    </div>
                    <span class="now-money">{{ strategy.invested }} USDT</span>
                </div>
                <div class="top-right">
                    <img src="https://newrobot.idyyvv.top/image/20210823/ff380e5a4eac6a36fbf7dde5ed153745.png" class="coin-img" alt="交易所">
                    <div class="flex-x">
                        <img src="/static/newimg/change.png" class="change-img" alt="切换">
                        <span class="now-money">Binance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表单内容 -->
        <div class="self-forms">
            <!-- 币种选择 -->
            <div class="forms-item f-1 box2 hover-glow" id="crypto-selector">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                        <div class="premium-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <img id="selected-crypto-icon" src="https://ai.hkd.red/symbolImage/{{ strategy.trade_pair.split('-')[0] }}.png" style="height: 32px; width: 32px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.08);" alt="币种图标">
                                <div id="selected-crypto-name" class="robot-name">{{ strategy.trade_pair.split('-')[0] }}/{{ strategy.trade_pair.split('-')[1] }}</div>
                                <input type="hidden" id="selected-crypto-pair" value="{{ strategy.trade_pair }}">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <span class="margin_r1" style="color: #1a6aff;"></span>
                            <span class="myicon icon-Choose" style="color: #1a6aff;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易对选择弹窗 -->
            <div id="crypto-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>选择交易对</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="crypto-search" placeholder="搜索币种...">
                    </div>
                    <div class="modal-body">
                        <div class="crypto-list">
                            {% for pair in trading_pairs %}
                            <div class="crypto-item" data-original="{{ pair.original }}" data-symbol="{{ pair.symbol }}" data-display="{{ pair.display }}">
                                <img src="{{ pair.icon_url }}" alt="{{ pair.symbol }}" onerror="this.src='/static/images/default-coin.svg'">
                                <span>{{ pair.display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 币种选择（隐藏） -->
            <div class="forms-item f-1 box2" style="display: none;">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                    </div>
                    </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <div class="robot-name">币种</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="flex-x">
                            <span>请选择币种</span>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-right" style="font-size: 14px; line-height: 14px; font-weight: normal; top: 1px; color: rgb(200, 200, 200);"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预设策略 -->
            <div class="flex-y margin_b1">
                <span class="lable-name">预设策略</span>
                <div class="type-scroll">
                    <div class="scroll-li-types type-actives">
                        <div class="li-type-center flex-x-c">保守型</div>
                    </div>
                    <div class="scroll-li-types premium-strategy">
                        <div class="li-type-center flex-x-c">稳健型</div>
                </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">激进型</div>
                    </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">自定义</div>
                </div>
                    </div>
            </div>
            
            <!-- 策略方向 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>策略方向</span>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color" style="padding: 0px;">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="type-box flex-x-b box-bg1" style="width: 176px;">
                                <span class="type-li type-active">做多</span>
                                <span class="type-li">做空</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-right"></div>
                </div>
            </div>
            
            <!-- 杠杆调整 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>杠杆调整</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input disabled="disabled" placeholder="选择杠杆倍数" maxlength="140" step="" enterkeyhint="done" autocomplete="off" type="text" class="uni-input-input">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-down-fill" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: #1a6aff;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预计投入 -->
            <div class="forms-item f-1 box2" id="margin-input-container">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>预计投入（保证金）</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border margin-input">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input placeholder="输入投入金额" maxlength="140" step="0.01" min="0.01" enterkeyhint="done" autocomplete="off" type="number" class="uni-input-input" id="margin-input" onchange="formatMarginValue(this)">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="margin-value-container">
                            <span style="font-weight: 500; color: #1a6aff;">USDT</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 策略参数设置 -->
            <div class="settings-card box hover-glow">
                <div class="settings-title">参数设置 <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">专业版</small></div>
                <div class="settings-row">
                    <div class="setting-label">网格数量</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.grid_count }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">价格区间</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.price_range }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">风险等级</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.risk_level }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>

                <!-- 添加仓位比例控制 -->
                <div class="settings-row">
                    <div class="setting-label">仓位比例控制</div>
                    <div class="setting-value">
                        <span id="position-value-percent" style="font-weight: 600; color: #1a6aff;">100%</span>
                    </div>
                </div>
                <div class="settings-row position-slider-container">
                    <div class="gress-box">
                        <div class="sunny-sliderBar" style="width: 100%; --sliderBarbgc:#f0f0f0; --primaryColor:#1a6aff;">
                            <div class="sliderBar" style="width: 100%;">
                                <div class="img-box">
                                    <div class="move-img" style="left: 0%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">0</span>
            </div>
                                    <div class="move-img" style="left: 25%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">25</span>
                </div>
                                    <div class="move-img" style="left: 50%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">50</span>
                    </div>
                                    <div class="move-img" style="left: 75%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">75</span>
                        </div>
                                    <div class="move-img" style="left: 100%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">100</span>
                        </div>
                    </div>
                                <div class="gone" style="width: 100%;"></div>
                                <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
                                    <span class="count">100%</span>
                </div>
                            </div>
                        </div>
                        </div>
                    </div>



                <div class="settings-row">
                    <div class="setting-label">续下单</div>
                    <div class="setting-value">
                        <button id="continue-order-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #1a6aff, #3f87ff); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(26, 106, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试用)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加策略控制按钮区域 -->
    <div class="strategy-controls" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能交易 - 策略设置</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/crypto-theme.css">
    <style>
        /* 页面基础样式 */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        /* 已下单状态按钮样式 */
        .confirm-btn.order-success {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            box-shadow: 0 4px 15px rgba(82, 196, 26, 0.3);
        }
        
        .confirm-btn.order-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
            background: linear-gradient(135deg, #46b314, #66c832);
        }
        
        /* 已持仓状态按钮样式 */
        .confirm-btn.position-active {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }
        
        .confirm-btn.position-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
            background: linear-gradient(135deg, #096dd9, #1f9fff);
        }
        
        /* 导航栏样式 */
        .u-navbar {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease;
        }
        
        .u-navbar__content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            padding: 0 15px;
        }
        
        .u-navbar__content__left {
            position: absolute;
            left: 15px;
            display: flex;
            align-items: center;
        }
        
        .u-navbar__content__title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .u-icon__icon {
            font-size: 20px;
            color: #ffffff;
            transition: transform 0.2s ease;
        }
        
        .u-icon__icon:hover {
            transform: scale(1.1);
        }
        
        /* 主要内容区域 */
        .robot-settings {
            margin-top: 70px;
            padding: 15px;
        }
        
        /* 卡片式容器 */
        .box {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .box:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.11);
            transform: translateY(-2px);
        }
        
        .box-card {
            padding: 22px;
        }
        
        /* 顶部资产信息 */
        .top-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .top-left {
            display: flex;
            flex-direction: column;
        }
        
        .available-m {
            font-size: 14px;
            color: #8c8c8c;
            margin-right: 8px;
        }
        
        .refresh-img {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .refresh-img:hover {
            transform: rotate(90deg);
        }
        
        .now-money {
            font-size: 24px;
            font-weight: 600;
            color: #262626;
            margin-top: 5px;
            letter-spacing: 0.5px;
        }
        
        .top-right {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .coin-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 2px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .change-img {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .change-img:hover {
            opacity: 1;
        }
        
        /* 表单项样式 */
        .self-forms {
            margin-top: 15px;
        }
        
        .forms-item {
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .forms-item:hover {
            transform: translateY(-2px);
        }
        
        .form-item-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .label {
            font-size: 15px;
            color: #262626;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .form-item-input {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .form-item-input:focus-within {
            box-shadow: 0 0 0 2px rgba(51, 102, 255, 0.2);
        }
        
        .input-border {
            border: 1px solid #e8e8e8;
        }
        
        .robot-info {
            display: flex;
            align-items: center;
        }
        
        .robot-name {
            margin-left: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #262626;
        }
        
        .input-right {
            margin-left: auto;
            color: #3366FF;
        }
        
        /* 策略类型选择 */
        .type-scroll {
            display: flex;
            overflow-x: auto;
            margin: 10px 0;
            padding: 8px 0;
            scrollbar-width: none; /* Firefox */
        }
        
        .type-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .scroll-li-types {
            min-width: 100px;
            height: 44px;
            border-radius: 22px;
            background-color: #f9fafc;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #5c5c5c;
            padding: 0 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .scroll-li-types:hover {
            background-color: #edf2ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(51, 102, 255, 0.15);
        }
        
        .type-actives {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.3);
            border: none;
        }
        
        /* 滑块样式 */
        .gress-box {
            margin: 15px 0;
            padding: 5px 0;
            width: 100%;
        }
        
        .sunny-sliderBar {
            width: 100%;
        }
        
        /* 进度条样式优化，修复背景出界问题 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            max-width: 100% !important;
            overflow: hidden;
        }
        
        /* 滑动条容器增强 */
        .sliderBar {
            cursor: pointer;
            background: linear-gradient(to bottom, #f0f0f0, #f9fafc);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
            border-radius: 22px;
            position: relative;
            border: 1px solid rgba(220, 220, 220, 0.9);
            height: 44px;
            overflow: hidden;
        }
        
        .img-box {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .move-img {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .move-img:hover {
            transform: translateY(-50%) scale(1.2);
        }
        
        .dot-indicator {
            width: 14px;
            height: 14px;
            background-color: #fff;
            border: 2px solid var(--primaryColor, #1a6aff);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(26, 106, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .move-img:hover .dot-indicator {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.3);
        }
        
        .bili-text {
            position: absolute;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .move-img:hover .bili-text {
            color: #1a6aff;
            font-weight: 600;
        }
        
        .gone {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 22px;
            z-index: 1;
            transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .slider {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(51, 102, 255, 0.4);
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) inset;
        }
        
        .slider::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        .slider:hover {
            box-shadow: 0 5px 18px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(1.05);
        }
        
        .slider:active {
            box-shadow: 0 2px 8px rgba(51, 102, 255, 0.6);
            transform: translateY(-50%) scale(0.98);
        }
        
        .count {
            color: rgba(255, 255, 255, 0);
            font-size: 13px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a6aff;
            padding: 2px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .slider:hover .count {
            color: rgba(255, 255, 255, 1);
            opacity: 1;
            bottom: -30px;
        }
        
        .position-slider-container {
            padding: 15px 0;
        }
        
        /* 底部按钮 */
        .confirm-bot-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background-color: white;
            z-index: 90;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.08);
        }
        
        .confirm-btn {
            width: 100%;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            color: white;
            font-size: 16px;
            font-weight: 500;
            border: none;
            box-shadow: 0 4px 15px rgba(51, 102, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
            letter-spacing: 1px;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 102, 255, 0.35);
            background: linear-gradient(135deg, #0a5aea, #2d78ff);
        }
        
        .confirm-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(51, 102, 255, 0.3);
        }
        
        /* 开关样式 */
        .toggle-wrapper {
            width: 60px;
            height: 32px;
            position: relative;
            background-color: #e8e8e8;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-background {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: block;
            transition: all 0.3s ease;
        }
        
        .toggle-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background-color: #fff;
            border-radius: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        .active-lis .toggle-background {
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
        }
        
        .active-lis .toggle-indicator {
            transform: translateX(28px);
        }
        
        /* 单选框样式 */
        .radio-box {
            display: flex;
            flex-wrap: wrap;
            margin: 5px 0;
        }
        
        .u-radio {
            margin-right: 15px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        
        .u-radio:hover {
            color: #3366FF;
        }
        
        .u-radio__icon-wrap {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #c8c9cc;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .u-radio__icon-wrap--circle {
            background-color: #fff;
        }
        
        /* 修改原有样式 */
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .settings-row:hover {
            background-color: #f9fafc;
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-size: 15px;
            color: #454545;
            font-weight: 500;
        }
        
        .setting-value {
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .arrow-right {
            margin-left: 10px;
            color: #c0c4cc;
            transition: transform 0.2s ease;
        }
        
        .settings-row:hover .arrow-right {
            transform: translateX(3px);
            color: #3366FF;
        }
        
        /* 添加uni-app风格组件样式 */
        .f-1 {
            flex: 1;
        }
        
        .box2 {
            background-color: #fff;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .box2:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.09);
        }
        
        .flexs {
            display: flex;
            align-items: center;
        }
        
        .flex-x {
            display: flex;
            align-items: center;
        }
        
        .flex-y {
            display: flex;
            flex-direction: column;
        }
        
        .flex-x-b {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .flex-x-c {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flex-y-c {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .f-s {
            display: flex;
            align-items: center;
        }
        
        .theme-border-color {
            border-color: #e8e8e8;
        }
        
        .theme-border-color2 {
            border-color: #f5f7fa;
        }
        
        .box-bg1 {
            background-color: #f5f7fa;
        }
        
        .margin_r1 {
            margin-right: 10px;
        }
        
        .margin_b1 {
            margin-bottom: 18px;
        }
        
        .lable-name {
            font-size: 15px;
            color: #262626;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .type-box {
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .type-li {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .type-active {
            background: linear-gradient(135deg, #3366FF, #5C91EF);
            color: white;
        }
        
        .icon-box {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        
        .uni-input-input {
            height: 36px;
            width: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 15px;
            color: #262626;
            font-weight: 500;
        }
        
        .uni-input-wrapper {
            width: 100%;
            position: relative;
        }
        
        .myicon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }
        
        .icon-Choose:before {
            content: "\f0c9";
        }
        
        /* 滑块相关样式补充 */
        .gress-box {
            margin: 10px 0;
            padding: 10px 5px;
            width: 100%;
        }
        
        .uni-input-placeholder {
            color: #999;
            font-size: 14px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
        }
        
        .uicon-question-circle:before {
            content: "\f059";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-right:before {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
        }
        
        .uicon-arrow-down-fill:before {
            content: "\f078";
            font-family: "Font Awesome 6 Free";
        }
        
        /* 修改滑块组件样式 */
        .position-slider-container {
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* 添加动画和过渡效果 */
        .element-animated {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .title-animated {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .row-clicked {
            background-color: #f0f7ff !important;
        }
        
        .btn-clicked {
            transform: scale(0.95) !important;
        }
        
        .slider-active {
            box-shadow: 0 5px 15px rgba(51, 102, 255, 0.5) !important;
        }
        
        .page-loaded .u-navbar {
            transform: translateY(0);
        }
        
        /* Toast消息提示 */
        .toast-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background-color: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            z-index: 9999;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 80%;
            font-weight: 500;
        }
        
        .toast-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 新增高级样式 */
        .premium-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #ffb700, #ffd869);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 2px 6px rgba(255, 183, 0, 0.3);
        }
        
        .premium-icon i {
            color: white;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .premium-strategy {
            position: relative;
        }
        
        .premium-strategy::after {
            content: "推荐";
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
        }
        
        /* 新增按钮悬停效果 */
        .hover-glow {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(26, 106, 255, 0.4);
        }
        
        /* 动画关键帧增强 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* 新增投入金额高亮效果 - 已修改为无动画 */
        .margin-highlight {
            box-shadow: 0 0 0 2px rgba(26, 106, 255, 0.3);
        }
        
        /* 杠杆选择框样式优化 */
        .leverage-dialog {
            animation: fadeInUp 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(230, 230, 230, 0.7);
        }
        
        .leverage-option {
            position: relative;
            overflow: hidden;
        }
        
        .leverage-option::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 106, 255, 0.05);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: -1;
        }
        
        .leverage-option:hover::before {
            transform: scaleX(1);
        }
        
        /* 页面初始化状态 */
        .u-navbar {
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        
        /* 滑块颜色样式 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }
        
        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }
        
        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }

        /* 滑块动画效果 */
        .slider-active {
            transform: scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }

        .slider-pulse {
            animation: pulse 0.3s ease-out;
        }

        .slider-done {
            animation: done 0.5s ease-out;
        }

        .dot-active {
            transform: scale(1.3);
            box-shadow: 0 0 15px rgba(26, 106, 255, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 3;
        }

        @keyframes pulse {
            0% { transform: scale(1) translateX(var(--x-position, 0)); }
            50% { transform: scale(1.2) translateX(var(--x-position, 0)); }
            100% { transform: scale(1) translateX(var(--x-position, 0)); }
        }

        @keyframes done {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }

        /* 滑动条容器增强样式 */
        .sliderBar {
            cursor: pointer;
            background-color: #f5f7fa;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 进度条样式增强 */
        .gone {
            transition: width 0.3s ease;
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25));
            border-radius: 4px;
        }

        /* 滑块增强样式 */
        .slider {
            cursor: grab;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            transition: background 0.3s, box-shadow 0.3s, transform 0.1s;
            z-index: 4;
        }
        
        .slider:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(26, 106, 255, 0.6);
        }
        
        .slider:active {
            cursor: grabbing;
        }

        /* 百分比显示样式增强 */
        .slider .count {
            background-color: #1a6aff;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .slider:hover .count {
            transform: translateY(-5px) scale(1.1);
        }

        /* 固定点样式增强 */
        .move-img {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border: 1px solid #e4e7ed;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 3;
        }
        
        .move-img:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(26, 106, 255, 0.4);
        }
        
        /* 滑块点指示器 */
        .dot-indicator {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dot-indicator::after {
            content: "";
            width: 6px;
            height: 6px;
            background-color: #1a6aff;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .move-img:hover .dot-indicator::after {
            transform: scale(1.5);
        }
        
        /* 滑块优化 */
        #position-slider-percent {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid white;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
        }
        
        #position-slider-percent:active {
            cursor: grabbing;
            transform: scale(1.1) translateX(var(--x-pos, 0px));
        }
        
        #position-slider-percent .count {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 50px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            background-color: #1a6aff;
            color: white;
            border-radius: 13px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.3s;
        }
        
        /* 修复动画效果 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out;
        }
        
        .slider-done {
            animation: sliderDone 0.5s ease-out;
        }
        
        @keyframes sliderPulse {
            0% { transform: scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: scale(1.2) translateX(var(--x-pos, 0px)); }
            100% { transform: scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 20px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        /* 保证金输入框更强优化 - 彻底消除跳动 */
        .form-item-input.margin-input {
            height: 56px; /* 固定高度 */
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            border: 1px solid rgba(230, 230, 230, 0.9);
            background: linear-gradient(to bottom, #f9fafc, #fff);
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 保证输入框内部元素不引起跳动 */
        .form-item-input.margin-input .uni-input-wrapper {
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .form-item-input.margin-input .uni-input-input {
            font-family: 'Roboto Mono', monospace, 'Segoe UI', 'PingFang SC';
            font-size: 16px;
            letter-spacing: 0.5px;
            height: 100%;
            line-height: 56px; /* 与容器高度相同 */
            transition: all 0.2s ease;
        }
        
        /* 右侧单位固定位置和尺寸 */
        .margin-value-container {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px; /* 固定宽度 */
            font-size: 16px;
        }
        
        /* 滑块球体居中 */
        #position-slider-percent {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a6aff, #3f87ff);
            border: 2px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.5);
            position: absolute;
            cursor: grab;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s, box-shadow 0.3s;
            z-index: 5;
            backdrop-filter: blur(4px);
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%) translateX(0); /* 垂直居中并保留水平移动能力 */
        }
        
        /* 更新滑块球体在激活和交互状态的变形样式 */
        #position-slider-percent:active {
            cursor: grabbing;
            transform: translateY(-50%) scale(1.05) translateX(var(--x-pos, 0px));
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }
        
        .slider-active {
            transform: translateY(-50%) scale(1.1) !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            z-index: 5;
        }
        
        /* 修复动画关键帧，保持垂直居中 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        /* 百分比值显示 */
        #position-value-percent {
            transition: color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            min-width: 50px;
            text-align: right;
        }
        
        #position-value-percent:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: right;
            opacity: 0.7;
        }
        
        #position-value-percent:hover:after {
            transform: scaleX(1);
        }
        
        /* 动画关键帧增强 */
        @keyframes sliderPulse {
            0% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
            50% { transform: translateY(-50%) scale(1.15) translateX(var(--x-pos, 0px)); }
            100% { transform: translateY(-50%) scale(1) translateX(var(--x-pos, 0px)); }
        }
        
        @keyframes sliderDone {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 25px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5); }
        }
        
        @keyframes dotPulse {
            0% { box-shadow: 0 0 0 rgba(26, 106, 255, 0); }
            50% { box-shadow: 0 0 15px rgba(26, 106, 255, 0.8); }
            100% { box-shadow: 0 3px 8px rgba(26, 106, 255, 0.3); }
        }
        
        .dot-active {
            animation: dotPulse 0.5s ease-out;
        }

        /* 数值变化动画 */
        .value-changing {
            animation: value-pulse 0.3s ease;
        }

        @keyframes value-pulse {
            0% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 添加滑块滑动时的样式，确保其垂直居中 */
        .slider-pulse {
            animation: sliderPulse 0.3s ease-out !important;
        }

        /* 更新HTML中的滑块初始样式 */
        <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
            <span class="count">100%</span>
        </div>

        /* 为数字输入添加额外的反跳动防护 */
        .uni-input-input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield;
            margin: 0;
            padding: 0 15px; /* 统一内边距，防止跳动 */
            width: 100%;
        }

        /* 消除数字输入框的上下箭头，避免高度变化 */
        .uni-input-input[type="number"]::-webkit-inner-spin-button,
        .uni-input-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 添加数值平滑过渡效果 */
        .form-item-input.margin-input .uni-input-input {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 输入值变化时的动画优化 */
        .value-changing {
            animation: value-pulse 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes value-pulse {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* 确保USDT单位有固定尺寸 */
        .margin-value-container span {
            min-width: 45px;
            text-align: center;
            display: block;
            font-size: 15px;
            font-weight: 600;
        }

        /* 不同颜色进度条的样式 */
        .progress-red {
            background: linear-gradient(135deg, rgba(255, 77, 79, 0.25), rgba(255, 120, 117, 0.25)) !important;
        }

        .progress-yellow {
            background: linear-gradient(135deg, rgba(250, 173, 20, 0.25), rgba(255, 197, 61, 0.25)) !important;
        }

        .progress-blue {
            background: linear-gradient(135deg, rgba(26, 106, 255, 0.25), rgba(63, 135, 255, 0.25)) !important;
        }

        /* 滑块的颜色样式增强 */
        .slider-red {
            background: linear-gradient(135deg, #ff4d4f, #ff7875) !important;
            box-shadow: 0 3px 12px rgba(255, 77, 79, 0.5) !important;
        }

        .slider-yellow {
            background: linear-gradient(135deg, #faad14, #ffc53d) !important;
            box-shadow: 0 3px 12px rgba(250, 173, 20, 0.5) !important;
        }

        .slider-blue {
            background: linear-gradient(135deg, #1a6aff, #3f87ff) !important;
            box-shadow: 0 3px 12px rgba(26, 106, 255, 0.5) !important;
        }
        
        /* 模态窗口样式 */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-container.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .modal-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .order-details {
            width: 100%;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        
        .detail-row {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        
        .detail-value {
            color: #333;
            max-width: 60%;
            word-break: break-all;
            text-align: right;
        }
        
        .modal-confirm-btn {
            background-color: #1a6aff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .modal-confirm-btn:hover {
            background-color: #0052d9;
        }
        
        .error-modal .modal-content {
            border-top: 4px solid #ff4d4f;
        }
        
        .error-icon {
            margin: 10px 0 20px;
            color: #ff4d4f;
        }
        
        .modal-message {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .error-modal .modal-confirm-btn {
            background-color: #ff4d4f;
        }
        
        .error-modal .modal-confirm-btn:hover {
            background-color: #ff1f1f;
        }

        /* 币种选择弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-search {
            margin-bottom: 15px;
        }
        
        .modal-search input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-body {
            overflow-y: auto;
            flex: 1;
        }
        
        .crypto-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .crypto-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .crypto-item:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .crypto-item.selected {
            background-color: #e6f0ff;
            border: 1px solid #1a6aff;
        }
        
        .crypto-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .crypto-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        
        /* 续下单按钮动画效果 */
        #continue-order-btn {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #continue-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(26, 106, 255, 0.4);
        }
        
        #continue-order-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
            z-index: -1;
        }
        
        #continue-order-btn:hover::before {
            left: 100%;
        }
    
        /* 禁用保证金输入框的所有动画和过渡 */
        #margin-input-container,
        #margin-input-container *,
        .margin-input,
        .uni-input-input {
            animation: none !important;
            transition: none !important;
            transform: none !important;
        }
        
        /* 禁用值变化动画 */
        .value-changing {
            animation: none !important;
            transition: none !important;
        }
        
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="u-navbar">
        <div class="u-navbar__content">
            <div class="u-navbar__content__left">
                <i class="fas fa-arrow-left u-icon__icon" onclick="goBackToContract()"></i>
            </div>
            <div class="u-navbar__content__title">{{ strategy.name }}</div>
            <div class="u-navbar__content__right"></div>
        </div>
        </div>
        
    <div class="robot-settings">
        <!-- 顶部资产信息 -->
        <div class="forms box box-card margin_t2 hover-glow">
            <div class="top-box">
                <div class="top-left">
                    <div class="flex-x">
                        <span class="available-m">可用资产</span>
                        <img src="/static/newimg/refresh.png" class="refresh-img" alt="刷新">
                    </div>
                    <span class="now-money">{{ strategy.invested }} USDT</span>
                </div>
                <div class="top-right">
                    <img src="https://newrobot.idyyvv.top/image/20210823/ff380e5a4eac6a36fbf7dde5ed153745.png" class="coin-img" alt="交易所">
                    <div class="flex-x">
                        <img src="/static/newimg/change.png" class="change-img" alt="切换">
                        <span class="now-money">Binance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表单内容 -->
        <div class="self-forms">
            <!-- 币种选择 -->
            <div class="forms-item f-1 box2 hover-glow" id="crypto-selector">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                        <div class="premium-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <img id="selected-crypto-icon" src="https://ai.hkd.red/symbolImage/{{ strategy.trade_pair.split('-')[0] }}.png" style="height: 32px; width: 32px; object-fit: cover; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.08);" alt="币种图标">
                                <div id="selected-crypto-name" class="robot-name">{{ strategy.trade_pair.split('-')[0] }}/{{ strategy.trade_pair.split('-')[1] }}</div>
                                <input type="hidden" id="selected-crypto-pair" value="{{ strategy.trade_pair }}">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <span class="margin_r1" style="color: #1a6aff;"></span>
                            <span class="myicon icon-Choose" style="color: #1a6aff;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易对选择弹窗 -->
            <div id="crypto-selection-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>选择交易对</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-search">
                        <input type="text" id="crypto-search" placeholder="搜索币种...">
                    </div>
                    <div class="modal-body">
                        <div class="crypto-list">
                            {% for pair in trading_pairs %}
                            <div class="crypto-item" data-original="{{ pair.original }}" data-symbol="{{ pair.symbol }}" data-display="{{ pair.display }}">
                                <img src="{{ pair.icon_url }}" alt="{{ pair.symbol }}" onerror="this.src='/static/images/default-coin.svg'">
                                <span>{{ pair.display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 币种选择（隐藏） -->
            <div class="forms-item f-1 box2" style="display: none;">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>币种选择</span>
                    </div>
                    </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="robot-info f-s">
                                <div class="robot-name">币种</div>
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="flex-x">
                            <span>请选择币种</span>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-right" style="font-size: 14px; line-height: 14px; font-weight: normal; top: 1px; color: rgb(200, 200, 200);"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预设策略 -->
            <div class="flex-y margin_b1">
                <span class="lable-name">预设策略</span>
                <div class="type-scroll">
                    <div class="scroll-li-types type-actives">
                        <div class="li-type-center flex-x-c">保守型</div>
                    </div>
                    <div class="scroll-li-types premium-strategy">
                        <div class="li-type-center flex-x-c">稳健型</div>
                </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">激进型</div>
                    </div>
                    <div class="scroll-li-types">
                        <div class="li-type-center flex-x-c">自定义</div>
                </div>
                    </div>
            </div>
            
            <!-- 策略方向 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>策略方向</span>
                    </div>
                </div>
                <div class="form-item-input flexs theme-border-color" style="padding: 0px;">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="type-box flex-x-b box-bg1" style="width: 176px;">
                                <span class="type-li type-active">做多</span>
                                <span class="type-li">做空</span>
                            </div>
                        </div>
                    </div>
                    <div class="input-right"></div>
                </div>
            </div>
            
            <!-- 杠杆调整 -->
            <div class="forms-item f-1 box2 hover-glow">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>杠杆调整</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input disabled="disabled" placeholder="选择杠杆倍数" maxlength="140" step="" enterkeyhint="done" autocomplete="off" type="text" class="uni-input-input">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div>
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-arrow-down-fill" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: #1a6aff;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 预计投入 -->
            <div class="forms-item f-1 box2" id="margin-input-container">
                <div class="form-item-label flexs" style="width: auto;">
                    <div class="label flexs">
                        <span>预计投入（保证金）</span>
                        <div class="icon-box">
                            <div class="u-icon u-icon--right">
                                <span class="u-icon__icon uicon-question-circle" style="font-size: 16px; line-height: 16px; font-weight: normal; top: 0px; color: rgb(96, 98, 102);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="label-right"></div>
                </div>
                <div class="form-item-input flexs theme-border-color input-border margin-input">
                    <div class="flexs f-1 theme-border-color2">
                        <div class="input f-1">
                            <div class="uni-input-wrapper">
                                <input placeholder="输入投入金额" maxlength="140" step="0.01" min="0.01" enterkeyhint="done" autocomplete="off" type="number" class="uni-input-input" id="margin-input" onchange="formatMarginValue(this)">
                            </div>
                        </div>
                    </div>
                    <div class="input-right">
                        <div class="margin-value-container">
                            <span style="font-weight: 500; color: #1a6aff;">USDT</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 策略参数设置 -->
            <div class="settings-card box hover-glow">
                <div class="settings-title">参数设置 <small style="font-size: 12px; color: #999; font-weight: normal; margin-left: 5px;">专业版</small></div>
                <div class="settings-row">
                    <div class="setting-label">网格数量</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.grid_count }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">价格区间</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.price_range }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-label">风险等级</div>
                    <div class="setting-value">
                        <span style="font-weight: 500; color: #262626; margin-right: 5px;">{{ strategy.risk_level }}</span>
                        <i class="fas fa-chevron-right arrow-right"></i>
                    </div>
                </div>

                <!-- 添加仓位比例控制 -->
                <div class="settings-row">
                    <div class="setting-label">仓位比例控制</div>
                    <div class="setting-value">
                        <span id="position-value-percent" style="font-weight: 600; color: #1a6aff;">100%</span>
                    </div>
                </div>
                <div class="settings-row position-slider-container">
                    <div class="gress-box">
                        <div class="sunny-sliderBar" style="width: 100%; --sliderBarbgc:#f0f0f0; --primaryColor:#1a6aff;">
                            <div class="sliderBar" style="width: 100%;">
                                <div class="img-box">
                                    <div class="move-img" style="left: 0%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">0</span>
            </div>
                                    <div class="move-img" style="left: 25%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">25</span>
                </div>
                                    <div class="move-img" style="left: 50%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">50</span>
                    </div>
                                    <div class="move-img" style="left: 75%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">75</span>
                        </div>
                                    <div class="move-img" style="left: 100%;">
                                        <div class="dot-indicator"></div>
                                        <span class="bili-text">100</span>
                        </div>
                    </div>
                                <div class="gone" style="width: 100%;"></div>
                                <div class="slider" id="position-slider-percent" style="transform: translateY(-50%) translateX(100%);">
                                    <span class="count">100%</span>
                </div>
                            </div>
                        </div>
                        </div>
                    </div>



                <div class="settings-row">
                    <div class="setting-label">续下单</div>
                    <div class="setting-value">
                        <button id="continue-order-btn" class="confirm-btn hover-glow" style="background: linear-gradient(135deg, #1a6aff, #3f87ff); padding: 8px 16px; border-radius: 8px; color: white; border: none; font-size: 14px; font-weight: 500; box-shadow: 0 4px 10px rgba(26, 106, 255, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试用)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加策略控制按钮区域 -->
    <div class="strategy-controls" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;">
        <button class="confirm-btn hover-glow" id="run-strategy-btn" style="background-color: #52c41a; flex: 2;">运行</button>
        <button class="confirm-btn hover-glow" id="stop-strategy-btn" style="background-color: #ff4d4f; display: none; flex: 1;">强制停止</button>
    </div>
    <div id="strategy-status" style="margin-top: 10px; text-align: center; font-size: 14px; color: #8c8c8c;"></div>
    
    <!-- 添加自动刷新状态显示区域 -->
    <div id="auto-refresh-status" style="display: flex; align-items: center; justify-content: center; margin-top: 10px; font-size: 12px; color: #8c8c8c;">
        <div id="refresh-indicator" style="width: 8px; height: 8px; background-color: #52c41a; border-radius: 50%; margin-right: 5px;"></div>
        <span>自动刷新已开启 (10秒/次)</span>
    </div>
    <div id="last-refresh-time" style="text-align: center; font-size: 12px; color: #8c8c8c; margin-top: 5px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面
            initSettingsPage();
            
            // 添加页面加载动画
            document.body.classList.add('page-loaded');
            
            // 初始化币种选择功能
            initCryptoSelector();
            
            // 创建一个隐藏的保存按钮，保持功能但不显示
            const hiddenSaveBtn = document.createElement('button');
            hiddenSaveBtn.id = 'save-strategy-btn';
            hiddenSaveBtn.style.display = 'none';
            document.querySelector('.strategy-controls').appendChild(hiddenSaveBtn);
            
            // 为保存按钮添加点击事件
            document.getElementById('save-strategy-btn').addEventListener('click', function() {
                // 仅保存策略，不运行
                saveStrategy(false);
            });
            
            // 初始化策略状态指示器的动画
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes blink {
                    0% { opacity: 0.3; }
                    50% { opacity: 1; }
                    100% { opacity: 0.3; }
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // 检查是否有保存的运行状态
            const isSystemRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            console.log(`页面加载时检查到系统运行状态: ${isSystemRunning ? '运行中' : '已停止'}`);
            
            // 如果系统之前是运行状态，自动启动交易系统循环
            if (isSystemRunning) {
                const runBtn = document.getElementById('run-strategy-btn');
                if (runBtn) {
                    runBtn.setAttribute('data-running', 'true');
                    runBtn.textContent = '停止';
                    runBtn.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    console.log('恢复之前的交易系统运行状态');
                }
            }
            
            // 立即检查持仓状态，优先处理buy_flag
            checkInitialPositionStatus();
            
            // 检查交易对JSON文件状态
            checkTradingPairsStatus();
            
            // 获取刷新指示灯元素
            const refreshIndicator = document.getElementById('refresh-indicator');
            // 添加自动刷新定时器 - 即使没有点击运行按钮也会自动刷新
            const autoRefreshInterval = setInterval(function() {
                console.log("自动刷新检查持仓状态...");
                
                // 每次刷新前，更新指示灯颜色为黄色，表示正在刷新
                if (refreshIndicator) {
                    refreshIndicator.style.backgroundColor = '#faad14';
                }
                
                // 检查状态，传入false参数表示只检查状态，不触发下单
                // 这里调用时，确保checkPositionStatus不会因为网络或其他原因意外重置系统状态
                const currentIsRunning = localStorage.getItem('tradingSystemRunning');
                checkPositionStatus(false);  // 只检查状态，不触发下单
                
                // 确保刷新后系统状态一致
                setTimeout(function() {
                    // 确保状态没有被意外改变
                    if (localStorage.getItem('tradingSystemRunning') !== currentIsRunning && currentIsRunning !== null) {
                        console.log('检测到系统状态被意外更改，正在恢复...');
                        localStorage.setItem('tradingSystemRunning', currentIsRunning);
                        // 强制更新UI
                        updateButtonStatus(chichang, currentIsRunning === 'true');
                    }
                    
                    // 刷新完成后，延迟将颜色改回绿色
                    if (refreshIndicator) {
                        refreshIndicator.style.backgroundColor = '#52c41a';
                    }
                }, 1000);
            }, 10000); // 每10秒自动刷新一次
            
            // 将自动刷新定时器保存到window对象，以便可以在需要时停止
            window.autoRefreshInterval = autoRefreshInterval;
            
            // 当页面关闭或刷新时，清除定时器
            window.addEventListener('beforeunload', function() {
                clearInterval(window.autoRefreshInterval);
            });
            
            // 初始化运行策略按钮
            document.getElementById('run-strategy-btn').addEventListener('click', function() {
                // 判断当前状态
                const isRunning = this.getAttribute('data-running') === 'true';
                
                if (isRunning) {
                    // 如果已经在运行，则停止循环
                    clearInterval(window.tradingSystemInterval);
                    this.setAttribute('data-running', 'false');
                    this.textContent = '运行';
                    this.style.backgroundColor = '#52c41a';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统已停止';
                        statusElement.style.color = '#8c8c8c';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    // 隐藏强制停止按钮
                    const stopBtn = document.getElementById('stop-strategy-btn');
                    if (stopBtn) {
                        stopBtn.style.display = 'none';
                    }
                    
                    showToast('交易系统循环已停止', 'info');
                } else {
                    // 如果未运行，启动循环
                    this.setAttribute('data-running', 'true');
                    this.textContent = '停止';
                    this.style.backgroundColor = '#ff4d4f';
                    
                    // 更新状态提示
                    const statusElement = document.getElementById('strategy-status');
                    if (statusElement) {
                        statusElement.textContent = '交易系统正在运行中...';
                        statusElement.style.color = '#52c41a';
                    }
                    
                    // 启动交易系统循环
                    startTradingSystemLoop();
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'true');
                    
                    // 如果有持仓，显示强制停止按钮
                    if (chichang) {
                        const stopBtn = document.getElementById('stop-strategy-btn');
                        if (stopBtn) {
                            stopBtn.style.display = 'inline-block';
                        }
                    }
                    
                    showToast('交易系统循环已启动', 'success');
                }
            });
            
            // 初始化停止策略按钮（强制停止）
            document.getElementById('stop-strategy-btn').addEventListener('click', function() {
                if (chichang) {
                    // 如果有持仓，提示用户需要平仓
                    showConfirmDialog(
                        '强制停止警告', 
                        '当前有持仓，强制停止可能导致持仓无法自动平仓。是否继续运行直到平仓完成？',
                        '继续运行',
                        '强制停止',
                        function() {
                            // 用户选择继续运行，不做任何操作
                            showToast('策略将继续运行直到平仓完成');
                        },
                        function() {
                            // 用户选择强制停止
                            clearInterval(strategyInterval);
                            strategyRunning = false;
                            
                            // 强制修改运行状态按钮
                            const runBtn = document.getElementById('run-strategy-btn');
                            if (runBtn) {
                                runBtn.setAttribute('data-running', 'false');
                                runBtn.textContent = '运行';
                                runBtn.style.backgroundColor = '#52c41a';
                            }
                            
                            // 保存运行状态到localStorage
                            localStorage.setItem('tradingSystemRunning', 'false');
                            
                            updateButtonStatus(chichang, false);
                            
                            const statusElement = document.getElementById('strategy-status');
                            statusElement.textContent = '策略已强制停止，但仍有未平仓的持仓';
                            statusElement.style.color = '#ff4d4f';
                            
                            // 隐藏强制停止按钮
                            this.style.display = 'none';
                            
                            showToast('策略已强制停止，请注意未平仓的持仓状态', 'warning');
                        }
                    );
                } else {
                    // 没有持仓，直接停止
                    clearInterval(strategyInterval);
                    strategyRunning = false;
                    
                    // 强制修改运行状态按钮
                    const runBtn = document.getElementById('run-strategy-btn');
                    if (runBtn) {
                        runBtn.setAttribute('data-running', 'false');
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                    
                    // 保存运行状态到localStorage
                    localStorage.setItem('tradingSystemRunning', 'false');
                    
                    updateButtonStatus(chichang, false);
                    
                    const statusElement = document.getElementById('strategy-status');
                    statusElement.textContent = '策略已强制停止';
                    statusElement.style.color = '#8c8c8c';
                    
                    // 隐藏强制停止按钮
                    this.style.display = 'none';
                    
                    showToast('策略已强制停止');
                }
            });
            
            // 为续下单按钮添加点击事件
            document.getElementById('continue-order-btn').addEventListener('click', function() {
                // 显示加载动画
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';
                this.disabled = true;
                
                // 显示测试提示
                showToast('这是测试功能，仅用于验证系统连接', 'info');
                
                // 调用测试功能而不是实际下单
                testOrderSystem();
                
                // 3秒后恢复按钮状态
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt" style="margin-right: 5px;"></i> 续下单(测试)';
                    this.disabled = false;
                }, 3000);
            });


        });
        
        // 页面加载时检查持仓状态并更新按钮
        function checkPositionStatusOnLoad() {
            // 获取当前URL中的策略ID和交易对
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 获取交易对（根据策略ID设置不同的默认交易对）
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多
            
            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 显示加载状态
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = '正在检查持仓状态...';
            
            // 向后端发送请求获取持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // 检查当前方向是否有持仓
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // 初始化全局变量chichang（根据持仓状态）
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 初始化运行按钮状态
                    updateButtonStatus(chichang, strategyRunning);
                    
                    // 根据当前交易方向和持仓状态更新按钮
                    if ((tradeDirection === 'buy' && hasBuyPosition) || 
                        (tradeDirection === 'sell' && hasSellPosition)) {
                        // 已有相同方向持仓
                        saveBtn.textContent = '已持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = `当前有${hasBuyPosition ? '多头' : ''}${hasSellPosition ? '空头' : ''}持仓`;
                        statusElement.style.color = '#faad14'; // 黄色警告
                    } else if ((!hasBuyPosition && !hasSellPosition) && data.hasOrder) {
                        // 没有持仓但有订单，显示为"已下单"
                        saveBtn.textContent = '已下单，执行中';
                        saveBtn.classList.add('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '订单正在处理中，请稍候...';
                        statusElement.style.color = '#1a6aff'; // 蓝色信息
                    } else {
                        // 无持仓无订单
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        
                        // 更新状态提示
                        statusElement.textContent = '系统准备就绪，点击"运行"开始策略';
                        statusElement.style.color = '#52c41a'; // 绿色正常
                    }
                    
                    // 添加状态摘要显示 - 如果后端提供了状态摘要
                    if (data.statusSummary) {
                        // 在状态元素的下方添加后端状态摘要
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `后端状态: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // 如果已有之前的状态摘要，先移除
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                }
            })
            .catch(error => {
                console.error('获取持仓状态失败:', error);
                statusElement.textContent = '网络错误，无法检查持仓状态';
                statusElement.style.color = '#ff4d4f'; // 红色错误
            });
        }
        
        // 保存策略设置函数
        function saveStrategy(shouldManuallyOrder = true) {
            // 获取当前URL中的策略ID
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 检查是否允许下单 - 只有当shouldManuallyOrder为true或者strategyRunning为true时才允许下单
            const shouldProceed = shouldManuallyOrder || strategyRunning;
            
            // 如果不允许下单，则记录日志并直接返回
            if (!shouldProceed) {
                console.log("自动检查状态，跳过下单操作");
                return;
            }
            
            // 获取保证金输入值并格式化
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 先格式化输入框的值
            formatMarginValue(marginInput);
            // 再获取格式化后的值
            const marginValue = marginInput.value || '0';
            
            // 检查保证金是否为有效值
            if (parseFloat(marginValue) <= 0) {
                showToast('请输入有效的保证金金额');
                return;
            }
            
            // 获取选中的交易方向
            const directionElements = document.querySelectorAll('.type-box .type-li');
            let tradeDirection = 'buy'; // 默认做多

            directionElements.forEach(function(el) {
                if (el.classList.contains('type-active')) {
                    tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                }
            });
            
            // 获取交易对
            const tradePair = '{{ strategy.trade_pair|default("BTC-USDT") }}';
            
            // 在按钮上显示加载状态
            const saveBtn = document.getElementById('save-strategy-btn');
            const originalBtnText = saveBtn.textContent;
            saveBtn.textContent = '处理中...';
            saveBtn.disabled = true;
            
            // 发送AJAX请求
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                }),
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                if (data.code === 200) {
                    // 检查持仓状态，只有在有订单结果且没有已存在的相同方向的持仓时才显示"已下单"
                    if (data.orderResult) {
                        // 获取当前交易方向
                        const dirElements = document.querySelectorAll('.type-box .type-li');
                        let currentDirection = 'buy'; // 默认方向
                        dirElements.forEach(function(el) {
                            if (el.classList.contains('type-active')) {
                                currentDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                            }
                        });
                        
                        // 检查是否已经有相同方向的持仓
                        const hasSameDirectionPosition = 
                            (currentDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                            (currentDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                        
                        if (hasSameDirectionPosition) {
                            // 已有相同方向持仓，显示为"已持仓中"
                            saveBtn.textContent = '已持仓中';
                            saveBtn.classList.add('position-active');
                        } else {
                            // 无相同方向持仓，显示为"已下单，执行中"
                            saveBtn.textContent = '已下单，执行中';
                            saveBtn.classList.add('order-success');
                        }
                        
                        showToast(`策略保存成功! 合约张数: ${data.contractSize}`);
                        showOrderResultModal(data.orderResult, tradePair);
                    } else {
                        // 没有下单，仅保存设置
                        saveBtn.textContent = '保存设置';
                        saveBtn.classList.remove('order-success');
                        saveBtn.classList.remove('position-active');
                        showToast('设置已成功保存');
                    }
                } else if (data.code === 503 || data.code === 504) {
                    // 网络错误处理
                    showNetworkErrorModal(data.message);
                } else {
                    // 处理错误，保持原有按钮文本
                    saveBtn.textContent = originalBtnText;
                    saveBtn.classList.remove('order-success');
                    saveBtn.classList.remove('position-active');
                    showNetworkErrorModal(data.message || '保存策略出错，请稍后再试');
                }
            })
            .catch(error => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                
                // 显示错误提示
                console.error('请求错误:', error);
                showNetworkErrorModal('网络请求失败，请检查网络连接');
            });
        }
        
        function initSettingsPage() {
            console.log('策略设置页面初始化');
            
            // 调整页面标题策略名称显示
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            let strategyName = '智能网格策略'; // 默认
            
            // 根据ID设置不同的策略名称
            if (strategyId === '1') {
                strategyName = '智能网格策略';
            } else if (strategyId === '2') {
                strategyName = '趋势跟踪策略';
            } else if (strategyId === '3') {
                strategyName = 'AI智能预测策略';
            } else if (strategyId === '4') {
                strategyName = '蓝龙综合策略';
            } else if (strategyId === '5') {
                strategyName = '蓝龙出海';
            } else if (strategyId === '6') {
                strategyName = '网格量化';
            }
            
            // 更新页面标题
            const titleElement = document.querySelector('.u-navbar__content__title');
            titleElement.textContent = strategyName;
            
            // 标题动画效果
            setTimeout(() => {
                document.querySelector('.u-navbar').style.transform = 'translateY(0)';
            }, 100);
            
            // 为交易方向选择器添加点击事件
            const directionButtons = document.querySelectorAll('.type-box .type-li');
            directionButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    // 移除所有按钮的活动状态
                    directionButtons.forEach(btn => btn.classList.remove('type-active'));
                    // 添加当前按钮的活动状态
                    this.classList.add('type-active');
                    
                    // 显示反馈
                    const direction = this.textContent.trim();
                    showToast(`已选择${direction}方向`);
                    
                    // 更新按钮状态
                    checkPositionStatusOnLoad();
                });
            });
            
            // 设置状态开关点击事件 - 检查元素是否存在
            const statusToggle = document.querySelector('.toggle-wrapper');
            if (statusToggle) {
                statusToggle.addEventListener('click', function() {
                    this.classList.toggle('active-lis');
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (this.classList.contains('active-lis')) {
                        indicator.style.transform = 'translateX(28px)';
                        showToast('策略已启动');
                    } else {
                        indicator.style.transform = 'translateX(0px)';
                        showToast('策略已暂停');
                    }
                });
            }
            
            // 设置预设策略点击事件
            const strategyTypes = document.querySelectorAll('.scroll-li-types');
            strategyTypes.forEach(type => {
                type.addEventListener('click', function() {
                    // 先移除所有active类
                    strategyTypes.forEach(t => {
                        t.classList.remove('type-actives');
                        // 添加淡出效果
                        t.style.opacity = '0.7';
                    });
                    
                    // 给当前点击元素添加active类
                    this.classList.add('type-actives');
                    this.style.opacity = '1';
                    
                    // 显示选择了什么策略
                    const strategyType = this.querySelector('.li-type-center').textContent;
                    showToast(`已选择${strategyType}策略`);
                    
                    // 恢复其他元素的透明度
                    setTimeout(() => {
                        strategyTypes.forEach(t => {
                            t.style.opacity = '1';
                        });
                    }, 300);
                });
            });
            
            // 添加做多做空按钮点击事件
            const typeLiButtons = document.querySelectorAll('.type-box .type-li');
            typeLiButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    typeLiButtons.forEach(btn => {
                        btn.classList.remove('type-active');
                    });
                    
                    // 给当前点击按钮添加active类
                    this.classList.add('type-active');
                    
                    // 显示消息
                    showToast(`已选择${this.textContent}策略`);
                });
            });
            
            // 添加杠杆调整点击事件
            const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
            const leverageContainer = leverageInput.closest('.form-item-input');
            leverageContainer.addEventListener('click', function() {
                // 模拟杠杆倍数选择弹窗
                const leverageOptions = [1, 2, 3, 5, 10, 20, 50, 100];
                let selectedLeverage = 10; // 默认选择
                
                // 创建杠杆选择对话框
                const createLeverageDialog = () => {
                    // 如果页面上已有对话框，先移除
                    const existingDialog = document.querySelector('.leverage-dialog');
                    if (existingDialog) {
                        existingDialog.remove();
                    }
                    
                    // 创建对话框容器
                    const dialog = document.createElement('div');
                    dialog.className = 'leverage-dialog';
                    dialog.style.position = 'fixed';
                    dialog.style.top = '50%';
                    dialog.style.left = '50%';
                    dialog.style.transform = 'translate(-50%, -50%)';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '320px';
                    dialog.style.backgroundColor = '#fff';
                    dialog.style.borderRadius = '12px';
                    dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
                    dialog.style.zIndex = '9999';
                    dialog.style.overflow = 'hidden';
                    
                    // 创建对话框标题
                    const dialogTitle = document.createElement('div');
                    dialogTitle.textContent = '选择杠杆倍数';
                    dialogTitle.style.padding = '16px';
                    dialogTitle.style.borderBottom = '1px solid #f0f0f0';
                    dialogTitle.style.fontSize = '16px';
                    dialogTitle.style.fontWeight = '600';
                    dialogTitle.style.textAlign = 'center';
                    dialogTitle.style.color = '#262626';
                    dialog.appendChild(dialogTitle);
                    
                    // 创建选项容器
                    const optionsContainer = document.createElement('div');
                    optionsContainer.style.padding = '10px 0';
                    optionsContainer.style.maxHeight = '300px';
                    optionsContainer.style.overflowY = 'auto';
                    dialog.appendChild(optionsContainer);
                    
                    // 添加杠杆选项
                    leverageOptions.forEach(leverage => {
                        const option = document.createElement('div');
                        option.className = 'leverage-option';
                        option.textContent = `${leverage}X`;
                        option.style.padding = '12px 16px';
                        option.style.transition = 'all 0.2s ease';
                        option.style.cursor = 'pointer';
                        option.style.fontSize = '15px';
                        
                        // 高亮当前选中的选项
                        if (leverage === selectedLeverage) {
                            option.style.color = '#1a6aff';
                            option.style.fontWeight = '600';
                            option.style.backgroundColor = '#f0f7ff';
                        }
                        
                        option.addEventListener('mouseenter', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = '#f9fafc';
                            }
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            if (leverage !== selectedLeverage) {
                                this.style.backgroundColor = 'transparent';
                            }
                        });
                        
                        option.addEventListener('click', function() {
                            selectedLeverage = leverage;
                            leverageInput.value = `${leverage}X`;
                            
                            // 更新页面上的保证金值
                            updateMarginFromLeverage(leverage);
                            
                            dialog.remove();
                            
                            // 显示杠杆设置消息
                            showToast(`已设置杠杆倍数: ${leverage}X`);
                            
                            // 添加点击动画效果
                            leverageContainer.classList.add('row-clicked');
                            setTimeout(() => {
                                leverageContainer.classList.remove('row-clicked');
                            }, 300);
                        });
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // 创建取消按钮
                    const cancelButton = document.createElement('div');
                    cancelButton.textContent = '取消';
                    cancelButton.style.padding = '14px';
                    cancelButton.style.borderTop = '1px solid #f0f0f0';
                    cancelButton.style.textAlign = 'center';
                    cancelButton.style.color = '#8c8c8c';
                    cancelButton.style.fontSize = '15px';
                    cancelButton.style.cursor = 'pointer';
                    cancelButton.style.transition = 'all 0.2s ease';
                    
                    cancelButton.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f9fafc';
                    });
                    
                    cancelButton.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    cancelButton.addEventListener('click', function() {
                        dialog.remove();
                    });
                    
                    dialog.appendChild(cancelButton);
                    
                    // 创建遮罩层
                    const overlay = document.createElement('div');
                    overlay.className = 'leverage-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.right = '0';
                    overlay.style.bottom = '0';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '9998';
                    
                    overlay.addEventListener('click', function() {
                        dialog.remove();
                        overlay.remove();
                    });
                    
                    // 将对话框和遮罩添加到页面
                    document.body.appendChild(overlay);
                    document.body.appendChild(dialog);
                    
                    // 添加动画
                    dialog.style.opacity = '0';
                    dialog.style.transform = 'translate(-50%, -60%)';
                    dialog.style.transition = 'all 0.3s ease';
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        dialog.style.opacity = '1';
                        dialog.style.transform = 'translate(-50%, -50%)';
                        overlay.style.opacity = '1';
                    }, 10);
                };
                
                // 显示杠杆选择对话框
                createLeverageDialog();
            });
            
            // 设置币种选择点击事件
            document.querySelector('.robot-info').parentElement.addEventListener('click', function() {
                showToast('币种选择功能正在开发中...');
            });
            
            // 设置设置项点击事件
            const settingItems = document.querySelectorAll('.setting-value .arrow-right');
            settingItems.forEach(item => {
                item.parentElement.parentElement.addEventListener('click', function() {
                    const settingName = this.querySelector('.setting-label').textContent;
                    showToast(`${settingName}设置页面正在开发中...`);
                    
                    // 添加点击动画效果
                    this.classList.add('row-clicked');
                    setTimeout(() => {
                        this.classList.remove('row-clicked');
                    }, 300);
                });
            });
            
            // 设置保存按钮事件
            const saveButton = document.querySelector('.confirm-btn');
            saveButton.addEventListener('click', function() {
                // 添加按钮动画
                this.classList.add('btn-clicked');
                
                // 获取保证金值和交易对信息
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                const marginValue = marginInput.value;
                
                // 获取URL中的策略ID
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('id') || '1';
                
                // 从隐藏字段获取用户选择的交易对
                const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
                
                // 获取交易方向（做多/做空）
                const dirElements = document.querySelectorAll('.type-box .type-li');
                let tradeDirection = 'buy'; // 默认做多
                dirElements.forEach(function(el) {
                    if (el.classList.contains('type-active')) {
                        tradeDirection = el.textContent.trim() === '做多' ? 'buy' : 'sell';
                    }
                });
                
                // 发送AJAX请求到后端
                fetch('/api/strategy/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategyId: strategyId,
                        marginValue: marginValue,
                        tradePair: tradePair,
                        tradeDirection: tradeDirection
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 仅保存设置成功的默认消息
                        showToast('设置已成功保存');
                        
                        // 显示后端返回的合约张数
                        if (data.contractSize) {
                            showToast(`相当于 ${data.contractSize} 张合约`);
                        }
                        
                        // 显示订单结果（如果有）
                        if (data.orderResult) {
                            // 创建订单结果弹窗
                            showOrderResultModal(data.orderResult, tradePair);
                            
                            // 检查是否已经有相同方向的持仓
                            const hasSameDirectionPosition = 
                                (tradeDirection === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                                (tradeDirection === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                            
                            if (hasSameDirectionPosition) {
                                // 已有相同方向持仓，显示为"已持仓中"
                                this.textContent = '已持仓中';
                                this.classList.add('position-active');
                            } else {
                                // 无相同方向持仓，显示为"已下单，执行中"
                                this.textContent = '已下单，执行中';
                                this.classList.add('order-success');
                            }
                        } else {
                            // 无订单，保持"保存设置"状态
                            this.textContent = '保存设置';
                            this.classList.remove('order-success');
                            this.classList.remove('position-active');
                        }
                    } else if (data.code === 503 || data.code === 504) {
                        // 网络错误处理
                        showNetworkErrorModal(data.message);
                    } else {
                        showToast('保存失败: ' + data.message);
                    }
                    this.classList.remove('btn-clicked');
                })
                .catch(error => {
                    console.error('Error:', error);
                    // 网络错误或服务器问题
                    showNetworkErrorModal('无法连接到服务器，请检查您的网络连接后重试');
                    this.classList.remove('btn-clicked');
                });
            });
            
            // 初始化仓位滑动条
            initPositionSlider();
            
            // 初始化百分比控制滑动条
            initPositionPercentSlider();
            
            // 添加页面内各元素的入场动画
            animateElements();
            
            // 投入金额获得焦点时添加高亮效果
            const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
            marginInput.addEventListener('focus', function() {
                // // document.getElementById('margin-input-container').classList.add('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            marginInput.addEventListener('blur', function() {
                // // document.getElementById('margin-input-container').classList.remove('margin-highlight'); // 已禁用动画 // 已禁用动画
            });
            
            // 根据杠杆倍数更新保证金金额
            function updateMarginFromLeverage(leverage) {
                // 获取当前百分比值
                const percentElement = document.getElementById('position-value-percent');
                const percent = parseInt(percentElement.textContent);
                
                // 计算保证金金额（示例计算公式）
                const baseAmount = 1000;  // 基础金额
                const calculatedMargin = (baseAmount / leverage) * (percent / 100);
                
                // 更新保证金输入框，使用平滑动画
                const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                // 使用toFixed保留两位小数，避免浮点数问题并应用平滑过渡
                const formattedValue = parseFloat(calculatedMargin.toFixed(2));
                // 检查值是否有明显变化
                if (marginInput.value !== formattedValue.toString()) {
                    // 存储上一次的值，用于动画判断
                    const prevValue = parseFloat(marginInput.value || '0');
                    // 如果变化大于一定值，应用过渡动画
                    if (Math.abs(prevValue - formattedValue) > 10) {
                        marginInput.classList.add('value-changing');
                        setTimeout(() => {
                            marginInput.classList.remove('value-changing');
                        }, 300);
                    }
                    // 设置新值
                    marginInput.value = formattedValue;
                }
                
                // 显示保证金更新提示
                showToast(`保证金已更新: ${calculatedMargin.toFixed(2)} USDT`);
            }
        }
        
        // 显示消息提示
        function showToast(message) {
            // 如果已有toast，先移除
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 创建新的toast元素
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 自动隐藏toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // 格式化保证金值，确保正确的数值格式
        function formatMarginValue(input) {
            // 获取输入值并解析为数值
            let value = parseFloat(input.value);
            
            // 检查是否为有效数字
            if (isNaN(value)) {
                input.value = '0.01';
                showToast('无效的金额，已设为最小值');
                return;
            }
            
            // 确保最小值为0.01
            if (value < 0.01) {
                value = 0.01;
                showToast('金额不能小于0.01 USDT');
            }
            
            // 将值格式化为最多两位小数
            const formattedValue = parseFloat(value.toFixed(2));
            
            // 如果格式化前后的值不同，更新输入框值
            if (parseFloat(input.value) !== formattedValue) {
                input.value = formattedValue;
                console.log(`保证金值已格式化: ${formattedValue} USDT`);
            }
            
            return formattedValue;
        }
        
        // 显示订单结果模态窗口
        function showOrderResultModal(orderResult, tradePair) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '450px';
            
            // 添加标题和成功图标
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.justifyContent = 'center';
            titleContainer.style.marginBottom = '15px';
            
            const successIcon = document.createElement('div');
            successIcon.innerHTML = '<svg viewBox="0 0 24 24" width="32" height="32"><path fill="#52c41a" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.177-7.86l-2.765-2.767L7 12.431l3.119 3.121a1 1 0 001.414 0l5.952-5.95-1.062-1.062-5.6 5.6z"/></svg>';
            successIcon.style.marginRight = '10px';
            
            const title = document.createElement('h3');
            title.textContent = '下单成功';
            title.className = 'modal-title';
            title.style.margin = '0';
            
            titleContainer.appendChild(successIcon);
            titleContainer.appendChild(title);
            modalContent.appendChild(titleContainer);
            
            // 添加交易对信息
            const pairInfo = document.createElement('div');
            pairInfo.style.background = 'linear-gradient(135deg, #f0f7ff, #e6f7ff)';
            pairInfo.style.padding = '12px 15px';
            pairInfo.style.borderRadius = '8px';
            pairInfo.style.marginBottom = '15px';
            pairInfo.style.display = 'flex';
            pairInfo.style.alignItems = 'center';
            pairInfo.style.justifyContent = 'space-between';
            
            const pairLabel = document.createElement('span');
            pairLabel.textContent = '交易对:';
            pairLabel.style.color = '#333';
            pairLabel.style.fontWeight = '500';
            
            const pairValue = document.createElement('span');
            pairValue.textContent = tradePair;
            pairValue.style.color = '#1a6aff';
            pairValue.style.fontWeight = '600';
            pairValue.style.fontSize = '16px';
            
            pairInfo.appendChild(pairLabel);
            pairInfo.appendChild(pairValue);
            modalContent.appendChild(pairInfo);
            
            // 添加订单详情
            const orderDetails = document.createElement('div');
            orderDetails.className = 'order-details';
            orderDetails.style.background = '#f9fafc';
            orderDetails.style.border = '1px solid #f0f0f0';
            orderDetails.style.borderRadius = '8px';
            orderDetails.style.padding = '15px';
            
            // 定义要显示的字段和对应的中文名称
            const fieldLabels = {
                'orderId': '订单ID',
                'status': '状态',
                'exchangeId': '交易所',
                'direction': '方向',
                'contractSize': '合约数量',
                'margin': '保证金',
                'tradePair': '交易对',
                'price': '价格',
                'time': '时间'
            };
            
            // 按顺序显示字段
            const fieldsOrder = ['orderId', 'status', 'exchangeId', 'direction', 'contractSize', 'margin', 'price', 'time'];
            
            // 格式化并显示订单结果数据
            fieldsOrder.forEach(key => {
                if (orderResult[key]) {
                const detailRow = document.createElement('div');
                detailRow.className = 'detail-row';
                
                const detailLabel = document.createElement('span');
                    detailLabel.textContent = fieldLabels[key] || key;
                detailLabel.className = 'detail-label';
                
                const detailValue = document.createElement('span');
                    detailValue.textContent = orderResult[key];
                detailValue.className = 'detail-value';
                    
                    // 为特定字段添加样式
                    if (key === 'direction') {
                        detailValue.style.color = orderResult[key] === '做多' ? '#52c41a' : '#ff4d4f';
                        detailValue.style.fontWeight = '600';
                    } else if (key === 'status') {
                        detailValue.style.color = '#52c41a';
                        detailValue.style.fontWeight = '600';
                    }
                
                detailRow.appendChild(detailLabel);
                detailRow.appendChild(detailValue);
                orderDetails.appendChild(detailRow);
            }
            });
            
            modalContent.appendChild(orderDetails);
            
            // 添加操作说明
            const infoText = document.createElement('p');
            infoText.textContent = '您的订单已成功提交，可在交易所查看订单详情。';
            infoText.style.color = '#8c8c8c';
            infoText.style.fontSize = '14px';
            infoText.style.textAlign = 'center';
            infoText.style.margin = '15px 0';
            modalContent.appendChild(infoText);
            
            // 添加确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = '确定';
            confirmButton.className = 'modal-confirm-btn';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.width = '100%';
            confirmButton.style.height = '40px';
            confirmButton.style.borderRadius = '20px';
            confirmButton.style.marginTop = '10px';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmButton);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 显示网络错误模态窗口
        function showNetworkErrorModal(message) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'modal-container error-modal';
            
            // 创建模态框内容
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 添加标题
            const titleEl = document.createElement('h3');
            titleEl.textContent = '网络连接问题';
            titleEl.className = 'modal-title';
            modalContent.appendChild(titleEl);
            
            // 添加错误图标
            const iconEl = document.createElement('div');
            iconEl.className = 'error-icon';
            iconEl.innerHTML = '<svg viewBox="0 0 24 24" width="48" height="48"><path fill="#ff4d4f" d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1-7v2h2v-2h-2zm0-8v6h2V7h-2z"/></svg>';
            modalContent.appendChild(iconEl);
            
            // 添加错误信息
            const msgEl = document.createElement('p');
            msgEl.textContent = message;
            msgEl.className = 'modal-message';
            modalContent.appendChild(msgEl);
            
            // 添加确认按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '确定';
            confirmBtn.className = 'modal-confirm-btn';
            confirmBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(confirmBtn);
            modal.appendChild(modalContent);
            
            // 添加到body并显示
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 添加元素入场动画
        function animateElements() {
            const elements = document.querySelectorAll('.box, .box2, .forms-item');
            elements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('element-animated');
                }, 100 * index);
            });
        }
        
        // 初始化百分比控制滑动条
        function initPositionPercentSlider() {
            const slider = document.getElementById('position-slider-percent');
            const sliderBar = slider.parentElement;
            const positionValue = document.getElementById('position-value-percent');
            const progressBar = sliderBar.querySelector('.gone');
            
            // 获取保证金输入框
            const marginInput = document.querySelector('.forms-item .uni-input-input[placeholder="输入投入金额"]');
            // 设置初始保证金值（假设有一个最大值）
            const maxMargin = 1000; // 假设最大保证金为1000 USDT
            
            // 平滑设置初始值
            setTimeout(() => {
                const formattedValue = parseFloat(maxMargin.toFixed(2));
                marginInput.value = formattedValue;
            }, 300);
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 平滑更新保证金值函数
            function updateMarginValue(percent, leverage) {
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                // 格式化值，保留2位小数
                const formattedValue = parseFloat(marginValue.toFixed(2));
                
                // 简化后的逻辑，直接设置值，无动画
                if (marginInput.value !== formattedValue.toString()) {
                    marginInput.value = formattedValue;
                }
            }
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(percent, leverage);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40; // 减去滑块自身宽度，使滑块能够完全移动到边缘
                sliderLeft = rect.left + 20; // 加上滑块半径，使百分比计算更准确
                
                isDragging = true;
                
                // 添加激活样式
                slider.classList.add('slider-active');
                document.body.style.cursor = 'grabbing';
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除激活样式
                slider.classList.remove('slider-active');
                document.body.style.cursor = '';
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
                
                // 添加完成动画
                slider.classList.add('slider-done');
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                }, 500);
            }
            
            // 为固定点添加点击事件
            sliderBar.querySelectorAll('.move-img').forEach(dot => {
                dot.addEventListener('click', function() {
                    const percent = parseInt(this.style.left);
                    
                    // 获取滑动条的宽度
                    const rect = sliderBar.getBoundingClientRect();
                    sliderWidth = rect.width - 40;
                    sliderLeft = rect.left + 20;
                    
                    const newPosition = (sliderWidth * percent) / 100;
                    
                    // 设置CSS变量记录当前位置，用于动画
                    slider.style.setProperty('--x-pos', `${newPosition}px`);
                    
                    // 添加过渡动画
                    slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    
                    // 更新滑块位置，保持垂直居中
                    slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                    progressBar.style.width = `${percent}%`;
                    slider.querySelector('.count').textContent = `${percent}%`;
                    positionValue.textContent = `${percent}%`;
                    
                    // 计算并更新保证金值
                    const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                    let leverage = 10; // 默认杠杆
                    if (leverageInput.value) {
                        // 解析杠杆值（例如 "10X" -> 10）
                        leverage = parseInt(leverageInput.value);
                        if (isNaN(leverage)) leverage = 10;
                    }
                    
                    // 使用平滑更新函数更新保证金值
                    updateMarginValue(percent, leverage);
                    
                    // 根据百分比改变颜色
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        progressBar.classList.remove('progress-yellow', 'progress-blue');
                        slider.classList.remove('slider-yellow', 'slider-blue');
                        progressBar.classList.add('progress-red');
                        slider.classList.add('slider-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        progressBar.classList.remove('progress-red', 'progress-blue');
                        slider.classList.remove('slider-red', 'slider-blue');
                        progressBar.classList.add('progress-yellow');
                        slider.classList.add('slider-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        progressBar.classList.remove('progress-red', 'progress-yellow');
                        slider.classList.remove('slider-red', 'slider-yellow');
                        progressBar.classList.add('progress-blue');
                        slider.classList.add('slider-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加点击高亮动画
                    this.classList.add('dot-active');
                    setTimeout(() => {
                        this.classList.remove('dot-active');
                    }, 500);
                    
                    // 添加完成动画
                    setTimeout(() => {
                        slider.classList.remove('slider-done');
                        // 强制重绘
                        void slider.offsetWidth;
                        slider.classList.add('slider-done');
                    }, 300);
                    
                    // 移除过渡动画，以便拖动时不受影响
                    setTimeout(() => {
                        slider.style.transition = '';
                        progressBar.style.transition = '';
                    }, 500);
                });
            });
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                // 如果点击的是滑块本身或者固定点，不处理
                if (e.target === slider || e.target.closest('.move-img')) return;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width - 40;
                sliderLeft = rect.left + 20;
                
                const clickX = e.clientX - sliderLeft + 20; // 调整点击位置
                const percent = Math.round((clickX / sliderWidth) * 100);
                const adjustedPercent = Math.max(0, Math.min(percent, 100)); // 确保百分比在0-100之间
                
                // 设置CSS变量记录当前位置，用于动画
                const newPosition = (sliderWidth * adjustedPercent) / 100;
                slider.style.setProperty('--x-pos', `${newPosition}px`);
                
                // 添加过渡动画
                slider.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                progressBar.style.transition = 'width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newPosition}px)`;
                progressBar.style.width = `${adjustedPercent}%`;
                slider.querySelector('.count').textContent = `${adjustedPercent}%`;
                positionValue.textContent = `${adjustedPercent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 使用平滑更新函数更新保证金值
                updateMarginValue(adjustedPercent, leverage);
                
                // 根据百分比改变颜色
                if (adjustedPercent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (adjustedPercent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
                
                // 添加完成动画
                setTimeout(() => {
                    slider.classList.remove('slider-done');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-done');
                }, 300);
                
                // 移除过渡动画，以便拖动时不受影响
                setTimeout(() => {
                    slider.style.transition = '';
                    progressBar.style.transition = '';
                }, 500);
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
            
            // 初始化时设置滑块的颜色
            setTimeout(() => {
                // 获取初始百分比
                const percent = parseInt(positionValue.textContent);
                
                if (percent < 30) {
                    positionValue.style.color = '#ff4d4f';
                    progressBar.classList.remove('progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-yellow', 'slider-blue');
                    progressBar.classList.add('progress-red');
                    slider.classList.add('slider-red');
                    slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                } else if (percent < 70) {
                    positionValue.style.color = '#faad14';
                    progressBar.classList.remove('progress-red', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-blue');
                    progressBar.classList.add('progress-yellow');
                    slider.classList.add('slider-yellow');
                    slider.querySelector('.count').style.backgroundColor = '#faad14';
                } else {
                    positionValue.style.color = '#1a6aff';
                    progressBar.classList.remove('progress-red', 'progress-yellow');
                    slider.classList.remove('slider-red', 'slider-yellow');
                    progressBar.classList.add('progress-blue');
                    slider.classList.add('slider-blue');
                    slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                }
            }, 500);
        }
        
        // 初始化仓位滑动条
        function initPositionSlider() {
            const slider = document.getElementById('position-slider');
            if (!slider) return; // 防止错误
            
            const progressBar = document.getElementById('progress-bar');
            const positionValue = document.getElementById('position-value');
            const sliderBar = document.querySelector('.sliderBar');
            
            let isDragging = false;
            let startX, sliderWidth, sliderLeft;
            
            // 更新滑块位置和值
            function updateSlider(clientX) {
                // 计算滑块在轨道上的位置百分比
                let newLeft = clientX - sliderLeft;
                newLeft = Math.max(0, Math.min(newLeft, sliderWidth));
                
                const percent = Math.round((newLeft / sliderWidth) * 100);
                
                // 设置CSS变量记录当前位置，用于动画
                slider.style.setProperty('--x-pos', `${newLeft}px`);
                
                // 更新滑块位置，保持垂直居中
                slider.style.transform = `translateY(-50%) translateX(${newLeft}px)`;
                
                // 更新进度条
                progressBar.style.width = `${percent}%`;
                
                // 更新值显示
                slider.querySelector('.count').textContent = `${percent}%`;
                positionValue.textContent = `${percent}%`;
                
                // 计算并更新保证金值
                const leverageInput = document.querySelector('.forms-item .uni-input-input[placeholder="选择杠杆倍数"]');
                let leverage = 10; // 默认杠杆
                if (leverageInput.value) {
                    // 解析杠杆值（例如 "10X" -> 10）
                    leverage = parseInt(leverageInput.value);
                    if (isNaN(leverage)) leverage = 10;
                }
                
                // 计算保证金
                const marginValue = (percent / 100) * (maxMargin / leverage);
                marginInput.value = marginValue.toFixed(2);
                
                // 添加滑块动画效果
                const handleSliderAnimation = (percent) => {
                    // 移除所有颜色类
                    progressBar.classList.remove('progress-red', 'progress-yellow', 'progress-blue');
                    slider.classList.remove('slider-red', 'slider-yellow', 'slider-blue');
                    
                    // 根据百分比应用相应的颜色类
                    if (percent < 30) {
                        positionValue.style.color = '#ff4d4f';
                        slider.classList.add('slider-red');
                        progressBar.classList.add('progress-red');
                        slider.querySelector('.count').style.backgroundColor = '#ff4d4f';
                    } else if (percent < 70) {
                        positionValue.style.color = '#faad14';
                        slider.classList.add('slider-yellow');
                        progressBar.classList.add('progress-yellow');
                        slider.querySelector('.count').style.backgroundColor = '#faad14';
                    } else {
                        positionValue.style.color = '#1a6aff';
                        slider.classList.add('slider-blue');
                        progressBar.classList.add('progress-blue');
                        slider.querySelector('.count').style.backgroundColor = '#1a6aff';
                    }
                    
                    // 添加缩放动画效果
                    if (isDragging) {
                        // 拖动时不添加脉冲动画
                        return;
                    }
                    
                    slider.classList.remove('slider-pulse');
                    // 强制重绘
                    void slider.offsetWidth;
                    slider.classList.add('slider-pulse');
                };
                
                handleSliderAnimation(percent);
                return percent;
            }
            
            // 鼠标/触摸事件处理
            function onStart(e) {
                e.preventDefault();
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                
                // 获取滑动条的宽度和位置
                const rect = sliderBar.getBoundingClientRect();
                sliderWidth = rect.width;
                sliderLeft = rect.left;
                
                isDragging = true;
                
                // 更新初始位置
                updateSlider(clientX);
                
                // 添加移动和结束事件监听
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                updateSlider(clientX);
            }
            
            function onEnd() {
                isDragging = false;
                
                // 移除事件监听
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            }
            
            // 为固定点添加点击事件
            const dotElements = document.querySelectorAll('.move-img');
            if (dotElements.length > 0) {
                dotElements.forEach(dot => {
                    dot.addEventListener('click', function() {
                        if (this.style.left) {
                            const percent = parseInt(this.style.left);
                            slider.style.left = `${percent}%`;
                            
                            if (progressBar) {
                                progressBar.style.width = `${percent}%`;
                            }
                            
                            const countElement = slider.querySelector('.count');
                            if (countElement) {
                                countElement.textContent = `${percent}%`;
                            }
                            
                            if (positionValue) {
                                positionValue.textContent = `${percent}%`;
                            }
                        }
                    });
                });
            }
            
            // 为滑动条添加点击事件
            sliderBar.addEventListener('click', function(e) {
                if (e.target === slider) return;
                
                const rect = sliderBar.getBoundingClientRect();
                const sliderWidth = rect.width;
                const clickX = e.clientX - rect.left;
                const percent = Math.round((clickX / sliderWidth) * 100);
                
                slider.style.left = `${percent}%`;
                
                if (progressBar) {
                    progressBar.style.width = `${percent}%`;
                }
                
                const countElement = slider.querySelector('.count');
                if (countElement) {
                    countElement.textContent = `${percent}%`;
                }
                
                if (positionValue) {
                    positionValue.textContent = `${percent}%`;
                }
            });
            
            // 添加拖动事件监听
            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart, { passive: false });
        }

        // 全局变量
        let strategyRunning = false;
        let strategyInterval = null;
        let chichang = false;

        // 检查持仓状态函数
        function checkPositionStatus(allowTrade = false) {
            console.log(`检查持仓状态 (允许交易: ${allowTrade})`);
            
            // 获取当前选择的交易对和交易方向
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 更新最后刷新时间
            const lastRefreshElement = document.getElementById('last-refresh-time');
            if (lastRefreshElement) {
                lastRefreshElement.textContent = `最后刷新: ${new Date().toLocaleTimeString()}`;
            }
            
            // 确保从localStorage中获取正确的运行状态，确保与按钮状态同步
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 如果localStorage中有运行状态，同步按钮状态
            const runBtn = document.getElementById('run-strategy-btn');
            if (runBtn) {
                const currentBtnState = runBtn.getAttribute('data-running') === 'true';
                // 如果按钮状态与保存的状态不一致，则同步
                if (currentBtnState !== savedIsRunning) {
                    console.log(`按钮状态(${currentBtnState})与localStorage中的运行状态(${savedIsRunning})不一致，正在同步...`);
                    runBtn.setAttribute('data-running', savedIsRunning.toString());
                    
                    // 更新按钮外观
                    if (savedIsRunning) {
                        runBtn.textContent = '停止';
                        runBtn.style.backgroundColor = '#ff4d4f';
                    } else {
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a';
                    }
                }
            }
            
            // 更新续下单按钮显示状态
            const continueOrderBtn = document.getElementById('continue-order-btn');
            
            // 发送请求检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 更新持仓状态
                    const hasBuyPosition = data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus.sell_flag;
                    chichang = hasBuyPosition || hasSellPosition;
                    
                    // 记录状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 更新策略运行状态指示器
                    const statusIndicator = document.getElementById('key-status-indicator');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    // 如果有持仓，更新续下单按钮样式
                    if (continueOrderBtn) {
                        if (chichang) {
                            continueOrderBtn.innerHTML = '<i class="fas fa-clock"></i> 已持仓(测试用)';
                            continueOrderBtn.style.background = 'linear-gradient(135deg, #1890ff, #40a9ff)';
                            continueOrderBtn.classList.add('position-active');
                            continueOrderBtn.disabled = false; // 保持可点击，因为它是测试按钮
                        } else {
                            // 检查是否有订单正在执行
                            if (data.hasOrder) {
                                continueOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #faad14, #ffc53d)';
                                continueOrderBtn.disabled = false; // 保持可点击
                            } else {
                                continueOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> 续下单(测试用)';
                                continueOrderBtn.style.background = 'linear-gradient(135deg, #1a6aff, #3f87ff)';
                                continueOrderBtn.classList.remove('position-active');
                                continueOrderBtn.disabled = false;
                            }
                        }
                    }
                    
                    // 显示状态指示器
                    if (statusIndicator) {
                        statusIndicator.style.display = 'block';
                        
                        // 更新状态文本和图标
                        if (chichang) {
                            statusText.innerHTML = `多头持仓: ${hasBuyPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}, 空头持仓: ${hasSellPosition ? '<span style="color:#52c41a">激活</span>' : '<span style="color:#bfbfbf">未激活</span>'}`;
                            statusIcon.innerHTML = '🔄';
                            statusIcon.style.animation = 'spin 5s linear infinite';
                            statusIndicator.style.backgroundColor = '#e6f7ff';
                            statusIndicator.style.borderColor = '#91d5ff';
                        } else if (data.hasOrder) {
                            statusText.innerHTML = '有订单正在处理中';
                            statusIcon.innerHTML = '⏳';
                            statusIcon.style.animation = 'blink 1.5s ease infinite';
                            statusIndicator.style.backgroundColor = '#fffbe6';
                            statusIndicator.style.borderColor = '#ffe58f';
                        } else {
                            statusText.innerHTML = '当前无持仓，可以下单';
                            statusIcon.innerHTML = '✅';
                            statusIcon.style.animation = 'none';
                            statusIndicator.style.backgroundColor = '#f6ffed';
                            statusIndicator.style.borderColor = '#b7eb8f';
                        }
                    }
                    
                    // 始终使用localStorage中的运行状态，而不是从按钮状态获取
                    const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                    
                    // 如果允许交易且系统正在运行，且没有持仓，则进行自动下单
                    if (allowTrade && isRunning && !chichang) {
                        console.log('交易系统循环触发自动下单...');
                        
                        // 获取保证金值
                        const marginInput = document.getElementById('margin-input') || 
                                            document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                        const marginValue = marginInput ? marginInput.value : '0';
                        
                        // 如果保证金值有效，执行下单
                        if (parseFloat(marginValue) > 0) {
                            console.log(`执行自动下单: 交易对=${tradePair}, 金额=${marginValue}, 方向=${tradeDirection}`);
                            saveStrategy(false); // 执行下单但不启动策略循环
                        } else {
                            console.log('保证金金额无效，跳过自动下单');
                        }
                    }
                    
                    // 更新按钮状态 - 始终使用localStorage中的状态
                    updateButtonStatus(chichang, isRunning);
                    
                } else {
                    console.error('检查持仓状态失败:', data.message);
                    showToast(`检查持仓状态失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('请求出错:', error);
                showToast('网络请求失败，请检查网络连接', 'error');
                
                // 即使网络请求失败，也要确保按钮状态与localStorage一致
                const isRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                updateButtonStatus(chichang, isRunning);
            });
        }

        // 更新按钮状态
        function updateButtonStatus(hasPosition, isRunning) {
            const runBtn = document.getElementById('run-strategy-btn');
            const stopBtn = document.getElementById('stop-strategy-btn');
            
            // 再次从localStorage获取以确保一致性
            const savedIsRunning = localStorage.getItem('tradingSystemRunning') === 'true';
            
            // 使用savedIsRunning而不是传入的isRunning，确保与localStorage一致
            if (!runBtn) return;
            
            if (savedIsRunning) {
                // 交易系统正在运行
                runBtn.textContent = '停止';
                runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示可以停止
                runBtn.setAttribute('data-running', 'true');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                    statusElement.style.color = '#52c41a';
                }
                
                // 仅当有持仓时显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = hasPosition ? 'inline-block' : 'none';
                    // 强制停止按钮的样式保持红色
                    stopBtn.style.backgroundColor = '#ff4d4f';
                }
                
                // 确保交易系统循环是启动的
                if (!window.tradingSystemInterval) {
                    console.log('检测到系统应该运行但循环未启动，重新启动交易系统循环...');
                    startTradingSystemLoop();
                }
            } else {
                // 交易系统未运行
                runBtn.textContent = '运行';
                runBtn.style.backgroundColor = '#52c41a'; // 绿色表示可以运行
                runBtn.setAttribute('data-running', 'false');
                
                // 更新状态提示
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    statusElement.textContent = hasPosition ? '交易系统已停止，但仍有持仓' : '交易系统已停止';
                    statusElement.style.color = '#8c8c8c';
                }
                
                // 系统未运行时，不显示强制停止按钮
                if (stopBtn) {
                    stopBtn.style.display = 'none';
                }
                
                // 确保循环已停止
                if (window.tradingSystemInterval) {
                    console.log('检测到系统应该停止但循环仍在运行，停止交易系统循环...');
                    clearInterval(window.tradingSystemInterval);
                    window.tradingSystemInterval = null;
                }
            }
        }

        // 自定义确认对话框函数
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm, onCancel) {
            // 创建对话框容器
            const dialogOverlay = document.createElement('div');
            dialogOverlay.style.position = 'fixed';
            dialogOverlay.style.top = '0';
            dialogOverlay.style.left = '0';
            dialogOverlay.style.width = '100%';
            dialogOverlay.style.height = '100%';
            dialogOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            dialogOverlay.style.zIndex = '9999';
            dialogOverlay.style.display = 'flex';
            dialogOverlay.style.justifyContent = 'center';
            dialogOverlay.style.alignItems = 'center';
            
            // 创建对话框内容
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '8px';
            dialog.style.width = '300px';
            dialog.style.maxWidth = '90%';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // 添加标题
            const titleElement = document.createElement('div');
            titleElement.textContent = title;
            titleElement.style.padding = '16px';
            titleElement.style.borderBottom = '1px solid #f0f0f0';
            titleElement.style.fontWeight = 'bold';
            dialog.appendChild(titleElement);
            
            // 添加消息
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.style.padding = '16px';
            messageElement.style.color = '#595959';
            dialog.appendChild(messageElement);
            
            // 添加按钮容器
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.borderTop = '1px solid #f0f0f0';
            
            // 确认按钮
            const confirmButton = document.createElement('button');
            confirmButton.textContent = confirmText;
            confirmButton.style.flex = '1';
            confirmButton.style.padding = '12px';
            confirmButton.style.border = 'none';
            confirmButton.style.backgroundColor = '#1a6aff';
            confirmButton.style.color = 'white';
            confirmButton.style.borderRadius = '0 0 0 8px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onConfirm) onConfirm();
            });
            
            // 取消按钮
            const cancelButton = document.createElement('button');
            cancelButton.textContent = cancelText;
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '12px';
            cancelButton.style.border = 'none';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#595959';
            cancelButton.style.borderRadius = '0 0 8px 0';
            cancelButton.style.cursor = 'pointer';
            cancelButton.addEventListener('click', function() {
                document.body.removeChild(dialogOverlay);
                if (onCancel) onCancel();
            });
            
            buttonsContainer.appendChild(confirmButton);
            buttonsContainer.appendChild(cancelButton);
            dialog.appendChild(buttonsContainer);
            
            dialogOverlay.appendChild(dialog);
            document.body.appendChild(dialogOverlay);
        }

        // 更新导航栏中的持仓数量显示
        function updatePositionCount(count) {
            // 尝试找到当前页面中的持仓数量显示元素
            const positionCountElem = document.querySelector('.flex-x.nav-li.active-nav-li.nav-li-p span:nth-child(2)');
            if (positionCountElem) {
                positionCountElem.textContent = `(${count})`;
            }
            
            // 尝试发送消息到spot页面（如果有）
            try {
                // 将持仓信息广播到其他页面
                localStorage.setItem('okxPositionCount', count.toString());
                
                // 派发自定义事件
                window.dispatchEvent(new CustomEvent('okxPositionUpdated', {
                    detail: { count: count }
                }));
            } catch (e) {
                console.error('更新持仓数量出错:', e);
            }
            
            // 创建持仓信息展示区（如果尚未创建）
            if (!document.getElementById('position-details-container')) {
                // 在状态显示下方添加持仓详情区域
                const statusElement = document.getElementById('strategy-status');
                if (statusElement) {
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = 'position-details-container';
                    detailsContainer.style.marginTop = '15px';
                    detailsContainer.style.padding = '15px';
                    detailsContainer.style.backgroundColor = '#f8f9fa';
                    detailsContainer.style.borderRadius = '8px';
                    detailsContainer.style.display = count > 0 ? 'block' : 'none';
                    statusElement.parentNode.insertBefore(detailsContainer, statusElement.nextSibling);
                }
            }
        }

        // 显示持仓详情
        function showPositionDetails(positionStatus, tradePair) {
            const container = document.getElementById('position-details-container');
            if (!container) return;
            
            container.style.display = 'block';
            container.innerHTML = `<h5 style="font-size: 16px; margin-bottom: 10px;">持仓详情</h5>`;
            
            // 显示多头持仓信息
            if (positionStatus.buy_flag) {
                const buyInfo = document.createElement('div');
                buyInfo.classList.add('position-item');
                buyInfo.style.marginBottom = '10px';
                buyInfo.style.padding = '10px';
                buyInfo.style.backgroundColor = '#e6f7ff';
                buyInfo.style.borderRadius = '4px';
                buyInfo.style.borderLeft = '3px solid #1890ff';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz) {
                    availPos = positionStatus.p_Pos_sz;
                }
                
                if (positionStatus.p_cw_avgPx) {
                    avgPrice = positionStatus.p_cw_avgPx;
                }
                
                buyInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 多头</span>
                        <span style="color: #52c41a;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(buyInfo);
            }
            
            // 显示空头持仓信息
            if (positionStatus.sell_flag) {
                const sellInfo = document.createElement('div');
                sellInfo.classList.add('position-item');
                sellInfo.style.marginBottom = '10px';
                sellInfo.style.padding = '10px';
                sellInfo.style.backgroundColor = '#fff2e8';
                sellInfo.style.borderRadius = '4px';
                sellInfo.style.borderLeft = '3px solid #fa541c';
                
                let availPos = '';
                let avgPrice = '';
                
                if (positionStatus.p_Pos_sz_s) {
                    availPos = positionStatus.p_Pos_sz_s;
                }
                
                if (positionStatus.p_cw_avgPx_s) {
                    avgPrice = positionStatus.p_cw_avgPx_s;
                }
                
                sellInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: 500;">${tradePair} 空头</span>
                        <span style="color: #ff4d4f;">${availPos} 张</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>开仓均价</span>
                        <span>${avgPrice}</span>
                    </div>
                `;
                
                container.appendChild(sellInfo);
            }
        }

        // 清除持仓详情显示
        function clearPositionDetails() {
            const container = document.getElementById('position-details-container');
            if (container) {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }
        
        // 页面加载时优先检查buy_flag状态并激活按钮
        function checkInitialPositionStatus() {
            // 获取当前URL中的策略ID和交易对
            const urlParams = new URLSearchParams(window.location.search);
            const strategyId = urlParams.get('id') || '1';
            
            // 获取交易对（根据策略ID设置不同的默认交易对）
            let tradePair = 'BTC-USDT';
            if (strategyId === '2') {
                tradePair = 'ETH-USDT';
            } else if (strategyId === '3') {
                tradePair = 'SOL-USDT';
            } else if (strategyId === '4') {
                tradePair = 'BNB-USDT';
            } else if (strategyId === '5') {
                tradePair = 'DOT-USDT';
            } else if (strategyId === '6') {
                tradePair = 'ADA-USDT';
            }
            
            // 显示加载状态
            const statusElement = document.getElementById('strategy-status');
            statusElement.textContent = '正在检查持仓状态...';
            
            // 向后端发送请求获取持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: 'buy'  // 无论当前选择什么方向，优先检查buy_flag
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 直接检查buy_flag
                    const hasBuyPosition = data.positionStatus && data.positionStatus.buy_flag;
                    const hasSellPosition = data.positionStatus && data.positionStatus.sell_flag;
                    
                    // 获取UI元素
                    const runBtn = document.getElementById('run-strategy-btn');
                    const stopBtn = document.getElementById('stop-strategy-btn');
                    const saveBtn = document.getElementById('save-strategy-btn');
                    
                    // 更新后端检查结果到控制台 - 这是控制zhibiao.py循环的关键状态
                    console.log(`[策略状态结果] 多头持仓: ${hasBuyPosition ? '激活' : '未激活'}, 空头持仓: ${hasSellPosition ? '激活' : '未激活'}`);
                    
                    // 关键状态：多头激活而空头未激活 - 这是最重要的状态，用来控制zhibiao.py循环
                    if (hasBuyPosition && !hasSellPosition) {
                        console.log('🔄 关键循环状态: 多头持仓激活且空头未激活，zhibiao.py主循环运行中');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮 - 清晰显示循环运行状态
                        runBtn.textContent = '循环运行中';
                        runBtn.style.backgroundColor = '#1a6aff'; // 蓝色表示正在循环
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '多头持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '🔄 多头持仓激活，zhibiao.py主循环运行中';
                        statusElement.style.color = '#1a6aff'; // 蓝色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 创建持仓状态指示标签
                        const statusIndicator = document.createElement('div');
                        statusIndicator.style.backgroundColor = '#e6f7ff';
                        statusIndicator.style.border = '1px solid #91d5ff';
                        statusIndicator.style.borderRadius = '4px';
                        statusIndicator.style.padding = '8px 12px';
                        statusIndicator.style.marginTop = '10px';
                        statusIndicator.style.fontWeight = 'bold';
                        statusIndicator.style.color = '#1a6aff';
                        statusIndicator.style.display = 'flex';
                        statusIndicator.style.alignItems = 'center';
                        statusIndicator.style.justifyContent = 'center';
                        statusIndicator.style.gap = '8px';
                        
                        // 添加循环图标和文本
                        statusIndicator.innerHTML = `
                            <div style="animation: spin 2s linear infinite;">🔄</div>
                            <div>多头持仓激活 - zhibiao.py主循环运行中</div>
                        `;
                        
                        // 如果已有状态指示，先移除
                        const existingIndicator = document.querySelector('#loop-status-indicator');
                        if (existingIndicator) {
                            existingIndicator.remove();
                        }
                        
                        statusIndicator.id = 'loop-status-indicator';
                        statusElement.parentNode.insertBefore(statusIndicator, statusElement.nextSibling);
                        
                        // 添加CSS动画
                        const style = document.createElement('style');
                        style.innerHTML = `
                            @keyframes spin {
                                from { transform: rotate(0deg); }
                                to { transform: rotate(360deg); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // 设置自动监控 - 更频繁检查状态
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 10000); // 10秒检查一次
                    } else if (hasBuyPosition && hasSellPosition) {
                        // 多头和空头都激活
                        console.log('检测到buy_flag=True和sell_flag=True，设置为双向持仓状态');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮
                        runBtn.textContent = '运行中';
                        runBtn.style.backgroundColor = '#faad14'; // 黄色表示运行中
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '双向持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '检测到多头和空头持仓，策略已激活';
                        statusElement.style.color = '#faad14'; // 黄色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 设置自动监控
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15秒检查一次
                    } else if (!hasBuyPosition && hasSellPosition) {
                        // 只有空头持仓
                        console.log('检测到buy_flag=False但sell_flag=True，设置为空头持仓状态');
                        
                        // 更新全局持仓状态
                        chichang = true;
                        
                        // 激活运行按钮
                        runBtn.textContent = '运行中';
                        runBtn.style.backgroundColor = '#ff4d4f'; // 红色表示空头运行中
                        runBtn.disabled = true;
                        
                        // 显示停止按钮
                        stopBtn.style.display = 'inline-block';
                        
                        // 激活保存按钮
                        saveBtn.textContent = '空头持仓中';
                        saveBtn.classList.add('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 更新状态提示
                        statusElement.textContent = '检测到空头持仓，多头未激活';
                        statusElement.style.color = '#ff4d4f'; // 红色警告
                        
                        // 自动开始策略运行状态
                        strategyRunning = true;
                        
                        // 设置自动监控
                        strategyInterval = setInterval(function() {
                            checkPositionStatus();
                        }, 15000); // 15秒检查一次
                    } else {
                        // 无任何持仓
                        console.log('检测到buy_flag=False，无任何持仓，设置为未激活状态');
                        
                        // 未检测到多头持仓，设置为非激活状态
                        chichang = false;
                        
                        // 保持正常状态
                        runBtn.textContent = '运行';
                        runBtn.style.backgroundColor = '#52c41a'; // 绿色
                        runBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        saveBtn.textContent = '保存设置';
                        statusElement.textContent = '无持仓，系统准备就绪';
                        statusElement.style.color = '#52c41a'; // 绿色正常
                        strategyRunning = false;
                        
                        // 确保移除任何激活状态的类
                        saveBtn.classList.remove('position-active');
                        saveBtn.classList.remove('order-success');
                        
                        // 如果没有buy_flag，则正常检查持仓状态
                        checkPositionStatusOnLoad();
                    }
                    
                    // 添加状态摘要显示 - 如果后端提供了状态摘要
                    if (data.statusSummary) {
                        // 在状态元素的下方添加后端状态摘要
                        const statusDetailElement = document.createElement('div');
                        statusDetailElement.textContent = `后端状态: ${data.statusSummary}`;
                        statusDetailElement.style.fontSize = '12px';
                        statusDetailElement.style.marginTop = '5px';
                        statusDetailElement.style.color = '#666';
                        
                        // 如果已有之前的状态摘要，先移除
                        const existingDetail = document.querySelector('.status-detail');
                        if (existingDetail) {
                            existingDetail.remove();
                        }
                        
                        statusDetailElement.classList.add('status-detail');
                        statusElement.parentNode.insertBefore(statusDetailElement, statusElement.nextSibling);
                    }
                    
                    // 关键状态显示
                    if (hasBuyPosition && !hasSellPosition) {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'block';
                        }
                    } else {
                        const keyStatusIndicator = document.getElementById('key-status-indicator');
                        if (keyStatusIndicator) {
                            keyStatusIndicator.style.display = 'none';
                        }
                    }
                } else {
                    // 如果检查失败，回退到正常检查
                    checkPositionStatusOnLoad();
                }
            })
            .catch(error => {
                console.error('优先检查buy_flag失败:', error);
                // 出错时回退到正常检查
                checkPositionStatusOnLoad();
            });
        }

        // 初始化币种选择器功能
        function initCryptoSelector() {
            // 币种选择模态框
            const modal = document.getElementById('crypto-selection-modal');
            const cryptoSelector = document.getElementById('crypto-selector');
            const closeBtn = document.querySelector('.close');
            const searchInput = document.getElementById('crypto-search');
            const cryptoItems = document.querySelectorAll('.crypto-item');
            
            // 打开模态框
            if (cryptoSelector) {
                cryptoSelector.addEventListener('click', function() {
                    modal.style.display = 'block';
                });
            }
            
            // 关闭模态框
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 搜索功能
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    cryptoItems.forEach(item => {
                        const symbol = item.getAttribute('data-symbol').toLowerCase();
                        const display = item.getAttribute('data-display').toLowerCase();
                        if (symbol.includes(searchTerm) || display.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
            
            // 选择交易对
            cryptoItems.forEach(item => {
                item.addEventListener('click', function() {
                    const symbol = this.getAttribute('data-symbol');
                    const display = this.getAttribute('data-display');
                    const originalPair = this.getAttribute('data-original');
                    
                    // 更新显示
                    document.getElementById('selected-crypto-name').textContent = display;
                    document.getElementById('selected-crypto-icon').src = `https://ai.hkd.red/symbolImage/${symbol}.png`;
                    document.getElementById('selected-crypto-pair').value = originalPair;
                    
                    // 高亮选中项
                    cryptoItems.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // 关闭模态框
                    modal.style.display = 'none';
                    
                    // 更新策略配置中的交易对
                    if (window.strategyConfig) {
                        window.strategyConfig.tradePair = originalPair;
                    }
                    
                    // 这里可以添加选择交易对后的其他逻辑，如更新杠杆选项等
                    showToast(`已选择 ${display} 交易对`);
                    
                    // 选择新的交易对后，重新检查持仓状态
                    checkPositionStatus(false);
                });
            });
        }

        // 策略方向选择事件
        const typeElements = document.querySelectorAll('.type-box .type-li');
        typeElements.forEach(function(el) {
            el.addEventListener('click', function() {
                // 移除所有的激活状态
                typeElements.forEach(item => {
                    item.classList.remove('type-active');
                });
                
                // 为当前点击元素添加激活状态
                this.classList.add('type-active');
                
                // 更新方向，如果是保存按钮再次提交，需要获取最新的方向
                const tradeDirection = this.textContent.trim() === '做多' ? 'buy' : 'sell';
                
                // 添加点击动画效果
                this.parentElement.classList.add('row-clicked');
                setTimeout(() => {
                    this.parentElement.classList.remove('row-clicked');
                }, 300);
                
                // 显示选择的方向
                showToast(`已选择${this.textContent.trim()}方向`);
                
                // 重置保存按钮状态 - 用户切换方向后应该重新提交订单
                const saveButton = document.querySelector('.confirm-btn');
                saveButton.textContent = '保存设置';
                saveButton.classList.remove('order-success');
                saveButton.classList.remove('position-active');
                
                // 检查当前方向是否已有持仓，如果有则更新按钮状态
                checkPositionStatus(tradeDirection);
            });
        });
        
        // 检查持仓状态
        function checkPositionStatus(direction) {
            const tradePair = document.getElementById('selected-crypto-pair').value || 'BTC-USDT';
            
            // 发送AJAX请求到后端检查持仓状态
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair,
                    tradeDirection: direction
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const saveButton = document.querySelector('.confirm-btn');
                    const hasSameDirectionPosition = 
                        (direction === 'buy' && data.positionStatus && data.positionStatus.buy_flag) || 
                        (direction === 'sell' && data.positionStatus && data.positionStatus.sell_flag);
                    
                    if (hasSameDirectionPosition) {
                        // 已有相同方向持仓，显示为"已持仓中"
                        saveButton.textContent = '已持仓中';
                        saveButton.classList.add('position-active');
                        saveButton.classList.remove('order-success');
                    } else if (data.hasOrder) {
                        // 有订单执行中
                        saveButton.textContent = '已下单，执行中';
                        saveButton.classList.add('order-success');
                        saveButton.classList.remove('position-active');
                    } else {
                        // 无持仓或订单
                        saveButton.textContent = '保存设置';
                        saveButton.classList.remove('order-success');
                        saveButton.classList.remove('position-active');
                    }
                    
                    // 更新状态指示器
                    updateStatusIndicator(data.positionStatus, data.statusSummary);
                }
            })
            .catch(error => {
                console.error('Error checking position:', error);
            });
        }
        
        // 更新状态指示器
        function updateStatusIndicator(positionStatus, statusSummary) {
            const statusIndicator = document.getElementById('key-status-indicator');
            const statusText = document.getElementById('status-text');
            const statusIcon = document.getElementById('status-icon');
            
            if (statusIndicator && statusText) {
                statusIndicator.style.display = 'block';
                
                // 更新状态文本
                if (statusSummary) {
                    statusText.textContent = statusSummary;
                } else {
                    const buyStatus = positionStatus && positionStatus.buy_flag ? '激活' : '未激活';
                    const sellStatus = positionStatus && positionStatus.sell_flag ? '激活' : '未激活';
                    statusText.textContent = `多头持仓: ${buyStatus}, 空头持仓: ${sellStatus}`;
                }
                
                // 更新图标
                if (positionStatus && (positionStatus.buy_flag || positionStatus.sell_flag)) {
                    statusIcon.textContent = '✅';
                } else {
                    statusIcon.textContent = '⚙️';
                }
            }
        }

        // 运行策略按钮点击事件
        document.getElementById('run-strategy-btn').addEventListener('click', function() {
            // 获取表单数据
            saveStrategy(true);  // 传入true表示运行策略
        });

        // 修改saveStrategy函数，添加运行成功后的处理逻辑
        function saveStrategy(shouldRunStrategy = false) {
            // 获取策略ID
            const strategyId = getStrategyId();
            // 获取保证金值
            const marginInput = document.getElementById('margin-input');
            const marginValue = marginInput ? marginInput.value : '0';
            // 获取交易对
            const tradePairInput = document.getElementById('selected-crypto-pair');
            const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 显示加载指示器
            showLoading();
            
            // 发送请求保存策略
            fetch('/api/strategy/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    strategyId: strategyId,
                    marginValue: marginValue,
                    tradePair: tradePair,
                    tradeDirection: tradeDirection
                })
            })
            .then(response => response.json())
            .then(data => {
                // 隐藏加载指示器
                hideLoading();
                
                // 显示合约张数
                if (data.code === 200) {
                    // 是否已经持有头寸
                    const hasPosition = data.positionStatus && 
                                       (data.positionStatus.buy_flag || data.positionStatus.sell_flag);
                    
                    // 更新运行状态
                    const runBtn = document.getElementById('run-strategy-btn');
                    const isRunning = runBtn ? runBtn.getAttribute('data-running') === 'true' : false;
                    
                    // 如果有订单结果或持仓，自动设置系统为运行状态
                    if (data.orderResult || hasPosition) {
                        console.log('下单成功或检测到持仓，自动启动交易系统');
                        
                        // 设置按钮状态
                        if (runBtn && !isRunning) {
                            runBtn.setAttribute('data-running', 'true');
                            runBtn.textContent = '停止';
                            runBtn.style.backgroundColor = '#ff4d4f';
                            
                            // 如果不是正在运行，启动循环
                            startTradingSystemLoop();
                        }
                        
                        // 保存运行状态到localStorage
                        localStorage.setItem('tradingSystemRunning', 'true');
                        
                        // 更新状态提示
                        const statusElement = document.getElementById('strategy-status');
                        if (statusElement) {
                            statusElement.textContent = hasPosition ? '交易系统运行中，有持仓' : '交易系统运行中，无持仓';
                            statusElement.style.color = '#52c41a';
                        }
                    }
                    
                    // 如果有订单结果，则显示订单结果
                    if (data.orderResult) {
                        console.log('下单成功，订单信息:', data.orderResult);
                        
                        // 显示订单成功对话框
                        showOrderSuccessDialog(data.orderResult);
                        
                        // 延迟检查交易对JSON状态
                        setTimeout(() => {
                            checkTradingPairsStatus();
                        }, 2000);
                        
                        // 如果是"运行策略"操作，则在对话框中添加"返回合约页面"按钮
                        if (shouldRunStrategy) {
                            // 延迟3秒后，清除localStorage中的持仓数据，并返回合约页面
                            setTimeout(() => {
                                // 清除localStorage数据，确保返回页面时能够重新获取最新数据
                                localStorage.removeItem('okxPositions');
                                localStorage.removeItem('okxPositionCount');
                                localStorage.removeItem('okxPositionsUpdateTime');
                                
                                // 返回合约页面，添加时间戳避免缓存问题
                                if (confirm('策略已成功运行，是否返回合约页面查看持仓状态？')) {
                                    goBackToContract();
                                }
                            }, 3000);
                        }
                    } else {
                        // 仅保存策略设置
                        showToast('策略保存成功!', 'success');
                    }
                } else {
                    // 处理错误情况
                    console.error('保存策略失败:', data.message);
                    showToast(`操作失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('保存策略时出错:', error);
                showToast('保存策略时出错，请稍后再试', 'error');
            });
        }

        // 获取策略ID
        function getStrategyId() {
            // 从URL中获取策略ID
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || '1';
        }

        // 显示加载指示器
        function showLoading() {
            // 检查是否存在加载指示器，没有则创建
            let loadingOverlay = document.getElementById('loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.position = 'fixed';
                loadingOverlay.style.top = '0';
                loadingOverlay.style.left = '0';
                loadingOverlay.style.width = '100%';
                loadingOverlay.style.height = '100%';
                loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.justifyContent = 'center';
                loadingOverlay.style.alignItems = 'center';
                loadingOverlay.style.zIndex = '9999';
                
                const spinner = document.createElement('div');
                spinner.style.width = '50px';
                spinner.style.height = '50px';
                spinner.style.border = '5px solid #f3f3f3';
                spinner.style.borderTop = '5px solid #3498db';
                spinner.style.borderRadius = '50%';
                spinner.style.animation = 'spin 1s linear infinite';
                
                // 添加旋转动画
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                loadingOverlay.appendChild(spinner);
                document.body.appendChild(loadingOverlay);
            } else {
                loadingOverlay.style.display = 'flex';
            }
        }

        // 隐藏加载指示器
        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // 显示订单成功对话框
        function showOrderSuccessDialog(orderResult) {
            // 创建对话框元素
            const dialog = document.createElement('div');
            dialog.className = 'order-success-dialog';
            dialog.style.position = 'fixed';
            dialog.style.top = '50%';
            dialog.style.left = '50%';
            dialog.style.transform = 'translate(-50%, -50%)';
            dialog.style.width = '80%';
            dialog.style.maxWidth = '350px';
            dialog.style.backgroundColor = '#fff';
            dialog.style.borderRadius = '8px';
            dialog.style.padding = '20px';
            dialog.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
            dialog.style.zIndex = '10000';
            
            // 设置对话框内容
            dialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <i class="fas fa-check-circle" style="font-size: 50px; color: #52c41a;"></i>
                    <h3 style="margin-top: 10px; font-size: 18px;">下单成功</h3>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">交易对:</span>
                        <span>${orderResult.tradePair}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">方向:</span>
                        <span>${orderResult.direction}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">合约张数:</span>
                        <span>${orderResult.contractSize}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">保证金:</span>
                        <span>${orderResult.margin}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">订单ID:</span>
                        <span>${orderResult.orderId}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #666;">时间:</span>
                        <span>${orderResult.time}</span>
                    </div>
                </div>
                <button id="close-dialog-btn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #1a6aff, #3f87ff); color: white; border: none; border-radius: 4px; font-weight: 500;">知道了</button>
            `;
            
            // 添加对话框到页面
            document.body.appendChild(dialog);
            
            // 创建背景遮罩
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
            document.body.appendChild(overlay);

            // 添加关闭按钮事件
            document.getElementById('close-dialog-btn').addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
            });

            // 点击背景遮罩也可以关闭
            overlay.addEventListener('click', function() {
                dialog.remove();
                overlay.remove();
            });
        }

        // 添加新的交易系统循环函数
        function startTradingSystemLoop() {
            // 先清除可能存在的旧定时器
            if (window.tradingSystemInterval) {
                clearInterval(window.tradingSystemInterval);
            }
            
            // 创建新的定时器，每30秒执行一次交易检查
            window.tradingSystemInterval = setInterval(function() {
                // 获取当前时间并格式化
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                // 更新最后检查时间
                const lastCheckElement = document.getElementById('last-refresh-time');
                if (lastCheckElement) {
                    lastCheckElement.textContent = `上次检查时间: ${timeString}`;
                }
                
                console.log(`[${timeString}] 执行交易系统检查...`);
                
                // 获取交易对和金额信息
                const tradePairInput = document.getElementById('selected-crypto-pair');
                const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
                
                // 获取保证金值
                const marginInput = document.getElementById('margin-input') || 
                                    document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                const marginValue = marginInput ? marginInput.value : '0';
                
                // 检查交易对状态
                checkPositionStatus(true);
                
                // 记录日志
                console.log(`检查交易对: ${tradePair}, 金额: ${marginValue} USDT`);
            }, 30000); // 每30秒执行一次
            
            // 立即执行一次
            console.log('启动交易系统循环，立即执行第一次检查...');
            checkPositionStatus(true);
        }

        // 添加测试订单系统功能
        function testOrderSystem() {
            // 获取当前表单数据
            const tradePairInput = document.getElementById('selected-crypto-pair');
            const tradePair = tradePairInput ? tradePairInput.value : 'BTC-USDT';
            
            const marginInput = document.getElementById('margin-input') || 
                                document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
            const marginValue = marginInput ? marginInput.value : '0';
            
            // 获取交易方向
            const directionElement = document.querySelector('.type-active');
            const tradeDirection = directionElement && directionElement.textContent === '做多' ? 'buy' : 'sell';
            
            // 记录测试信息
            console.log('测试交易系统连接...');
            console.log(`交易对: ${tradePair}, 金额: ${marginValue} USDT, 方向: ${tradeDirection}`);
            
            // 检查持仓状态但不实际下单
            fetch('/api/position/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tradePair: tradePair
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // 显示成功测试结果
                    showToast(`测试成功! 持仓状态: ${JSON.stringify(data.positionStatus)}`, 'success');
                } else {
                    // 显示测试失败
                    showToast(`测试失败: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('测试订单系统出错:', error);
                showToast('测试过程中发生错误，请检查网络连接', 'error');
            });
        }

        // 检查交易对JSON文件状态
        function checkTradingPairsStatus() {
            console.log('检查交易对JSON文件状态...');
            
            // 请求获取所有交易对数据
            fetch('/api/trading_pairs/list')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && Array.isArray(data.data)) {
                        const tradingPairs = data.data;
                        
                        console.log(`获取到${tradingPairs.length}个交易对`);
                        
                        // 如果有交易对数据，说明系统可能在使用中
                        if (tradingPairs.length > 0) {
                            // 检查localStorage中的运行状态
                            const isSystemRunning = localStorage.getItem('tradingSystemRunning') === 'true';
                            
                            // 如果没有明确的运行状态记录，或状态为false，但有交易对，则假设系统应该是运行中的
                            if (localStorage.getItem('tradingSystemRunning') === null || !isSystemRunning) {
                                console.log('检测到交易对数据但系统未运行，自动设置为运行中');
                                
                                // 设置运行状态为true
                                localStorage.setItem('tradingSystemRunning', 'true');
                                
                                // 更新UI
                                const runBtn = document.getElementById('run-strategy-btn');
                                if (runBtn && runBtn.getAttribute('data-running') !== 'true') {
                                    runBtn.setAttribute('data-running', 'true');
                                    runBtn.textContent = '停止';
                                    runBtn.style.backgroundColor = '#ff4d4f';
                                    
                                    // 更新状态提示
                                    const statusElement = document.getElementById('strategy-status');
                                    if (statusElement) {
                                        statusElement.textContent = '交易系统正在运行中...';
                                        statusElement.style.color = '#52c41a';
                                    }
                                    
                                    // 启动交易系统循环
                                    startTradingSystemLoop();
                                    
                                    // 显示通知
                                    showToast('检测到交易对数据，自动启动交易系统', 'info');
                                }
                            }
                            
                            // 获取当前选择的交易对
                            const currentTradePair = document.getElementById('selected-crypto-pair').value;
                            
                            // 尝试找到匹配当前交易对的数据
                            const matchedPair = tradingPairs.find(p => p.tradePair === currentTradePair);
                            
                            // 如果找到匹配的交易对，填充金额信息
                            if (matchedPair) {
                                console.log(`找到匹配的交易对: ${matchedPair.tradePair}, 金额: ${matchedPair.amount}`);
                                
                                // 更新金额输入框
                                const marginInput = document.getElementById('margin-input') || 
                                                  document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
                                if (marginInput && !marginInput.value) {
                                    marginInput.value = matchedPair.amount;
                                    console.log(`已自动填充金额: ${matchedPair.amount}`);
                                }
                            }
                        } else {
                            // 没有交易对数据，可以考虑设置运行状态为false
                            // 但这里我们不自动更改，因为用户可能想保持系统运行状态
                            console.log('没有检测到交易对数据，保持当前系统状态');
                        }
                    } else {
                        console.log('没有获取到交易对数据或请求失败');
                    }
                })
                .catch(error => {
                    console.error('获取交易对数据出错:', error);
                });
        }
    </script>

    <script>
        // 确保保证金输入框稳定，禁用所有动画
        document.addEventListener('DOMContentLoaded', function() {
            const marginContainer = document.getElementById('margin-input-container');
            if (marginContainer) {
                // 移除所有可能导致动画的类
                marginContainer.classList.remove('hover-glow', 'element-animated', 'margin-highlight');
                
                // 设置内联样式以覆盖任何动画
                marginContainer.style.transition = 'none';
                marginContainer.style.animation = 'none';
                marginContainer.style.transform = 'none';
                
                // 获取输入框
                const input = marginContainer.querySelector('.uni-input-input');
                if (input) {
                    input.style.transition = 'none';
                    input.style.animation = 'none';
                }
            }
        });
    </script>
    

<script>
    // 实时获取持仓数量并更新显示
    (function() {
        // 定时获取实际持仓数量
        function updateRealPositionCount() {
            fetch('/api/position/count')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const count = data.count;
                    console.log("从OKX获取的实际持仓数量:", count);
                    
                    // 更新所有导航栏中的持仓数量显示
                    const navElems = document.querySelectorAll('.flex-x.nav-li.nav-li-p span:nth-child(2)');
                    navElems.forEach(elem => {
                        elem.textContent = `(${count})`;
                    });
                    
                    // 保存到localStorage
                    localStorage.setItem('okxPositionCount', count.toString());
                }
            })
            .catch(error => {
                console.error("获取持仓数量失败:", error);
            });
        }
        
        // 页面加载完成后立即执行一次
        document.addEventListener('DOMContentLoaded', function() {
            updateRealPositionCount();
            // 每30秒自动更新一次
            setInterval(updateRealPositionCount, 30000);
        });
    })();
</script>

<script>
// 添加返回函数
function goBackToContract() {
    // 清除可能导致问题的localStorage数据
    localStorage.removeItem('okxPositions');
    localStorage.removeItem('okxPositionCount');
    localStorage.removeItem('okxPositionsUpdateTime');
    
    // 直接跳转到合约页面，添加时间戳参数避免缓存问题
    window.location.href = '/spot?type=contract&t=' + new Date().getTime();
}
</script>

<!-- 添加已保存交易对列表 -->
<div class="box" style="margin-top: 20px;">
    <div class="box-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size: 18px; font-weight: 600; color: #333;">已保存的交易对</div>
            <div>
                <button class="btn btn-sm btn-primary" onclick="refreshTradingPairs()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>
        
        <div id="trading-pairs-list" class="mt-3">
            <!-- 交易对列表将在这里动态加载 -->
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载交易对...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 已有的JavaScript代码...
    
    // 页面加载完成后获取交易对列表
    document.addEventListener('DOMContentLoaded', function() {
        refreshTradingPairs();
    });
    
    // 刷新交易对列表
    function refreshTradingPairs() {
        fetch('/api/trading_pairs/list')
            .then(response => response.json())
            .then(data => {
                const listElement = document.getElementById('trading-pairs-list');
                
                if (data.code === 200 && Array.isArray(data.data)) {
                    if (data.data.length === 0) {
                        // 没有交易对
                        listElement.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 暂无保存的交易对
                            </div>
                        `;
                        return;
                    }
                    
                    // 有交易对，创建表格
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>交易对</th>
                                        <th>USDT金额</th>
                                        <th>添加时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // 添加数据行
                    data.data.forEach(pair => {
                        html += `
                            <tr>
                                <td>${pair.tradePair}</td>
                                <td>${pair.amount} USDT</td>
                                <td>${pair.formattedTime}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTradingPair('${pair.tradePair}')">
                                        <i class="fas fa-trash-alt"></i> 删除
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="useTradingPair('${pair.tradePair}', ${pair.amount})">
                                        <i class="fas fa-check"></i> 使用
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    listElement.innerHTML = html;
                } else {
                    // 请求错误
                    listElement.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 获取交易对失败: ${data.message || '未知错误'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('获取交易对出错:', error);
                const listElement = document.getElementById('trading-pairs-list');
                listElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 网络错误，无法获取交易对列表
                    </div>
                `;
            });
    }
    
    // 删除交易对
    function deleteTradingPair(tradePair) {
        if (!confirm(`确定要删除交易对 ${tradePair} 吗？`)) {
            return;
        }
        
        fetch('/api/trading_pairs/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tradePair: tradePair
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                // 删除成功，刷新列表
                showToast('成功', `已删除交易对 ${tradePair}`, 'success');
                refreshTradingPairs();
            } else {
                // 删除失败
                showToast('失败', data.message || '删除失败', 'error');
            }
        })
        .catch(error => {
            console.error('删除交易对出错:', error);
            showToast('错误', '网络错误，无法删除交易对', 'error');
        });
    }
    
    // 使用已保存的交易对填充表单
    function useTradingPair(tradePair, amount) {
        // 设置交易对
        document.getElementById('selected-crypto-pair').value = tradePair;
        
        // 更新显示的交易对名称
        const cryptoNameElement = document.querySelector('.robot-name');
        if (cryptoNameElement) {
            const baseCurrency = tradePair.split('-')[0];
            cryptoNameElement.textContent = baseCurrency;
        }
        
        // 更新图标
        const cryptoIconElement = document.querySelector('.coin-img');
        if (cryptoIconElement) {
            const baseCurrency = tradePair.split('-')[0];
            cryptoIconElement.src = `https://ai.hkd.red/symbolImage/${baseCurrency}.png`;
        }
        
        // 设置USDT金额
        const marginInput = document.querySelector('.uni-input-input[placeholder="输入投入金额"]');
        if (marginInput) {
            marginInput.value = amount;
        }
        
        showToast('提示', `已选择交易对 ${tradePair}`, 'info');
    }
    
    // 显示提示消息
    function showToast(title, message, type = 'info') {
        // 检查是否已有toast容器
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // 创建toast元素
        const toast = document.createElement('div');
        toast.className = `toast fade show ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : 'bg-info text-white'}`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        // 设置toast内容
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // 添加到容器
        toastContainer.appendChild(toast);
        
        // 3秒后自动关闭
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
</script>

</body>
</html> 